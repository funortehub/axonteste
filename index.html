<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Axon</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" id="status-bar-style-meta" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Axon">
    <link rel="apple-touch-icon" href="https://i.imgur.com/ZsfZEh2.png">
    <meta name="theme-color" id="theme-color-meta" content="#1a202c">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Outfit:wght@300;400;600;800&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            /* Gallium Fluidity Theme */
            --bg-color: #050507;
            --text-color: #ffffff;
            --text-muted: #94a3b8;
            --accent-color: #cbd5e1;
            --highlight-color: #38bdf8;
            /* Cyan-blue for focus */
            --error-color: #f87171;
            --success-color: #4ade80;

            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);

            --font-main: 'Outfit', sans-serif;
            --font-code: 'JetBrains Mono', monospace;

            --transition-fluid: cubic-bezier(0.77, 0, 0.175, 1);

            /* Legacy Variables Mapped */
            --bg-gradient: linear-gradient(135deg, #050507, #0a0a0f);
            --input-bg: rgba(255, 255, 255, 0.05);
            --border-color: var(--glass-border);
            --header-text-color: #ffffff;
            --prompt-color: #38bdf8;
            --command-color: #cbd5e1;
            --output-color: #e2e8f0;
            --terminal-header-bg: rgba(0, 0, 0, 0.3);
            --button-bg: rgba(255, 255, 255, 0.1);
            --button-hover-bg: rgba(255, 255, 255, 0.2);

            /* MOBILE 2.0 THEME VARIABLES */
            /* Gallium Pearl (Light Mode Default) */
            --m2-bg-blur: rgba(226, 232, 240, 0.5);
            --m2-gallium-base: #cfd8e3;
            --m2-gallium-reflect: #f1f5f9;
            --m2-gallium-shadow: rgba(148, 163, 184, 0.25);
            --m2-text-primary: #334155;
            --m2-text-mono: #64748b;
            --m2-accent-glow: rgba(37, 99, 235, 0.2);
            --m2-status-off: #94a3b8;
            --m2-status-on: #10b981;
            --m2-btn-bg: rgba(255, 255, 255, 0.5);
            --m2-surface-edge: rgba(255, 255, 255, 0.6);
            --m2-transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            --m2-card-radius: 28px;
        }

        /* MOBILE 2.0 DARK MODE */
        [data-theme="dark"] {
            /* Liquid Onyx */
            --m2-bg-blur: rgba(15, 23, 42, 0.7);
            --m2-gallium-base: #0f172a;
            --m2-gallium-reflect: #1e293b;
            --m2-gallium-shadow: rgba(0, 0, 0, 0.4);
            --m2-text-primary: #f1f5f9;
            --m2-text-mono: #94a3b8;
            --m2-accent-glow: rgba(96, 165, 250, 0.25);
            --m2-status-off: #334155;
            --m2-status-on: #34d399;
            --m2-btn-bg: rgba(30, 41, 59, 0.6);
            --m2-surface-edge: rgba(255, 255, 255, 0.05);
        }

        /* Base Resets */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* SVG Blob Background */
        .gallium-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            filter: url('#gooey');
            overflow: hidden;
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
            opacity: 0.6;
            animation: move-fluid 20s infinite alternate;
        }

        .blob-1 {
            background: #4b5563;
            width: 400px;
            height: 400px;
            top: -50px;
            left: -50px;
            animation-duration: 25s;
        }

        .blob-2 {
            background: #374151;
            width: 300px;
            height: 300px;
            bottom: 10%;
            right: 10%;
            animation-duration: 18s;
            animation-delay: -5s;
        }

        .blob-3 {
            background: #cbd5e1;
            width: 150px;
            height: 150px;
            top: 40%;
            left: 40%;
            opacity: 0.3;
            animation-duration: 15s;
            animation-delay: -2s;
        }

        @keyframes move-fluid {
            0% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(50px, -50px) scale(1.1);
            }

            66% {
                transform: translate(-30px, 40px) scale(0.9);
            }

            100% {
                transform: translate(20px, 20px) scale(1);
            }
        }

        /* Glassmorphism Generic Class */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        /* Main App Layout */
        .container {
            position: relative;
            z-index: 10;
            display: flex;
            flex: 1;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 65px);
            /* Header offset */
        }

        /* Header */
        .header {
            position: relative;
            z-index: 20;
            height: 65px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
            background: rgba(5, 5, 7, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
        }

        .app-title {
            font-family: var(--font-main);
            font-weight: 800;
            font-size: 1.5rem;
            letter-spacing: -0.05em;
            text-transform: uppercase;
        }

        /* Terminals and Panels Overwrite */
        .terminal {
            @apply glass-panel;
            /* Pseudo-code, actually applied via class or var */
            background: var(--glass-bg) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid var(--glass-border) !important;
            border-radius: 12px;
        }

        /* Login Modal - Gallium Hero Layout */
        #login-modal {
            background: transparent !important;
            /* Let body bg show */
            display: flex;
            /* Flex to center/stretch */
            align-items: center;
            justify-content: center;
        }

        .gallium-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            width: 100%;
            max-width: 1400px;
            height: 90vh;
            padding: 2rem;
            gap: 4rem;
            align-items: center;
        }

        .hero-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .hero-title {
            font-size: 5rem;
            font-weight: 800;
            line-height: 0.95;
            letter-spacing: -0.03em;
            margin-bottom: 1.5rem;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-subtitle {
            font-family: var(--font-code);
            color: var(--accent-color);
            font-size: 0.9rem;
            max-width: 400px;
            line-height: 1.6;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 3rem;
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        /* Inputs Gallium Style */
        .input-group {
            position: relative;
            margin-bottom: 1rem;
        }

        .gallium-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 0;
            color: white;
            font-family: var(--font-code);
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }

        .gallium-input:focus {
            border-bottom-color: var(--highlight-color);
        }

        /* Fluid Underline Animation */
        .input-underline {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--highlight-color);
            transition: all 0.4s var(--transition-fluid);
            transform: translateX(-50%);
        }

        .gallium-input:focus~.input-underline {
            width: 100%;
        }

        /* Buttons */
        .gallium-btn {
            position: relative;
            background: white;
            color: black;
            font-family: var(--font-main);
            font-weight: 700;
            text-transform: uppercase;
            padding: 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.2s;
        }

        /* Floating Label Logic */
        .gallium-input:focus~label,
        .gallium-input:not(:placeholder-shown)~label {
            top: -12px !important;
            font-size: 0.65rem !important;
            color: var(--gallium-bright) !important;
        }

        /* Ensure Inputs have transparent bg */
        .gallium-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            padding: 8px 0;
            color: white;
            font-family: var(--font-ui);
            outline: none;
        }

        .gallium-btn:hover {
            transform: translateY(-2px);
        }

        .gallium-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
            transition: 0.5s;
        }

        .gallium-btn:hover::after {
            left: 100%;
        }

        /* Meta Layer in Footer */
        .meta-layer {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-family: var(--font-code);
            font-size: 0.7rem;
            color: var(--text-muted);
            z-index: 5;
            display: flex;
            gap: 20px;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .gallium-layout {
                grid-template-columns: 1fr;
                gap: 2rem;
                justify-content: center;
            }

            .hero-section {
                display: none;
                /* Hide hero on mobile to focus on login */
            }
        }

        /* Restoring functional classes with new styles */
        .hidden {
            display: none !important;
        }

        /* Click Ripple */
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            background-color: rgba(255, 255, 255, 0.4);
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Ensure Modals sit on top */
        .modal {
            z-index: 50;
        }

        /* Gallium Animations & Styles */
        .gallium-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            filter: url('#gooey');
            z-index: 0;
            /* Behind everything by default */
            pointer-events: none;
            /* Let clicks pass through */
            position: fixed;
            /* Fix to viewport */
        }

        .blob {
            position: absolute;
            background: linear-gradient(135deg, var(--gallium-bright), var(--gallium-shadow));
            border-radius: 50%;
            opacity: 0.7;
            animation: move-fluid 20s infinite alternate var(--transition-fluid);
        }

        .blob-1 {
            width: 400px;
            height: 400px;
            top: -100px;
            left: -100px;
            animation-duration: 25s;
        }

        .blob-2 {
            width: 300px;
            height: 300px;
            bottom: -50px;
            right: 10%;
            animation-duration: 18s;
            animation-delay: -2s;
        }

        .blob-3 {
            width: 150px;
            height: 150px;
            top: 40%;
            left: 60%;
            animation-duration: 12s;
            background: var(--gallium-bright);
            opacity: 0.4;
        }

        @keyframes move-fluid {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }

            33% {
                transform: translate(10vw, 20vh) scale(1.1) rotate(120deg);
            }

            66% {
                transform: translate(-5vw, 10vh) scale(0.9) rotate(240deg);
            }

            100% {
                transform: translate(0, 0) scale(1) rotate(360deg);
            }
        }

        /* Updated Login Modal Styles */
        /* Updated Login Modal Styles */
        #login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            /* High z-index to cover header/footer */
            /* High z-index to cover header/footer */
            background: rgba(5, 5, 7, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            /* Opaque background with blur */
            overflow: hidden;
            padding: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #login-modal .login-frame {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 1100px;
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 2rem;
            /* Reduced from 4rem */
            padding: 2rem;
        }

        #login-modal .hero-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #login-modal .hero-title {
            font-size: 9rem;
            /* Increased by 80% from 5rem */
            font-weight: 800;
            line-height: 0.9;
            color: var(--gallium-bright);
            letter-spacing: -0.04em;
            text-transform: uppercase;
            margin-bottom: 2rem;
            pointer-events: none;
        }

        #login-modal .hero-section .data-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            letter-spacing: 0.2em;
            color: var(--accent);
            opacity: 0.6;
            margin-bottom: 0.5rem;
        }

        #login-modal .form-container {
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 3.5rem;
            border-radius: 2px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: form-reveal 1.2s var(--transition-fluid);
        }

        @keyframes form-reveal {
            from {
                opacity: 0;
                transform: translateY(30px) skewY(2deg);
            }

            to {
                opacity: 1;
                transform: translateY(0) skewY(0deg);
            }
        }

        @media (max-width: 900px) {
            #login-modal .login-frame {
                grid-template-columns: 1fr;
                gap: 2rem;
                padding: 1.5rem;
                max-width: 500px;
            }

            #login-modal .hero-section h1 {
                font-size: 3rem;
            }

            #login-modal .hero-section {
                text-align: center;
                margin-bottom: 2rem;
                align-items: center;
            }

            #login-modal {
                overflow-y: auto;
                align-items: flex-start;
                padding-top: 5vh !important;
                padding-bottom: 5vh !important;
            }

            #login-modal .form-container {
                padding: 2rem;
            }
        }

        #login-modal .input-group {
            position: relative;
            margin-bottom: 2.5rem;
        }

        #login-modal .input-group label {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
            color: var(--accent);
            opacity: 0.8;
            text-align: left;
        }

        #login-modal .input-field {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--gallium-bright);
            font-family: 'Outfit', sans-serif;
            /* Might need to import Outfit or fallback */
            font-size: 1.1rem;
            padding: 0.5rem 0;
            outline: none;
            transition: all 0.4s ease;
        }

        #login-modal .input-field:focus {
            border-bottom-color: var(--gallium-bright);
        }

        #login-modal .input-underline {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--gallium-bright), transparent);
            transition: width 0.6s var(--transition-fluid);
        }

        #login-modal .input-field:focus+.input-underline {
            width: 100%;
        }

        #login-modal .submit-btn {
            position: relative;
            width: 100%;
            padding: 1.25rem;
            background: var(--gallium-bright);
            color: #000;
            border: none;
            font-family: 'Outfit', sans-serif;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        #login-modal .submit-btn:hover {
            transform: translateY(-2px);
        }

        #login-modal .submit-btn:active {
            transform: translateY(1px);
        }

        #login-modal .btn-fluid {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.1), transparent);
            transition: left 0.5s ease;
        }

        #login-modal .hero-subtitle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.35rem;
            /* Increased from ~0.75rem */
            letter-spacing: 0.2em;
            color: var(--accent);
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        #login-modal .hero-subtitle-text {
            color: white;
            font-size: 0.9rem;
            /* Reduced by ~30% from inherited 1.35rem */
            opacity: 0.8;
            display: block;
            margin-top: 10px;
            transition: color 0.3s ease;
        }

        #login-modal .submit-btn:hover .btn-fluid {
            left: 100%;
        }

        #login-modal .footer-links {
            margin-top: 2rem;
            display: flex;
            justify-content: space-between;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
        }

        #login-modal .footer-links a {
            color: var(--accent);
            text-decoration: none;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        #login-modal .footer-links a:hover {
            opacity: 1;
        }

        #login-modal .meta-layer {
            position: absolute;
            bottom: 2rem;
            left: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.2);
            pointer-events: none;
        }

        @media (max-width: 900px) {
            #login-modal .login-frame {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            #login-modal .hero-section {
                display: none;
            }

            #login-modal .form-container {
                width: 100%;
                max-width: 400px;
                margin: 0 auto;
            }
        }


        body.light-mode {
            --bg-gradient: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            --glass-bg: rgba(255, 255, 255, 0.5);
            --glass-border: rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(100, 100, 100, 0.2);
            --text-color: #2d3748;
            --header-text-color: #1a202c;
            --prompt-color: #2b6cb0;
            --command-color: #2c5282;
            --output-color: #2d3748;
            --error-color: #c53030;
            --success-color: #2f855a;
            --border-color: rgba(0, 0, 0, 0.1);
            --highlight-color: #3182ce;
            --highlight-text-color: #ffffff;
            --diagnosis-color: #805ad5;
            --conduct-color: #2f855a;
            --altered-color: #d69e2e;
            --input-bg: rgba(0, 0, 0, 0.05);
            --terminal-header-bg: rgba(0, 0, 0, 0.05);
            --button-bg: rgba(0, 0, 0, 0.05);
            --button-hover-bg: rgba(0, 0, 0, 0.1);
            --free-mode-bg: #f7f9fc;

            /* Light Mode Login Modal Overrides */
            --gallium-bright: #3182ce;
        }

        body.light-mode #login-modal {
            background: rgba(200, 220, 240, 0.6);
            /* Darker/More visible background */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        body.light-mode #login-modal .hero-title {
            background: linear-gradient(135deg, #1a202c 0%, #4a5568 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: #1a202c;
            /* Fallback */
            text-shadow: none !important;
        }

        body.light-mode #login-modal .hero-subtitle,
        body.light-mode #login-modal .hero-subtitle-text {
            background: linear-gradient(135deg, #2d3748 0%, #718096 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: #2d3748;
            /* Fallback */
            opacity: 1 !important;
        }

        body.light-mode #login-modal .login-container {
            background: rgba(255, 255, 255, 0.5) !important;
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.05);
            color: #2d3748 !important;
        }

        body.light-mode #login-modal .meta-layer,
        body.light-mode #login-modal .meta-layer span,
        body.light-mode #login-modal #login-modal-feedback {
            color: #4a5568 !important;
            opacity: 1 !important;
        }

        body.light-mode .blob {
            background: linear-gradient(135deg, #cbd5e0, #a0aec0);
            opacity: 0.6;
        }

        body.light-mode #login-modal input {
            color: #1a202c !important;
            border-bottom-color: #a0aec0 !important;
        }

        body.light-mode #login-modal label {
            color: #4a5568 !important;
        }

        body.light-mode #login-modal #login-modal-button,
        body.light-mode #login-modal .gallium-btn {
            background-color: #000000 !important;
            color: #ffffff !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        body.light-mode .terminal-logo-internal {
            filter: invert(1);
            opacity: 0.15;
            /* Slightly increase opacity for better visibility */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Consolas, 'Courier New', monospace;
            touch-action: manipulation;
            user-select: none;
            /* Disable text selection for native app feel */
            -webkit-user-select: none;
        }

        /* Allow selection in inputs and editable areas */
        input,
        textarea,
        [contenteditable] {
            user-select: text;
            -webkit-user-select: text;
        }

        body {
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background .5s ease, color .5s ease
        }

        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 12px 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            height: 65px;
            flex-shrink: 0
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .logout-button,
        .settings-button,
        .theme-toggle {
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            transition: color .3s ease, transform .2s ease, background-color .3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%
        }

        .logout-button:hover,
        .settings-button:hover,
        .theme-toggle:hover {
            color: var(--highlight-color);
            background-color: var(--button-hover-bg);
            transform: scale(1.1)
        }

        .logout-button:hover {
            background-color: var(--error-color) !important;
            color: #ffffff !important;
        }

        .app-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--header-text-color);
            text-shadow: 0 1px 2px rgba(0, 0, 0, .1)
        }

        /* --- Status Diffusion --- */
        .status-hub {
            display: flex;
            gap: 25px;
            padding: 0 30px;
            border-left: 1px solid var(--surface-edge);
            margin: 0 15px;
        }

        .status-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .indicator-liquid {
            width: 20px;
            height: 5px;
            border-radius: 3px;
            background: var(--gallium-base);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .indicator-liquid.on,
        .indicator-liquid.status-on {
            background: var(--success);
            box-shadow: 0 0 15px var(--success);
        }

        .status-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            height: calc(100vh - 65px - 40px);
            min-height: 0
        }

        .terminal {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--glass-shadow);
            position: relative
        }

        .terminal-header {
            padding: 8px 12px;
            background-color: var(--terminal-header-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .terminal-title {
            font-size: 14px;
            font-weight: 700
        }

        .terminal-actions {
            display: flex;
            gap: 8px
        }

        .terminal-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%
        }

        .close-btn {
            background-color: #ff5f56
        }

        .minimize-btn {
            background-color: #ffbd2e
        }

        .maximize-btn {
            background-color: #27c93f
        }

        .terminal-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .terminal-content::-webkit-scrollbar {
            width: 8px
        }

        .terminal-content::-webkit-scrollbar-track {
            background: 0 0
        }

        .terminal-content::-webkit-scrollbar-thumb {
            background-color: var(--button-hover-bg);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box
        }

        .terminal-content::-webkit-scrollbar-thumb:hover {
            background-color: var(--highlight-color)
        }

        .interactive-terminal,
        .non-interactive-terminal {
            flex: 1;
            min-width: 300px;
            min-height: 0
        }

        .input-line {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .prompt {
            color: var(--prompt-color);
            white-space: nowrap
        }

        .command-input {
            background: 0 0;
            border: none;
            color: var(--command-color);
            width: 100%;
            font-size: 16px;
            caret-color: var(--command-color);
            outline: 0;
            padding: 2px 0
        }

        .command-output {
            color: var(--output-color);
            white-space: pre-wrap;
            line-height: 1.5;
            text-align: left
        }

        .command {
            color: var(--command-color);
            font-weight: 700
        }

        .error {
            color: var(--error-color)
        }

        .success {
            color: var(--success-color)
        }

        .technical-log {
            opacity: 0.7;
            font-size: 0.9em;
            border-left: 2px solid var(--border-color);
            padding-left: 5px;
            margin: 2px 0;
        }

        .hide-technical-logs .technical-log {
            display: none !important;
        }

        .info {
            color: var(--prompt-color)
        }

        .highlight {
            color: var(--highlight-color)
        }

        .blocked-msg {
            color: var(--altered-color)
        }

        .anamnesis-content {
            line-height: 1.8;
            font-size: 15px
        }

        .section-title {
            font-weight: 700;
            margin-top: 10px;
            color: var(--highlight-color)
        }

        .help-list {
            padding-left: 0;
            margin: 10px 0;
            line-height: 1.8;
            list-style: none
        }

        .help-item {
            margin-bottom: 5px
        }

        .diagnosis-item {
            color: var(--diagnosis-color);
            margin-bottom: 8px;
            padding-left: 15px;
            position: relative
        }

        .diagnosis-item:before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: var(--diagnosis-color)
        }

        .conduct-section {
            margin-bottom: 15px
        }

        .conduct-title:hover {
            color: var(--highlight-color);
            background: rgba(var(--highlight-color-rgb), 0.1);
            /* Highlight effect */
            border-bottom-color: var(--highlight-color)
        }

        /* Persistent Highlight Logic if requested for ALL conduct titles by default? 
           User said: "Adicione um highlith em todo o conduct-title destacando o dos demais textos."
           This implies it should always be highlighted, not just on hover. */
        .conduct-title {
            color: var(--conduct-color);
            font-weight: 800;
            /* Bolder */
            margin-bottom: 5px;
            border-bottom: 2px solid var(--conduct-color);
            /* Thicker border */
            padding-bottom: 3px;
            cursor: pointer;
            transition: color .2s, border-bottom-color .2s;
            text-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
            /* Slight shadow for pop */
        }

        .conduct-item {
            margin-bottom: 8px;
            padding-left: 15px;
            position: relative
        }

        .conduct-item:before {
            content: "-";
            position: absolute;
            left: 0
        }

        .receituario-item {
            white-space: pre;
            font-family: 'Courier New', monospace;
            color: var(--output-color);
            margin-bottom: 5px
        }

        .footer {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 10px 20px;
            border-top: 1px solid var(--glass-border);
            text-align: center;
            font-size: 12px;
            color: var(--text-color);
            height: 40px;
            flex-shrink: 0
        }

        .terminal-logo-internal {
            position: absolute;
            top: 15px;
            right: 15px;
            height: calc(105.3px * 1.8 * .7 * 1.2);
            width: auto;
            opacity: .1;
            z-index: 0
        }

        .monitor-view {
            text-transform: uppercase;
            height: 100%
        }

        .monitor-view .axon-eye-title,
        .monitor-view .conduct-title,
        .monitor-view .section-title {
            text-transform: none
        }

        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            z-index: 100;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 0
        }

        .camera-container {
            display: flex;
            flex-direction: column;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            position: relative;
            z-index: 1;
            padding: 0;
            gap: 10px;
            overflow: hidden;
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none
        }

        .camera-video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 177.77%;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0
        }

        .camera-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .camera-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            z-index: 2;
            width: 90%
        }

        .camera-button {
            background-color: rgba(0, 0, 0, .5);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, .2);
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: background-color .3s ease, transform .2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            flex-shrink: 0;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px)
        }

        .camera-button:hover {
            background-color: var(--highlight-color);
            transform: scale(1.05)
        }

        .camera-button.disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: .7
        }

        .album-button,
        .camera-action-buttons {
            position: absolute;
            top: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
            background-color: rgba(0, 0, 0, .4);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 5px 10px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px)
        }

        .album-button {
            left: 10px
        }

        .camera-action-buttons {
            right: 10px
        }

        .camera-switch-button,
        .flashlight-button {
            background-color: transparent;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 12px;
            transition: color .2s
        }

        .album-button:hover,
        .camera-switch-button:hover,
        .flashlight-button:hover {
            color: var(--highlight-color)
        }

        .flashlight-button.active {
            color: var(--highlight-color)
        }

        .album-count {
            background-color: var(--highlight-color);
            color: var(--highlight-text-color);
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center
        }

        .monitor-toggle-buttons {
            display: flex;
            gap: 5px;
            margin-left: auto;
            margin-right: 10px
        }

        .monitor-toggle-button {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all .3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px
        }

        .monitor-toggle-button:hover {
            background-color: var(--button-hover-bg)
        }

        .monitor-toggle-button.active {
            background-color: var(--highlight-color);
            color: var(--highlight-text-color);
            border-color: transparent
        }

        #monitor-content-wrapper {
            position: relative
        }

        .monitor-copy-btn {
            position: absolute;
            top: 50px;
            right: 25px;
            background: var(--button-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all .3s ease;
            z-index: 5
        }

        .monitor-copy-btn:hover {
            background-color: var(--highlight-color);
            color: var(--highlight-text-color)
        }

        .fullscreen-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, .9)
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
            border-radius: 10px
        }

        #caption,
        .modal-content {
            animation-name: zoom;
            animation-duration: .6s
        }

        @keyframes zoom {
            from {
                transform: scale(0)
            }

            to {
                transform: scale(1)
            }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: 700;
            transition: .3s
        }

        .modal-close:focus,
        .modal-close:hover {
            color: #bbb;
            text-decoration: none;
            cursor: pointer
        }

        .output .altered-text {
            color: var(--altered-color);
            font-weight: 700;
            margin-left: 10px
        }

        .album-modal,
        .app-modal,
        .patient-details-modal,
        .patient-list-modal {
            display: none;
            position: fixed;
            z-index: 105;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, .5);
            justify-content: center;
            align-items: center
        }

        .album-modal-content,
        .app-modal-content,
        .patient-details-content,
        .patient-list-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            margin: auto;
            padding: 25px;
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--glass-shadow);
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 90vh
        }

        .app-modal-body {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            /* Prevent scrollbar overlap */
        }

        .album-modal-content,
        .patient-details-content,
        .patient-list-content {
            max-width: 800px
        }

        .album-modal-header,
        .app-modal-header,
        .patient-details-header,
        .patient-list-header {
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px
        }

        .album-modal-title,
        .app-modal-title,
        .patient-details-title,
        .patient-list-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--prompt-color)
        }

        .album-modal-close,
        .app-modal-close,
        .patient-details-close,
        .patient-list-close {
            color: var(--text-color);
            font-size: 28px;
            font-weight: 700;
            cursor: pointer;
            transition: .3s;
            position: absolute;
            top: 15px;
            right: 20px
        }

        .album-modal-close:hover,
        .app-modal-close:hover,
        .patient-details-close:hover,
        .patient-list-close:hover {
            color: var(--highlight-color)
        }

        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            overflow-y: auto;
            padding-right: 5px
        }

        .album-item {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            overflow: hidden;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: transform .2s ease
        }

        .album-item:hover {
            transform: scale(1.03)
        }

        .album-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block
        }

        .album-delete-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, .7);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: background-color .2s
        }

        .album-delete-button:hover {
            background-color: rgba(255, 0, 0, 1)
        }

        .axon-eye-title {
            color: var(--error-color);
            font-weight: 700;
            margin-top: 10px;
            margin-bottom: 5px;
            border-bottom: 1px solid var(--error-color);
            padding-bottom: 3px
        }

        .axon-eye-image-preview {
            max-width: 100%;
            height: auto;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px
        }

        .patient-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            max-height: 400px
        }

        .patient-item {
            padding: 12px;
            background-color: var(--button-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: background-color .2s
        }

        .patient-item:hover {
            background-color: var(--button-hover-bg)
        }

        .patient-details-body {
            overflow-y: auto;
            padding-right: 5px
        }

        .patient-details-section {
            margin-bottom: 20px
        }

        .patient-details-section-title {
            font-weight: 700;
            color: var(--highlight-color);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px
        }

        .patient-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px
        }

        .patient-image-item {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            overflow: hidden;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer
        }

        .patient-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block
        }

        .consultation-item {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden
        }

        .consultation-header {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color .2s
        }

        .consultation-header:hover {
            background-color: var(--button-hover-bg)
        }

        .consultation-body {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: transparent
        }

        .patient-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px
        }

        .patient-action-button {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all .3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex: 1
        }

        .patient-action-button.disabled {
            background-color: var(--input-bg);
            color: var(--text-color);
            cursor: not-allowed;
            opacity: .5
        }

        .patient-action-button:not(.disabled):hover {
            background-color: var(--button-hover-bg)
        }

        .patient-action-button.delete:not(.disabled) {
            color: var(--error-color)
        }

        .patient-action-button.delete:not(.disabled):hover {
            background-color: var(--error-color);
            color: #fff
        }

        .patient-action-button.pdf:not(.disabled) {
            color: var(--success-color)
        }

        .patient-action-button.pdf:not(.disabled):hover {
            background-color: var(--success-color);
            color: #fff
        }

        .patient-action-button.details:not(.disabled) {
            color: var(--prompt-color)
        }

        .patient-action-button.details:not(.disabled):hover {
            background-color: var(--prompt-color);
            color: #fff
        }

        .patient-search-container {
            margin-bottom: 15px
        }

        .patient-search-input {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px
        }

        .patient-search-input:focus {
            outline: 0;
            border-color: var(--highlight-color)
        }

        .terminal-footer {
            padding: 8px 15px;
            border-top: 1px solid var(--border-color);
            background-color: var(--terminal-header-bg)
        }

        .action-buttons-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px
        }

        .action-button {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all .2s, transform .1s
        }

        .action-button:focus,
        .action-button:hover {
            background-color: var(--highlight-color);
            color: var(--highlight-text-color);
            outline: 0
        }

        .action-button:active {
            transform: scale(.95)
        }

        .action-button.active {
            background-color: var(--success-color);
            color: var(--highlight-text-color);
            box-shadow: 0 0 8px var(--success-color)
        }

        .action-button.blocked-ui {
            opacity: .4;
            cursor: not-allowed
        }

        .app-modal-body p {
            margin-bottom: 20px;
            color: var(--text-color)
        }

        .app-modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px
        }

        .app-modal-input:focus {
            outline: 0;
            border-color: var(--highlight-color)
        }

        .app-modal-button {
            width: 100%;
            padding: 12px;
            background-color: var(--highlight-color);
            color: var(--highlight-text-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: background-color .3s ease
        }

        body.light-mode .app-modal-button:hover {
            background-color: #2b6cb0
        }

        body:not(.light-mode) .app-modal-button:hover {
            background-color: #63b3ed
        }

        .app-modal-button:disabled {
            background-color: #555;
            cursor: not-allowed
        }

        .app-modal-feedback {
            margin-top: 15px;
            color: var(--error-color);
            min-height: 20px
        }

        .admin-section {
            margin-bottom: 20px;
            text-align: left;
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 10px
        }

        .admin-section-title {
            color: var(--prompt-color);
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase
        }

        .admin-list {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .admin-list-item {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .admin-input-group {
            flex: 1;
            display: flex;
            gap: 5px
        }

        .admin-input {
            flex: 1;
            padding: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 12px
        }

        .admin-action-btn,
        .admin-btn-add,
        .admin-btn-remove {
            border-radius: 8px
        }

        #admin-panel-modal .app-modal-content {
            max-width: 900px;
            width: 95%;
            height: 85vh;
            display: flex;
            flex-direction: column
        }

        .admin-tab-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 15px;
            display: flex;
            flex-direction: column
        }

        .admin-users-container {
            display: flex;
            flex: 1;
            min-height: 0;
            gap: 20px;
            text-align: left;
            overflow: hidden
        }

        .admin-users-list-section {
            flex: 1;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding-right: 10px
        }

        .admin-users-details-section {
            flex: 2;
            overflow-y: auto;
            padding-left: 10px
        }

        .user-list-scroll {
            overflow-y: auto;
            flex: 1
        }

        .user-list-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color .2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
            margin-bottom: 5px
        }

        .user-list-item:hover {
            background-color: var(--button-hover-bg)
        }

        .user-list-item.selected {
            background-color: rgba(66, 153, 225, .2);
            border-left: 3px solid var(--highlight-color)
        }

        .user-detail-header {
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px
        }

        .user-detail-row {
            margin-bottom: 10px
        }

        .user-detail-label {
            color: var(--prompt-color);
            font-weight: 700;
            font-size: 12px;
            display: block;
            margin-bottom: 2px
        }

        .user-detail-value {
            color: var(--text-color);
            font-size: 14px
        }

        .admin-user-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px
        }

        .admin-user-img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: transform .2s
        }

        .admin-user-img:hover {
            transform: scale(1.05)
        }

        .usage-stats-box {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px
        }

        .admin-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px
        }

        .admin-tab-btn {
            flex: 1;
            background: 0 0;
            border: none;
            color: var(--text-color);
            padding: 10px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 14px;
            transition: all .3s ease
        }

        .admin-tab-btn:hover {
            background-color: var(--button-hover-bg)
        }

        .admin-tab-btn.active {
            border-bottom-color: var(--highlight-color);
            color: var(--highlight-color);
            font-weight: 700
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer
        }

        .ai-processing-animation {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--prompt-color)
        }

        .scanner-animation {
            width: 100px;
            height: 100px;
            position: relative;
            margin-bottom: 15px
        }

        .scanner-animation .brain-icon {
            width: 100%;
            height: 100%;
            font-size: 80px;
            line-height: 100px;
            text-align: center;
            opacity: .5
        }

        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--highlight-color);
            box-shadow: 0 0 10px var(--highlight-color);
            border-radius: 2px;
            animation: scan 2.5s infinite linear
        }

        @keyframes scan {
            0% {
                top: 0
            }

            50% {
                top: 100%
            }

            100% {
                top: 0
            }
        }

        .prescription-template-item {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px
        }

        .prescription-template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px
        }

        .prescription-template-title {
            font-weight: 700;
            color: var(--prompt-color)
        }

        .prescription-template-copy-btn {
            background-color: var(--button-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all .2s
        }

        .prescription-template-copy-btn:hover {
            background-color: var(--highlight-color);
            color: var(--highlight-text-color)
        }

        .prescription-template-text {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: var(--output-color);
            background: rgba(0, 0, 0, .1);
            padding: 10px;
            border-radius: 5px
        }

        /* Mobile 2.0 New Layout */
        .mobile-2-0-container {
            width: 100%;
            max-width: 440px;
            background: var(--m2-bg-blur);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid var(--m2-surface-edge);
            border-radius: 48px;
            padding: 32px;
            box-shadow: 0 40px 100px -20px var(--m2-gallium-shadow),
                inset 0 2px 5px var(--m2-surface-edge);
            position: relative;
            animation: containerReveal 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes containerReveal {
            0% {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Header Style */
        .mobile-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .mobile-header h2 {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1.5px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--m2-text-primary) 30%, var(--m2-text-mono));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .mobile-header p {
            font-size: 14px;
            color: var(--m2-text-mono);
            font-weight: 400;
        }

        /* Banner Style - Diffusion Vitreous */
        .info-banner {
            background: var(--m2-btn-bg);
            border: 1px solid var(--m2-surface-edge);
            border-radius: 24px;
            padding: 16px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .chat-bubble-info {
            display: flex;
            gap: 12px;
            font-size: 13px;
            line-height: 1.5;
            color: var(--m2-text-primary);
            position: relative;
            z-index: 1;
            /* Reset previous styles if any */
            background: none;
            backdrop-filter: none;
            box-shadow: none;
            border: none;
            animation: none;
        }

        .chat-bubble-info i {
            color: #3b82f6;
            font-size: 16px;
            margin-top: 2px;
        }

        .highlight-link {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 600;
            margin-left: 4px;
            border-bottom: 1px solid transparent;
            transition: var(--m2-transition);
        }

        .highlight-link:hover {
            border-color: #3b82f6;
            opacity: 0.8;
        }

        /* Grid System - Fluid Pods */
        .mobile-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 35px;
            width: 100%;
            max-width: none;
        }

        .mobile-btn {
            background: var(--m2-btn-bg);
            border: 1px solid var(--m2-surface-edge);
            border-radius: var(--m2-card-radius);
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            cursor: pointer;
            transition: var(--m2-transition);
            box-shadow: 0 4px 15px var(--m2-gallium-shadow);
            position: relative;
            overflow: hidden;
            aspect-ratio: auto;
        }

        .mobile-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            pointer-events: none;
        }

        .mobile-btn i {
            font-size: 28px;
            color: var(--m2-text-primary);
            transition: var(--m2-transition);
        }

        .mobile-btn span {
            font-size: 13px;
            font-weight: 600;
            color: var(--m2-text-primary);
            text-align: center;
        }

        .mobile-btn:hover {
            transform: translateY(-5px) scale(1.02);
            background: var(--m2-gallium-reflect);
            box-shadow: 0 15px 30px var(--m2-gallium-shadow);
            border-color: #3b82f644;
        }

        .mobile-btn:hover i {
            transform: scale(1.1);
            color: #3b82f6;
        }

        /* Connection Status Hub */
        .mobile-connection-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid var(--m2-surface-edge);
            /* Reset old styles */
            justify-content: flex-start;
            margin-top: 0;
            padding-bottom: 0;
            opacity: 1;
            font-size: inherit;
            color: inherit;
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--m2-btn-bg);
            border-radius: 20px;
            border: 1px solid var(--m2-surface-edge);
            font-size: 12px;
            font-weight: 500;
            color: var(--m2-text-primary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--m2-status-off);
            box-shadow: 0 0 0 4px rgba(148, 163, 184, 0.1);
            position: relative;
            transition: none;
            /* override old transition if needed */
        }

        .status-dot.active {
            background: var(--m2-status-on);
            box-shadow: 0 0 12px var(--m2-status-on);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .logout-hint {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--m2-text-mono);
            text-align: center;
            max-width: 240px;
            line-height: 1.4;
            cursor: pointer;
            transition: var(--m2-transition);
        }

        .logout-hint:hover {
            color: #ef4444;
        }

        /* Theme Toggle Fixed */
        .theme-switcher {
            position: absolute;
            top: 25px;
            right: 25px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--m2-btn-bg);
            border: 1px solid var(--m2-surface-edge);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--m2-text-primary);
            transition: var(--m2-transition);
            z-index: 10;
        }

        .theme-switcher:hover {
            background: var(--m2-gallium-reflect);
            transform: rotate(15deg) scale(1.1);
        }

        /* Branding Dot */
        .axon-dot {
            position: absolute;
            top: 25px;
            left: 25px;
            font-weight: 800;
            font-size: 18px;
            letter-spacing: -1px;
            color: var(--m2-text-primary);
        }

        .axon-dot::after {
            content: '';
            display: inline-block;
            width: 5px;
            height: 5px;
            background: var(--m2-status-on);
            border-radius: 50%;
            margin-left: 2px;
        }

        .chatbox-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            z-index: 1000;
            flex-direction: column
        }

        .chatbox-header {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 12px 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--glass-border);
            height: 65px;
            flex-shrink: 0
        }

        .chatbox-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--header-text-color)
        }

        .chatbox-close-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            position: absolute;
            right: 20px
        }

        .chatbox-new-chat-btn {
            font-size: 22px;
            cursor: pointer;
            color: var(--text-color);
            position: absolute;
            left: 20px
        }

        .chatbox-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 15px 15px
        }

        .chat-message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            max-width: 85%
        }

        .chat-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
            animation: slideInFromRight .4s ease-out
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px)
            }

            to {
                opacity: 1;
                transform: translateX(0)
            }
        }

        .chat-message.model {
            align-self: flex-start;
            animation: fadeIn .5s ease
        }

        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--input-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0
        }

        .chat-message.user .chat-avatar {
            background-color: var(--highlight-color);
            color: var(--highlight-text-color)
        }

        .message-bubble {
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .1)
        }

        .message-bubble b {
            font-weight: 600
        }

        .chat-message.user .message-bubble {
            background-color: var(--highlight-color);
            color: var(--highlight-text-color);
            border-bottom-right-radius: 5px
        }

        .chat-message.model .message-bubble {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            border-bottom-left-radius: 5px
        }

        .message-bubble.typing {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 15px 18px
        }

        .message-bubble.typing .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-color);
            opacity: .7;
            animation: typing-blink 1.4s infinite both
        }

        .message-bubble.typing .dot:nth-child(2) {
            animation-delay: .2s
        }

        .message-bubble.typing .dot:nth-child(3) {
            animation-delay: .4s
        }

        @keyframes typing-blink {
            0% {
                opacity: .2
            }

            20% {
                opacity: 1
            }

            100% {
                opacity: .2
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .chatbox-input-area {
            padding: 10px 15px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .chat-input-row {
            display: flex;
            width: 100%;
            gap: 10px;
            align-items: center
        }

        .chatbox-input {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 12px 15px;
            color: var(--text-color);
            font-size: 16px
        }

        .chatbox-input:focus {
            outline: 0;
            border-color: var(--highlight-color)
        }

        .chatbox-send-btn,
        .chatbox-upload-btn {
            background-color: var(--highlight-color);
            color: var(--highlight-text-color);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: transform .2s;
            flex-shrink: 0
        }

        .chatbox-upload-btn {
            background-color: var(--button-bg);
            color: var(--text-color)
        }

        .chatbox-send-btn:active,
        .chatbox-upload-btn:active {
            transform: scale(.9)
        }

        .chat-image-previews {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            width: 100%;
            padding: 5px 0
        }

        .chat-preview-item {
            position: relative;
            flex-shrink: 0
        }

        .chat-preview-item img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--border-color)
        }

        .chat-preview-delete {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: rgba(255, 0, 0, .8);
            color: #fff;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer
        }

        .message-bubble .chat-image-attachment {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 10px;
            margin-top: 10px;
            display: block
        }

        .confirm-modal {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000000;
            /* Super high z-index to beat mobile container (999999) */
            backdrop-filter: blur(5px);
        }

        .confirm-modal-content {
            background: var(--m2-gallium-base);
            /* Adapts to theme */
            color: var(--m2-text-primary);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 35px 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            /* More rounded */
            width: 90%;
            max-width: 380px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            text-align: center;
            color: white;
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalPop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        #confirm-modal-text {
            margin-bottom: 30px;
            font-size: 17px;
            line-height: 1.5;
            color: var(--m2-text-primary);
            font-weight: 500;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.2s ease;
            flex: 1;
        }

        .confirm-btn:active {
            transform: scale(0.95);
        }

        #confirm-btn-yes {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
        }

        #confirm-btn-yes:hover {
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.6);
            transform: translateY(-2px);
        }

        #confirm-btn-no {
            background: var(--m2-btn-bg);
            color: var(--m2-text-primary);
            border: 1px solid var(--m2-surface-edge);
        }

        #confirm-btn-no:hover {
            filter: brightness(1.1);
            color: var(--m2-text-primary);
        }

        /* Fix for Button Overflow */
        .confirm-btn {
            min-width: 80px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 10px 15px;
        }

        .mobile-loader {
            display: none;
            position: fixed;
            z-index: 2500;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            justify-content: center;
            align-items: center
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--button-bg);
            transition: .4s;
            border-radius: 28px;
            border: 1px solid var(--border-color)
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 3px;
            background-color: #fff;
            transition: .4s;
            border-radius: 50%
        }

        input:checked+.slider {
            background-color: var(--highlight-color)
        }

        input:checked+.slider:before {
            transform: translateX(22px)
        }

        .transfer-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            color: var(--text-color);
            cursor: pointer;
            margin-bottom: 15px;
            transition: all .3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px
        }

        .transfer-drop-zone:hover,
        .transfer-drop-zone.dragover {
            border-color: var(--highlight-color);
            background-color: var(--button-bg)
        }

        .transfer-icon {
            font-size: 40px;
            color: var(--highlight-color);
            margin-bottom: 10px
        }

        .transfer-status {
            margin-top: 15px;
            text-align: center;
            font-size: 14px
        }

        .progress-bar-container {
            width: 100%;
            background-color: var(--input-bg);
            border-radius: 10px;
            height: 10px;
            margin-top: 10px;
            overflow: hidden
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: width .2s ease
        }

        .notification-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            padding: 15px;
            border-radius: 10px;
            z-index: 4000;
            display: none;
            flex-direction: column;
            gap: 5px;
            box-shadow: var(--glass-shadow);
            width: 300px;
            animation: slideInRight .3s ease-out
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%)
            }

            to {
                transform: translateX(0)
            }
        }

        .notification-popup.mobile-center {
            width: 80%;
            max-width: 300px
        }

        .progress-bar-fill.pro-mode {
            background-color: #4299e1;
            box-shadow: 0 0 10px #4299e1
        }

        /* Plugin System Styles */
        .plugin-modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0;
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            height: 80vh;
            box-shadow: var(--glass-shadow);
            position: relative;
            display: flex;
            flex-direction: column;
            margin: auto;
        }

        .plugin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
            overflow-y: auto;
        }

        .plugin-card {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.3s ease;
            position: relative;
        }

        .plugin-card:hover {
            transform: translateY(-2px);
            border-color: var(--highlight-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .plugin-icon-area {
            height: 60px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .plugin-icon-img {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
            background: var(--button-bg);
        }

        .plugin-info {
            flex: 1;
        }

        .plugin-name {
            font-weight: bold;
            font-size: 16px;
            color: var(--header-text-color);
            margin-bottom: 2px;
        }

        .plugin-author {
            font-size: 12px;
            opacity: 0.7;
        }

        .plugin-desc {
            font-size: 13px;
            opacity: 0.8;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 36px;
        }

        .plugin-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .plugin-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn-install {
            background: var(--button-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-install:hover {
            background: var(--highlight-color);
            color: white;
            border-color: transparent;
        }

        .btn-open-plugin {
            background: var(--success-color);
            color: white;
        }

        .btn-uninstall {
            background: transparent;
            color: var(--error-color);
            border: 1px solid var(--border-color);
            width: 30px;
            flex: 0 0 30px;
        }

        .btn-uninstall:hover {
            background: rgba(255, 0, 0, 0.1);
            border-color: var(--error-color);
        }

        /* Floating Window */
        .floating-plugin-window {
            position: fixed;
            top: 100px;
            left: 100px;
            width: 400px;
            height: 500px;
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 200px;
            min-height: 150px;
            resize: both;
        }

        .floating-header {
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: grab;
        }

        .floating-header:active {
            cursor: grabbing;
        }

        .floating-title {
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .floating-controls {
            display: flex;
            gap: 8px;
        }

        .float-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
        }

        .floating-content {
            flex: 1;
            position: relative;
            background: white;
            /* Plugins are usually white-bg designed */
        }

        body.dark-mode .floating-content {
            background: #1a202c;
            /* Or matching theme */
        }

        .floating-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
        }

        /* Axon Cloud Styles */
        .cloud-container {
            display: flex;
            height: 100%;
            gap: 10px;
            overflow: hidden;
        }

        .cloud-sidebar {
            width: 220px;
            background: var(--input-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 10px;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .cloud-sidebar-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background .2s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
            font-size: 14px;
        }

        .cloud-sidebar-item:hover,
        .cloud-sidebar-item.active {
            background: var(--button-hover-bg);
            color: var(--highlight-color);
        }

        .cloud-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }

        .cloud-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .cloud-breadcrumb {
            font-size: 14px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 2px;
        }

        .cloud-breadcrumb-item {
            cursor: pointer;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cloud-breadcrumb-item:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .cloud-content-area {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            position: relative;
        }

        .cloud-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 15px;
            padding-bottom: 20px;
            min-height: 100%;
            /* Ensure grid fills height for context menu */
            align-content: start;
        }

        .cloud-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px 10px;
            border-radius: 8px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all .2s;
            position: relative;
            background: var(--input-bg);
        }

        .cloud-item:hover {
            background: var(--button-hover-bg);
            border-color: var(--border-color);
            transform: translateY(-2px);
        }

        .cloud-item.selected {
            background: rgba(66, 153, 225, 0.2);
            border-color: var(--highlight-color);
        }

        .cloud-item-icon {
            font-size: 40px;
            color: var(--text-color);
        }

        .cloud-item[data-type="folder"] .cloud-item-icon {
            color: #ecc94b;
        }

        .cloud-item-name {
            font-size: 12px;
            text-align: center;
            word-break: break-word;
            max-width: 100%;
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
        }

        .cloud-upload-drop {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin-bottom: 10px;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            transition: all .2s;
            gap: 10px;
            background: rgba(0, 0, 0, 0.1);
        }

        .cloud-upload-drop:hover {
            border-color: var(--highlight-color);
            opacity: 1;
            color: var(--highlight-color);
            background: rgba(66, 153, 225, 0.1);
        }

        .storage-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: auto;
        }

        .storage-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--highlight-color), var(--success-color));
            width: 0%;
            transition: width 0.5s;
        }

        .storage-text {
            font-size: 11px;
            color: var(--text-color);
            opacity: 0.8;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }

        .context-menu {
            position: absolute;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 5px 0;
            z-index: 5000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            display: none;
            min-width: 150px;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-color);
            transition: background .2s;
        }

        .context-menu-item:hover {
            background: var(--highlight-color);
            color: #fff;
        }

        .context-menu-item i {
            width: 16px;
            text-align: center;
        }

        /* Custom Modals & Preview */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 6000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }

        .custom-modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--glass-shadow);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .custom-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--highlight-color);
        }

        .custom-modal-input {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            color: var(--text-color);
            width: 100%;
        }

        .custom-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .preview-modal {
            display: none;
            position: fixed;
            z-index: 7000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .preview-header {
            width: 100%;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .preview-title {
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70%;
        }

        .preview-content {
            max-width: 90%;
            max-height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .preview-content img,
        .preview-content video {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .preview-content iframe {
            width: 80vw;
            height: 80vh;
            border: none;
            background: white;
            border-radius: 8px;
        }

        /* Admin Axon Drive */
        .pinata-storage-container {
            background: var(--input-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .pinata-file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 10px;
        }

        .pinata-file-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .pinata-file-row:last-child {
            border-bottom: none;
        }

        .pinata-key-manager {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .key-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            word-break: break-all;
        }

        /* Custom Modals & Preview */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 6000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }

        .custom-modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--glass-shadow);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .custom-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--highlight-color);
        }

        .custom-modal-input {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            color: var(--text-color);
            width: 100%;
        }

        .custom-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .preview-modal {
            display: none;
            position: fixed;
            z-index: 7000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .preview-header {
            width: 100%;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .preview-title {
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70%;
        }

        .preview-content {
            max-width: 90%;
            max-height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .preview-content img,
        .preview-content video {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .preview-content iframe {
            width: 80vw;
            height: 80vh;
            border: none;
            background: white;
            border-radius: 8px;
        }

        /* Admin Axon Drive */
        .pinata-storage-container {
            background: var(--input-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .pinata-file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 10px;
        }

        .pinata-file-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .pinata-file-row:last-child {
            border-bottom: none;
        }

        .pinata-key-manager {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .key-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            word-break: break-all;
        }

        .pinata-debug-container {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .cloud-sidebar {
                display: none;
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                z-index: 100;
                box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
            }

            .cloud-sidebar.active {
                display: flex;
            }

            .cloud-container {
                position: relative;
            }

            .notification-popup.mobile-center {
                width: 90%;
                max-width: 400px;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                bottom: auto;
                right: auto;
                border-radius: 16px;
                padding: 25px;
            }
        }

        @media (max-width:768px) {
            .notification-popup {
                bottom: auto;
                top: 50%;
                left: 50%;
                right: auto;
                transform: translate(-50%, -50%);
                animation: fadeIn .3s ease-out;
                border-radius: 16px;
                padding: 20px
            }

            .notification-popup.mobile-center {
                width: 85%
            }

            .container {
                flex-direction: column-reverse;
                padding: 10px;
                gap: 10px
            }

            .monitor-toggle-button span,
            .status-bar span {
                display: none
            }

            .monitor-toggle-button {
                padding: 5px 8px;
                font-size: 16px;
                width: auto;
                min-width: 35px
            }

            .status-bar {
                gap: 10px;
                margin-right: 0
            }

            /* Empty ruleset removed */

            .logout-button,
            .settings-button,
            .theme-toggle {
                font-size: 18px
            }

            .camera-modal.fullscreen-mobile {
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 100;
                border-radius: 0
            }

            .camera-modal.fullscreen-mobile .camera-container {
                border-radius: 0;
                border: none
            }

            .radio-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px
            }

            .admin-users-container {
                flex-direction: column
            }

            .admin-users-list-section {
                flex: 0 0 45%;
                min-height: 220px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 15px;
                padding-right: 0
            }

            .admin-users-details-section {
                flex: 1;
                min-height: 0;
                padding-left: 0;
                padding-top: 15px
            }
        }

        @media (min-width:769px) {
            .camera-video-wrapper {
                padding-bottom: 56.25%
            }
        }

        /* FIX: Button Text Overflow */
        .custom-modal-actions .action-button,
        .confirm-modal-buttons .confirm-btn {
            width: auto !important;
            height: auto !important;
            padding: 10px 20px !important;
            border-radius: 8px !important;
            white-space: nowrap;
            min-width: 100px;
        }

        /* Text Editor Modal */
        .text-editor-modal {
            display: none;
            position: fixed;
            z-index: 8000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .text-editor-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: var(--glass-shadow);
        }

        .text-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .text-editor-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--highlight-color);
        }

        .text-editor-textarea {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: none;
            border-radius: 8px;
            outline: none;
            margin-bottom: 15px;
        }

        .text-editor-textarea:focus {
            border-color: var(--highlight-color);
        }



        /* Liquid Glass Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }



        /* Adjust main btn used in wrapper to have square right edges when wrapper is used? 
           Ideally, yes, but simpler to just slap it next to it. 
           Let's style the wrapper to visually group them. */

        /* Prescription Modal Styles - Compact & Scroll */
        .compact-input {
            padding: 8px !important;
            font-size: 13px !important;
            margin-bottom: 10px !important;
        }

        .prescription-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .prescription-result-container {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 15px;
            padding-right: 5px;
        }

        .prescription-suggestion-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            position: relative;
        }

        .prescription-suggestion-text {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-color);
        }

        .suggestion-copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--button-bg);
            border: 1px solid var(--border-color);
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
        }

        .suggestion-copy-btn:hover {
            background: var(--highlight-color);
            color: white;
        }

        /* Free Mode Styles */
        #free-mode-textarea {
            flex: 1;
            width: 100%;
            background: transparent;
            color: var(--success-color);
            /* Matches terminal aesthetic */
            border: none;
            outline: none;
            resize: none;
            padding: 15px;
            font-family: inherit;
            font-size: 16px;
            line-height: 1.5;
            overflow-y: auto;
        }

        #free-mode-textarea::placeholder {
            color: var(--text-color);
            opacity: 0.5;
        }

        /* Gallery Styles */
        .fullscreen-image-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            /* Important for zoom/pan */
            position: relative;
        }

        .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            transition: transform 0.1s ease;
            /* Smooth zoom */
            cursor: grab;
        }

        .modal-content.panning {
            cursor: grabbing;
            transition: none;
            /* No transition during drag */
        }

        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 15px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1001;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-arrow:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .nav-arrow.prev {
            left: 20px;
        }

        .nav-arrow.next {
            right: 20px;
        }

        .zoom-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 20px;
            z-index: 1001;
        }

        .zoom-controls button {
            background: transparent;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .zoom-controls button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* --- AXON LAYOUT INTEGRATION (VITREOUS DESIGN) --- */
        :root {
            /* Gallium Phase - Liquid Onyx (DEFAULT DARK) */
            --bg-color: #0f172a;
            --surface: rgba(30, 41, 59, 0.6);
            --surface-edge: rgba(255, 255, 255, 0.06);
            --gallium-base: #1e293b;
            --gallium-glow: rgba(96, 165, 250, 0.2);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #60a5fa;
            --success: #34d399;
            --danger: #fb7185;
            --terminal-bg: rgba(15, 23, 42, 0.6);
            --input-bg: rgba(30, 41, 59, 0.8);
            --shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
            --inner-reflect: inset 0 1px 1px rgba(255, 255, 255, 0.05);
            --transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        body.light-mode {
            /* Gallium Phase - Refined Light Mode (Muted/Vitreous) */
            --bg-color: #cfd8dc;
            --surface: rgba(248, 250, 252, 0.45);
            --surface-edge: rgba(255, 255, 255, 0.7);
            --gallium-base: #94a3b8;
            --gallium-glow: rgba(37, 99, 235, 0.15);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --accent: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --terminal-bg: rgba(255, 255, 255, 0.25);
            --input-bg: rgba(255, 255, 255, 0.5);
            --shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
            --inner-reflect: inset 0 2px 4px rgba(255, 255, 255, 0.8);
        }

        /* --- Vitreous Header --- */
        .header-wrap {
            padding: 20px 30px;
            display: flex;
            justify-content: center;
            z-index: 100;
            position: relative;
        }

        .axon-glass-header {
            width: 100%;
            max-width: 1600px;
            height: 84px;
            background: var(--surface);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid var(--surface-edge);
            border-radius: 42px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            box-shadow: var(--shadow), var(--inner-reflect);
            position: relative;
        }

        .brand-diffusion {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-left: 25px;
        }

        .brand-title {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -1.5px;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }

        .brand-title::after {
            content: '';
            position: absolute;
            bottom: 6px;
            right: -10px;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--success);
            animation: pulse 2s infinite;
        }

        /* --- Navigation Pods --- */
        .nav-pod-container {
            display: flex;
            align-items: center;
            background: var(--input-bg);
            border: 1px solid var(--surface-edge);
            border-radius: 30px;
            padding: 5px;
            gap: 5px;
            box-shadow: var(--inner-reflect);
        }

        .nav-link {
            padding: 10px 22px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .nav-link.active {
            background: var(--text-primary);
            color: var(--bg-color);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .nav-link:not(.active):hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* --- Status Diffusion --- */
        .status-hub {
            display: flex;
            gap: 25px;
            padding: 0 30px;
            border-left: 1px solid var(--surface-edge);
            margin: 0 15px;
        }

        .status-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .indicator-liquid {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            /* Default Gray/Off */
            opacity: 0.5;
            transition: all 0.3s;
            box-shadow: none;
        }

        .indicator-liquid.on,
        .indicator-liquid.status-on {
            background: var(--success);
            box-shadow: 0 0 15px var(--success);
        }

        .status-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* --- Layout Grid --- */
        .main-stage {
            flex: 1;
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 25px;
            padding: 0 30px 30px 30px;
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
            overflow: hidden;
        }

        .vitreous-panel {
            background: var(--terminal-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 32px;
            border: 1px solid var(--surface-edge);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow);
            animation: panelEntrance 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .panel-header {
            height: 64px;
            padding: 0 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.03);
            border-bottom: 1px solid var(--surface-edge);
        }

        .panel-title {
            font-weight: 800;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-body {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.7;
        }

        /* --- Footer Dock (Dynamic Island Style) --- */
        .dock-area {
            padding: 15px;
            border-top: 1px solid var(--surface-edge);
            display: flex;
            justify-content: center;
        }

        .floating-dock {
            background: var(--input-bg);
            padding: 6px 12px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--surface-edge);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(15px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .floating-dock:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .input-pill {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid var(--surface-edge);
            border-radius: 30px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 8px;
            width: 200px;
            height: 38px;
            transition: var(--transition);
        }

        .input-pill:focus-within {
            width: 350px;
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
        }

        .medical-input {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            font-size: 13px;
        }

        .fab-trigger {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface);
            border: 1px solid var(--surface-edge);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            position: relative;
        }

        .fab-trigger:hover {
            transform: scale(1.15) translateY(-3px);
            background: var(--accent);
            color: white;
            box-shadow: 0 8px 15px var(--gallium-glow);
        }

        .fab-trigger::after {
            content: attr(data-label);
            position: absolute;
            top: -25px;
            background: var(--text-primary);
            color: var(--bg-color);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s;
            transform: scale(0.8);
        }

        .fab-trigger:hover::after {
            opacity: 1;
            top: -25px;
            transform: scale(1);
        }

        /* --- Monitor Toggle --- */
        .monitor-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.05);
            padding: 4px;
            border-radius: 14px;
            gap: 4px;
        }

        .tab-btn {
            border: none;
            background: transparent;
            padding: 8px 16px;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .tab-btn.active {
            background: var(--surface);
            color: var(--text-primary);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .footer-metadata {
            text-align: center;
            padding: 10px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--text-secondary);
            opacity: 0.6;
        }

        /* ===== USER INFO MODAL V2 (Glassmorphic Design) ===== */
        .user-info-modal-v2 {
            z-index: 10000;
        }

        .user-info-modal-content {
            position: relative;
            width: 100%;
            max-width: 440px;
            padding: 2px;
            border-radius: 32px;
            background: linear-gradient(145deg, var(--glass-border), var(--bg-secondary) 40%, var(--glass-border));
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            animation: userInfoModalEntry 0.5s ease-out forwards;
        }

        .user-info-modal-content::before {
            content: '';
            position: absolute;
            inset: 2px;
            background: #0f172a;
            /* Fallback */
            opacity: 0.95;
            /* Slightly transparent */
            border-radius: 30px;
            z-index: -1;
        }

        body.light-mode .user-info-modal-content::before {
            background: var(--m2-gallium-reflect);
            /* Light mode support */
        }

        @keyframes userInfoModalEntry {
            0% {
                transform: scale(0.9) translateY(30px);
                opacity: 0;
            }

            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .user-info-close {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            z-index: 2;
        }

        .user-info-close:hover {
            background: var(--text-primary);
            color: var(--bg-color);
            transform: rotate(90deg);
        }

        .user-info-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 40px 20px;
        }

        .user-info-avatar-v2 {
            position: relative;
            width: 84px;
            height: 84px;
            border-radius: 28px;
            background: var(--highlight-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            box-shadow: 0 10px 25px rgba(56, 189, 248, 0.3);
            margin-bottom: 20px;
            transition: all 0.6s ease;
        }

        .user-info-avatar-v2::after {
            content: '';
            position: absolute;
            inset: -4px;
            border: 2px solid var(--highlight-color);
            border-radius: 32px;
            opacity: 0.3;
            animation: avatarPulse 3s infinite ease-in-out;
        }

        @keyframes avatarPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.3;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.1;
            }
        }

        .user-info-badge-v2 {
            background: var(--text-primary);
            color: var(--bg-color);
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 8px;
        }

        .user-info-body-v2 {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 20px;
            padding: 4px;
            margin: 0 24px 24px;
        }

        .user-info-row-v2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--glass-bg);
            transition: all 0.3s ease;
        }

        .user-info-row-v2:first-child {
            border-radius: 16px 16px 0 0;
        }

        .user-info-row-v2:nth-child(3) {
            border-radius: 0 0 16px 16px;
        }

        .user-info-row-v2:hover {
            background: transparent;
        }

        .row-label-v2 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .row-value-v2 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .row-value-v2.subscription-active {
            color: #10b981;
            font-weight: 700;
        }

        .row-value-v2.subscription-expired {
            color: var(--error-color);
            font-weight: 700;
        }

        .user-info-expired-warning-v2 {
            margin: 16px 24px 24px;
            padding: 16px;
            border-radius: 16px;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
            font-size: 13px;
            line-height: 1.5;
            display: none;
            align-items: center;
            gap: 12px;
            animation: warningShake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes warningShake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        /* ===== SUBSCRIPTION EXPIRED MODAL (Cryo-Tech Design) ===== */
        .cryo-overlay {
            position: fixed;
            inset: 0;
            background: #030708;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 11000;
            font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
            color: #e2e8f0;
            overflow: hidden;
        }

        .cryo-container {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 0;
            perspective: 1000px;
        }

        .fluid-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.4;
            animation: orbDrift 20s infinite alternate ease-in-out;
        }

        .fluid-orb.orb-1 {
            width: 300px;
            height: 300px;
            background: #00f2ff;
            top: -100px;
            left: -50px;
        }

        .fluid-orb.orb-2 {
            width: 250px;
            height: 250px;
            background: #7000ff;
            bottom: -80px;
            right: -40px;
            animation-delay: -5s;
        }

        @keyframes orbDrift {
            0% {
                transform: translate(0, 0) scale(1);
            }

            100% {
                transform: translate(40px, 60px) scale(1.1);
            }
        }

        .cryo-glass-card {
            position: relative;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 10, 0.98);
            backdrop-filter: blur(40px) saturate(150%);
            -webkit-backdrop-filter: blur(40px) saturate(150%);
            border: none;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: cryoCardEntry 1s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes cryoCardEntry {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #00f2ff, transparent);
            opacity: 0.3;
            animation: scanlineMove 4s linear infinite;
        }

        @keyframes scanlineMove {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(1000%);
            }
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 100px;
            margin-bottom: 32px;
        }

        .pulse-dot {
            width: 6px;
            height: 6px;
            background: #00f2ff;
            border-radius: 50%;
            box-shadow: 0 0 10px #00f2ff;
            animation: pulseDot 2s infinite;
        }

        @keyframes pulseDot {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.4;
                transform: scale(1.2);
            }
        }

        .mono-label {
            font-family: 'JetBrains Mono', 'Space Mono', monospace;
            font-size: 10px;
            letter-spacing: 0.1em;
            color: #94a3b8;
        }

        .icon-container {
            color: #00f2ff;
            margin-bottom: 24px;
        }

        .cryo-icon {
            width: 48px;
            height: 48px;
            filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.4));
        }

        .cryo-main-title {
            font-size: 42px;
            font-weight: 300;
            line-height: 1.1;
            margin: 0 0 24px 0;
            letter-spacing: -0.02em;
            color: #e2e8f0;
        }

        .cryo-highlight {
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #00f2ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .cryo-description {
            font-size: 16px;
            line-height: 1.6;
            color: #e2e8f0;
            margin-bottom: 40px;
        }

        .cryo-sub-text {
            display: block;
            margin-top: 12px;
            color: #94a3b8;
            font-size: 14px;
        }

        .support-module {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .support-module:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(0, 242, 255, 0.3);
        }

        .support-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 20px;
        }

        .mono-label-small {
            font-family: 'JetBrains Mono', 'Space Mono', monospace;
            font-size: 9px;
            color: #00f2ff;
            letter-spacing: 0.2em;
        }

        .phone-number {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.05em;
            font-family: 'JetBrains Mono', 'Space Mono', monospace;
            color: #e2e8f0;
        }

        .cryo-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.08);
            margin-bottom: 20px;
        }

        .action-trigger {
            width: 100%;
            background: #00f2ff;
            color: #000;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.15);
        }

        .action-trigger:hover {
            transform: translateY(-2px);
            background: #fff;
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.4);
        }

        .action-trigger:active {
            transform: translateY(0);
        }

        .footer-meta {
            margin-top: 32px;
            text-align: center;
            opacity: 0.3;
        }

        .mono-meta {
            font-family: 'JetBrains Mono', 'Space Mono', monospace;
            font-size: 9px;
            letter-spacing: 0.3em;
        }

        @media (max-width: 480px) {
            .cryo-glass-card {
                padding: 32px 24px;
            }

            .cryo-main-title {
                font-size: 32px;
            }

            .user-info-modal-content {
                margin: 0 16px;
                max-width: calc(100% - 32px);
            }
        }
    </style>
</head>

<body>
    <!-- SVG Filter for Gooey Effect -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1"
        xmlns="http://www.w3.org/2000/svg">
        <defs>
            <filter id="gooey">
                <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
                <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7"
                    result="goo" />
                <feBlend in="SourceGraphic" in2="goo" />
            </filter>
        </defs>
    </svg>
    <div class="header-wrap">
        <header class="axon-glass-header">
            <div class="brand-diffusion">
                <div class="brand-title">axon</div>
            </div>

            <div class="nav-pod-container">
                <div class="nav-link" id="btn-transfer-file">
                    <i class="fas fa-paper-plane"></i>
                    <span>Enviar</span>
                </div>
                <div class="nav-link" id="btn-tools">
                    <i class="fas fa-microscope"></i>
                    <span>Ferramentas</span>
                </div>
                <!-- Cloud Button mapped to new ID logic or kept same? Old was btn-cloud. -->
                <div class="nav-link" id="btn-cloud">
                    <i class="fas fa-cloud"></i>
                    <span>Nuvem</span>
                </div>
            </div>

            <div class="status-hub">
                <div class="status-node">
                    <div class="indicator-liquid on" id="api-status"></div>
                    <span class="status-label">Engine</span>
                </div>
                <div class="status-node">
                    <div class="indicator-liquid" id="mic-status"></div>
                    <span class="status-label">Voice</span>
                </div>
                <div class="status-node">
                    <div class="indicator-liquid" id="camera-status"></div>
                    <span class="status-label">Vision</span>
                </div>
            </div>

            <div style="display: flex; gap: 10px; padding-right: 15px;">
                <button class="fab-trigger" id="theme-toggle" data-label="Fluxo Visual">
                    <i class="fas fa-sun"></i>
                </button>
                <button class="fab-trigger" id="settings-button" data-label="ConfiguraÃ§Ãµes">
                    <i class="fas fa-sliders-h"></i>
                </button>
                <button class="fab-trigger" id="logout-button" data-label="Sair">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </header>
    </div>
    <main class="main-stage">
        <!-- Interactive Terminal Panel -->
        <section class="vitreous-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-terminal" style="color:var(--accent)"></i>
                    Terminal ClÃ­nico Inteligente
                </div>
                <div style="display:flex; gap:8px;">
                    <div style="width:12px; height:12px; border-radius:50%; background:var(--danger); opacity:0.6;">
                    </div>
                    <div style="width:12px; height:12px; border-radius:50%; background:#fbbf24; opacity:0.6;"></div>
                    <div style="width:12px; height:12px; border-radius:50%; background:var(--success); opacity:0.6;">
                    </div>
                </div>
            </div>

            <div class="panel-body" id="interactive-output">
                <div style="color: var(--text-secondary); margin-bottom: 15px;">[SISTEMA] Axon v1.8 inicializado...
                </div>
                <div style="color: var(--success);"><i class="fas fa-check-circle"></i> MÃ³dulos do sistema carregados
                    com sucesso!
                </div>
                <div style="color: var(--accent);"><i class="fas fa-info-circle"></i> Aguardando entrada clÃ­nica do
                    especialista.</div>

            </div>

            <!-- Free Mode Board (Moved as Sibling to prevent collapse) -->
            <div class="panel-body" id="free-mode-board"
                style="display:none; flex-direction:column; padding:20px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-top: 0; border: 1px solid var(--surface-edge);">
                <textarea id="free-mode-textarea" placeholder="Digite livremente aqui... (Texto salvo automaticamente)"
                    spellcheck="false"
                    style="width: 100%; height: 100%; min-height: 200px; background: transparent; border: none; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; resize: none; font-size: 14px; outline: none; line-height: 1.5; flex: 1;"></textarea>
                <div
                    style="padding-top: 10px; border-top: 1px solid var(--surface-edge); display:flex; justify-content:flex-end;">
                    <button id="btn-process-free-mode" class="fab-trigger"
                        style="width: auto; padding: 0 20px; border-radius: 20px; font-size: 12px; height: 36px;">
                        <i class="fas fa-paper-plane" style="margin-right: 8px;"></i> Processar
                    </button>
                </div>
            </div>


            <!-- Preserving ID just in case JS targets it -->
            </div>

            <div class="dock-area">
                <div class="floating-dock">
                    <button class="fab-trigger" id="btn-hd" data-label="HipÃ³teses"><i
                            class="fas fa-lightbulb"></i></button>
                    <button class="fab-trigger" id="btn-cd" data-label="Conduta"><i class="fas fa-user-md"></i></button>
                    <button class="fab-trigger" id="btn-exames" data-label="Exames"><i
                            class="fas fa-file-medical-alt"></i></button>
                    <button class="fab-trigger" id="btn-see" data-label="Axon Eye"><i class="fas fa-eye"></i></button>
                    <button class="fab-trigger" id="btn-records" data-label="ProntuÃ¡rios"><i
                            class="fas fa-book-medical"></i></button>

                    <div class="input-pill">
                        <span style="color: var(--accent); font-weight: 800;">&gt;</span>
                        <input type="text" class="medical-input" id="command-input"
                            placeholder="Sintoma ou evoluÃ§Ã£o mÃ©dica..." autocomplete="off">
                    </div>

                    <button class="fab-trigger" id="btn-mic" data-label="Escuta Ativa"><i
                            class="fas fa-microphone"></i></button>
                    <button class="fab-trigger" id="btn-clear" style="color: var(--danger)" data-label="Limpar"><i
                            class="fas fa-eraser"></i></button>
                    <button class="fab-trigger" id="btn-prescription-assist" data-label="PrescriÃ§Ã£o"><i
                            class="fas fa-heartbeat"></i></button>
                    <button class="fab-trigger" id="btn-free-mode" data-label="Modo Livre"><i
                            class="fas fa-edit"></i></button>
                </div>
            </div>
        </section>

        <!-- Monitor Panel -->
        <section class="vitreous-panel">
            <div class="panel-header">
                <div class="monitor-tabs">
                    <button class="tab-btn active" id="toggle-anamnesis">EvoluÃ§Ã£o</button>
                    <button class="tab-btn" id="toggle-exams">Exames</button>
                    <button class="tab-btn" id="toggle-axon-eye">Axon Eye</button>
                </div>
                <button class="fab-trigger" id="monitor-copy-btn" style="width:32px; height:32px; font-size:12px;">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            <div class="panel-body">
                <div id="monitor-content-wrapper">
                    <div id="anamnesis-preview" class="monitor-view">
                        <div class="info" style="color:var(--text-secondary)">Aguardando inÃ­cio da anamnese...</div>
                    </div>
                    <div id="exams-results-preview" class="monitor-view" style="display:none">
                        <div class="info" style="color:var(--text-secondary)">Nenhum exame analisado ainda.</div>
                    </div>
                    <div id="axon-eye-results-preview" class="monitor-view" style="display:none">
                        <div class="info" style="color:var(--text-secondary)">Nenhuma anÃ¡lise visual feita ainda.</div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <div class="footer"><span>AXON | Sistema mÃ©dico inteligente desenvolvido por Ian Bastos</span></div>
    <div id="camera-modal" class="camera-modal">
        <div class="camera-container">
            <div class="terminal-header">
                <div class="terminal-title" id="camera-modal-title">CÃ¢mera de Exames</div>
                <div class="terminal-actions">
                    <div class="terminal-btn close-btn" id="camera-close-btn"></div>
                </div>
            </div>
            <div class="terminal-content" style="padding:10px">
                <div class="camera-video-wrapper"><video id="camera-video" class="camera-video" autoplay playsinline
                        muted></video>
                    <div class="camera-action-buttons"><button id="flashlight-button" class="flashlight-button"
                            style="display:none"><i class="fas fa-lightbulb"></i>Lanterna</button><button
                            id="camera-switch-button" class="camera-switch-button" style="display:none"><i
                                class="fas fa-sync-alt"></i>Trocar CÃ¢mera</button></div>
                    <div id="album-button" class="album-button" style="display:none"><i
                            class="fas fa-images"></i>Ãlbum<span id="album-count" class="album-count">0</span></div>
                    <div class="camera-controls"><button id="capture-button" class="camera-button"
                            title="Capturar Foto"><i class="fas fa-camera"></i></button><input type="file"
                            id="file-input" accept="image/*" multiple="multiple" style="display:none"><button
                            id="upload-button" class="camera-button" title="Carregar Arquivo"><i
                                class="fas fa-upload"></i></button><button id="send-exams-button"
                            class="camera-button disabled" title="Enviar Exames"><i
                                class="fas fa-paper-plane"></i></button><button id="send-axon-eye-button"
                            class="camera-button disabled" title="Analisar com Axon Eye" style="display:none"><i
                                class="fas fa-eye"></i></button><button id="cancel-camera-button" class="camera-button"
                            title="Cancelar"><i class="fas fa-times"></i></button></div>
                </div><canvas id="camera-canvas" style="display:none"></canvas>
            </div>
        </div>
    </div>
    <div id="fullscreen-modal" class="fullscreen-modal">
        <span class="modal-close">&times;</span>
        <div class="fullscreen-image-container" id="fullscreen-image-container">
            <img class="modal-content" id="modal-image">
        </div>
        <button class="nav-arrow prev" id="modal-prev-btn"><i class="fas fa-chevron-left"></i></button>
        <button class="nav-arrow next" id="modal-next-btn"><i class="fas fa-chevron-right"></i></button>
        <div class="zoom-controls">
            <button id="modal-zoom-in"><i class="fas fa-plus"></i></button>
            <button id="modal-zoom-reset"><i class="fas fa-compress"></i></button>
            <button id="modal-zoom-out"><i class="fas fa-minus"></i></button>
        </div>
    </div>
    <div id="album-modal" class="album-modal">
        <div class="album-modal-content"><span class="album-modal-close">&times;</span>
            <div class="album-modal-header">
                <div class="album-modal-title">Ãlbum de Exames</div>
            </div>
            <div id="album-grid" class="album-grid"></div>
        </div>
    </div>
    <div id="patient-list-modal" class="patient-list-modal">
        <div class="patient-list-content"><span class="patient-list-close">&times;</span>
            <div class="patient-list-header">
                <div class="patient-list-title">Pacientes Salvos</div>
            </div>
            <div class="patient-search-container"><input type="text" id="patient-search-input"
                    class="patient-search-input" placeholder="Pesquisar paciente..."></div>
            <div id="patient-list" class="patient-list"></div>
            <div class="patient-list-footer"
                style="margin-top:15px;padding-top:15px;border-top:1px solid var(--border-color)"><button
                    id="btn-save-from-list" class="app-modal-button" style="width:100%">Salvar Consulta Atual</button>
            </div>
        </div>
    </div>
    <div id="patient-details-modal" class="patient-details-modal">
        <div class="patient-details-content"><span class="patient-details-close">&times;</span>
            <div class="patient-details-header">
                <div class="patient-details-title" id="patient-details-title">Detalhes do Paciente</div>
            </div>
            <div id="patient-details-body" class="patient-details-body"></div>
        </div>
    </div>
    <div id="login-modal" class="modal" style="display: flex;"> <!-- Forced display flex as per new CSS logic -->
        <div class="gallium-layout" style="position:relative; z-index:10;">
            <!-- Left Column: Hero -->
            <!-- Left Column: Hero -->
            <div class="hero-section">
                <div class="hero-title">AXON</div>
                <div class="hero-subtitle">
                    ASSISTENTE MÃ‰DICO V1.8<br>
                    <span class="hero-subtitle-text">Aguardando credenciais de acesso...</span>
                </div>
            </div>

            <!-- Right Column: Login Form -->
            <div class="login-container">
                <div
                    style="font-family: 'Outfit'; font-weight: 700; font-size: 1.2rem; margin-bottom: 2rem; letter-spacing: 0.05em;">
                    IDENTIFICAÃ‡ÃƒO DE USUÃRIO
                </div>

                <div class="input-group">
                    <input type="text" id="login-modal-user" class="gallium-input" placeholder=" "
                        autocomplete="username">
                    <div class="input-underline"></div>
                    <label
                        style="position:absolute; top:10px; left:0; pointer-events:none; transition:0.3s; font-size:0.8rem; color: #94a3b8;">USUÃRIO</label>
                </div>

                <div class="input-group">
                    <input type="password" id="login-modal-pass" class="gallium-input" placeholder=" "
                        autocomplete="current-password">
                    <div class="input-underline"></div>
                    <label
                        style="position:absolute; top:10px; left:0; pointer-events:none; transition:0.3s; font-size:0.8rem; color: #94a3b8;">SENHA</label>
                </div>

                <button id="login-modal-button" class="gallium-btn">
                    Iniciar SessÃ£o
                </button>

                <div id="login-modal-feedback"
                    style="min-height: 20px; font-size: 0.8rem; color: var(--error-color); text-align: center;"></div>

                <div class="meta-layer"
                    style="position: relative; bottom: 0; left: 0; margin-top: 1rem; justify-content: center;">
                    <span>STATUS: ONLINE</span>
                    <span>SERVER: SÃƒO PAULO</span>
                </div>
            </div>
        </div>
    </div>
    <div id="save-patient-modal" class="app-modal">
        <div class="app-modal-content"><span class="app-modal-close">&times;</span>
            <div class="app-modal-header">
                <h2 class="app-modal-title">Salvar Paciente</h2>
            </div>
            <div class="app-modal-body">
                <p>Insira os dados do paciente para salvar a sessÃ£o atual.</p><input type="text" id="save-patient-name"
                    placeholder="Nome Completo do Paciente" class="app-modal-input"> <input type="text"
                    id="save-patient-dob" placeholder="Data de Nascimento (DD/MM/AAAA)" class="app-modal-input"><button
                    id="save-patient-button" class="app-modal-button">Salvar</button>
                <div id="save-patient-feedback" class="app-modal-feedback"></div>
            </div>
        </div>
    </div>
    <div id="admin-auth-modal" class="app-modal">
        <div class="app-modal-content"><span class="app-modal-close">&times;</span>
            <div class="app-modal-header">
                <h2 class="app-modal-title">AdministraÃ§Ã£o</h2>
            </div>
            <div class="app-modal-body">
                <p>Insira a senha de administrador.</p><input type="password" id="admin-auth-pass" placeholder="Senha"
                    class="app-modal-input"><button id="admin-auth-button" class="app-modal-button">Acessar</button>
                <div id="admin-auth-feedback" style="margin-top: 10px; font-size: 13px; text-align: center;"></div>
            </div>
        </div>
    </div>
    <!-- User Profile Modal (for non-admin users) -->
    <div id="user-info-modal" class="app-modal user-info-modal-v2">
        <div class="user-info-modal-content">
            <span class="app-modal-close user-info-close"><i class="fas fa-times"></i></span>

            <div class="user-info-header">
                <div id="user-info-avatar" class="user-info-avatar-v2">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h2 class="app-modal-title" id="user-info-username">Axon User</h2>
                <div id="user-info-badge" class="user-info-badge-v2">Axon Personal</div>
            </div>

            <div class="user-info-body-v2" id="user-info-body">
                <div class="user-info-row-v2">
                    <span class="row-label-v2">Email:</span>
                    <span id="user-info-email" class="row-value-v2">-</span>
                </div>

                <div class="user-info-row-v2">
                    <span class="row-label-v2">Membro Desde:</span>
                    <span id="user-info-created" class="row-value-v2">-</span>
                </div>

                <div class="user-info-row-v2">
                    <span class="row-label-v2">Expira em:</span>
                    <span id="user-info-subscription" class="row-value-v2 subscription-active">-</span>
                </div>

                <div id="user-info-expired-warning" class="user-info-expired-warning-v2">
                    <i class="fas fa-circle-exclamation" style="font-size: 18px;"></i>
                    <span>Sua assinatura expirou. Entre em contato com o suporte para renovar.</span>
                </div>

                <!-- Student Disclaimer -->
                <div id="user-info-student-warning"
                    style="display:none; text-align:center; opacity:0.75; font-size:12px; margin-top:20px; padding:15px; border-top:1px solid rgba(255,255,255,0.1); color: var(--text-muted); line-height: 1.4;">
                    <i class="fas fa-info-circle" style="margin-bottom:8px; display:block; font-size:16px;"></i>
                    <span>Sua conta Ã© licenciada como "estudante" e pode ter algumas limitaÃ§Ãµes. Seu uso Ã© liberado
                        apenas para uso acadÃªmico, sem fins comerciais.</span>
                </div>
            </div>
        </div>
    </div>
    <div id="admin-panel-modal" class="app-modal">
        <div class="app-modal-content"><span class="app-modal-close">&times;</span>
            <div class="app-modal-header">
                <h2 class="app-modal-title">Painel Administrativo</h2>
            </div>
            <div class="admin-tabs"><button class="admin-tab-btn active" data-tab="users">UsuÃ¡rios</button><button
                    class="admin-tab-btn" data-tab="api">API</button><button class="admin-tab-btn"
                    data-tab="axon-drive">Axon Drive</button><button class="admin-tab-btn"
                    data-tab="bridge">Bridge</button><button class="admin-tab-btn"
                    data-tab="alerts">Alertas</button><button class="admin-tab-btn" data-tab="debug">Debug</button>
            </div>
            <div id="tab-users" class="admin-tab-content">
                <div class="patient-search-container" style="margin:0 0 15px 0"><input type="text"
                        id="admin-user-search" class="patient-search-input" placeholder="Buscar usuÃ¡rio..."></div>
                <div class="admin-users-container">
                    <div class="admin-users-list-section">
                        <div class="admin-section-title"
                            style="margin-top:0;margin-bottom:10px;flex-shrink:0;display:flex;justify-content:space-between;align-items:center">
                            <span>UsuÃ¡rios (Rank de Uso)</span>
                            <div style="display:flex;gap:5px"><button id="disconnect-all-users-btn"
                                    class="patient-action-button"
                                    style="flex:0;padding:4px 8px;font-size:12px;color:var(--error-color)"><i
                                        class="fas fa-power-off"></i>Desconectar Todos</button><button
                                    id="toggle-create-user-form" class="patient-action-button details"
                                    style="flex:0;padding:4px 8px;font-size:12px"><i
                                        class="fas fa-plus"></i>Novo</button></div>
                        </div>
                        <div id="admin-users-list" class="user-list-scroll">
                            <div class="info">Carregando...</div>
                        </div>
                    </div>
                    <div class="admin-users-details-section" id="admin-user-details">
                        <div class="info" style="margin-top:20px">Selecione um usuÃ¡rio para ver detalhes.</div>
                    </div>
                </div>
                <div id="create-user-form-container" class="admin-section"
                    style="margin-top:15px;padding:10px 15px;flex-shrink:0;display:none">
                    <div class="admin-section-title"
                        style="display:flex;justify-content:space-between;align-items:center"><span>Criar Novo
                            UsuÃ¡rio</span><i id="close-create-user-form" class="fas fa-times"
                            style="cursor:pointer;font-size:16px"></i></div>
                    <div style="display:flex;gap:10px;margin-bottom:10px"><input type="text" id="admin-new-user"
                            class="admin-input" placeholder="Novo nome de usuÃ¡rio" style="flex:1"> <input type="text"
                            id="admin-new-pass" class="admin-input" placeholder="Nova senha" style="flex:1"></div>
                    <div style="display:flex;gap:10px;margin-bottom:10px"><input type="email" id="admin-new-email"
                            class="admin-input" placeholder="Email (opcional)" style="flex:1">
                        <select id="admin-new-level" class="admin-input"
                            style="flex:1; background: var(--bg-secondary); color: var(--text-color);">
                            <option value="personal">Axon Personal</option>
                            <option value="enterprise">Axon Enterprise</option>
                            <option value="student">Axon Student</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:10px;margin-bottom:10px; align-items:center;">
                        <input type="number" id="admin-new-days" class="admin-input" placeholder="Dias" value="30"
                            style="flex: 1;">
                        <input type="number" id="admin-new-hours" class="admin-input" placeholder="Horas" value="0"
                            style="flex: 1;">
                        <input type="number" id="admin-new-minutes" class="admin-input" placeholder="Min" value="0"
                            style="flex: 1;">
                    </div>
                    <div style="display:flex;gap:10px;margin-bottom:10px; align-items:center;">
                        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;">
                            <input type="checkbox" id="admin-new-isadmin"> Administrador
                        </label>
                    </div>
                    <button class="app-modal-button" onclick="window.createUserFromPanel()">Criar UsuÃ¡rio</button>
                    <div id="admin-create-user-feedback" class="app-modal-feedback"
                        style="text-align:left;margin-top:10px;min-height:15px;font-size:12px"></div>
                </div>
            </div>
            <!-- End of tab-users content -->

            <div id="tab-api" class="admin-tab-content" style="display:none">
                <div id="admin-settings-body"></div>
            </div>
            <div id="tab-debug" class="admin-tab-content" style="display:none">
                <div id="admin-debug-body"></div>
            </div>

            <!-- AXON DRIVE TAB -->
            <div id="tab-axon-drive" class="admin-tab-content" style="display:none">
                <div class="admin-section">
                    <h3>Status do Armazenamento (Pinata)</h3>
                    <div class="pinata-storage-container">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span id="admin-pinata-usage-text">Carregando...</span>
                            <span id="admin-pinata-usage-percent">0%</span>
                        </div>
                        <div class="storage-bar-container" style="height: 15px; background: rgba(255,255,255,0.1);">
                            <div class="storage-bar-fill" id="admin-pinata-usage-bar"></div>
                        </div>
                        <div style="margin-top: 10px; font-size: 11px; opacity: 0.7;">
                            *Armazenamento combinado de todas as chaves ativas.
                        </div>
                    </div>

                    <h3>Gerenciador de Arquivos Global</h3>
                    <div class="pinata-file-list" id="admin-pinata-file-list">
                        <!-- List populated by JS -->
                        <div style="padding: 10px; text-align: center; color: var(--text-color); opacity: 0.5;">
                            Carregando arquivos...</div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3>Gerenciador de Chaves Pinata (Multi-Key)</h3>
                    <div class="pinata-key-manager">
                        <div id="admin-pinata-key-list"></div>

                        <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 8px;">
                            <h4>Adicionar Nova Chave</h4>
                            <input type="text" id="new-pinata-key" placeholder="API Key" class="admin-input"
                                style="margin-bottom: 5px;">
                            <input type="text" id="new-pinata-secret" placeholder="Secret Key" class="admin-input"
                                style="margin-bottom: 5px;">
                            <input type="text" id="new-pinata-jwt" placeholder="JWT (Opcional)" class="admin-input"
                                style="margin-bottom: 5px;">
                            <div style="display:flex; justify-content: flex-end;">
                                <button class="action-button" id="btn-add-pinata-key"
                                    style="background: var(--success-color); width: auto; padding: 6px 12px; white-space: nowrap;">Adicionar
                                    (+1GB)</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SUPABASE SECTION -->
                <div class="admin-section"
                    style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                    <h3>Supabase Storage (OpÃ§Ã£o HÃ­brida)</h3>
                    <div style="font-size:12px; opacity:0.7; margin-bottom:10px">
                        Quando ativado, arquivos menores que 50MB serÃ£o salvos no Supabase. O restante irÃ¡ para o
                        Pinata.
                    </div>

                    <!-- Config -->
                    <div style="background: rgba(0,0,0,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                            <span style="font-weight:bold;">Ativar IntegraÃ§Ã£o</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="admin-supabase-toggle"
                                    onchange="window.toggleSupabase(this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <input type="text" id="admin-supabase-url" class="admin-input"
                            placeholder="Project URL (https://...supabase.co)" style="margin-bottom: 8px;">
                        <input type="text" id="admin-supabase-key" class="admin-input" placeholder="API Key"
                            style="margin-bottom: 8px;">
                        <input type="text" id="admin-supabase-bucket" class="admin-input"
                            placeholder="Nome do Bucket (PadrÃ£o: axons-drive)" style="margin-bottom: 8px;">

                        <div style="display:flex; justify-content:flex-end;">
                            <button class="patient-action-button" id="btn-save-supabase"
                                onclick="window.saveSupabaseConfig()">
                                <i class="fas fa-save"></i> Salvar Credenciais
                            </button>
                        </div>
                    </div>

                    <!-- Storage Visualization (Mocked or simple count) -->
                    <h3>Armazenamento Supabase</h3>
                    <div class="pinata-storage-container">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span id="admin-supabase-usage-text">Carregando...</span>
                            <span id="admin-supabase-usage-percent">0%</span>
                        </div>
                        <div class="storage-bar-container" style="height: 15px; background: rgba(255,255,255,0.1);">
                            <div class="storage-bar-fill" id="admin-supabase-usage-bar"
                                style="width: 0%; background: #3ecf8e;"></div>
                        </div>
                    </div>

                    <!-- File List -->
                    <h3 style="margin-top:15px;">Arquivos no Supabase</h3>
                    <div class="pinata-file-list" id="admin-supabase-file-list">
                        <div class="info">Carregando arquivos...</div>
                    </div>
                </div>
            </div>
            <!-- AXON BRIDGE TAB -->
            <div id="tab-bridge" class="admin-tab-content" style="display:none">
                <div class="admin-section">
                    <h3>Gerenciamento de APIs (Axon Bridge)</h3>
                    <div style="font-size:12px; opacity:0.7; margin-bottom:15px">Controle quais APIs de sistema os
                        plugins podem acessar.</div>
                    <div id="admin-bridge-body">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <div class="admin-section"
                    style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                    <h3>Gerenciamento de Plugins (Axon Store)</h3>
                    <div style="font-size:12px; opacity:0.7; margin-bottom:15px">Carregue plugins (.json) para a Axon
                        Store global.</div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="app-modal-button"
                            onclick="document.getElementById('admin-plugin-upload').click()">
                            <i class="fas fa-upload"></i> Upload Plugin (.json)
                        </button>
                        <input type="file" id="admin-plugin-upload" accept=".json" style="display: none;"
                            onchange="window.adminUploadPlugin(this)">
                    </div>

                    <div id="admin-plugins-list" class="pinata-file-list">
                        <!-- List populated by JS -->
                        <div style="padding: 10px; text-align: center; color: var(--text-color); opacity: 0.5;">
                            Carregando plugins...
                        </div>
                    </div>
                </div>
            </div>

            <!-- ALERTS TAB -->
            <div id="tab-alerts" class="admin-tab-content" style="display:none">
                <style>
                    /* Scoped Styles for Alert Preview & Management */
                    .alert-preview-stage {
                        position: relative;
                        width: 100%;
                        max-width: 500px;
                        height: 350px;
                        background: rgba(255, 255, 255, 0.45);
                        backdrop-filter: blur(32px) saturate(180%);
                        -webkit-backdrop-filter: blur(32px) saturate(180%);
                        border-radius: 20px;
                        box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.05);
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                        font-family: 'Plus Jakarta Sans', sans-serif;
                        color: #1a1a1a;
                        margin: 0 auto;
                        transform-origin: center top;
                        transform: scale(0.85);
                        /* Scale down for better fit */
                    }

                    /* Alert Elements */
                    .alert-header {
                        padding: 20px 25px 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .alert-badge {
                        font-family: monospace;
                        font-size: 9px;
                        font-weight: 700;
                        text-transform: uppercase;
                        color: #1a1a1a;
                        background: rgba(0, 0, 0, 0.05);
                        padding: 4px 8px;
                        border-radius: 4px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }

                    .alert-badge::before {
                        content: "";
                        width: 5px;
                        height: 5px;
                        background: #ff3b30;
                        border-radius: 50%;
                        box-shadow: 0 0 6px #ff3b30;
                    }

                    .alert-content {
                        padding: 0 25px;
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        overflow-y: auto;
                    }

                    .alert-title {
                        font-weight: 800;
                        font-size: 20px;
                        color: #000;
                        line-height: 1.1;
                        margin-bottom: 8px;
                        letter-spacing: -0.02em;
                    }

                    .alert-message {
                        font-size: 13px;
                        color: rgba(0, 0, 0, 0.6);
                        line-height: 1.5;
                        margin-bottom: 15px;
                    }

                    .alert-media-container {
                        width: 100%;
                        border-radius: 12px;
                        overflow: hidden;
                        margin-bottom: 15px;
                        background: rgba(0, 0, 0, 0.05);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        min-height: 100px;
                    }

                    .alert-media-container img,
                    .alert-media-container video,
                    .alert-media-container iframe {
                        width: 100%;
                        height: auto;
                        display: block;
                        object-fit: cover;
                    }

                    .alert-media-container iframe {
                        height: 200px;
                        border: none;
                    }

                    .alert-footer {
                        padding: 20px 25px;
                        display: flex;
                        gap: 10px;
                        padding-top: 0;
                    }

                    .alert-btn {
                        padding: 10px 20px;
                        border-radius: 10px;
                        font-weight: 600;
                        font-size: 12px;
                        cursor: pointer;
                        border: none;
                        transition: all 0.2s;
                    }

                    .alert-btn-primary {
                        background: #1a1a1a;
                        color: #fff;
                        flex: 1;
                    }

                    /* Form Styles */
                    .alert-form-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 20px;
                        width: 100%;
                        max-width: 100%;
                        box-sizing: border-box;
                    }

                    .alert-form-section {
                        padding: 15px;
                        background: rgba(0, 0, 0, 0.1);
                        border-radius: 8px;
                    }

                    @media (max-width: 900px) {
                        .alert-form-grid {
                            grid-template-columns: 1fr;
                        }
                    }
                </style>

                <div class="alert-form-grid">
                    <!-- Left: Form -->
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div class="admin-section">
                            <h3>Criar Novo Alerta</h3>

                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="font-size:12px; opacity:0.7;">TÃ­tulo</label>
                                <input type="text" id="alert-title" class="admin-input"
                                    placeholder="Ex: ManutenÃ§Ã£o Programada" oninput="window.updateAlertPreview()">
                            </div>

                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="font-size:12px; opacity:0.7;">ConteÃºdo</label>
                                <textarea id="alert-content" class="admin-input" rows="3"
                                    placeholder="Mensagem detalhada..." oninput="window.updateAlertPreview()"
                                    style="resize:vertical;"></textarea>
                            </div>

                            <div class="form-group" style="margin-bottom: 10px;">
                                <label style="font-size:12px; opacity:0.7;">MÃ­dia (Opcional)</label>
                                <select id="alert-media-type" class="admin-input" onchange="window.toggleMediaType()"
                                    style="margin-bottom: 5px;">
                                    <option value="none">Nenhuma</option>
                                    <option value="image">Imagem</option>
                                    <option value="video">VÃ­deo (.mp4)</option>
                                    <option value="iframe">iFrame / HTML Embutido</option>
                                </select>

                                <div id="media-input-container" style="display:none;">
                                    <!-- URL Input -->
                                    <input type="text" id="alert-media-url" class="admin-input"
                                        placeholder="URL da MÃ­dia (ou use Upload)" oninput="window.updateAlertPreview()"
                                        style="margin-bottom: 5px;">

                                    <!-- HTML Code Input (For iFrame/HTML Mode) -->
                                    <textarea id="alert-html-content" class="admin-input" rows="5"
                                        placeholder="Cole seu cÃ³digo HTML aqui (<iframe>, <div>, etc)..."
                                        oninput="window.updateAlertPreview()"
                                        style="margin-bottom: 5px; display: none; font-family: monospace; font-size: 12px;"></textarea>

                                    <!-- Upload Button for Supabase -->
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <button class="action-button"
                                            onclick="document.getElementById('alert-media-upload').click()"
                                            style="background:var(--accent-color); width:auto; padding: 6px 12px; font-size:11px;">
                                            <i class="fas fa-cloud-upload-alt"></i> Upload (Supabase)
                                        </button>
                                        <span id="alert-upload-status" style="font-size: 10px; opacity: 0.7;"></span>
                                        <input type="file" id="alert-media-upload" style="display: none;"
                                            onchange="window.handleAlertMediaUpload(this)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="admin-section">
                            <h3>ConfiguraÃ§Ãµes de ExibiÃ§Ã£o</h3>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size:12px; opacity:0.7;">PÃºblico</label>
                                    <select id="alert-audience" class="admin-input">
                                        <option value="all">Todos os UsuÃ¡rios</option>
                                        <option value="all_except_admin">Todos (Exceto Administradores)</option>
                                        <option value="personal">Apenas Axon Personal</option>
                                        <option value="enterprise">Apenas Axon Enterprise</option>
                                        <option value="student">Apenas Estudantes (Student)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:12px; opacity:0.7;">FrequÃªncia</label>
                                    <select id="alert-frequency" class="admin-input">
                                        <option value="once">Uma vez apenas</option>
                                        <option value="always">Sempre (Toda vez que abrir)</option>
                                    </select>
                                </div>
                            </div>

                            <div style="margin-top: 10px;">
                                <label style="font-size:12px; opacity:0.7;">Bloqueio de Fechamento (Propaganda)</label>
                                <div style="display:flex; align-items:center; gap: 10px;">
                                    <input type="number" id="alert-lock-time" class="admin-input" value="0" min="0"
                                        placeholder="Segundos" style="width: 80px;">
                                    <span style="font-size:11px; opacity:0.6;">segundos (0 = botÃ£o fechar
                                        liberado)</span>
                                </div>
                            </div>

                            <div style="margin-top: 10px; display: flex; gap: 15px;">
                                <div style="flex:1;">
                                    <label style="font-size:12px; opacity:0.7;">Largura (px)</label>
                                    <input type="number" id="alert-width" class="admin-input"
                                        placeholder="Auto (Ex: 550)" oninput="window.updateAlertPreview()">
                                </div>
                                <div style="flex:1;">
                                    <label style="font-size:12px; opacity:0.7;">Altura (px)</label>
                                    <input type="number" id="alert-height" class="admin-input" placeholder="Auto"
                                        oninput="window.updateAlertPreview()">

                                    <!-- Hidden Fields for Visual styling -->
                                    <input type="hidden" id="alert-close-size" value="24">
                                    <input type="hidden" id="alert-close-color" value="#000000">
                                    <input type="hidden" id="alert-media-height" value="">
                                </div>
                            </div>

                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button id="btn-publish-alert" class="app-modal-button" onclick="window.publishAlert()"
                                    style="background: var(--success-color);">
                                    <i class="fas fa-paper-plane"></i> Publicar Alerta
                                </button>
                                <button class="app-modal-button" onclick="window.previewCurrentAlert()"
                                    style="background: var(--button-bg); border: 1px solid var(--border-color); color: var(--text-color);"
                                    title="Testar o popup real">
                                    <i class="fas fa-eye"></i> Testar
                                </button>
                                <button class="app-modal-button" onclick="window.clearAlertForm()"
                                    style="background: var(--bg-secondary); color: var(--text-color);">
                                    Limpar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Preview -->
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div
                            style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 12px; opacity: 0.5;">PREVIEW (Tempo Real)</span>
                            <button onclick="window.openVisualEditor()"
                                style="padding: 4px 10px; font-size: 11px; background: var(--highlight-color); border: none; border-radius: 4px; color: white; cursor: pointer;">
                                <i class="fas fa-edit"></i> Editor Visual
                            </button>
                        </div>
                        <div class="alert-preview-stage">
                            <!-- Background Texture -->
                            <div
                                style="position: absolute; inset: 0; z-index: 0; opacity: 0.08; background-image: url('data:image/svg+xml,%3Csvg viewBox=\'0 0 200 200\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cfilter id=\'noiseFilter\'%3E%3CfeTurbulence type=\'fractalNoise\' baseFrequency=\'0.65\' numOctaves=\'3\' stitchTiles=\'stitch\'/%3E%3C/filter%3E%3Crect width=\'100%25\' height=\'100%25\' filter=\'url(%23noiseFilter)\'/%3E%3C/svg%3E'); pointer-events: none;">
                            </div>

                            <div class="alert-header">
                                <div class="alert-badge">ADMIN MENSAGEM</div>
                                <div style="font-family: monospace; font-size: 9px; opacity: 0.4;">AGORA</div>
                            </div>

                            <div class="alert-content">
                                <h1 id="preview-title" class="alert-title">TÃ­tulo do Alerta</h1>
                                <p id="preview-message" class="alert-message">O conteÃºdo da mensagem aparecerÃ¡ aqui
                                    conforme vocÃª digita.</p>

                                <div id="preview-media" class="alert-media-container" style="display:none;">
                                    <!-- Media element injected here -->
                                </div>
                            </div>

                            <div class="alert-footer">
                                <button id="preview-btn" class="alert-btn alert-btn-primary">Entendido (Fechar)</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Management List -->
                <div class="admin-section" style="margin-top: 20px;">
                    <h3>Alertas Ativos</h3>
                    <div id="active-alerts-list" class="pinata-file-list">
                        <div style="padding: 15px; text-align: center; opacity: 0.5;">Carregando alertas...</div>
                    </div>
                </div>

                <!-- Paused Alerts List -->
                <div class="admin-section" style="margin-top: 20px; opacity: 0.8;">
                    <h3>Alertas Pausados</h3>
                    <div id="paused-alerts-list" class="pinata-file-list"
                        style="border: 1px dashed var(--border-color);">
                        <div style="padding: 15px; text-align: center; opacity: 0.5;">Nenhum alerta pausado.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>

    <!-- Add Time Modal (Standalone) -->
    <div id="add-time-modal" class="app-modal" style="z-index: 10001;">
        <div class="app-modal-content" style="max-width: 350px;">
            <span class="app-modal-close"
                onclick="document.getElementById('add-time-modal').style.display='none'">&times;</span>
            <div class="app-modal-header">
                <h2 class="app-modal-title">Adicionar Tempo</h2>
                <div style="font-size: 12px; color: var(--text-secondary);" id="add-time-target-user"></div>
            </div>
            <div class="app-modal-body">
                <div class="form-group">
                    <label class="form-label">Dias</label>
                    <input type="number" id="add-time-days" class="app-modal-input" value="0" placeholder="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Horas</label>
                    <input type="number" id="add-time-hours" class="app-modal-input" value="0" placeholder="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Minutos</label>
                    <input type="number" id="add-time-minutes" class="app-modal-input" value="0" placeholder="0">
                </div>
                <button class="app-modal-button" id="submit-add-time-btn">Adicionar Tempo</button>
            </div>
        </div>
    </div>

    <!-- Subscription Expired Modal (Standalone) -->
    <div id="subscription-expired-modal" class="cryo-overlay" style="display: none;">
        <div class="cryo-container">
            <div class="fluid-orb orb-1"></div>
            <div class="fluid-orb orb-2"></div>

            <div class="cryo-glass-card">
                <div class="scanline"></div>

                <div class="status-badge">
                    <span class="pulse-dot"></span>
                    <span class="mono-label">STATUS DA CONTA: SUSPENSA</span>
                </div>

                <div class="icon-container">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="cryo-icon">
                        <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.5" />
                        <path d="M12 3V5M12 19V21M3 12H5M19 12H21" stroke="currentColor" stroke-width="1.5"
                            stroke-linecap="round" />
                    </svg>
                </div>

                <h1 class="cryo-main-title" style="text-align: center;">Assinatura Expirada</h1>

                <p class="cryo-description" style="text-align: center;">
                    Entre em contato com nossa equipe para a renovaÃ§Ã£o.
                </p>

                <div class="support-module">
                    <div class="support-info">
                        <span class="mono-label-small">SUPORTE TÃ‰CNICO</span>
                        <span class="phone-number">(38) 9 9851-7363</span>
                    </div>
                    <div class="cryo-divider"></div>
                    <button class="action-trigger"
                        onclick="window.open('https://wa.me/5538998517363?text=Ol%C3%A1%2C%20gostaria%20de%20reativar%20o%20acesso%20da%20minha%20conta%20Axon.', '_blank')">
                        <span class="btn-text">REATIVAR ACESSO</span>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7" />
                        </svg>
                    </button>
                    <!-- Back to Login Button -->
                    <button class="action-trigger"
                        style="position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%;"
                        onclick="resetInteractiveTerminal(true); document.getElementById('subscription-expired-modal').style.display='none';">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>

                <div class="footer-meta">
                    <span class="mono-meta">AXON</span>
                </div>
            </div>
        </div>
    </div>
    <div id="prescription-helper-modal" class="app-modal">
        <div class="app-modal-content" style="max-width:600px"><span class="app-modal-close">&times;</span>
            <div class="app-modal-header">
                <h2 class="app-modal-title" id="prescription-helper-title">Assistente de PrescriÃ§Ã£o</h2>
            </div>
            <div class="app-modal-body" id="prescription-helper-body" style="text-align:left;overflow-y:auto"></div>
        </div>
    </div>
    <div id="chatbox-modal" class="chatbox-modal">
        <div class="chatbox-header"><i id="chatbox-new-chat-btn" class="fas fa-plus-circle chatbox-new-chat-btn"
                title="Nova Conversa"></i><span class="chatbox-title">Axon AI Chat</span><i id="chatbox-close-btn"
                class="fas fa-times chatbox-close-btn"></i></div>
        <div class="chatbox-messages" id="chatbox-messages"></div>
        <div class="chatbox-input-area">
            <div id="chat-image-previews" class="chat-image-previews"></div>
            <div class="chat-input-row"><input type="file" id="chat-file-input" accept="image/*" multiple="multiple"
                    style="display:none"><button id="chatbox-upload-btn" class="chatbox-upload-btn"><i
                        class="fas fa-camera"></i></button><input type="text" id="chatbox-input" class="chatbox-input"
                    placeholder="FaÃ§a uma pergunta..."><button id="chatbox-send-btn" class="chatbox-send-btn"><i
                        class="fas fa-paper-plane"></i></button></div>
        </div>
    </div>
    <div id="custom-confirm-modal" class="confirm-modal">
        <div class="confirm-modal-content">
            <p id="confirm-modal-text"></p>
            <div class="confirm-modal-buttons"><button id="confirm-btn-no" class="confirm-btn">Cancelar</button><button
                    id="confirm-btn-yes" class="confirm-btn">Confirmar</button></div>
        </div>
    </div>

    <!-- LOG SETTINGS MODAL -->
    <div id="log-settings-modal" class="app-modal">
        <div class="app-modal-content" style="max-width: 400px; text-align: center;">
            <span class="app-modal-close"
                onclick="document.getElementById('log-settings-modal').style.display='none'">&times;</span>
            <div class="app-modal-header">
                <h2 class="app-modal-title">ConfiguraÃ§Ãµes de Log</h2>
            </div>
            <div class="app-modal-body">
                <div
                    style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="font-size: 40px; margin-bottom: 15px; color: var(--prompt-color);">
                        <i class="fas fa-terminal"></i>
                    </div>
                    <p style="margin-bottom: 20px; font-size: 14px; opacity: 0.8;">
                        Gerencie quais mensagens aparecem no terminal. Ocultar logs tÃ©cnicos deixa a interface mais
                        limpa.
                    </p>

                    <div
                        style="display: flex; align-items: center; justify-content: space-between; background: var(--glass-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                        <span style="font-weight: bold;">Ocultar Logs TÃ©cnicos</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="modal-hide-status-toggle"
                                onchange="window.toggleLogSuppression(this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <button class="app-modal-button"
                    onclick="document.getElementById('log-settings-modal').style.display='none'">Fechar</button>
            </div>
        </div>
    </div>
    <div id="mobile-analysis-loader" class="mobile-loader">
        <div class="ai-processing-animation">
            <div class="scanner-animation">
                <div class="brain-icon"><i class="fas fa-brain"></i></div>
                <div class="scanner-line"></div>
            </div><span>Analisando Imagens...</span>
        </div>
    </div>
    <div id="transfer-modal" class="app-modal">
        <div class="app-modal-content"><span class="app-modal-close">&times;</span>
            <div class="app-modal-header">
                <h2 class="app-modal-title">TransferÃªncia de Arquivos</h2>
            </div>
            <div class="app-modal-body">
                <div id="transfer-drop-zone" class="transfer-drop-zone">
                    <div class="transfer-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <p>Arraste e solte arquivos aqui ou clique para selecionar</p>
                </div><input type="file" id="transfer-file-input" style="display:none" multiple>
                <div id="transfer-status" class="transfer-status"></div>
                <div id="transfer-progress-bar" class="progress-bar-container" style="display:none">
                    <div id="transfer-progress-fill" class="progress-bar-fill"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="transfer-notification" class="app-modal"
        style="display:none;align-items:center;justify-content:center;z-index:4000;">
        <div class="app-modal-content" style="max-width:400px;text-align:center;">
            <div class="app-modal-header">
                <h2 class="app-modal-title">Recebendo Arquivo</h2>
            </div>
            <div class="app-modal-body">
                <div style="font-size:50px;color:var(--highlight-color);margin-bottom:20px;"><i
                        class="fas fa-file-import"></i></div>
                <p id="transfer-notification-text" style="font-size:16px;margin-bottom:20px;">Baixando arquivo...
                </p>
                <div class="progress-bar-container">
                    <div id="transfer-notification-progress" class="progress-bar-fill"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="axon-cloud-modal" class="app-modal">
        <div class="app-modal-content"
            style="max-width:1000px;height:85vh;width:95%; display: flex; flex-direction: column;">
            <div class="app-modal-header">
                <div
                    style="display:flex; align-items: center; gap: 15px; flex: 1; overflow: hidden; margin-right: 15px;">
                    <h2 class="app-modal-title" style="white-space:nowrap;"><i class="fas fa-cloud"></i> Axon Cloud
                    </h2>
                    <div class="cloud-breadcrumb" id="cloud-breadcrumb" style="border: none; padding: 0;">
                        <div class="cloud-breadcrumb-item"><i class="fas fa-home"></i> InÃ­cio</div>
                    </div>
                </div>
                <span class="app-modal-close axon-cloud-close">&times;</span>
            </div>
            <div class="app-modal-body" style="padding:0;display:flex;flex-direction:column;flex:1;overflow:hidden;">
                <div class="cloud-container">
                    <div class="cloud-sidebar">
                        <div class="cloud-upload-drop" id="cloud-drop-zone"><i class="fas fa-cloud-upload-alt"
                                style="font-size:30px;"></i><span style="font-size: 11px;">Arraste e solte</span>
                        </div>

                        <div class="cloud-sidebar-item active" data-target="all"><i class="fas fa-server"></i> Todos
                        </div>
                        <div class="cloud-sidebar-item" data-target="images"><i class="fas fa-images"></i> Imagens
                        </div>
                        <div class="cloud-sidebar-item" data-target="videos"><i class="fas fa-video"></i> VÃ­deos
                        </div>
                        <div class="cloud-sidebar-item" data-target="docs"><i class="fas fa-file-alt"></i> Docs
                        </div>

                        <div style="margin-top:auto;">
                            <div class="storage-text"><span>Armazenamento</span><span id="cloud-storage-text">0 / 0
                                    GB</span></div>
                            <div class="storage-bar-container">
                                <div id="cloud-storage-bar" class="storage-bar-fill"></div>
                            </div>
                        </div>
                    </div>
                    <div class="cloud-main">
                        <div class="cloud-toolbar"><button class="patient-action-button" id="cloud-btn-upload"><i
                                    class="fas fa-upload"></i> Upload</button><button class="patient-action-button"
                                id="cloud-btn-new-folder"><i class="fas fa-folder-plus"></i> Nova
                                Pasta</button><button class="patient-action-button" id="cloud-btn-refresh"><i
                                    class="fas fa-sync-alt"></i></button>
                            <div style="margin-left: auto;">
                                <input type="text" id="cloud-search" class="admin-input" placeholder="Pesquisar..."
                                    style="width:200px;">
                            </div>
                        </div>
                        <div class="cloud-content-area" id="cloud-content-area">
                            <div class="cloud-grid" id="cloud-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Preview Modal -->
    <div id="file-preview-modal" class="preview-modal">
        <div class="preview-header">
            <span class="preview-title" id="preview-title">Nome do Arquivo</span>
            <div style="display: flex; gap: 10px;">
                <a id="preview-download-btn" href="#" download class="action-button"
                    style="text-decoration: none; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; border-radius: 50%;"><i
                        class="fas fa-download"></i></a>
                <button class="action-button"
                    onclick="document.getElementById('file-preview-modal').style.display='none'"
                    style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%;"><i
                        class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="preview-content" id="preview-content">
            <!-- Content injected via JS -->
        </div>
    </div>

    <!-- Custom Input Modal -->
    <div id="custom-input-modal" class="custom-modal">
        <div class="custom-modal-content">
            <span class="custom-modal-title" id="custom-input-title">TÃ­tulo</span>
            <p id="custom-input-message" style="font-size: 14px; opacity: 0.8;"></p>
            <input type="text" id="custom-input-field" class="custom-modal-input">
            <div class="custom-modal-actions">
                <button class="action-button" id="custom-input-cancel"
                    style="background: transparent; border: 1px solid var(--border-color);">Cancelar</button>
                <button class="action-button" id="custom-input-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Select Folder Modal -->
    <div id="select-folder-modal" class="custom-modal">
        <div class="custom-modal-content" style="max-height: 70vh; display: flex; flex-direction: column;">
            <span class="custom-modal-title">Mover para...</span>
            <div id="folder-list-container"
                style="overflow-y: auto; margin: 15px 0; border: 1px solid var(--border-color); border-radius: 8px; max-height: 300px; text-align: left;">
                <!-- Folder List Injected Here -->
            </div>
            <div class="custom-modal-actions">
                <button class="action-button" id="select-folder-cancel"
                    style="background: transparent; border: 1px solid var(--border-color);">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="cloud-context-menu" class="context-menu">
        <div class="context-menu-item" id="ctx-open"><i class="fas fa-external-link-alt"></i> Abrir</div>
        <div class="context-menu-item" id="ctx-download"><i class="fas fa-download"></i> Download</div>
        <div class="context-menu-item" id="ctx-copy"><i class="fas fa-copy"></i> Copiar</div>
        <div class="context-menu-item" id="ctx-rename"><i class="fas fa-edit"></i> Renomear</div>
        <div class="context-menu-item" id="ctx-move"><i class="fas fa-arrows-alt"></i> Mover para...</div>
        <div class="context-menu-item" id="ctx-delete" style="color:var(--error-color);"><i class="fas fa-trash"></i>
            Excluir</div>
    </div>

    <div id="cloud-bg-context-menu" class="context-menu">
        <div class="context-menu-item" id="ctx-bg-new-folder"><i class="fas fa-folder-plus"></i> Nova Pasta</div>
        <div class="context-menu-item" id="ctx-bg-new-text"><i class="fas fa-file-alt"></i> Novo Arquivo de Texto
        </div>
        <div class="context-menu-item" id="ctx-bg-paste"><i class="fas fa-paste"></i> Colar</div>
        <div class="context-menu-item" id="ctx-bg-upload"><i class="fas fa-upload"></i> Upload</div>
    </div>

    <!-- Plugin Manager Modal -->
    <div id="plugin-manager-modal" class="app-modal">
        <div class="plugin-modal-content">
            <div class="app-modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                <div style="display:flex; align-items:center; gap: 10px;">
                    <h2 class="app-modal-title"><i class="fas fa-cubes"></i> Ferramentas & Plugins</h2>
                    <div
                        style="display:flex; background: var(--input-bg); border-radius: 20px; padding: 2px; margin-left: 20px;">
                        <button class="monitor-toggle-button active" id="tab-installed-plugins"
                            onclick="window.axonPluginManager.switchTab('installed')">Instalados</button>
                        <button class="monitor-toggle-button" id="tab-axon-store"
                            onclick="window.axonPluginManager.switchTab('store')">Axon Store</button>
                    </div>
                </div>
                <span class="app-modal-close"
                    onclick="document.getElementById('plugin-manager-modal').style.display='none'">&times;</span>
            </div>

            <!-- Installed Tab -->
            <div id="view-installed-plugins" class="app-modal-body" style="padding: 0; display: block;">
                <div id="installed-plugins-list" class="plugin-grid">
                    <!-- Plugins injected here -->
                </div>
                <div id="no-plugins-msg" style="text-align:center; padding: 50px; opacity: 0.6; display: none;">
                    <i class="fas fa-box-open" style="font-size: 40px; margin-bottom: 15px;"></i>
                    <p>Nenhum plugin instalado.</p>
                    <button class="confirmation-btn" onclick="window.axonPluginManager.switchTab('store')"
                        style="margin-top:10px; background: var(--highlight-color); border:none; color:white; padding:8px 15px; border-radius:6px; cursor:pointer;">Ir
                        para Loja</button>
                </div>
            </div>

            <!-- Store Tab -->
            <div id="view-axon-store" class="app-modal-body" style="padding: 0; display: none;">
                <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; gap: 10px;">
                    <input type="text" id="store-search" class="admin-input" placeholder="Buscar na Axon Store..."
                        style="flex:1;" oninput="window.axonPluginManager.renderStore()">
                </div>
                <div id="store-plugins-list" class="plugin-grid">
                    <!-- Store Items injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Text Editor Modal -->
    <div id="text-editor-modal" class="text-editor-modal">
        <div class="text-editor-content">
            <div class="text-editor-header">
                <div class="text-editor-title" id="text-editor-title">Editar Arquivo</div>
                <div style="display:flex; gap:10px;">
                    <button class="action-button" id="text-editor-save"
                        style="border-radius:8px; width:auto; padding:0 15px; font-size:14px;"><i class="fas fa-save"
                            style="margin-right:5px;"></i> Salvar</button>
                    <button class="action-button" id="text-editor-close"
                        style="width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:50%;"><i
                            class="fas fa-times"></i></button>
                </div>
            </div>
            <textarea id="text-editor-textarea" class="text-editor-textarea"></textarea>
            <div style="font-size:12px; color:var(--text-color); opacity:0.7; text-align:right;"
                id="text-editor-status"></div>
        </div>
    </div>
    <script type="module">import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, doc, getDoc, setDoc, updateDoc, deleteDoc, getDocs, where, increment, writeBatch, collectionGroup, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA4bis9CVQkl1eJDfezsvUKTx1X_kFVT4M",
            authDomain: "axon-91d0b.firebaseapp.com",
            projectId: "axon-91d0b",
            storageBucket: "axon-91d0b.firebasestorage.app",
            messagingSenderId: "701115983749",
            appId: "1:701115983749:web:9a57928b678918ffbb86ec"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Expose to window for external scripts (Mobile 2.0 IIFE)
        window.db = db;
        window.deleteDoc = deleteDoc;
        window.addDoc = addDoc; // Exposed for Alert System
        window.doc = doc;
        window.collection = collection;
        window.query = query; // Exposed for Alert System
        window.where = where; // Exposed for Alert System
        window.orderBy = orderBy; // Exposed for Alert System
        window.onSnapshot = onSnapshot;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.deleteField = deleteField;

        // Expose Auth similarly to legacy SDK for compatibility
        const auth = getAuth(app);
        window.auth = auth;
        window.firebase = {
            auth: () => auth
        };

        const commandInput = document.getElementById('command-input');
        const interactiveOutput = document.getElementById('interactive-output');
        const anamnesisPreview = document.getElementById('anamnesis-preview');
        const examsResultsPreview = document.getElementById('exams-results-preview');
        const axonEyeResultsPreview = document.getElementById('axon-eye-results-preview');
        const apiStatus = document.getElementById('api-status');
        const micStatus = document.getElementById('mic-status');
        const cameraStatus = document.getElementById('camera-status');

        const monitorCopyBtn = document.getElementById('monitor-copy-btn');
        const logoutButton = document.getElementById('logout-button');
        const settingsButton = document.getElementById('settings-button');
        const themeToggleButton = document.getElementById('theme-toggle');

        const cameraModal = document.getElementById('camera-modal');
        const cameraModalTitle = document.getElementById('camera-modal-title');
        const cameraVideo = document.getElementById('camera-video');
        const cameraCanvas = document.getElementById('camera-canvas');
        const captureButton = document.getElementById('capture-button');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const sendExamsButton = document.getElementById('send-exams-button');
        const sendAxonEyeButton = document.getElementById('send-axon-eye-button');
        const cancelCameraButton = document.getElementById('cancel-camera-button');
        const cameraSwitchButton = document.getElementById('camera-switch-button');
        const flashlightButton = document.getElementById('flashlight-button');
        const cameraCloseBtn = document.getElementById('camera-close-btn');

        const toggleAnamnesisButton = document.getElementById('toggle-anamnesis');
        const toggleExamsButton = document.getElementById('toggle-exams');
        const toggleAxonEyeButton = document.getElementById('toggle-axon-eye');

        const fullscreenModal = document.getElementById('fullscreen-modal');
        const modalImage = document.getElementById('modal-image');
        const modalClose = document.getElementsByClassName('modal-close')[0];

        const albumButton = document.getElementById('album-button');
        const albumCount = document.getElementById('album-count');
        const albumModal = document.getElementById('album-modal');
        const albumModalClose = albumModal.querySelector('.album-modal-close');
        const albumGrid = document.getElementById('album-grid');

        const btnExames = document.getElementById('btn-exames');
        const btnSee = document.getElementById('btn-see');
        const btnHd = document.getElementById('btn-hd');
        const btnCd = document.getElementById('btn-cd');
        const btnMic = document.getElementById('btn-mic');
        const btnRecords = document.getElementById('btn-records');
        const btnClear = document.getElementById('btn-clear');

        const patientListModal = document.getElementById('patient-list-modal');
        const patientList = document.getElementById('patient-list');
        const patientListClose = patientListModal.querySelector('.patient-list-close');
        const patientDetailsModal = document.getElementById('patient-details-modal');
        const patientDetailsTitle = document.getElementById('patient-details-title');
        const patientDetailsBody = document.getElementById('patient-details-body');
        const patientDetailsClose = patientDetailsModal.querySelector('.patient-details-close');
        const patientSearchInput = document.getElementById('patient-search-input');
        const btnSaveFromList = document.getElementById('btn-save-from-list');

        const loginModal = document.getElementById('login-modal');
        const loginModalUser = document.getElementById('login-modal-user');
        const loginModalPass = document.getElementById('login-modal-pass');
        const loginModalButton = document.getElementById('login-modal-button');
        const loginModalFeedback = document.getElementById('login-modal-feedback');

        const savePatientModal = document.getElementById('save-patient-modal');
        const savePatientNameInput = document.getElementById('save-patient-name');
        const savePatientDobInput = document.getElementById('save-patient-dob');
        const savePatientButton = document.getElementById('save-patient-button');
        const savePatientFeedback = document.getElementById('save-patient-feedback');
        const savePatientModalClose = savePatientModal.querySelector('.app-modal-close');

        const adminAuthModal = document.getElementById('admin-auth-modal');
        const adminAuthPass = document.getElementById('admin-auth-pass');
        const adminAuthButton = document.getElementById('admin-auth-button');
        const adminAuthFeedback = document.getElementById('admin-auth-feedback');
        const adminAuthClose = adminAuthModal.querySelector('.app-modal-close');

        const adminPanelModal = document.getElementById('admin-panel-modal');
        const adminPanelClose = adminPanelModal.querySelector('.app-modal-close');
        const adminSettingsBody = document.getElementById('admin-settings-body');
        const adminDebugBody = document.getElementById('admin-debug-body');
        const adminUsersList = document.getElementById('admin-users-list');
        const adminUserDetails = document.getElementById('admin-user-details');
        const adminUserSearch = document.getElementById('admin-user-search');
        const adminTabButtons = document.querySelectorAll('.admin-tab-btn');
        const disconnectAllUsersBtn = document.getElementById('disconnect-all-users-btn');

        const prescriptionHelperModal = document.getElementById('prescription-helper-modal');
        const prescriptionHelperTitle = document.getElementById('prescription-helper-title');
        const prescriptionHelperBody = document.getElementById('prescription-helper-body');
        const prescriptionHelperClose = prescriptionHelperModal.querySelector('.app-modal-close');

        const statusTextApi = document.querySelector('.status-text-api');
        const statusTextMic = document.querySelector('.status-text-mic');
        const statusTextCam = document.querySelector('.status-text-cam');

        // Mobile 2.0 Elements
        const mobileContainer = document.getElementById('mobile-2-0-container');
        const mobileWelcomeTitle = document.getElementById('mobile-welcome-title');
        const mobileBtnExames = document.getElementById('mobile-btn-exames');
        const mobileBtnSee = document.getElementById('mobile-btn-see');

        const mobileBtnChat = document.getElementById('mobile-btn-chat');
        const chatboxModal = document.getElementById('chatbox-modal');
        const chatboxCloseBtn = document.getElementById('chatbox-close-btn');
        const chatboxNewChatBtn = document.getElementById('chatbox-new-chat-btn');
        const chatboxMessages = document.getElementById('chatbox-messages');
        const chatboxInput = document.getElementById('chatbox-input');
        const chatboxSendBtn = document.getElementById('chatbox-send-btn');
        const chatboxUploadBtn = document.getElementById('chatbox-upload-btn');
        const chatFileInput = document.getElementById('chat-file-input');
        const chatImagePreviews = document.getElementById('chat-image-previews');

        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const mobileAnalysisLoader = document.getElementById('mobile-analysis-loader');

        // Transfer Elements
        const btnTransferFile = document.getElementById('btn-transfer-file');
        const btnCloud = document.getElementById('btn-cloud');
        const transferModal = document.getElementById('transfer-modal');
        const transferModalClose = transferModal.querySelector('.app-modal-close');
        const transferDropZone = document.getElementById('transfer-drop-zone');
        const transferFileInput = document.getElementById('transfer-file-input');
        const transferStatus = document.getElementById('transfer-status');
        const transferProgressBar = document.getElementById('transfer-progress-bar');
        const transferProgressFill = document.getElementById('transfer-progress-fill');
        const transferNotification = document.getElementById('transfer-notification');
        const transferNotificationText = document.getElementById('transfer-notification-text');
        const transferNotificationProgress = document.getElementById('transfer-notification-progress');


        let isListening = false;
        let isLoggedIn = false;
        let isUserBlocked = false;
        let isCloudDisabled = false;
        let currentUser = null;
        let recognition = null;
        let audioStream = null;
        let anamnesis = {
            qp: "", hma: "", hp: "", hf: "", hps: "",
            hgo: "", ha: "",
            ectoscopia: "",
            dados_vitais: "",
            exame_fisico: { scv: "", sr: "", sd: "", dermatologico: "" }
        };
        let examsResults = "";
        let axonEyeResults = "";
        let lastAnamnesisInfo = "";
        // let isCloudDisabled = false; // This was already here, but the instruction was to add it. I'll keep the one I added above with other state variables.
        let apiConnectionStatus = "Desconhecido";
        let unsubscribeSnapshot = null;
        let lastClearTimestamp = 0;
        let unsubscribeUserDoc = null;
        let unsubscribeSettings = null;
        let unsubscribeTransfer = null;
        let cameraStream = null;
        let capturedImages = [];
        let temporaryImgurUploads = [];
        let currentCameraFacingMode = 'environment';
        let currentMonitorView = 'anamnesis';
        let isFlashlightOn = false;
        let cameraMode = 'exams';
        const isMobileDevice = () => /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isMobile = isMobileDevice();
        window.isMobile = isMobile; // Expose to window for IIFE accessibility
        let allPatients = [];
        let conversationHistory = [];
        let adminUsersData = [];
        let chatImagesToSend = [];
        let desktopHeartbeatInterval = null;
        let expiryCheckInterval = null;
        let axonCloud = null;
        let deviceId = localStorage.getItem('axon_device_id');
        if (!deviceId) {
            deviceId = 'device_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('axon_device_id', deviceId);
        }

        const defaultApiKeys = [
            '',
            '',
            ''
        ];
        const defaultApiModels = [
            { id: 1, name: 'gemini-2.0-flash', vision: true },
            { id: 2, name: 'gemini-flash-lite-latest', vision: true },
            { id: 3, name: 'gemini-2.5-flash', vision: true },
            { id: 4, name: 'gemini-2.5-pro', vision: true },
            { id: 5, name: 'gemini-1.5-pro', vision: true },
            { id: 6, name: 'gemini-1.5-flash', vision: true }
        ];
        const openRouterModels = [
            { name: 'amazon/nova-2-lite-v1:free', vision: false },
            { name: 'arcee-ai/trinity-mini:free', vision: false },
            { name: 'tngtech/deepseek-r1t-chimera:free', vision: false },
            { name: 'allenai/olmo-3-32b-think:free', vision: false },
            { name: 'kwaipilot/kat-coder-pro:free', vision: false },
            { name: 'nvidia/nemotron-nano-12b-v2-vl:free', vision: true },
            { name: 'alibaba/tongyi-deepresearch-30b-a3b:free', vision: false },
            { name: 'meituan/longcat-flash-chat:free', vision: false },
            { name: 'nvidia/nemotron-nano-9b-v2:free', vision: true },
            { name: 'openai/gpt-oss-120b', vision: false },
            { name: 'openai/gpt-oss-20b', vision: false },
            { name: 'z-ai/glm-4.5-air', vision: false },
            { name: 'qwen/qwen3-coder-480b-a35b-07-25:free', vision: false },
            { name: 'moonshotai/kimi-k2:free', vision: false },
            { name: 'cognitivecomputations/dolphin-mistral-24b-venice-edition:free', vision: false }, // Uncensored (free)
            { name: 'google/gemma-3n-e2b-it:free', vision: false },
            { name: 'google/gemini-2.0-flash-exp:free', vision: true },
            { name: 'xiaomi/mimo-v2-flash:free', vision: false }
        ];
        const groqModels = []; // Deprecated in favor of dynamic fetching


        let globalSettings = window.globalSettings = {
            apiKeys: [...defaultApiKeys],
            apiModels: [...defaultApiModels],
            mode: 'automatic',
            manualTextModel: '',
            manualVisionModel: '',
            manualApiKey: '',
            apiProvider: 'gemini',
            openRouterKey: '',
            groqKey: '',
            groqModel: 'llama-3.3-70b-versatile',
            mobile2_0_enabled: true,
            customTextProvider: 'gemini',
            customTextProvider: 'gemini',
            customVisionProvider: 'gemini',
            pinataKeys: [
                { key: "", secret: "" }
            ],
            bridgePermissions: {
                sendToChat: true,
                callAI: true,
                getAnamnesis: true,
                storage: true
            }
        };

        let currentApiKeyIndex = 0;
        let currentAIModel = 'gemini-2.0-flash';
        let currentVisionAIModel = 'gemini-2.5-flash-lite';
        const IMGUR_CLIENT_ID = '546c25a59c58ad7';

        // Pinata Constants
        // Pinata Constants removed in favor of globalSettings.pinataKeys

        const setTheme = (theme) => {
            localStorage.setItem('theme', theme);
            const icon = themeToggleButton.querySelector('i');
            const themeColorMeta = document.getElementById('theme-color-meta');
            const statusBarStyleMeta = document.getElementById('status-bar-style-meta');

            if (theme === 'light') {
                document.body.classList.add('light-mode');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                if (themeColorMeta) themeColorMeta.setAttribute('content', '#f0f9ff');
                if (statusBarStyleMeta) statusBarStyleMeta.setAttribute('content', 'default');
            } else { // dark mode
                document.body.classList.remove('light-mode');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                if (themeColorMeta) themeColorMeta.setAttribute('content', '#1a202c');
                if (statusBarStyleMeta) statusBarStyleMeta.setAttribute('content', 'black-translucent');
            }
        };

        const toggleTheme = () => {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        };

        const getGeminiUrl = (modelName, apiKey) => `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        const validCommands = [
            '/exit', '/hear on', '/hear off', '/hd', '/cd', '/copy',
            '/ia', '/help', '/clear', '/api', '/api-set', '/register', '/exames', '/see', '/ask', '/delete', '/pdf', '/load', '/users'
        ];

        const isSpeechRecognitionSupported = () => 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;

        const initSpeechRecognition = () => {
            if (!isSpeechRecognitionSupported()) {
                appendOutput("Reconhecimento de voz nÃ£o suportado neste navegador.", "error");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'pt-BR';

            recognition.onstart = () => {
                isListening = true;
                micStatus.classList.remove('status-off');
                btnMic.classList.add('active');
                btnMic.innerHTML = '<i class="fas fa-microphone"></i>';
                appendOutput("Microfone ativado. Gravando consulta...", "success");
                if (isLoggedIn && currentUser) {
                    updateMonitorStateInFirestore(currentUser, { activeView: 'anamnesis' });
                }
            };

            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript;

                if (transcript.trim()) {
                    appendOutput(`[Voz] ${transcript}`, "info");
                    processAnamnesisInfo(transcript);
                }
            };

            recognition.onerror = (event) => {
                appendOutput(`Erro no reconhecimento de voz: ${event.error}`, "error");
                stopListening();
            };

            recognition.onend = () => {
                if (isListening) {
                    recognition.start();
                }
            };
        };

        const toggleListening = () => {
            if (!isListening) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        audioStream = stream;
                        recognition.start();
                    })
                    .catch(err => {
                        appendOutput(`PermissÃ£o de microfone negada: ${err.message}`, "error");
                    });
            } else {
                stopListening();
            }
        };

        const stopListening = () => {
            if (recognition) {
                recognition.stop();
            }
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
            isListening = false;
            micStatus.classList.add('status-off');
            btnMic.classList.remove('active');
            btnMic.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            appendOutput("Microfone desativado.", "info");
        };

        const appendOutput = (text, type = "output", logToFirebase = true) => {
            const interactiveOutput = document.getElementById('interactive-output');
            if (!interactiveOutput) return;

            // Define phrases to hide if the setting is enabled
            const hiddenPhrases = [
                "tentando motor",
                "sucesso com motor",
                "verificando status",
                "motor conectado",
                "chave #",
                "status da api",
                "gemini",
                "groq",
                "openai",
                "anthropic",
                "llama",
                "conectando",
                "resposta vazia",
                "erro na chamada",
                "falha ao conectar"
            ];

            // Check debug filter
            // Check debug filter and tag message
            let isTechnicalLog = false;
            // Check if text contains any hidden phrase
            if (hiddenPhrases.some(phrase => text.toLowerCase().includes(phrase))) {
                isTechnicalLog = true;
            }

            const outputElement = document.createElement('div');
            outputElement.classList.add('command-output');

            if (type === "command") {
                outputElement.innerHTML = `<span class="prompt">></span> <span class="command">${text}</span>`;
            } else if (type === "error") {
                outputElement.innerHTML = `<span class="error">${text}</span>`;
            } else if (type === "success") {
                outputElement.innerHTML = `<span class="success">${text}</span>`;
            } else if (type === "info") {
                outputElement.innerHTML = `<span class="info">${text}</span>`;
            } else if (type === "highlight") {
                outputElement.classList.add('blocked-msg');
                outputElement.textContent = text;
            }
            else {
                outputElement.innerHTML = `<span class="${type}">${text}</span>`;
            }

            if (isTechnicalLog) {
                outputElement.classList.add('technical-log');
            }

            interactiveOutput.appendChild(outputElement);
            interactiveOutput.scrollTop = interactiveOutput.scrollHeight;

            if (logToFirebase && isLoggedIn && currentUser) {
                logInteractionToFirebase(currentUser, text, type, 'interactive');
            }
        };

        const resetInteractiveTerminal = (requireLogin = false) => {
            const elementsToKeep = [];
            Array.from(interactiveOutput.children).forEach(child => {
                if (!elementsToKeep.includes(child) && !child.classList.contains('terminal-logo-internal')) {
                    child.remove();
                }
            });



            if (requireLogin) {
                isLoggedIn = false;
                isUserBlocked = false;
                isCloudDisabled = false;
                currentUser = null;
                localStorage.removeItem('axon_logged_in_user');
                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot();
                    unsubscribeSnapshot = null;
                }
                if (unsubscribeUserDoc) {
                    unsubscribeUserDoc();
                    unsubscribeUserDoc = null;
                }
                if (unsubscribeTransfer) {
                    unsubscribeTransfer();
                    unsubscribeTransfer = null;
                }

                loginModal.style.display = 'flex';
                loginModalUser.focus();
            } else {

            }
            interactiveOutput.scrollTop = interactiveOutput.scrollHeight;
        };

        const performSessionClear = async () => {
            // Immediate invalidation to prevent race conditions
            lastClearTimestamp = Date.now();

            // Reset local state immediately
            anamnesis = {
                qp: "", hma: "", hp: "", hf: "", hps: "",
                hgo: "", ha: "",
                ectoscopia: "",
                dados_vitais: "",
                exame_fisico: { scv: "", sr: "", sd: "", dermatologico: "" }
            };
            examsResults = ""; axonEyeResults = ""; conversationHistory = [];
            lastAnamnesisInfo = "";

            updateAnamnesisPreview(false);
            updateExamsResultsPreview(false);
            updateAxonEyeResultsPreview(false);

            // Clear captured images (Monitor/Album)
            capturedImages = [];
            updateAlbumCount();
            renderAlbum();

            // Force clear preview content
            if (axonEyeResultsPreview) axonEyeResultsPreview.innerHTML = '';

            // Close Patient Details Modal to remove lingering "Saved Patient" images from screen
            if (patientDetailsModal) patientDetailsModal.style.display = 'none';
            if (patientListModal) patientListModal.style.display = 'none';

            await clearTemporaryUploads();

            if (currentUser) {
                const userRef = doc(db, "sessions", currentUser);
                const resetData = {
                    anamnesis: {
                        qp: "", hma: "", hp: "", hf: "", hps: "",
                        hgo: "", ha: "",
                        ectoscopia: "",
                        dados_vitais: "",
                        exame_fisico: { scv: "", sr: "", sd: "", dermatologico: "" }
                    },
                    examsResults: "",
                    axonEyeResults: "",
                    axonEyeImages: [], // Clear images from Firestore session
                    conversationHistory: [],
                    isAnalyzing: { status: false, type: null }
                };
                try {
                    await updateDoc(userRef, resetData);
                } catch (e) {
                    console.error("Erro ao limpar sessÃ£o no Firestore:", e);
                }
            }

            if (window.clearFreeModeData) await window.clearFreeModeData();

            resetInteractiveTerminal(false);
            appendOutput("SessÃ£o limpa.", "success");
        };

        // Expose to window for external calls
        window.resetInteractiveTerminal = resetInteractiveTerminal;

        const resetSession = async () => {
            await performSessionClear();
        };

        const logoutUser = async () => {
            appendOutput("Fazendo logout...", "info", false);
            if (desktopHeartbeatInterval) {
                clearInterval(desktopHeartbeatInterval);
                desktopHeartbeatInterval = null;
            }
            if (expiryCheckInterval) {
                clearInterval(expiryCheckInterval);
                expiryCheckInterval = null;
            }
            await clearTemporaryUploads();
            if (currentUser) {
                try {
                    await deleteDoc(doc(db, "sessions", currentUser));
                } catch (e) {
                    console.error("Could not delete session doc on logout:", e);
                }
            }
            if (unsubscribeUserDoc) {
                unsubscribeUserDoc();
                unsubscribeUserDoc = null;
            }
            if (unsubscribeTransfer) {
                unsubscribeTransfer();
                unsubscribeTransfer = null;
            }
            stopListening();
            resetInteractiveTerminal(true);
        };

        const updateAnamnesisPreview = (logToFirebase = true) => {
            const hasValue = (val) => val && val !== "Nenhuma" && val.trim() !== "";

            let previewHTML = `
                <div class="anamnesis-content">
                    <div class="section-title">Queixa Principal (QP):</div>
                    <div>${anamnesis.qp || "Ainda nÃ£o informado."}</div><br>
                    <div class="section-title">HistÃ³ria da MolÃ©stia Atual (HMA):</div>
                    <div>${anamnesis.hma || "Ainda nÃ£o informado."}</div><br>
                    <div class="section-title">HistÃ³ria PatolÃ³gica (HP):</div>
                    <div>${anamnesis.hp || "Ainda nÃ£o informado."}</div><br>
                    <div class="section-title">HistÃ³ria Familiar (HF):</div>
                    <div>${anamnesis.hf || "Ainda nÃ£o informado."}</div><br>
                    <div class="section-title">HistÃ³ria Psicossocial (HPS):</div>
                    <div>${anamnesis.hps || "Ainda nÃ£o informado."}</div>
                    
                    ${hasValue(anamnesis.hgo) ? `<br><div class="section-title">HistÃ³ria Gineco-obstÃ©trica (HGO):</div><div>${anamnesis.hgo}</div>` : ''}
                    ${hasValue(anamnesis.ha) ? `<br><div class="section-title">HistÃ³ria Alimentar (HA):</div><div>${anamnesis.ha}</div>` : ''}

                    <div style="margin: 15px 0; border-top: 1px solid var(--border-color); opacity: 0.3;"></div>

                    <div class="section-title">ECTOSCOPIA:</div>
                    <div>${anamnesis.ectoscopia || "Ainda nÃ£o informado."}</div><br>

                    <div class="section-title">DADOS VITAIS:</div>
                    <div>${anamnesis.dados_vitais || "Ainda nÃ£o informado."}</div><br>

                    <div class="section-title">EXAME FÃSICO:</div>
                    <div style="padding-left: 10px;">
                        <div><span style="font-weight:600; opacity:0.8;">SCV:</span> ${anamnesis.exame_fisico?.scv || "NÃ£o informado"}</div>
                        <div><span style="font-weight:600; opacity:0.8;">SR:</span> ${anamnesis.exame_fisico?.sr || "NÃ£o informado"}</div>
                        <div><span style="font-weight:600; opacity:0.8;">SD:</span> ${anamnesis.exame_fisico?.sd || "NÃ£o informado"}</div>
                        ${hasValue(anamnesis.exame_fisico?.dermatologico) ? `<div><span style="font-weight:600; opacity:0.8; color:var(--highlight-color);">DermatolÃ³gico:</span> ${anamnesis.exame_fisico.dermatologico}</div>` : ''}
                    </div>
                </div>`;
            anamnesisPreview.innerHTML = previewHTML;
            if (logToFirebase && isLoggedIn && currentUser) {
                saveAnamnesisToFirestore(currentUser, anamnesis);
            }
        };

        const updateExamsResultsPreview = (logToFirebase = true) => {
            let formattedResults = '';
            if (examsResults) {
                formattedResults = examsResults.split('\n')
                    .filter(line => line.trim() !== '')
                    .map(line => {
                        if (/\((Alterado|Anormal)\)/i.test(line)) {
                            const cleanLine = line.replace(/\((Alterado|Anormal)\)/gi, '').trim();
                            return `<div class="output">${cleanLine} <span class="altered-text">(Alterado)</span></div>`;
                        }
                        return `<div class="output">${line.trim()}</div>`;
                    }).join('');
            }
            examsResultsPreview.innerHTML = `<div class="section-title">RESULTADOS DOS EXAMES:</div>${formattedResults || '<div class="info">Nenhum exame analisado ainda.</div>'}`;
            if (logToFirebase && isLoggedIn && currentUser) {
                saveExamsResultsToFirestore(currentUser, examsResults);
            }
        };

        const updateAxonEyeResultsPreview = (logToFirebase = true) => {
            let formattedResults = '';
            let imageHtml = '';
            if (temporaryImgurUploads.length > 0) {
                imageHtml = `<div class="patient-images-grid" style="margin-top: 15px;">`;
                temporaryImgurUploads.forEach(img => {
                    imageHtml += `<div class="patient-image-item"><img src="${img.link}" class="patient-image" onclick="openFullscreenModal('${img.link}')" alt="Imagem Analisada"></div>`;
                });
                imageHtml += `</div>`;
            }
            if (axonEyeResults) {
                const boldedResults = axonEyeResults.replace(/\*(.*?)\*/g, '<b>$1</b>');
                const impressionRegex = /(ImpressÃ£o DiagnÃ³stica|InterpretaÃ§Ã£o ClÃ­nica|DiagnÃ³sticos Diferenciais):\s*(.*)/i;
                let match = boldedResults.match(impressionRegex);
                if (match) {
                    const title = match[1];
                    const content = match[2].trim();
                    const preText = boldedResults.substring(0, match.index).trim();
                    const postText = boldedResults.substring(match.index + match[0].length).trim();
                    formattedResults += `<div class="output">${preText.split('\n').map(line => line.trim()).filter(line => line).join('<br>')}</div>`;
                    formattedResults += `<div class="axon-eye-title">${title}</div>`;
                    formattedResults += `<div class="output">${content}</div>`;
                    formattedResults += `<div class="output">${postText.split('\n').map(line => line.trim()).filter(line => line).join('<br>')}</div>`;
                } else {
                    formattedResults = boldedResults.split('\n').filter(line => line.trim() !== '').map(line => `<div class="output">${line.trim()}</div>`).join('');
                }
            }
            axonEyeResultsPreview.innerHTML = `<div class="section-title">ANÃLISE AXON EYE:</div>${formattedResults || '<div class="info">Nenhuma anÃ¡lise visual feita ainda.</div>'}${imageHtml}`;
            if (logToFirebase && isLoggedIn && currentUser) {
                saveAxonEyeResultsToFirestore(currentUser, axonEyeResults);
            }
        };

        const toggleMonitorView = (view, fromRemote = false) => {
            currentMonitorView = view;
            anamnesisPreview.style.display = 'none';
            examsResultsPreview.style.display = 'none';
            axonEyeResultsPreview.style.display = 'none';

            // This logic is for classic mode only
            if (!isMobile || !globalSettings.mobile2_0_enabled) {
                if (view === 'camera' && !fromRemote) {
                    cameraModal.style.display = 'flex';
                } else {
                    cameraModal.style.display = 'none';
                    stopCameraStreamOnly();
                }
            }

            toggleAnamnesisButton.classList.remove('active');
            toggleExamsButton.classList.remove('active');
            toggleAxonEyeButton.classList.remove('active');
            if (view === 'anamnesis') {
                anamnesisPreview.style.display = 'block';
                toggleAnamnesisButton.classList.add('active');
            } else if (view === 'exams') {
                examsResultsPreview.style.display = 'block';
                toggleExamsButton.classList.add('active');
            } else if (view === 'axon-eye') {
                axonEyeResultsPreview.style.display = 'block';
                toggleAxonEyeButton.classList.add('active');
            }
            if (!fromRemote && isLoggedIn && currentUser) {
                updateMonitorStateInFirestore(currentUser, { activeView: view });
            }
        };

        const incrementUserUsage = async (type) => {
            if (!currentUser || !isLoggedIn) return;
            const userRef = doc(db, "users", currentUser);
            try {
                const updateData = {};
                if (type === 'text') {
                    updateData.textRequests = increment(1);
                } else if (type === 'vision') {
                    updateData.visionRequests = increment(1);
                }
                await updateDoc(userRef, updateData);
            } catch (e) {
                console.error("Erro ao incrementar uso do usuÃ¡rio:", e);
            }
        };

        const compressImage = (base64Str, maxWidth = 1024, quality = 0.7) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = (error) => reject(error);
            });
        };

        const callOpenRouterAPI = async (prompt, images = []) => {
            const modelName = globalSettings.openRouterModel || 'x-ai/grok-4.1-fast:free';
            const apiKey = globalSettings.openRouterKey;

            appendOutput(`Conectando via OpenRouter (${modelName})...`, "info", false);

            try {
                let messages = [];

                if (images.length > 0) {
                    const contentArray = [
                        { type: "text", text: prompt }
                    ];

                    images.forEach(img => {
                        contentArray.push({
                            type: "image_url",
                            image_url: { url: img }
                        });
                    });

                    messages = [{ role: "user", content: contentArray }];
                } else {
                    messages = [{ role: "user", content: prompt }];
                }

                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                        "X-Title": "Axon A.I"
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: messages
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content;
                    if (content) {
                        await incrementUserUsage(images.length > 0 ? 'vision' : 'text');
                        if (!globalSettings.hideStatusMessages) {
                            appendOutput(`Sucesso via OpenRouter.`, "success", false);
                        }
                        return content;
                    }
                    throw new Error("Resposta vazia do OpenRouter.");
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `Erro OpenRouter: ${response.status}`);
                }
            } catch (e) {
                console.error("Erro na chamada OpenRouter:", e);
                throw e;
            }
        };

        const callGroqAPI = async (prompt, images = []) => {
            const isVision = images.length > 0;
            const modelName = isVision
                ? (globalSettings.groqVisionModel || 'llama-3.2-90b-vision-preview')
                : (globalSettings.groqTextModel || 'llama-3.3-70b-versatile');

            const apiKey = globalSettings.groqKey;

            appendOutput(`Conectando via Groq (${modelName})...`, "info", false);

            try {
                let messages = [];

                if (images.length > 0) {
                    appendOutput(`Comprimindo ${images.length} imagem(ns) para envio...`, "info", false);
                    const compressedImages = await Promise.all(images.map(img => compressImage(img, 1024, 0.7)));

                    const contentArray = [
                        { type: "text", text: prompt }
                    ];

                    compressedImages.forEach(img => {
                        contentArray.push({
                            type: "image_url",
                            image_url: {
                                url: img
                            }
                        });
                    });

                    messages = [{ role: "user", content: contentArray }];
                } else {
                    messages = [{ role: "user", content: prompt }];
                }

                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: messages,
                        temperature: 1,
                        max_tokens: 8192,
                        top_p: 1,
                        stream: false,
                        stop: null
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content;
                    if (content) {
                        await incrementUserUsage(images.length > 0 ? 'vision' : 'text');
                        appendOutput(`Sucesso via Groq.`, "success", false);
                        return content;
                    }
                    throw new Error("Resposta vazia do Groq.");
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `Erro Groq: ${response.status}`);
                }
            } catch (e) {
                console.error("Erro na chamada Groq:", e);
                throw e;
            }
        };

        window.toggleUserCloudAccess = async (username, shouldDisable) => {
            try {
                const userRef = doc(db, "users", username);
                await updateDoc(userRef, { isCloudDisabled: shouldDisable });
                // Optimistic update
                const userIdx = adminUsersData.findIndex(u => u.username === username);
                if (userIdx !== -1) {
                    adminUsersData[userIdx].isCloudDisabled = shouldDisable;
                    window.selectAdminUser(username); // Re-render details
                }
            } catch (e) {
                console.error("Erro ao alterar acesso cloud:", e);
                alert("Erro ao alterar acesso cloud: " + e.message);
            }
        };

        const getRandomPinataKey = () => {
            const keys = globalSettings.pinataKeys;
            if (!keys || keys.length === 0) return null;
            return keys[Math.floor(Math.random() * keys.length)];
        };

        const unpinFromPinata = async (ipfsHash) => {
            if (!globalSettings.pinataKeys || globalSettings.pinataKeys.length === 0) return false;

            for (const key of globalSettings.pinataKeys) {
                try {
                    const response = await fetch(`https://api.pinata.cloud/pinning/unpin/${ipfsHash}`, {
                        method: 'DELETE',
                        headers: {
                            'pinata_api_key': key.key,
                            'pinata_secret_api_key': key.secret
                        }
                    });
                    if (response.ok) return true;
                } catch (e) { console.error("Unpin failed with key", key, e); }
            }
            return false;
        };

        const uploadToPinata = async (file, onProgress) => {
            let keys = [];
            if (globalSettings.pinataKeys && globalSettings.pinataKeys.length > 0) {
                keys = globalSettings.pinataKeys;
            } else {
                const k = getRandomPinataKey();
                if (k) keys.push(k);
            }

            if (keys.length === 0) return Promise.reject(new Error("Nenhuma chave Pinata configurada."));

            let lastError = null;

            // Try each key
            for (const pinataKey of keys) {
                try {
                    return await new Promise((resolve, reject) => {
                        const url = `https://api.pinata.cloud/pinning/pinFileToIPFS`;
                        const data = new FormData();
                        data.append('file', file);

                        const xhr = new XMLHttpRequest();
                        xhr.upload.addEventListener("progress", (event) => {
                            if (event.lengthComputable && onProgress) {
                                const percentComplete = (event.loaded / event.total) * 100;
                                onProgress(percentComplete);
                            }
                        });

                        xhr.onload = () => {
                            if (xhr.status === 200) {
                                const result = JSON.parse(xhr.responseText);
                                resolve({ ipfsHash: result.IpfsHash, pinataKey: pinataKey });
                            } else {
                                reject(new Error(`Erro Pinata (${xhr.status}): ${xhr.statusText}`));
                            }
                        };
                        xhr.onerror = () => reject(new Error("Erro de rede no upload para Pinata."));
                        xhr.open("POST", url);
                        xhr.setRequestHeader("pinata_api_key", pinataKey.key);
                        xhr.setRequestHeader("pinata_secret_api_key", pinataKey.secret);
                        xhr.send(data);
                    });
                } catch (e) {
                    console.warn(`Upload falhou com a chave ${pinataKey.label || 'Standard'}:`, e);
                    lastError = e;
                    // Continue to next key
                }
            }

            // If all failed
            // Update UI with error badge if needed?
            const errorBadge = document.getElementById('api-error-badge');
            if (errorBadge) errorBadge.style.display = 'block'; // Assuming we create this element somewhere or user creates it?
            // User asked: "Display an exclamation badge for APIs that encounter these errors."
            // I should inject the Logic for the badge here or globally.
            // Let's assume a generic badge toggler function or ID.
            updateSystemStatus('pinata', 'error');
            throw lastError || new Error("Falha no upload com todas as chaves.");
        };

        const updateSystemStatus = (type, status) => {
            // Simple implementation
            const badge = document.getElementById('system-status-badge'); // Allow user to style this later
            if (status === 'error' && badge) {
                badge.style.display = 'flex';
                badge.title = "Erro no sistema (" + type + ")";
            }
        };

        const callGeminiAPI = async (prompt) => {
            let provider = globalSettings.apiProvider;
            if (provider === 'custom') {
                provider = globalSettings.customTextProvider || 'gemini';
            }

            if (provider === 'openrouter') {
                return await callOpenRouterAPI(prompt);
            }
            if (provider === 'groq') {
                return await callGroqAPI(prompt);
            }

            let strategyModels = [];
            let keysToTry = [];

            if (globalSettings.mode === 'manual') {
                if (globalSettings.manualTextModel && globalSettings.manualApiKey) {
                    strategyModels = [globalSettings.manualTextModel];
                    keysToTry = [globalSettings.manualApiKey];
                } else {
                    throw new Error("Modo manual ativo, mas modelo ou chave nÃ£o configurados.");
                }
            } else {
                const preferredOrder = ['gemini-2.0-flash', 'gemini-flash-lite-latest', 'gemini-2.5-flash', 'gemini-2.5-pro'];
                const availableModelNames = globalSettings.apiModels.map(m => m.name);
                const activePreferred = preferredOrder.filter(name => availableModelNames.includes(name));
                const others = availableModelNames.filter(name => !preferredOrder.includes(name));
                strategyModels = [...activePreferred, ...others];
                keysToTry = globalSettings.apiKeys;
            }

            let lastError = null;

            for (const modelName of strategyModels) {
                for (let i = 0; i < keysToTry.length; i++) {
                    const keyIndex = (currentApiKeyIndex + i) % keysToTry.length;
                    const apiKeyToTry = keysToTry[keyIndex];

                    if (!isMobile || !globalSettings.mobile2_0_enabled) {
                        appendOutput(`Tentando motor ${modelName} (Chave #${keyIndex + 1})...`, "info", false);
                    }

                    try {
                        const url = getGeminiUrl(modelName, apiKeyToTry);
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (globalSettings.mode === 'automatic') {
                                currentApiKeyIndex = keyIndex;
                            }
                            await incrementUserUsage('text');
                            if (!isMobile || !globalSettings.mobile2_0_enabled) {
                                appendOutput(`Sucesso com motor ${modelName}.`, "success", false);
                            }
                            return data.candidates?.[0]?.content?.parts?.[0]?.text || "NÃ£o foi possÃ­vel obter uma resposta.";
                        }

                        const errorData = await response.json().catch(() => ({ error: { message: `HTTP error! status: ${response.status}` } }));
                        lastError = new Error(errorData.error?.message || `Erro desconhecido (${response.status})`);
                        console.warn(`Falha com motor ${modelName} chave ${keyIndex}: ${lastError.message}`);

                    } catch (error) {
                        lastError = error;
                        console.warn(`Falha de rede motor ${modelName} chave ${keyIndex}: ${error.message}`);
                    }
                }
            }

            console.error("Erro final na chamada da API de texto:", lastError);
            throw lastError || new Error("Todas as tentativas de chaves e motores falharam.");
        };

        const callVisionAPI = async (imageUrls, prompt) => {
            let provider = globalSettings.apiProvider;
            if (provider === 'custom') {
                provider = globalSettings.customVisionProvider || 'gemini';
            }

            if (provider === 'openrouter') {
                return await callOpenRouterAPI(prompt, imageUrls);
            }
            if (provider === 'groq') {
                return await callGroqAPI(prompt, imageUrls);
            }

            let strategyModels = [];
            let keysToTry = [];

            if (globalSettings.mode === 'manual') {
                if (globalSettings.manualVisionModel && globalSettings.manualApiKey) {
                    strategyModels = [globalSettings.manualVisionModel];
                    keysToTry = [globalSettings.manualApiKey];
                } else {
                    throw new Error("Modo manual ativo, mas modelo de visÃ£o ou chave nÃ£o configurados.");
                }
            } else {
                const preferredOrder = ['gemini-2.0-flash', 'gemini-flash-lite-latest', 'gemini-2.5-flash', 'gemini-2.5-pro'];
                const availableModelNames = globalSettings.apiModels.filter(m => m.vision).map(m => m.name);

                const activePreferred = preferredOrder.filter(name => availableModelNames.includes(name));
                const others = availableModelNames.filter(name => !preferredOrder.includes(name));

                strategyModels = [...activePreferred, ...others];
                keysToTry = globalSettings.apiKeys;
            }

            let lastError = null;

            for (const modelName of strategyModels) {
                const imageParts = imageUrls.map(url => ({ inlineData: { mimeType: 'image/jpeg', data: url.split(',')[1] } }));
                const textPart = { text: prompt };

                for (let i = 0; i < keysToTry.length; i++) {
                    const keyIndex = (currentApiKeyIndex + i) % keysToTry.length;
                    const apiKeyToTry = keysToTry[keyIndex];

                    if (!isMobile || !globalSettings.mobile2_0_enabled) {
                        appendOutput(`Tentando motor de visÃ£o ${modelName} (Chave #${keyIndex + 1})...`, "info", false);
                    }

                    try {
                        const url = getGeminiUrl(modelName, apiKeyToTry);
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [...imageParts, textPart] }] })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (globalSettings.mode === 'automatic') {
                                currentApiKeyIndex = keyIndex;
                            }
                            await incrementUserUsage('vision');
                            if (!isMobile || !globalSettings.mobile2_0_enabled) {
                                appendOutput(`Sucesso com motor de visÃ£o ${modelName}.`, "success", false);
                            }
                            return data.candidates?.[0]?.content?.parts?.[0]?.text || "NÃ£o foi possÃ­vel obter uma resposta da anÃ¡lise de imagem.";
                        }

                        const errorData = await response.json().catch(() => ({ error: { message: `HTTP error! status: ${response.status}` } }));
                        lastError = new Error(errorData.error?.message || `Erro desconhecido na API de VisÃ£o (${response.status})`);
                        console.warn(`Falha visÃ£o motor ${modelName} chave ${keyIndex}: ${lastError.message}`);

                    } catch (error) {
                        lastError = error;
                        console.warn(`Falha de rede visÃ£o motor ${modelName} chave ${keyIndex}: ${error.message}`);
                    }
                }
            }

            console.error("Erro final na chamada da API de visÃ£o:", lastError);
            throw lastError || new Error("Todas as tentativas de chaves e motores de visÃ£o falharam.");
        };

        const processAnamnesisInfo = async (info) => {
            lastAnamnesisInfo = info;
            const prompt = `VocÃª Ã© um assistente mÃ©dico especialista em semiologia. Sua tarefa Ã© redigir uma anamnese mÃ©dica profissional e estruturar o exame fÃ­sico, organizando as informaÃ§Ãµes fornecidas em seÃ§Ãµes adequadas. A anamnese deve ser bem redigida, coesa e utilizar termos mÃ©dicos apropriados.

            Contexto da consulta atual (informaÃ§Ãµes existentes):
            - QP (Queixa Principal): "${anamnesis.qp || "Nenhuma"}"
            - HMA (HistÃ³ria da MolÃ©stia Atual): "${anamnesis.hma || "Nenhuma"}"
            - HP (HistÃ³ria PatolÃ³gica): "${anamnesis.hp || "Nenhuma"}"
            - HF (HistÃ³ria Familiar): "${anamnesis.hf || "Nenhuma"}"
            - HPS (HistÃ³ria Psicossocial): "${anamnesis.hps || "Nenhuma"}"
            - HGO (HistÃ³ria Gineco-obstÃ©trica): "${anamnesis.hgo || "Nenhuma"}"
            - HA (HistÃ³ria Alimentar): "${anamnesis.ha || "Nenhuma"}"
            
            - ECTOSCOPIA: "${anamnesis.ectoscopia || "Nenhuma"}"
            - DADOS VITAIS: "${anamnesis.dados_vitais || "Nenhuma"}"

            - EXAME FÃSICO:
              -- SCV (Cardiovascular): "${anamnesis.exame_fisico?.scv || "Nenhuma"}"
              -- SR (RespiratÃ³rio): "${anamnesis.exame_fisico?.sr || "Nenhuma"}"
              -- SD (Digestivo): "${anamnesis.exame_fisico?.sd || "Nenhuma"}"
              -- DermatolÃ³gico: "${anamnesis.exame_fisico?.dermatologico || "Nenhuma"}"

            Nova informaÃ§Ã£o recebida (diÃ¡logo mÃ©dico-paciente): "${info}"

            InstruÃ§Ãµes cruciais:
            1.  **Analise o contexto completo**: Considere tanto as informaÃ§Ãµes existentes quanto a "nova informaÃ§Ã£o recebida" para construir a anamnese mais precisa.
            2.  **Ordene logicamente**: Integre a nova informaÃ§Ã£o Ã  seÃ§Ã£o apropriada (QP, HMA, HP, HF, HPS, HGO, HA, Ectoscopia, Dados Vitais, Exame FÃ­sico).
            3.  **Seja Fiel ao ConteÃºdo**: NÃƒO adicione, invente ou presuma informaÃ§Ãµes que nÃ£o foram explicitamente ditas.
            4.  **Distinga os interlocutores**: Extraia APENAS as respostas e relatos do paciente ou observaÃ§Ãµes ditadas pelo mÃ©dico. Ignore perguntas.
            5.  **Atualize, nÃ£o substitua**: Integre a nova informaÃ§Ã£o Ã  seÃ§Ã£o apropriada, complementando o que jÃ¡ existe.
            6.  **Filtro Rigoroso**: Ignore saudaÃ§Ãµes e conversas nÃ£o clÃ­nicas.
            7.  **Exame FÃ­sico**:
                - Separe em SCV, SR, SD.
                - **DermatolÃ³gico**: Preencha APENAS se houver descriÃ§Ã£o explÃ­cita de lesÃµes de pele ou anexos. Caso contrÃ¡rio, deixe como string vazia.

            Formato da Resposta: Retorne EXCLUSIVAMENTE um objeto JSON com a seguinte estrutura:
            {
               "qp": "...",
               "hma": "...",
               "hp": "...",
               "hf": "...",
               "hps": "...",
               "hgo": "...",
               "ha": "... (descreva hÃ¡bitos alimentares se citados)",
               "ectoscopia": "... (estado geral, fÃ¡cies, atitude, etc)",
               "dados_vitais": "... (PA, FC, FR, Temp, SatO2 - se citados)",
               "exame_fisico": {
                   "scv": "...",
                   "sr": "...",
                   "sd": "...",
                   "dermatologico": "..." (ou vazio)
               }
            }`;
            try {
                const callTimestamp = Date.now();
                const response = await callGeminiAPI(prompt);

                if (callTimestamp < lastClearTimestamp) {
                    console.warn("Ignorando resposta da IA pois a sessÃ£o foi limpa.");
                    return;
                }

                const jsonStart = response.indexOf('{');
                const jsonEnd = response.lastIndexOf('}') + 1;
                const jsonString = response.substring(jsonStart, jsonEnd);
                const updatedAnamnesis = JSON.parse(jsonString);

                // Merge logic to ensure we don't lose sub-objects if AI sends partial
                anamnesis = {
                    qp: updatedAnamnesis.qp || anamnesis.qp || "",
                    hma: updatedAnamnesis.hma || anamnesis.hma || "",
                    hp: updatedAnamnesis.hp || anamnesis.hp || "",
                    hf: updatedAnamnesis.hf || anamnesis.hf || "",
                    hps: updatedAnamnesis.hps || anamnesis.hps || "",
                    hgo: updatedAnamnesis.hgo || anamnesis.hgo || "",
                    ha: updatedAnamnesis.ha || anamnesis.ha || "",
                    ectoscopia: updatedAnamnesis.ectoscopia || anamnesis.ectoscopia || "",
                    dados_vitais: updatedAnamnesis.dados_vitais || anamnesis.dados_vitais || "",
                    exame_fisico: {
                        scv: updatedAnamnesis.exame_fisico?.scv || anamnesis.exame_fisico?.scv || "",
                        sr: updatedAnamnesis.exame_fisico?.sr || anamnesis.exame_fisico?.sr || "",
                        sd: updatedAnamnesis.exame_fisico?.sd || anamnesis.exame_fisico?.sd || "",
                        dermatologico: updatedAnamnesis.exame_fisico?.dermatologico || anamnesis.exame_fisico?.dermatologico || ""
                    }
                };
                updateAnamnesisPreview();
                appendOutput("Anamnese e Exame FÃ­sico atualizados.", "success");
            } catch (error) {
                appendOutput(`Erro ao atualizar a anamnese: ${error.message}.`, "error");
            }
        };

        const generateDiagnosticHypotheses = async () => {
            const prompt = `Com base na anamnese: ${JSON.stringify(anamnesis)}, nos exames: ${examsResults || "Nenhum"}, e na anÃ¡lise visual: ${axonEyeResults || "Nenhuma"}, liste as hipÃ³teses diagnÃ³sticas em ordem de probabilidade. Seja tÃ©cnico e resumido. Formate palavras importantes ou tÃ­tulos com asteriscos (ex: *HipÃ³tese Principal*). Retorne apenas a lista.`;
            try {
                const response = await callGeminiAPI(prompt);
                const boldedResponse = response.replace(/\*(.*?)\*/g, '<b>$1</b>');
                const formattedDiagnosis = boldedResponse.split('\n').filter(item => item.trim()).map(item => `<div class="diagnosis-item">${item.trim()}</div>`).join('');
                appendOutput(`<div class="conduct-title">HIPÃ“TESES DIAGNÃ“STICAS:</div>${formattedDiagnosis}`, "output");
            } catch (error) {
                appendOutput(`Erro ao gerar hipÃ³teses: ${error.message}`, "error");
            }
        };

        const generateMedicalConduct = async () => {
            const prompt = `Com base na anamnese: ${JSON.stringify(anamnesis)}, exames: ${examsResults || "Nenhum"}, e anÃ¡lise visual: ${axonEyeResults || "Nenhuma"}, proponha uma conduta mÃ©dica completa. Formate palavras importantes ou tÃ­tulos com asteriscos (ex: *MedicaÃ§Ã£o Sugerida*).
Use EXATAMENTE os seguintes tÃ­tulos para cada seÃ§Ã£o, na ordem apresentada, mesmo que a seÃ§Ã£o nÃ£o tenha conteÃºdo: 
1. CONDUTA FARMACOLÃ“GICA (SUS):
2. EXAMES COMPLEMENTARES (SUS):
3. CONDUTAS NÃƒO FARMACOLÃ“GICAS (SUS):
4. RECOMENDAÃ‡Ã•ES:
Seja tÃ©cnico, objetivo e resumido.`;
            try {
                const response = await callGeminiAPI(prompt);
                const boldedResponse = response.replace(/\*(.*?)\*/g, '<b>$1</b>');
                const formattedConduct = boldedResponse
                    .replace(/(?:<[bB]>\s*)?(?:[\d\.]+\s*)?[\*#]*\s*CONDUTA\s+FARMACOLÃ“GICA(?:\s*\(SUS\))?[\s\:\*#]*(?:<\/[bB]>)?/gi, '<div class="conduct-title" data-category="CONDUTA FARMACOLÃ“GICA (SUS)">CONDUTA FARMACOLÃ“GICA (SUS): <span style="font-size: 11px; opacity: 0.7; font-weight: normal; margin-left: 5px;">(Clique para ver conduta pronta)</span></div>')
                    .replace(/(?:<[bB]>\s*)?(?:[\d\.]+\s*)?[\*#]*\s*EXAMES\s+COMPLEMENTARES(?:\s*\(SUS\))?[\s\:\*#]*(?:<\/[bB]>)?/gi, '<div class="conduct-title" data-category="EXAMES COMPLEMENTARES (SUS)">EXAMES COMPLEMENTARES (SUS): <span style="font-size: 11px; opacity: 0.7; font-weight: normal; margin-left: 5px;">(Clique para ver conduta pronta)</span></div>')
                    .replace(/(?:<[bB]>\s*)?(?:[\d\.]+\s*)?[\*#]*\s*CONDUTAS\s+NÃƒO\s+FARMACOLÃ“GICAS(?:\s*\(SUS\))?[\s\:\*#]*(?:<\/[bB]>)?/gi, '<div class="conduct-title" data-category="CONDUTAS NÃƒO FARMACOLÃ“GICAS (SUS)">CONDUTAS NÃƒO FARMACOLÃ“GICAS (SUS): <span style="font-size: 11px; opacity: 0.7; font-weight: normal; margin-left: 5px;">(Clique para ver conduta pronta)</span></div>')
                    .replace(/(?:<[bB]>\s*)?(?:[\d\.]+\s*)?[\*#]*\s*RECOMENDAÃ‡Ã•ES[\s\:\*#]*(?:<\/[bB]>)?/gi, '<div class="conduct-title" data-category="RECOMENDAÃ‡Ã•ES">RECOMENDAÃ‡Ã•ES:</div>')
                    .split('\n').map(line => {
                        const cleanedLine = line.trim().replace(/^\d+\.\s*/, '');
                        if (cleanedLine === '' || line.includes('<div')) return line;
                        return `<div class="conduct-item">${cleanedLine}</div>`;
                    }).join('');
                appendOutput(formattedConduct, "output");
            } catch (error) {
                appendOutput(`Erro ao gerar conduta: ${error.message}`, "error");
            }
        };

        const askQuestionBasedOnContext = async (question) => {
            conversationHistory.push({ role: 'user', parts: [{ text: question }] });
            const simplifiedHistory = conversationHistory.map(item => `${item.role}: ${item.parts[0].text}`).join('\n');

            const prompt = `**InstruÃ§Ã£o de Persona:** VocÃª Ã© o AXON, um assistente mÃ©dico de IA. Seu usuÃ¡rio Ã© um mÃ©dico qualificado. Responda de forma concisa, direta e tÃ©cnica, sem usar frases de cautela como "consulte um especialista" ou "isso nÃ£o Ã© um diagnÃ³stico". O mÃ©dico jÃ¡ sabe disso. Seu objetivo Ã© ser um assistente rÃ¡pido e eficiente. Use o contexto clÃ­nico fornecido para dar respostas mais relevantes. Formate palavras importantes ou tÃ­tulos com asteriscos (ex: *DiagnÃ³stico Diferencial*), que serÃ£o renderizados em negrito.

**Contexto ClÃ­nico Atual:**
- **Anamnese:** ${anamnesis && Object.values(anamnesis).some(v => v) ? JSON.stringify(anamnesis) : "Nenhuma informaÃ§Ã£o."}
- **AnÃ¡lise Visual (Axon Eye):** ${axonEyeResults || "Nenhuma informaÃ§Ã£o."}

**HistÃ³rico da Conversa:**
${simplifiedHistory}

**Pergunta do MÃ©dico:** "${question}"

Responda diretamente Ã  pergunta.`;

            try {
                const response = await callGeminiAPI(prompt);
                conversationHistory.push({ role: 'model', parts: [{ text: response }] });
                return response;
            } catch (error) {
                console.error("Erro em askQuestionBasedOnContext:", error);
                throw error;
            }
        };

        const askVisionQuestionBasedOnContext = async (question, images) => {
            const imageParts = images.map(url => ({ inlineData: { mimeType: 'image/jpeg', data: url.split(',')[1] } }));
            conversationHistory.push({ role: 'user', parts: [{ text: question }, ...imageParts] });

            const simplifiedHistory = conversationHistory.map(item => {
                const textPart = item.parts.find(p => p.text);
                return `${item.role}: ${textPart ? textPart.text : '[Imagem enviada]'}`;
            }).join('\n');

            const prompt = `**InstruÃ§Ã£o de Persona:** VocÃª Ã© o AXON, um assistente mÃ©dico de IA. Seu usuÃ¡rio Ã© um mÃ©dico qualificado. Ele enviou ${images.length} imagem(ns) junto com uma pergunta. Analise as imagens e responda de forma concisa, direta e tÃ©cnica, sem usar frases de cautela. Use o contexto clÃ­nico se for relevante. Formate palavras importantes com asteriscos (ex: *LesÃ£o sugestiva de...*).

**Contexto ClÃ­nico Atual:**
- **Anamnese:** ${anamnesis && Object.values(anamnesis).some(v => v) ? JSON.stringify(anamnesis) : "Nenhuma informaÃ§Ã£o."}
- **AnÃ¡lise Visual (Axon Eye) PrÃ©via:** ${axonEyeResults || "Nenhuma informaÃ§Ã£o."}

**HistÃ³rico da Conversa:**
${simplifiedHistory}

**Pergunta do MÃ©dico (referente Ã (s) imagem(ns) enviada(s) agora):** "${question}"

Analise a(s) imagem(ns) e responda diretamente Ã  pergunta.`;

            try {
                const response = await callVisionAPI(images, prompt);
                conversationHistory.push({ role: 'model', parts: [{ text: response }] });
                return response;
            } catch (error) {
                console.error("Erro em askVisionQuestionBasedOnContext:", error);
                throw error;
            }
        };

        const copyMonitorContent = () => {
            let contentToCopy = "";
            if (currentMonitorView === 'anamnesis') contentToCopy = anamnesisPreview.innerText;
            else if (currentMonitorView === 'exams') contentToCopy = examsResultsPreview.innerText.replace("RESULTADOS DOS EXAMES:", "").trim();
            else if (currentMonitorView === 'axon-eye') contentToCopy = axonEyeResultsPreview.innerText.replace("ANÃLISE AXON EYE:", "").trim();
            navigator.clipboard.writeText(contentToCopy).then(() => appendOutput("ConteÃºdo copiado.", "success"), () => appendOutput("Erro ao copiar.", "error"));
        };

        const checkApiStatus = async (modelName = currentAIModel) => {
            let keysToTest = [];
            let modelToTest = modelName;

            let provider = globalSettings.apiProvider;
            if (provider === 'custom') {
                provider = globalSettings.customTextProvider || 'gemini';
            }

            if (provider === 'openrouter') {
                try {
                    const response = await fetch("https://openrouter.ai/api/v1/auth/key", {
                        method: "GET",
                        headers: { "Authorization": `Bearer ${globalSettings.openRouterKey}` }
                    });
                    if (response.ok) {
                        apiConnectionStatus = "Conectado (OpenRouter)";
                        apiStatus.classList.remove('status-off');
                        return true;
                    }
                    throw new Error("Chave OpenRouter invÃ¡lida");
                } catch (e) {
                    apiConnectionStatus = "Offline (OpenRouter)";
                    apiStatus.classList.add('status-off');
                    return false;
                }
            }

            if (provider === 'groq') {
                try {
                    const response = await fetch("https://api.groq.com/openai/v1/models", {
                        method: "GET",
                        headers: { "Authorization": `Bearer ${globalSettings.groqKey}` }
                    });
                    if (response.ok) {
                        apiConnectionStatus = "Conectado (Groq)";
                        apiStatus.classList.remove('status-off');
                        return true;
                    }
                    throw new Error("Chave Groq invÃ¡lida");
                } catch (e) {
                    apiConnectionStatus = "Offline (Groq)";
                    apiStatus.classList.add('status-off');
                    return false;
                }
            }

            if (globalSettings.mode === 'manual') {
                keysToTest = [globalSettings.manualApiKey || ''];
                modelToTest = globalSettings.manualTextModel || modelName;
            } else {
                keysToTest = globalSettings.apiKeys;
            }

            if (keysToTest.length === 0 || !keysToTest[0]) {
                apiConnectionStatus = "Sem chaves configuradas";
                apiStatus.classList.add('status-off');
                return false;
            }

            const isVision = globalSettings.apiModels.find(m => m.name === modelToTest)?.vision;
            let requestBody;

            if (isVision) {
                const dummyImagePart = { inlineData: { mimeType: 'image/png', data: 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=' } };
                requestBody = JSON.stringify({ contents: [{ parts: [dummyImagePart, { text: "ping" }] }] });
            } else {
                requestBody = JSON.stringify({ contents: [{ parts: [{ text: "ping" }] }] });
            }

            for (let i = 0; i < keysToTest.length; i++) {
                const apiKey = keysToTest[i];
                try {
                    const url = getGeminiUrl(modelToTest, apiKey);
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: requestBody,
                        signal: AbortSignal.timeout(5000)
                    });

                    if (response.ok) {
                        apiConnectionStatus = "Conectado";
                        apiStatus.classList.remove('status-off');

                        if (globalSettings.mode === 'automatic') {
                            currentApiKeyIndex = i;
                        }
                        return true;
                    }
                } catch (error) {
                    console.warn(`Falha ao testar chave ${i} no status check: ${error.message}`);
                }
            }

            apiConnectionStatus = "Offline (Todas as chaves falharam)";
            apiStatus.classList.add('status-off');
            return false;
        };

        const initializeAIModel = async () => {
            if (isMobile && globalSettings.mobile2_0_enabled) return;
            appendOutput("Verificando status da API...", "info", false);

            if (globalSettings.mode === 'manual') {
                currentAIModel = globalSettings.manualTextModel || currentAIModel;
                currentVisionAIModel = globalSettings.manualVisionModel || currentVisionAIModel;
            } else {
                currentAIModel = 'gemini-2.0-flash';
                currentVisionAIModel = 'gemini-2.0-flash';
            }

            let textModelOK = await checkApiStatus(currentAIModel);
            let providerName = globalSettings.apiProvider.charAt(0).toUpperCase() + globalSettings.apiProvider.slice(1);
            if (globalSettings.apiProvider === 'gemini') {
                providerName = currentAIModel;
            }

            if (textModelOK) appendOutput(`Motor conectado (${providerName}).`, "success", false);
            else appendOutput(`Falha ao conectar motor: ${apiConnectionStatus}.`, "error", false);
        };

        const logInteractionToFirebase = async (username, content, type, terminal) => { try { await addDoc(collection(db, "sessions", username, "interactions"), { content, type, terminal, timestamp: new Date() }); } catch (e) { console.error("Erro no log Firebase: ", e); } };
        const saveAnamnesisToFirestore = async (username, data) => { try { await setDoc(doc(db, "sessions", username), { anamnesis: data, lastUpdated: new Date() }, { merge: true }); } catch (e) { console.error("Erro ao salvar anamnese: ", e); } };
        const saveExamsResultsToFirestore = async (username, data) => { try { await setDoc(doc(db, "sessions", username), { examsResults: data, lastUpdated: new Date() }, { merge: true }); } catch (e) { console.error("Erro ao salvar exames: ", e); } };
        const saveAxonEyeResultsToFirestore = async (username, data) => { try { await setDoc(doc(db, "sessions", username), { axonEyeResults: data, lastUpdated: new Date() }, { merge: true }); } catch (e) { console.error("Erro ao salvar Axon Eye: ", e); } };
        const updateMonitorStateInFirestore = async (username, state) => { try { await setDoc(doc(db, "sessions", username), { monitorState: { ...state, lastUpdated: new Date() } }, { merge: true }); } catch (e) { console.error("Erro ao salvar estado do monitor: ", e); } };

        const setAnalyzingStateInFirestore = async (isAnalyzing, analysisType = null) => {
            if (!isLoggedIn || !currentUser) return;
            try {
                await setDoc(doc(db, "sessions", currentUser), {
                    isAnalyzing: { status: isAnalyzing, type: analysisType }
                }, { merge: true });
            } catch (e) {
                console.error("Erro ao atualizar estado de anÃ¡lise:", e);
            }
        };

        const objectsAreEqual = (obj1, obj2) => {
            const keys1 = Object.keys(obj1);
            const keys2 = Object.keys(obj2);
            if (keys1.length !== keys2.length) return false;
            for (let key of keys1) {
                if (obj1[key] !== obj2[key]) return false;
            }
            return true;
        };

        const getDesktopInfo = () => {
            const ua = navigator.userAgent;
            let os = 'OS Desconhecido';
            let browser = 'Navegador Desconhecido';

            // OS Detection
            if (navigator.appVersion.indexOf("Win") != -1) os = "Windows";
            if (navigator.appVersion.indexOf("Mac") != -1) os = "macOS";
            if (navigator.appVersion.indexOf("X11") != -1) os = "UNIX";
            if (navigator.appVersion.indexOf("Linux") != -1) os = "Linux";

            // Browser Detection
            if (ua.toLowerCase().indexOf("axon") !== -1) {
                browser = `Axon USB App`;
            } else if (ua.indexOf("Edg/") !== -1) {
                browser = `Edge ${ua.split('Edg/')[1].split(' ')[0]}`;
            } else if (ua.indexOf("Firefox/") !== -1) {
                browser = `Firefox ${ua.split('Firefox/')[1].split(' ')[0]}`;
            } else if (ua.indexOf("Chrome/") !== -1 && ua.indexOf("Safari/") !== -1 && ua.indexOf("OPR/") === -1) {
                browser = `Chrome ${ua.split('Chrome/')[1].split(' ')[0]}`;
            } else if (ua.indexOf("Safari/") !== -1 && ua.indexOf("Chrome/") === -1) {
                browser = `Safari ${ua.split('Version/')[1].split(' ')[0]}`;
            }

            return { os, browser, userAgent: ua };
        };

        const updateMobileConnectionStatus = (desktopData) => {
            const mobileStatusEl = document.querySelector('.mobile-connection-status');
            if (!mobileStatusEl) return;

            const dot = mobileStatusEl.querySelector('.status-dot');
            const text = mobileStatusEl.querySelector('span');

            const isConnected = desktopData && desktopData.timestamp && (new Date() - desktopData.timestamp.toDate() < 30000);

            dot.classList.toggle('status-on', isConnected);
            if (isConnected) {
                const isAxon = (desktopData.userAgent && desktopData.userAgent.toLowerCase().includes('axon')) || (desktopData.browser && desktopData.browser.toLowerCase().includes('axon'));
                if (isAxon) {
                    text.innerHTML = `<span style="color: #68d391; border: 1px solid #68d391; padding: 2px 6px; border-radius: 4px; font-weight: bold; background: rgba(104, 211, 145, 0.1);">CONECTADO VIA UNIDADE AXON USB</span>`;
                } else {
                    text.textContent = `Conectado em desktop: ${desktopData.os} - ${desktopData.browser}`;
                }
            } else {
                text.textContent = 'Nenhum desktop conectado';
            }
        };

        const setupTransferListener = (username) => {
            if (unsubscribeTransfer) unsubscribeTransfer();
            const transfersRef = collection(db, "sessions", username, "transfers");
            unsubscribeTransfer = onSnapshot(transfersRef, (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === "added" || change.type === "modified") {
                        const data = change.doc.data();

                        // Ignora arquivos enviados por mim mesmo
                        if (data.senderId === deviceId) return;

                        if (data.status === 'complete') {
                            // Mostra notificaÃ§Ã£o de recebimento
                            transferNotification.style.display = 'flex';

                            // Adjust popup for mobile if needed (handled by CSS, but ensure visible logic is fine)
                            if (isMobile) {
                                transferNotification.classList.add('mobile-center');
                            }

                            if (data.type === 'pinata') {
                                transferNotificationText.textContent = `Baixando ${data.filename} via Axon Share Pro...`;
                                try {
                                    // Fetch blob from Gateway
                                    const gatewayUrl = `https://gateway.pinata.cloud/ipfs/${data.ipfsHash}`;
                                    const response = await fetch(gatewayUrl);
                                    if (!response.ok) throw new Error("Falha ao baixar do IPFS");

                                    const blob = await response.blob();
                                    const downloadUrl = window.URL.createObjectURL(blob);

                                    const link = document.createElement('a');
                                    link.href = downloadUrl;
                                    link.download = data.filename;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    window.URL.revokeObjectURL(downloadUrl);

                                    transferNotificationText.textContent = "ConcluÃ­do!";
                                    transferNotificationProgress.style.width = '100%';

                                    // Create ephemeral cleanup task or notify sender? 
                                    // Sender is cleaner. But if sender is offline?
                                    // Rule: "apÃ³s ser baixado no outro dispositivo o arquivo deve ser apagado do pinata"
                                    // Receiver triggers the unpin via a signal back or if keys allow, unpin directly.
                                    // Since we have keys on client (as per user request), we can unpin from here too or ask sender.
                                    // Let's try unpinning directly since we share the keys.
                                    await unpinFromPinata(data.ipfsHash);

                                    await deleteDoc(change.doc.ref);

                                } catch (e) {
                                    console.error("Erro download Pinata:", e);
                                    transferNotificationText.textContent = "Erro no download Pro.";
                                    transferNotificationText.style.color = "var(--error-color)";
                                }
                            } else {
                                // Default Firebase Method
                                transferNotificationText.textContent = `Baixando ${data.filename}...`;
                                try {
                                    let base64Data = "";
                                    if (data.chunkCount && data.chunkCount > 0) {
                                        // Reassembling chunks
                                        const chunksRef = collection(db, "sessions", username, "transfers", change.doc.id, "chunks");
                                        const chunksSnap = await getDocs(query(chunksRef, orderBy('__name__')));

                                        const chunks = [];
                                        chunksSnap.forEach(doc => chunks.push({ id: parseInt(doc.id), data: doc.data().data }));
                                        chunks.sort((a, b) => a.id - b.id);

                                        base64Data = chunks.map(c => c.data).join('');
                                    } else {
                                        base64Data = data.data;
                                    }

                                    // Trigger Download
                                    const link = document.createElement('a');
                                    link.href = base64Data;
                                    link.download = data.filename;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);

                                    transferNotificationText.textContent = "ConcluÃ­do!";
                                    transferNotificationProgress.style.width = '100%';

                                    // Clean up Firestore
                                    await deleteDoc(change.doc.ref);
                                    if (data.chunkCount > 0) {
                                        const chunksRef = collection(db, "sessions", username, "transfers", change.doc.id, "chunks");
                                        const chunksSnap = await getDocs(chunksRef);
                                        const batch = writeBatch(db);
                                        chunksSnap.forEach(c => batch.delete(c.ref));
                                        await batch.commit();
                                    }

                                } catch (e) {
                                    console.error("Erro ao baixar arquivo:", e);
                                    transferNotificationText.textContent = "Erro no download.";
                                    transferNotificationText.style.color = "var(--error-color)";
                                }
                            }

                            setTimeout(() => {
                                transferNotification.style.display = 'none';
                                transferNotificationProgress.style.width = '0%';
                                transferNotification.classList.remove('mobile-center');
                            }, 3000);
                        }
                    }
                });
            });
        };



        const setupFirebaseListener = (username) => {
            if (unsubscribeSnapshot) unsubscribeSnapshot();
            const docRef = doc(db, "sessions", username);
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();

                    if (isMobile && globalSettings.mobile2_0_enabled) {
                        updateMobileConnectionStatus(data.desktopConnection);
                    }

                    // Handle analysis state synchronization
                    if (data.isAnalyzing && data.isAnalyzing.status) {
                        const type = data.isAnalyzing.type;
                        const animationHTML = `
                            <div class="ai-processing-animation">
                                <div class="scanner-animation">
                                    <div class="brain-icon"><i class="fas fa-brain"></i></div>
                                    <div class="scanner-line"></div>
                                </div>
                                <span>Analisando Imagens...</span>
                            </div>`;

                        if (type === 'exams') {
                            if (currentMonitorView !== 'exams') toggleMonitorView('exams', true);
                            if (!examsResultsPreview.querySelector('.ai-processing-animation')) {
                                examsResultsPreview.innerHTML = animationHTML;
                            }
                        } else if (type === 'axon-eye') {
                            if (currentMonitorView !== 'axon-eye') toggleMonitorView('axon-eye', true);
                            if (!axonEyeResultsPreview.querySelector('.ai-processing-animation')) {
                                axonEyeResultsPreview.innerHTML = animationHTML;
                            }
                        }
                    }

                    // Always process content updates. This will replace the animation when results are ready.
                    if (data.anamnesis && !objectsAreEqual(data.anamnesis, anamnesis)) {
                        anamnesis = data.anamnesis;
                        updateAnamnesisPreview(false);
                    }
                    if (data.examsResults !== undefined && data.examsResults !== examsResults) {
                        examsResults = data.examsResults;
                        updateExamsResultsPreview(false);
                    }
                    if (data.axonEyeImages && JSON.stringify(data.axonEyeImages) !== JSON.stringify(temporaryImgurUploads)) {
                        temporaryImgurUploads = data.axonEyeImages;
                        updateAxonEyeResultsPreview(false);
                    } else if (!data.axonEyeImages && temporaryImgurUploads.length > 0) {
                        temporaryImgurUploads = [];
                        updateAxonEyeResultsPreview(false);
                    }
                    if (data.axonEyeResults !== undefined && data.axonEyeResults !== axonEyeResults) {
                        axonEyeResults = data.axonEyeResults;
                        updateAxonEyeResultsPreview(false);
                    }
                    if (data.monitorState && data.monitorState.activeView !== currentMonitorView) {
                        // Avoid view switching if an analysis is active, as it's already handled by the logic above
                        if (!data.isAnalyzing || !data.isAnalyzing.status) {
                            toggleMonitorView(data.monitorState.activeView, true);
                        }
                    }

                } else {
                    // Document does not exist. Session ended remotely or cleared.
                    if (!isMobile) { // If we are on desktop
                        if (isLoggedIn) { // Avoid multiple logout calls
                            appendOutput("SessÃ£o encerrada remotamente. Desconectando...", "info", false);
                            setTimeout(() => logoutUser(), 1500);
                        }
                        return; // Stop further processing for desktop
                    }

                    // Original mobile logic
                    if (isMobile && globalSettings.mobile2_0_enabled) {
                        updateMobileConnectionStatus(null);
                    }
                    anamnesis = { qp: "", hma: "", hp: "", hf: "", hps: "" };
                    examsResults = "";
                    axonEyeResults = "";
                    updateAnamnesisPreview(false);
                    updateExamsResultsPreview(false);
                    updateAxonEyeResultsPreview(false);
                }
            });
        };

        const applySettings = () => {
            const container = document.querySelector('.container');
            const mContainer = document.getElementById('mobile-2-0-container');

            if (isMobile) {
                // FORCE MOBILE VIEW regardless of screen size or orientation, if detected as mobile device (UserAgent)
                if (globalSettings.mobile2_0_enabled) {
                    // Check Login Status for Visibility
                    if (isLoggedIn) {
                        if (container) container.style.display = 'none';
                        if (mContainer) mContainer.style.display = 'flex';
                        document.body.classList.add('mobile-2-0-active');
                    } else {
                        // Not logged in: Hide mobile container, but keep body class to suppress other elements if needed,
                        // OR remove class to allow login modal to be seen clearly without mobile container overlay.
                        // User wants: "mobile-2-0-container nÃ£o apareÃ§a... somente o modal de login... mobile-2-0-container deve ficar oculto"
                        if (container) container.style.display = 'none'; // Hide desktop container background
                        if (mContainer) mContainer.style.display = 'none'; // Hide mobile container
                        document.body.classList.remove('mobile-2-0-active'); // Remove active class so Login Modal (which might be outside) is visible?
                        // Wait, login modal is usually top level.
                        // But we want to ensure desktop container is HIDDEN on mobile devices even if not logged in?
                        // "aparecerÃ¡ para ao usuÃ¡rio somente o modal de login persistente"
                        // If we hide desktop container (container.style.display='none') and mobile container is none,
                        // we just see the background and the modal. This is correct.
                    }
                    if (btnCloud) btnCloud.style.display = 'none';
                }
            } else {
                // Desktop Logic
                if (container) container.style.display = 'flex';
                if (mContainer) mContainer.style.display = 'none';
                if (btnCloud) btnCloud.style.display = 'flex';
                document.body.classList.remove('mobile-2-0-active');
            }

            // Mobile 2.0 Button Visibility (Global Rule)
            // Hides specific action buttons if Mobile 2.0 is enabled, even on Desktop
            const shouldHideActionButtons = globalSettings.mobile2_0_enabled;
            if (btnExames) btnExames.style.display = shouldHideActionButtons ? 'none' : 'flex';
            if (btnSee) btnSee.style.display = shouldHideActionButtons ? 'none' : 'flex';

            // Apply Log Suppression CSS Class
            const interactiveOutput = document.getElementById('interactive-output');
            if (interactiveOutput) {
                // Ensure checking explicit boolean true
                if (globalSettings.hideStatusMessages === true) {
                    interactiveOutput.classList.add('hide-technical-logs');
                } else {
                    interactiveOutput.classList.remove('hide-technical-logs');
                }
            }

            initializeAIModel();

            // Enforce Global Prescription Assistant Visibility
            const btnPrescAssist = document.getElementById('btn-prescription-assist');
            if (btnPrescAssist) {
                // Determine if we should show it based on Global Settings
                // Default to true if somehow undefined, but globalSettings shoud have it.
                const shouldShow = globalSettings.showPrescriptionAssistant !== false;

                // If Mobile 2.0 hides actions, we might want to respect that OR let this override?
                // Usually global toggle means "feature enabled/disabled".
                // If feature is disabled globally -> Hide.
                // If feature is enabled globally -> Check local/mobile context.

                if (!shouldShow) {
                    btnPrescAssist.style.display = 'none';
                } else {
                    // Feature is enabled globally.
                    // If we are NOT covering it by other logic (like mobile 2.0 hiding everything), show it.
                    // But wait, existing logic uses display: flex;
                    btnPrescAssist.style.display = 'flex';
                }
            }
        };

        const setupGlobalSettingsListener = () => {
            window.setupGlobalSettingsListener = setupGlobalSettingsListener; // Expose for debug/access
            return new Promise((resolve) => {
                if (unsubscribeSettings) unsubscribeSettings();
                const docRef = doc(db, "settings", "global");
                let isAllocated = false;

                unsubscribeSettings = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        globalSettings = {
                            apiKeys: data.apiKeys || [...defaultApiKeys],
                            apiModels: data.apiModels || [...defaultApiModels],
                            mode: data.mode || 'automatic',
                            manualTextModel: data.manualTextModel || '',
                            manualVisionModel: data.manualVisionModel || '',
                            manualApiKey: data.manualApiKey || '',
                            apiProvider: data.apiProvider || 'gemini',
                            openRouterKey: data.openRouterKey || '',
                            openRouterModel: data.openRouterModel || '',
                            groqKey: data.groqKey || '',
                            groqTextModel: data.groqTextModel || 'llama-3.3-70b-versatile',
                            groqVisionModel: data.groqVisionModel || 'llama-3.2-90b-vision-preview',
                            groqAvailableModels: data.groqAvailableModels || [],
                            mobile2_0_enabled: data.mobile2_0_enabled === undefined ? isMobile : data.mobile2_0_enabled,
                            hideStatusMessages: data.hideStatusMessages || false,
                            customTextProvider: data.customTextProvider || 'gemini',
                            customVisionProvider: data.customVisionProvider || 'gemini',
                            pinataKeys: data.pinataKeys || [
                                { key: "", secret: "" }
                            ],
                            supabaseUrl: data.supabaseUrl || '',
                            supabaseKey: data.supabaseKey || '',
                            supabaseBucket: data.supabaseBucket || 'axon-drive',
                            supabaseEnabled: data.supabaseEnabled || false,
                            showPrescriptionAssistant: data.showPrescriptionAssistant !== false,
                            showToolsButton: data.showToolsButton !== false, // default true
                            axonEyeStorageProvider: data.axonEyeStorageProvider || 'imgur',
                            bridgePermissions: data.bridgePermissions || {
                                sendToChat: true,
                                sendToAnamnesis: true,
                                readAnamnesis: true
                            }
                        };
                        window.globalSettings = globalSettings; // Sync strict reference

                        // Force Mobile 2.0 Update
                        if (typeof window.updateMobile2Layout === 'function') {
                            window.updateMobile2Layout();
                        }

                        // Update Tools Button Visibility
                        const btnTools = document.getElementById('btn-tools');
                        if (btnTools) {
                            btnTools.style.display = (globalSettings.showToolsButton !== false) ? 'flex' : 'none';
                        }

                        // Update locally settings dependent logic
                        if (globalSettings.mode === 'manual') currentApiKeyIndex = 0;


                        if (adminPanelModal.style.display === 'flex') {
                            if (document.querySelector('.admin-tab-btn[data-tab="api"]').classList.contains('active')) {
                                renderAdminSettingsUI();
                            }
                            if (document.querySelector('.admin-tab-btn[data-tab="debug"]').classList.contains('active')) {
                                renderAdminDebugUI();
                            }
                        }

                        applySettings();
                        if (!isAllocated) { isAllocated = true; resolve(); }
                    } else {
                        // Default settings if doc doesn't exist
                        globalSettings = {
                            apiKeys: [...defaultApiKeys],
                            apiModels: [...defaultApiModels],
                            mode: 'automatic',
                            manualTextModel: '',
                            manualVisionModel: '',
                            manualApiKey: '',
                            apiProvider: 'gemini',
                            openRouterKey: '',
                            openRouterModel: '',
                            groqKey: '',
                            groqTextModel: 'llama-3.3-70b-versatile',
                            groqVisionModel: 'llama-3.2-90b-vision-preview',
                            groqAvailableModels: [],
                            mobile2_0_enabled: isMobile,
                            hideStatusMessages: false,
                            customTextProvider: 'gemini',
                            customVisionProvider: 'gemini',
                            pinataKeys: [
                                { key: "", secret: "" }
                            ],
                            supabaseUrl: '',
                            supabaseKey: '',
                            supabaseBucket: 'axon-drive',
                            supabaseEnabled: false,
                            showPrescriptionAssistant: true,
                            showToolsButton: true,
                            axonEyeStorageProvider: 'imgur',
                            bridgePermissions: { sendToChat: true, callAI: true, getAnamnesis: true, storage: true }
                        };
                        setDoc(docRef, globalSettings);
                        if (!isAllocated) { isAllocated = true; resolve(); }
                    }
                }, (error) => {
                    console.error("Erro ao sincronizar configuraÃ§Ãµes globais:", error);
                    if (!isAllocated) { isAllocated = true; resolve(); }
                });
            });
        };

        const verifyAdminPassword = async (inputPassword) => {
            try {
                const docRef = doc(db, "settings", "global_admin");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().password === inputPassword;
                } else {
                    console.warn("ADMIN SECURITY WARNING: 'settings/global_admin' document missing in Firebase. Admin access disabled.");
                    return false;
                }
            } catch (error) {
                console.error("Error verifying admin password:", error);
                return false;
            }
        };

        const registerUser = async (adminPassword, username, password, email = '', accountLevel = 'personal', subscriptionDays = 30, subscriptionHours = 0, subscriptionMinutes = 0, isAdmin = false) => {
            if (!(await verifyAdminPassword(adminPassword))) return appendOutput("Senha de administrador incorreta.", "error");
            if (!username || !password) return appendOutput("Uso: /register [senha_admin] [usuÃ¡rio] [senha]", "error");
            try {
                const userRef = doc(db, "users", username);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) appendOutput(`UsuÃ¡rio '${username}' jÃ¡ existe.`, "error");
                else {
                    await setDoc(userRef, {
                        password,
                        email: email || '',
                        accountLevel: accountLevel || 'personal', // 'personal' or 'enterprise'
                        subscriptionDays: isAdmin ? 0 : (subscriptionDays || 30),
                        subscriptionHours: isAdmin ? 0 : (subscriptionHours || 0),
                        subscriptionMinutes: isAdmin ? 0 : (subscriptionMinutes || 0),
                        subscriptionStartDate: null, // Set on first login
                        isAdmin: isAdmin || false,
                        createdAt: new Date(),
                        textRequests: 0,
                        visionRequests: 0,
                        isBlocked: false,
                        isCloudDisabled: false
                    });
                    appendOutput(`UsuÃ¡rio '${username}' registrado com sucesso.`, "success");
                }
            } catch (e) { appendOutput(`Erro ao registrar: ${e.message}`, "error"); }
        };

        const deleteUser = async (adminPassword, username) => {
            if (!(await verifyAdminPassword(adminPassword))) return appendOutput("Senha de administrador incorreta.", "error");
            if (!username) return appendOutput("Uso: /delete [senha_admin] [usuÃ¡rio]", "error");
            try {
                const userRef = doc(db, "users", username);
                await deleteDoc(userRef);
                appendOutput(`UsuÃ¡rio '${username}' deletado.`, "success");
                if (currentUser === username) {
                    appendOutput("VocÃª foi desconectado.", "info");
                    logoutUser();
                }
            } catch (e) { appendOutput(`Erro ao deletar: ${e.message}`, "error"); }
        };
        const authenticateUser = async (username, password) => {
            try {
                const userRef = doc(db, "users", username);
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    if (userData.password === password) {
                        return {
                            success: true,
                            isBlocked: userData.isBlocked || false,
                            isCloudDisabled: userData.isCloudDisabled || false,
                            isAdmin: userData.isAdmin || false,
                            email: userData.email || '',
                            accountLevel: userData.accountLevel || 'personal',
                            subscriptionDays: userData.subscriptionDays || 0,
                            subscriptionHours: userData.subscriptionHours || 0,
                            subscriptionMinutes: userData.subscriptionMinutes || 0,
                            subscriptionStartDate: userData.subscriptionStartDate,
                            createdAt: userData.createdAt
                        };
                    }
                }
                return { success: false };
            } catch (e) { return { success: false }; }
        };

        // Subscription status checking
        const checkSubscriptionStatus = (userData) => {
            // Admins have infinite subscription
            if (userData.isAdmin) return { expired: false, remaining: Infinity, formattedRemaining: 'Ilimitado' };

            // Calculate remaining time
            const startDate = userData.subscriptionStartDate?.toDate?.() || userData.subscriptionStartDate || userData.createdAt?.toDate?.() || userData.createdAt;
            if (!startDate) return { expired: true, remaining: 0, formattedRemaining: 'Expirado' };

            const totalMs = (userData.subscriptionDays || 0) * 86400000
                + (userData.subscriptionHours || 0) * 3600000
                + (userData.subscriptionMinutes || 0) * 60000;

            const startTime = new Date(startDate).getTime();
            const expirationDate = new Date(startTime + totalMs);
            const now = new Date();
            const remaining = expirationDate - now;

            // Format remaining time
            let formattedRemaining = 'Expirado';
            if (remaining > 0) {
                const days = Math.floor(remaining / 86400000);
                const hours = Math.floor((remaining % 86400000) / 3600000);
                const minutes = Math.floor((remaining % 3600000) / 60000);

                const parts = [];
                if (days > 0) parts.push(`${days}d`);
                if (hours > 0) parts.push(`${hours}h`);
                if (minutes > 0) parts.push(`${minutes}m`);
                formattedRemaining = parts.length > 0 ? parts.join(' ') : 'Menos de 1 minuto';
            }

            return {
                expired: remaining <= 0,
                remaining: Math.max(0, remaining),
                expirationDate,
                formattedRemaining
            };
        };

        // Store current user data globally for UI access
        let currentUserData = null;

        const isUserValid = async (username) => {
            try {
                const userRef = doc(db, "users", username);
                const docSnap = await getDoc(userRef);
                return docSnap.exists();
            } catch (e) {
                console.error("Error checking user validity:", e);
                return false;
            }
        };


        let wasUserBlocked = false; // Track previous state to prevent spam

        const updateBlockedUI = () => {
            const buttons = document.querySelectorAll('.action-button, .mobile-btn');
            const infoBannerBubble = document.querySelector('.info-banner .chat-bubble-info');
            const infoBannerContent = document.getElementById('info-banner-content');

            if (isUserBlocked) {
                if (!wasUserBlocked) {
                    appendOutput("Sua conta foi bloqueada! Funcionalidade indisponÃ­vel.", "highlight");
                    wasUserBlocked = true;
                }
                buttons.forEach(btn => btn.classList.add('blocked-ui'));
                commandInput.disabled = true;
                if (cameraModal.style.display === 'flex') stopCamera();
                patientListModal.style.display = 'none';
                savePatientModal.style.display = 'none';
                adminPanelModal.style.display = 'none';
                chatboxModal.style.display = 'none';
                transferModal.style.display = 'none';
                if (btnCloud) btnCloud.classList.add('blocked-ui');

                if (isMobile && globalSettings.mobile2_0_enabled && infoBannerBubble && infoBannerContent) {
                    infoBannerBubble.style.backgroundColor = 'var(--altered-color)';
                    infoBannerBubble.style.color = '#1a202c'; // Dark text for yellow bg
                    infoBannerContent.innerHTML = 'Sua conta do usuÃ¡rio foi bloqueada.';
                }
            } else {
                if (wasUserBlocked) {
                    appendOutput("Sua conta foi desbloqueada.", "success");
                    wasUserBlocked = false;
                }
                buttons.forEach(btn => btn.classList.remove('blocked-ui'));
                commandInput.disabled = false;
                if (btnCloud) btnCloud.classList.remove('blocked-ui');

                if (isMobile && globalSettings.mobile2_0_enabled && infoBannerBubble && infoBannerContent) {
                    infoBannerBubble.style.backgroundColor = '';
                    infoBannerBubble.style.color = '';
                    infoBannerContent.innerHTML = `Para acesso completo, abra o Axon Web em seu computador em<a href="https://funortehub.github.io/axon" target="_blank" class="highlight-link">funortehub.github.io/axon</a>ou insira um dispositivo AXON USB.`;
                }
            }
        };

        const uploadToImgur = async (base64Image) => {
            try {
                const response = await fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: {
                        Authorization: `Client-ID ${IMGUR_CLIENT_ID}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: base64Image.split(',')[1],
                        type: 'base64',
                        title: 'Axon Eye Analysis',
                        description: `Image uploaded by Axon A.I for user ${currentUser}`
                    }),
                });
                const data = await response.json();
                if (data.success) {
                    return { link: data.data.link, deleteHash: data.data.deletehash };
                } else {
                    throw new Error(data.data.error || 'Imgur upload failed');
                }
            } catch (error) {
                console.error("Imgur upload error:", error);
                appendOutput(`Erro ao fazer upload da imagem para o Imgur: ${error.message}`, 'error');
                return null;
            }
        };

        const deleteFromImgur = async (deleteHash) => {
            if (!deleteHash) return;
            try {
                await fetch(`https://api.imgur.com/3/image/${deleteHash}`, {
                    method: 'DELETE',
                    headers: {
                        Authorization: `Client-ID ${IMGUR_CLIENT_ID}`,
                    },
                });
            } catch (error) {
                console.error("Imgur delete error:", error);
            }
        };

        const dataURLtoFile = (dataurl, filename) => {
            let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, { type: mime });
        };

        const uploadAxonEyeImage = async (base64Image) => {
            const provider = globalSettings.axonEyeStorageProvider || 'imgur';
            console.log("DEBUG: uploadAxonEyeImage called.");
            console.log("DEBUG: Provider:", provider);
            console.log("DEBUG: Supabase Config:", {
                enabled: globalSettings.supabaseEnabled,
                url: !!globalSettings.supabaseUrl,
                key: !!globalSettings.supabaseKey,
                bucket: globalSettings.supabaseBucket
            });

            if (provider === 'axon_storage') {
                try {
                    const filename = `axon_eye_${Date.now()}_${Math.floor(Math.random() * 1000)}.jpg`;
                    const file = dataURLtoFile(base64Image, filename);

                    // Check Supabase
                    if ((globalSettings.supabaseEnabled === true || globalSettings.supabaseEnabled === 'true') && globalSettings.supabaseUrl && globalSettings.supabaseKey) {
                        // Upload to TEMP folder specific for this user
                        const tempFilename = `temp/${currentUser}/${filename}`;
                        const fileWithTempName = dataURLtoFile(base64Image, filename); // keeping original name for file obj but uploading to temp path? 
                        // uploadToSupabase usually takes a file object and uses its name. 
                        // We need to modify uploadToSupabase or pass the path explicitly.
                        // Assuming uploadToSupabase handles the path generation or we need to intercept it.
                        // Wait, uploadToSupabase is generic. Let's look at it.
                        // Actually, for safer implementation without modifying uploadToSupabase deeply right now:
                        // Let's rely on standard upload and then MOVE? No, better upload directly to temp.
                        // Let's modify uploadToSupabase call or assume we can pass a path. 
                        // Since uploadToSupabase is likely using `upload(path, file)`, let's pass a custom path if possible?
                        // `uploadToSupabase` implementation (assumed from context): likely creates `user/filename`.
                        // We'll wrap it or just call fetch directly here for custom path?
                        // To be safe and minimal: Let's use a new helper `uploadToSupabasePath`.

                        const uploadToSupabasePath = async (file, path) => {
                            // Match working uploadToSupabase implementation: Raw Body + apikey header
                            const response = await fetch(`${globalSettings.supabaseUrl}/storage/v1/object/${globalSettings.supabaseBucket || 'axon-drive'}/${path}`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${globalSettings.supabaseKey.trim()}`,
                                    'apikey': globalSettings.supabaseKey.trim()
                                    // 'Content-Type': file.type // Optional, Supabase handles it
                                },
                                body: file
                            });
                            if (!response.ok) {
                                const errorText = await response.text();
                                console.error("Supabase Error Response:", errorText);
                                throw new Error(`Supabase upload failed: ${errorText} (${response.status})`);
                            }
                            const data = await response.json();
                            return {
                                url: `${globalSettings.supabaseUrl}/storage/v1/object/public/${globalSettings.supabaseBucket || 'axon-drive'}/${path}`,
                                path: path,
                                fullPath: data.Key
                            };
                        };

                        const result = await uploadToSupabasePath(file, tempFilename);

                        return {
                            link: result.url,
                            deleteHash: result.path,
                            provider: 'supabase',
                            fullPath: result.fullPath,
                            isTemp: true // Mark as temp
                        };
                    } else {
                        // Fallback Pinata (No temp folder logic for Pinata yet, standard upload)
                        const result = await uploadToPinata(file);
                        const ipfsUrl = `https://gateway.pinata.cloud/ipfs/${result.ipfsHash}`;
                        return {
                            link: ipfsUrl,
                            deleteHash: result.ipfsHash,
                            provider: 'pinata'
                        };
                    }
                } catch (e) {
                    console.error("Erro no upload Axon Storage (Stack):", e);
                    appendOutput(`Erro no Axon Storage (${e.message}). Detalhes no console. Tentando Imgur...`, "error");
                }
            }
            console.log("DEBUG: Falling back to Imgur upload.");
            // Default Imgur
            const result = await uploadToImgur(base64Image);
            if (result) result.provider = 'imgur';
            return result;
        };

        const deleteAxonEyeImage = async (imageObj) => {
            if (!imageObj) return;
            try {
                if (imageObj.provider === 'supabase') {
                    await deleteFromSupabase(imageObj.deleteHash);
                } else if (imageObj.provider === 'pinata') {
                    await unpinFromPinata(imageObj.deleteHash);
                } else {
                    await deleteFromImgur(imageObj.deleteHash);
                }
            } catch (e) {
                console.warn("Erro ao deletar imagem Axon Eye:", e);
            }
        };

        const moveInSupabase = async (oldPath, newPath) => {
            if (!globalSettings.supabaseUrl || !globalSettings.supabaseKey) return null;
            try {
                // Supabase Storage 'move' API
                const response = await fetch(`${globalSettings.supabaseUrl}/storage/v1/object/move`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${globalSettings.supabaseKey.trim()}`,
                        'apikey': globalSettings.supabaseKey.trim(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bucketId: globalSettings.supabaseBucket || 'axon-drive',
                        sourceKey: oldPath,
                        destinationKey: newPath
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Move failed');
                }

                return true;
            } catch (e) {
                console.error("Erro ao mover arquivo no Supabase:", e);
                return false;
            }
        };

        const clearTemporaryUploads = async () => {
            if (temporaryImgurUploads.length > 0) {
                appendOutput('Limpando imagens nÃ£o salvas...', 'info');

                // Temporary Draft Logic:
                // If image.saved === true, it belongs to a Saved Patient record -> KEEP in cloud.
                // If image.saved !== true, it was just a draft/analysis -> DELETE from cloud.

                const deletionPromises = [];
                for (const img of temporaryImgurUploads) {
                    if (img.saved !== true) {
                        deletionPromises.push(deleteAxonEyeImage(img));
                    }
                }

                if (deletionPromises.length > 0) {
                    appendOutput(`Apagando ${deletionPromises.length} imagem(ns) temporÃ¡ria(s)...`, 'info');
                    await Promise.all(deletionPromises);
                }

                temporaryImgurUploads = [];
            }
        };

        const startCamera = async (mode) => {
            // Limpa estado anterior para uma nova anÃ¡lise
            examsResults = "";
            axonEyeResults = "";
            capturedImages = [];
            examsResultsPreview.innerHTML = '<div class="info">Nenhum exame analisado ainda.</div>';
            axonEyeResultsPreview.innerHTML = '<div class="info">Nenhuma anÃ¡lise visual feita ainda.</div>';
            updateAlbumCount();
            sendExamsButton.classList.add('disabled');
            sendAxonEyeButton.classList.add('disabled');

            cameraMode = mode;
            cameraModalTitle.textContent = mode === 'exams' ? 'CÃ¢mera de Exames' : 'Axon Eye';
            sendExamsButton.style.display = mode === 'exams' ? 'flex' : 'none';
            sendAxonEyeButton.style.display = mode === 'axon-eye' ? 'flex' : 'none';

            cameraModal.style.display = 'flex';
            if (isMobile) {
                cameraModal.classList.add('fullscreen-mobile');
                document.body.style.overflow = 'hidden';
            }

            updateMonitorStateInFirestore(currentUser, { activeView: mode === 'exams' ? 'exams' : 'axon-eye' });

            try {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }

                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentCameraFacingMode, width: { ideal: 4096 }, height: { ideal: 2160 } } });

                cameraVideo.srcObject = stream;
                cameraStream = stream;

                cameraVideo.onloadedmetadata = () => {
                    cameraVideo.play().catch(e => console.error("Play failed:", e));
                };

                cameraStatus.classList.remove('status-off');
                if (!isMobile || !globalSettings.mobile2_0_enabled) {
                    appendOutput(`CÃ¢mera ativada para ${mode === 'exams' ? 'exames' : 'anÃ¡lise visual'}.`, "info");
                }

                const devices = await navigator.mediaDevices.enumerateDevices();
                if (devices.filter(d => d.kind === 'videoinput').length > 1) {
                    cameraSwitchButton.style.display = 'block';
                }

                const track = stream.getVideoTracks()[0];
                if (track && 'torch' in track.getCapabilities()) {
                    flashlightButton.style.display = 'block';
                }

            } catch (err) {
                if (!isMobile || !globalSettings.mobile2_0_enabled) {
                    appendOutput(`Erro ao acessar a cÃ¢mera: ${err.message}.`, "error");
                } else {
                    showConfirmModal(`Erro ao acessar a cÃ¢mera: ${err.message}. Tente novamente.`, () => { });
                }
                stopCamera();
            }
        };

        const stopCameraStreamOnly = () => {
            if (cameraStream) {
                if (isFlashlightOn) toggleFlashlight();
                cameraStream.getTracks().forEach(track => track.stop()); cameraVideo.srcObject = null; cameraStream = null;
            }
            cameraStatus.classList.add('status-off');
        };

        const stopCamera = () => {
            stopCameraStreamOnly();
            cameraModal.style.display = 'none';
            if (isMobile) {
                cameraModal.classList.remove('fullscreen-mobile');
                document.body.style.overflow = 'auto';
            }
            if (!isMobile || !globalSettings.mobile2_0_enabled) {
                toggleMonitorView(currentMonitorView === 'camera' ? 'anamnesis' : currentMonitorView);
            }
        };

        const cancelCamera = () => {
            updateMonitorStateInFirestore(currentUser, { activeView: 'anamnesis' });
            stopCamera();
            capturedImages = [];
            updateAlbumCount();
            sendExamsButton.classList.add('disabled');
            sendAxonEyeButton.classList.add('disabled');
        };

        const switchCamera = async () => { currentCameraFacingMode = (currentCameraFacingMode === 'user') ? 'environment' : 'user'; await startCamera(cameraMode); };
        const toggleFlashlight = async () => {
            if (!cameraStream) return;
            const track = cameraStream.getVideoTracks()[0];
            if (track && 'torch' in track.getCapabilities()) {
                try { await track.applyConstraints({ advanced: [{ torch: !isFlashlightOn }] }); isFlashlightOn = !isFlashlightOn; flashlightButton.classList.toggle('active', isFlashlightOn); } catch (err) { appendOutput("Erro ao controlar a lanterna.", "error"); }
            }
        };
        const capturePhoto = () => { if (!cameraStream) return; cameraCanvas.width = cameraVideo.videoWidth; cameraCanvas.height = cameraVideo.videoHeight; cameraCanvas.getContext('2d').drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height); addCapturedImage(cameraCanvas.toDataURL('image/jpeg')); };
        const handleFileUpload = (event) => { for (const file of event.target.files) { if (file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (e) => addCapturedImage(e.target.result); reader.readAsDataURL(file); } } };
        const addCapturedImage = (imageDataURL) => { capturedImages.push(imageDataURL); updateAlbumCount(); sendExamsButton.classList.remove('disabled'); sendAxonEyeButton.classList.remove('disabled'); };
        const removeCapturedImage = (imageDataURL) => { capturedImages = capturedImages.filter(url => url !== imageDataURL); updateAlbumCount(); if (capturedImages.length === 0) { sendExamsButton.classList.add('disabled'); sendAxonEyeButton.classList.add('disabled'); } renderAlbum(); };
        const updateAlbumCount = () => { albumCount.textContent = capturedImages.length; albumButton.style.display = capturedImages.length > 0 ? 'flex' : 'none'; };
        const openAlbumModal = () => { renderAlbum(); albumModal.style.display = 'flex'; };
        const closeAlbumModal = () => { albumModal.style.display = 'none'; };
        const renderAlbum = () => {
            albumGrid.innerHTML = capturedImages.length === 0 ? '<div class="info" style="grid-column: 1 / -1; text-align: center;">Nenhuma imagem no Ã¡lbum.</div>' : '';
            capturedImages.forEach(url => {
                const item = document.createElement('div'); item.className = 'album-item';
                const img = document.createElement('img'); img.src = url; img.className = 'album-image'; img.onclick = () => openFullscreenModal(url);
                const delBtn = document.createElement('button'); delBtn.className = 'album-delete-button'; delBtn.innerHTML = '&times;'; delBtn.onclick = (e) => { e.stopPropagation(); removeCapturedImage(url); };
                item.append(img, delBtn); albumGrid.appendChild(item);
            });
        };

        // Gallery State
        let galleryImages = [];
        let currentGalleryIndex = 0;
        let zoomLevel = 1;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;

        window.openFullscreenModal = (imageUrl, index = -1, allImages = []) => {
            if (!imageUrl) return;

            // Setup Gallery
            if (allImages.length > 0) {
                galleryImages = allImages;
                currentGalleryIndex = index >= 0 ? index : 0;
            } else {
                // Single image fallback
                galleryImages = [{ link: imageUrl }];
                currentGalleryIndex = 0;
            }

            updateGalleryImage();

            // Show/Hide Nav Buttons
            const prevBtn = document.getElementById('modal-prev-btn');
            const nextBtn = document.getElementById('modal-next-btn');

            if (galleryImages.length > 1) {
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'block';
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            }

            fullscreenModal.style.display = 'block';

            // Reset Zoom
            resetZoom();
        };

        const updateGalleryImage = () => {
            const imgObj = galleryImages[currentGalleryIndex];
            if (imgObj) {
                modalImage.src = imgObj.link || imgObj; // Handle object or string
                resetZoom();
            }
        };

        const navigateGallery = (direction) => {
            if (galleryImages.length <= 1) return;

            if (direction === 'next') {
                currentGalleryIndex = (currentGalleryIndex + 1) % galleryImages.length;
            } else {
                currentGalleryIndex = (currentGalleryIndex - 1 + galleryImages.length) % galleryImages.length;
            }
            updateGalleryImage();
        };

        // Zoom & Pan Logic
        const updateTransform = () => {
            modalImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomLevel})`;
        };

        const resetZoom = () => {
            zoomLevel = 1;
            translateX = 0;
            translateY = 0;
            updateTransform();
            modalImage.classList.remove('panning');
        };

        // Event Listeners for Gallery
        document.getElementById('modal-prev-btn').addEventListener('click', (e) => { e.stopPropagation(); navigateGallery('prev'); });
        document.getElementById('modal-next-btn').addEventListener('click', (e) => { e.stopPropagation(); navigateGallery('next'); });

        document.getElementById('modal-zoom-in').addEventListener('click', (e) => {
            e.stopPropagation();
            zoomLevel += 0.2;
            updateTransform();
        });
        document.getElementById('modal-zoom-out').addEventListener('click', (e) => {
            e.stopPropagation();
            if (zoomLevel > 0.4) zoomLevel -= 0.2;
            updateTransform();
        });
        document.getElementById('modal-zoom-reset').addEventListener('click', (e) => { e.stopPropagation(); resetZoom(); });

        // Keyboard Nav
        document.addEventListener('keydown', (e) => {
            if (fullscreenModal.style.display === 'block') {
                if (e.key === 'ArrowRight') navigateGallery('next');
                if (e.key === 'ArrowLeft') navigateGallery('prev');
                if (e.key === 'Escape') fullscreenModal.style.display = 'none';
            }
        });

        // Drag/Pan Events
        modalImage.addEventListener('mousedown', (e) => {
            if (zoomLevel > 1) {
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                modalImage.classList.add('panning');
                e.preventDefault();
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (isDragging && zoomLevel > 1) {
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            }
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            modalImage.classList.remove('panning');
        });

        // Update click handler in saved patients list to pass array
        // (This needs to be updated in the render function where we set the onclick)

        modalClose.onclick = () => fullscreenModal.style.display = 'none';
        fullscreenModal.onclick = (e) => { if (e.target === fullscreenModal) fullscreenModal.style.display = 'none'; };

        const showMobileLoader = () => { if (isMobile && globalSettings.mobile2_0_enabled) mobileAnalysisLoader.style.display = 'flex'; };
        const hideMobileLoader = () => { if (isMobile && globalSettings.mobile2_0_enabled) mobileAnalysisLoader.style.display = 'none'; };


        const analyzeExams = async () => {
            const callTimestamp = Date.now();
            if (capturedImages.length === 0) return appendOutput("Nenhuma imagem de exame para analisar.", "info");

            if (!isMobile || !globalSettings.mobile2_0_enabled) {
                toggleMonitorView('exams');
            } else {
                showMobileLoader();
            }
            await setAnalyzingStateInFirestore(true, 'exams');

            try {
                const prompt = `VocÃª Ã© um assistente especialista em anÃ¡lise de exames mÃ©dicos. Sua tarefa Ã© extrair e transcrever os dados dos exames fornecidos. Siga estas regras ESTRITAMENTE:\n\n1. **Resultados Laboratoriais:** Transcreva os resultados em formato de lista. Se um valor estiver alterado, adicione "(Alterado)" ao final da linha. Exemplo: Glicose: 90 mg/dL (Alterado).\n2. **Laudos de Imagem:** Se for um laudo de texto, transcreva o texto completo, palavra por palavra, sem NENHUMA alteraÃ§Ã£o ou resumo.\n3. **Formato RÃ­gido:** NUNCA comece sua resposta com frases como "Aqui estÃ£o os resultados...", "Analisando os exames...", etc. Sua resposta DEVE comeÃ§ar DIRETAMENTE com o primeiro item do resultado. Retorne APENAS a lista de resultados ou o texto do laudo.`;

                let fullResponse = "";
                const isGroq = globalSettings.apiProvider === 'groq' || (globalSettings.apiProvider === 'custom' && globalSettings.customVisionProvider === 'groq');

                if (isGroq && capturedImages.length > 5) {
                    appendOutput(`Groq: Detectadas ${capturedImages.length} imagens. Enviando em lotes de atÃ© 5...`, "info", false);
                    const chunks = [];
                    for (let i = 0; i < capturedImages.length; i += 5) {
                        chunks.push(capturedImages.slice(i, i + 5));
                    }
                    for (let i = 0; i < chunks.length; i++) {
                        appendOutput(`Enviando lote ${i + 1}/${chunks.length}...`, "info", false);
                        const chunkResponse = await callVisionAPI(chunks[i], prompt);
                        fullResponse += chunkResponse + "\n";
                    }
                } else {
                    fullResponse = await callVisionAPI(capturedImages, prompt);
                }

                if (callTimestamp < lastClearTimestamp) {
                    console.warn("Ignorando anÃ¡lise de exames pois a sessÃ£o foi limpa.");
                    return;
                }

                await setDoc(doc(db, "sessions", currentUser), {
                    examsResults: fullResponse.trim(),
                    isAnalyzing: { status: false, type: null }
                }, { merge: true });

                if (isMobile && globalSettings.mobile2_0_enabled) {
                    showConfirmModal('AnÃ¡lise de exames concluÃ­da!', () => { }, true);
                } else {
                    appendOutput("AnÃ¡lise de exames concluÃ­da.", "success");
                }

            } catch (error) {
                if (isMobile && globalSettings.mobile2_0_enabled) {
                    showConfirmModal(`Erro ao analisar exames: ${error.message}`, () => { }, true);
                } else {
                    appendOutput(`Erro ao analisar exames: ${error.message}`, "error");
                }

                await setDoc(doc(db, "sessions", currentUser), {
                    examsResults: "",
                    isAnalyzing: { status: false, type: null }
                }, { merge: true });

            } finally {
                hideMobileLoader();
                stopCamera(); capturedImages = []; updateAlbumCount();
            }
        };

        const analyzeAxonEye = async () => {
            const callTimestamp = Date.now();
            if (capturedImages.length === 0) return appendOutput("Nenhuma imagem para anÃ¡lise visual.", "info");

            await clearTemporaryUploads();

            if (!isMobile || !globalSettings.mobile2_0_enabled) {
                toggleMonitorView('axon-eye');
            } else {
                showMobileLoader();
            }

            // Start Animation immediately (sets isAnalyzing = true in Firestore)
            await setAnalyzingStateInFirestore(true, 'axon-eye');

            try {
                // 1. Upload Images to Storage (Imgur/Supabase)
                const currentUploads = [];
                for (const imgBase64 of capturedImages) {
                    const uploadResult = await uploadAxonEyeImage(imgBase64);
                    if (uploadResult) {
                        currentUploads.push(uploadResult);
                    }
                }

                if (currentUploads.length !== capturedImages.length) {
                    throw new Error("Falha no upload de uma ou mais imagens.");
                }

                temporaryImgurUploads = [...currentUploads];

                // 2. Save Images to Firestore NOW
                // This ensures that when the animation ends (via listener on isAnalyzing=false),
                // the images are already available in the 'axonEyeImages' field.
                if (currentUser) {
                    await setDoc(doc(db, "sessions", currentUser), {
                        axonEyeImages: temporaryImgurUploads
                    }, { merge: true });
                }

                const prompt = `Analise as imagens e forneÃ§a uma opiniÃ£o clÃ­nica detalhada. Descreva achados, lesÃµes, ou sintomas. Ao final, inclua uma seÃ§Ã£o "ImpressÃ£o DiagnÃ³stica:" ou "InterpretaÃ§Ã£o ClÃ­nica:" com sua conclusÃ£o. Formate palavras importantes com asteriscos (ex: *LesÃ£o sugestiva de...*). Seja descritivo e clinicamente relevante.`;

                let fullResponse = "";
                let imagesForApiCall;

                // Decide the image source based on provider
                if (globalSettings.apiProvider === 'openrouter') {
                    imagesForApiCall = temporaryImgurUploads.map(upload => upload.link);
                } else {
                    imagesForApiCall = capturedImages;
                }

                const isGroq = globalSettings.apiProvider === 'groq' || (globalSettings.apiProvider === 'custom' && globalSettings.customVisionProvider === 'groq');

                if (isGroq && imagesForApiCall.length > 5) {
                    appendOutput(`Groq: Detectadas ${imagesForApiCall.length} imagens. Enviando em lotes de atÃ© 5...`, "info", false);
                    const chunks = [];
                    for (let i = 0; i < imagesForApiCall.length; i += 5) {
                        chunks.push(imagesForApiCall.slice(i, i + 5));
                    }
                    for (let i = 0; i < chunks.length; i++) {
                        appendOutput(`Enviando lote ${i + 1}/${chunks.length}...`, "info", false);
                        const chunkResponse = await callVisionAPI(chunks[i], prompt);
                        fullResponse += chunkResponse + "\n\n";
                    }
                } else {
                    fullResponse = await callVisionAPI(imagesForApiCall, prompt);
                }

                if (callTimestamp < lastClearTimestamp) {
                    console.warn("Ignorando anÃ¡lise Axon Eye pois a sessÃ£o foi limpa.");
                    return;
                }

                // 3. Save Results and Stop Animation
                await setDoc(doc(db, "sessions", currentUser), {
                    axonEyeResults: fullResponse.trim(),
                    axonEyeImages: [...temporaryImgurUploads],
                    isAnalyzing: { status: false, type: null }
                }, { merge: true });

                if (isMobile && globalSettings.mobile2_0_enabled) {
                    showConfirmModal('AnÃ¡lise Axon Eye concluÃ­da. Imagens prontas para salvar em um prontuÃ¡rio.', () => { }, true);
                } else {
                    appendOutput("AnÃ¡lise Axon Eye concluÃ­da. Imagens prontas para salvar.", "success");
                }

            } catch (error) {
                if (isMobile && globalSettings.mobile2_0_enabled) {
                    showConfirmModal(`Erro com Axon Eye: ${error.message}`, () => { }, true);
                } else {
                    appendOutput(`Erro com Axon Eye: ${error.message}`, "error");
                }
                await clearTemporaryUploads();

                await setDoc(doc(db, "sessions", currentUser), {
                    axonEyeResults: "",
                    isAnalyzing: { status: false, type: null }
                }, { merge: true });

            } finally {
                hideMobileLoader();
                stopCamera(); capturedImages = []; updateAlbumCount();
            }
        };

        const savePatient = async (patientName, birthDate) => {
            if (!isLoggedIn) {
                appendOutput("VocÃª precisa estar logado.", "error");
                return;
            }
            savePatientButton.disabled = true;
            savePatientFeedback.textContent = 'Salvando...';

            try {
                const patientId = `${currentUser}_${patientName.replace(/\s+/g, '_').toLowerCase()}_${birthDate.replace(/\//g, '')}`;
                const patientRef = doc(db, "patients", patientId);

                // PROCESS IMAGES FIRST (Move & Update Links)
                if (temporaryImgurUploads && temporaryImgurUploads.length > 0) {
                    for (const img of temporaryImgurUploads) {
                        img.saved = true;
                        // Move from TEMP to PERMANENT if Supabase
                        if (img.provider === 'supabase' && img.isTemp) {
                            const filename = img.deleteHash.split('/').pop(); // Extract filename from temp/user/file.jpg
                            const newPath = `${currentUser}/${filename}`;

                            const moveSuccess = await moveInSupabase(img.deleteHash, newPath);
                            if (moveSuccess) {
                                img.deleteHash = newPath;
                                // Reconstruct the full public URL explicitly to allow viewing
                                const bucket = globalSettings.supabaseBucket || 'axon-drive';
                                let urlPrefix = globalSettings.supabaseUrl;
                                if (!urlPrefix.startsWith('http')) {
                                    urlPrefix = `https://${urlPrefix}`;
                                }
                                img.link = `${urlPrefix}/storage/v1/object/public/${bucket}/${newPath}`;
                                img.isTemp = false;
                            }
                        }
                    }
                }

                const newConsultation = {
                    date: new Date(),
                    anamnesis: { ...anamnesis },
                    examsResults,
                    axonEyeResults,
                    axonEyeImages: [...temporaryImgurUploads], // Now contains UPDATED links
                };

                const docSnap = await getDoc(patientRef);

                if (docSnap.exists()) {
                    const existingData = docSnap.data();
                    const updatedConsultations = existingData.consultations ? [...existingData.consultations, newConsultation] : [newConsultation];
                    await updateDoc(patientRef, {
                        consultations: updatedConsultations,
                        lastUpdated: new Date()
                    });
                    appendOutput(`Nova consulta salva para '${patientName}'.`, "success");
                } else {
                    await setDoc(patientRef, {
                        patientName,
                        birthDate,
                        savedBy: currentUser,
                        createdAt: new Date(),
                        consultations: [newConsultation],
                        lastUpdated: new Date()
                    });

                    appendOutput(`Paciente '${patientName}' e primeira consulta salvos com sucesso.`, "success");
                }

                temporaryImgurUploads = [];
                closeSaveModal();
            } catch (e) {
                appendOutput(`Erro ao salvar paciente: ${e.message}`, "error");
                savePatientFeedback.textContent = `Erro: ${e.message}`;
            } finally {
                savePatientButton.disabled = false;
            }
        };

        const loadPatientList = async () => {
            if (!isLoggedIn) return appendOutput("VocÃª precisa estar logado.", "error");
            try {
                const q = query(collection(db, "patients"), where("savedBy", "==", currentUser));
                const querySnapshot = await getDocs(q);

                allPatients = [];
                querySnapshot.forEach((doc) => {
                    allPatients.push({ id: doc.id, ...doc.data() });
                });

                allPatients.sort((a, b) => {
                    const dateA = a.lastUpdated?.toDate() || a.createdAt?.toDate() || 0;
                    const dateB = b.lastUpdated?.toDate() || b.createdAt?.toDate() || 0;
                    return dateB - dateA;
                });

                patientList.innerHTML = '';
                if (allPatients.length === 0) {
                    patientList.innerHTML = '<div class="info">Nenhum paciente salvo.</div>';
                } else {
                    allPatients.forEach(p => {
                        const hasConsultations = p.consultations && p.consultations.length > 0;

                        let lastConsultDateStr = 'Nenhuma consulta registrada';
                        if (hasConsultations) {
                            const mostRecentConsult = p.consultations
                                .filter(c => c.date && c.date.toDate)
                                .sort((a, b) => b.date.toDate() - a.date.toDate())[0];
                            if (mostRecentConsult) {
                                lastConsultDateStr = mostRecentConsult.date.toDate().toLocaleString();
                            }
                        }

                        const item = document.createElement('div');
                        item.className = 'patient-item';
                        item.dataset.patientId = p.id;
                        item.innerHTML = `<div><strong>${p.patientName}</strong> - ${p.birthDate || 'N/A'}</div>
                                          <div style="font-size: 12px; color: var(--text-color); opacity: 0.7;">Ãšltima consulta: ${lastConsultDateStr}</div>
                                          <div class="patient-actions">
                                            <button class="patient-action-button delete" data-id="${p.id}"><i class="fas fa-trash"></i> Excluir</button>
                                            <button class="patient-action-button details ${!hasConsultations ? 'disabled' : ''}" data-id="${p.id}"><i class="fas fa-eye"></i> Detalhes</button>
                                            <button class="patient-action-button pdf ${!hasConsultations ? 'disabled' : ''}" data-id="${p.id}"><i class="fas fa-file-pdf"></i> PDF</button>
                                          </div>`;
                        patientList.appendChild(item);
                    });
                }

                const saveButtonFooter = patientListModal.querySelector('.patient-list-footer');
                if (saveButtonFooter) {
                    if (isMobile && globalSettings.mobile2_0_enabled) {
                        saveButtonFooter.style.display = 'none';
                    } else {
                        saveButtonFooter.style.display = 'block';
                    }
                }

                patientListModal.style.display = 'flex';
            } catch (e) {
                appendOutput(`Erro ao carregar pacientes: ${e.message}`, "error");
                console.error("Erro em loadPatientList:", e);
            }
        };

        const deletePatient = async (patientId) => {
            showConfirmModal("Tem certeza que deseja excluir este paciente e TODAS as suas consultas? A aÃ§Ã£o Ã© irreversÃ­vel.", async () => {
                try {
                    const patientRef = doc(db, "patients", patientId);
                    const docSnap = await getDoc(patientRef);

                    if (docSnap.exists()) {
                        const patientData = docSnap.data();
                        if (patientData.consultations && patientData.consultations.length > 0) {
                            appendOutput("Excluindo imagens associadas (Imgur/Axon Storage)...", "info");
                            for (const consult of patientData.consultations) {
                                if (consult.axonEyeImages && consult.axonEyeImages.length > 0) {
                                    for (const img of consult.axonEyeImages) {
                                        await deleteAxonEyeImage(img);
                                    }
                                }
                            }
                        }
                    }

                    await deleteDoc(patientRef);
                    appendOutput("Paciente e todos os registros foram excluÃ­dos com sucesso.", "success");
                    await loadPatientList();
                } catch (e) {
                    appendOutput(`Erro ao excluir paciente: ${e.message}`, "error");
                }
            });
        };

        const generatePatientPDF = async (patientId) => {
            try {
                const patientSnap = await getDoc(doc(db, "patients", patientId));
                if (!patientSnap.exists()) return appendOutput("Paciente nÃ£o encontrado.", "error");

                const patient = patientSnap.data();
                if (!patient.consultations || patient.consultations.length === 0) {
                    return appendOutput("Nenhuma consulta registrada para gerar PDF.", "info");
                }

                const { jsPDF } = window.jspdf;
                const pdfDoc = new jsPDF();

                pdfDoc.setFontSize(18).text('AXON A.I - ProntuÃ¡rio MÃ©dico Completo', 105, 20, { align: 'center' });
                pdfDoc.setFontSize(14).text(`Paciente: ${patient.patientName}`, 14, 35);
                pdfDoc.setFontSize(12).text(`Data de Nascimento: ${patient.birthDate || 'N/A'}`, 14, 42);
                pdfDoc.line(14, 45, 196, 45);

                let y = 55;
                const pageHeight = pdfDoc.internal.pageSize.height;
                const addSection = (title, content, doc) => {
                    if (!content || (typeof content === 'string' && !content.trim()) || (typeof content === 'object' && Object.values(content).every(v => !v))) return;

                    if (y + 15 > pageHeight - 20) { doc.addPage(); y = 20; }
                    doc.setFontSize(12).setFont(undefined, 'bold').text(title, 14, y); y += 7;

                    const text = typeof content === 'object' ? Object.entries(content).map(([k, v]) => {
                        if (k === 'exame_fisico' && typeof v === 'object') {
                            return `EXAME FÃSICO:\n` + Object.entries(v).map(([subK, subV]) => `   - ${subK.toUpperCase()}: ${subV || 'NÃ£o informado'}`).join('\n');
                        }
                        if ((k === 'hgo' || k === 'ha') && !v) return null;
                        return `${k.toUpperCase().replace(/_/g, ' ')}: ${v || 'NÃ£o informado'}`;
                    }).filter(Boolean).join('\n') : content;

                    const splitText = doc.splitTextToSize(text, 180);

                    if (y + (splitText.length * 5) > pageHeight - 20) { doc.addPage(); y = 20; }
                    doc.setFontSize(10).setFont(undefined, 'normal').text(splitText, 14, y);
                    y += splitText.length * 5 + 5;
                };

                const sortedConsultations = [...patient.consultations]
                    .filter(c => c.date && c.date.toDate)
                    .sort((a, b) => (a.date.toDate()) - (b.date.toDate()));

                sortedConsultations.forEach((consult, index) => {
                    if (y + 20 > pageHeight - 20) { pdfDoc.addPage(); y = 20; }

                    const consultDate = consult.date ? consult.date.toDate().toLocaleString() : 'Data indisponÃ­vel';
                    pdfDoc.setFontSize(14).setFont(undefined, 'bold').text(`Consulta ${index + 1}: ${consultDate}`, 105, y, { align: 'center' });
                    y += 5;
                    pdfDoc.line(14, y, 196, y);
                    y += 10;

                    addSection('Anamnese', consult.anamnesis, pdfDoc);
                    addSection('Resultados dos Exames', consult.examsResults, pdfDoc);
                    addSection('AnÃ¡lise Visual (Axon Eye)', consult.axonEyeResults, pdfDoc);
                });

                pdfDoc.save(`prontuario_${patient.patientName.replace(/\s+/g, '_')}.pdf`);
                appendOutput(`PDF do prontuÃ¡rio completo gerado com sucesso.`, "success");

            } catch (e) { appendOutput(`Erro ao gerar PDF: ${e.message}`, "error"); console.error(e); }
        };

        const generatePDFFromCurrentSession = (patientName) => {
            if (!patientName) {
                appendOutput("Uso: /pdf [nome_do_paciente]", "error");
                return;
            }

            const { jsPDF } = window.jspdf;
            const pdfDoc = new jsPDF();

            pdfDoc.setFontSize(18).text('AXON A.I - ProntuÃ¡rio MÃ©dico', 105, 20, { align: 'center' });
            pdfDoc.setFontSize(14).text(`Paciente: ${patient.patientName}`, 14, 35);
            pdfDoc.setFontSize(12).text(`Gerado em: ${new Date().toLocaleString()}`, 14, 42);
            pdfDoc.line(14, 45, 196, 45);

            let y = 55;
            const pageHeight = pdfDoc.internal.pageSize.height;

            const addSection = (title, content) => {
                if (!content || (typeof content === 'string' && !content.trim()) || (typeof content === 'object' && Object.values(content).every(v => !v))) return;

                if (y + 15 > pageHeight - 20) { pdfDoc.addPage(); y = 20; }
                pdfDoc.setFontSize(12).setFont(undefined, 'bold').text(title, 14, y); y += 7;

                const text = typeof content === 'object' ? Object.entries(content).map(([k, v]) => {
                    if (k === 'exame_fisico' && typeof v === 'object') {
                        return `EXAME FÃSICO:\n` + Object.entries(v).map(([subK, subV]) => `   - ${subK.toUpperCase()}: ${subV || 'NÃ£o informado'}`).join('\n');
                    }
                    if ((k === 'hgo' || k === 'ha') && !v) return null;
                    return `${k.toUpperCase().replace(/_/g, ' ')}: ${v || 'NÃ£o informado'}`;
                }).filter(Boolean).join('\n') : content;

                const splitText = pdfDoc.splitTextToSize(text, 180);

                if (y + (splitText.length * 5) > pageHeight - 20) { pdfDoc.addPage(); y = 20; }
                pdfDoc.setFontSize(10).setFont(undefined, 'normal').text(splitText, 14, y);
                y += splitText.length * 5 + 5;
            };

            addSection('Anamnese', anamnesis);
            addSection('Resultados dos Exames', examsResults);
            addSection('AnÃ¡lise Visual (Axon Eye)', axonEyeResults);

            pdfDoc.save(`prontuario_atual_${patientName.replace(/\s+/g, '_')}.pdf`);
            appendOutput(`PDF da sessÃ£o atual gerado com sucesso.`, "success");
        };

        const showPatientDetails = (patient) => {
            patientDetailsTitle.textContent = `Paciente: ${patient.patientName}`;
            let detailsHTML = '';

            const addDetailSection = (title, content) => {
                if (!content || (typeof content === 'string' && !content.trim()) || (typeof content === 'object' && Object.values(content).every(v => !v))) return '';
                let body = '';
                if (title === 'ANAMNESE' && typeof content === 'object') {
                    const order = ['qp', 'hma', 'hp', 'hf', 'hps', 'hgo', 'ha', 'ectoscopia', 'dados_vitais', 'exame_fisico'];
                    body = order
                        .map(key => {
                            if (content.hasOwnProperty(key)) {
                                if (key === 'exame_fisico' && typeof content[key] === 'object') {
                                    const ef = content[key];
                                    let efHtml = '<br><strong>EXAME FÃSICO:</strong><div style="padding-left: 10px; border-left: 2px solid var(--border-color); margin-left: 5px;">';
                                    efHtml += `<div><strong>SCV:</strong> ${ef.scv || "NÃ£o informado"}</div>`;
                                    efHtml += `<div><strong>SR:</strong> ${ef.sr || "NÃ£o informado"}</div>`;
                                    efHtml += `<div><strong>SD:</strong> ${ef.sd || "NÃ£o informado"}</div>`;
                                    if (ef.dermatologico) efHtml += `<div><strong>DERMATOLÃ“GICO:</strong> ${ef.dermatologico}</div>`;
                                    efHtml += '</div><br>';
                                    return efHtml;
                                }
                                if ((key === 'hgo' || key === 'ha') && !content[key]) return ''; // Skip empty conditional fields
                                return `<strong>${key.toUpperCase()}:</strong> ${content[key] || "NÃ£o informado"}<br>`;
                            }
                            return '';
                        })
                        .join('');
                } else if (typeof content === 'object') {
                    body = Object.entries(content).map(([k, v]) => `<strong>${k.toUpperCase()}:</strong> ${v || "NÃ£o informado"}<br>`).join('');
                } else {
                    // Helper to format markdown bold
                    const formatMarkdown = (text) => {
                        if (!text) return text;
                        return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                    };
                    body = formatMarkdown(content).replace(/\n/g, '<br>');
                }
                return `<div class="patient-details-section"><div class="patient-details-section-title">${title}</div><div>${body}</div></div>`;
            };

            if (patient.consultations && patient.consultations.length > 0) {
                const sortedConsultations = [...patient.consultations]
                    .filter(c => c.date && c.date.toDate)
                    .sort((a, b) => b.date.toDate() - a.date.toDate());
                detailsHTML += `<div class="consultation-list">`;
                sortedConsultations.forEach((consult, index) => {
                    const consultDate = consult.date ? consult.date.toDate().toLocaleString() : 'Data indisponÃ­vel';
                    detailsHTML += `<div class="consultation-item">
                                        <div class="consultation-header">
                                            <i class="fas fa-chevron-right"></i> Consulta de ${consultDate}
                                        </div>
                                        <div class="consultation-body" style="display: none;">
                                            ${addDetailSection('ANAMNESE', consult.anamnesis)}
                                            ${addDetailSection('RESULTADOS DOS EXAMES', consult.examsResults)}
                                            ${addDetailSection('ANÃLISE VISUAL (AXON EYE)', consult.axonEyeResults)}`;
                    if (consult.axonEyeImages && consult.axonEyeImages.length > 0) {
                        detailsHTML += `<div class="patient-details-section"><div class="patient-details-section-title">IMAGENS (${consult.axonEyeImages.length})</div><div class="patient-images-grid">`;
                        // Serialize images array for the modal context (careful with quotes)
                        const imagesJson = JSON.stringify(consult.axonEyeImages).replace(/"/g, '&quot;');

                        consult.axonEyeImages.forEach((img, i) => {
                            // Pass 'this', index, and the full array to the modal
                            /* 
                               We'll use a globally accessible helper or pass the array directly? 
                               Passing complex JSON in onclick is messy. 
                               Better: Store the images in a global map using a consultation ID or just pass them if small.
                               Let's pass via function arguments using the previously serialized JSON, parsed on the fly? 
                               Or simpler: `openFullscreenModal(url, index, ${imagesJson})` - risky if too large.
                               
                               Best approach given constraints:
                               Assign this consultation's images to a window variable temporarily on click? 
                               No, let's just use the robust `data-all-images` attribute.
                            */
                            detailsHTML += `<div class="patient-image-item">
                                <img src="${img.link}" class="patient-image" 
                                     data-index="${i}"
                                     onclick='const allImgs = ${JSON.stringify(consult.axonEyeImages)}; openFullscreenModal("${img.link}", ${i}, allImgs)' 
                                     alt="Imagem do paciente">
                            </div>`;
                        });
                        detailsHTML += `</div></div>`;
                    }
                    detailsHTML += `</div></div>`;
                });
                detailsHTML += `</div>`;
            } else {
                detailsHTML = '<div class="info">Nenhuma consulta registrada para este paciente.</div>';
            }
            patientDetailsBody.innerHTML = detailsHTML;
            patientDetailsModal.style.display = 'flex';
        };

        const openSaveModal = () => {
            savePatientNameInput.value = '';
            savePatientDobInput.value = '';
            savePatientFeedback.textContent = '';
            savePatientModal.style.display = 'flex';
            savePatientNameInput.focus();
        };

        const closeSaveModal = () => {
            savePatientModal.style.display = 'none';
        };

        const startDesktopHeartbeat = (username) => {
            if (typeof desktopHeartbeatInterval !== 'undefined' && desktopHeartbeatInterval) clearInterval(desktopHeartbeatInterval);
            if (!isMobile) {
                const updateDesktopStatus = () => {
                    if (isLoggedIn && currentUser) {
                        const desktopInfo = getDesktopInfo();
                        const sessionRef = doc(db, "sessions", currentUser);
                        setDoc(sessionRef, {
                            desktopConnection: { ...desktopInfo, timestamp: new Date() }
                        }, { merge: true }).catch(e => console.error("Heartbeat failed:", e));
                    }
                };
                updateDesktopStatus();
                desktopHeartbeatInterval = setInterval(updateDesktopStatus, 2000);
            }
        };

        const setupFirestoreListeners = (username) => {
            // --- REMOTE DISCONNECT LISTENER ---
            if (window.sessionDisconnectListener) window.sessionDisconnectListener();

            try {
                window.sessionDisconnectListener = onSnapshot(doc(db, "sessions", username), (docSnap) => {
                    if (!docSnap.exists() && isLoggedIn) {
                        // Session deleted remotely or invalid
                        // Logic to determine if it's a real disconnect or just init
                        // If we just logged in, doc might be creating.
                        // But usually we create it.
                        // For now, let's keep the existing logic but be careful.
                        // The old logic had a flag hasSessionExisted.
                    } else if (docSnap.exists()) {
                        // Check for remote disconnect command? 
                        // The old logic checked if it VANISHED.
                    }
                });

                // Re-implementing the exact logic from old function for safety
                let hasSessionExisted = false;
                if (window.sessionDisconnectListener) window.sessionDisconnectListener();

                window.sessionDisconnectListener = onSnapshot(doc(db, "sessions", username), (docSnap) => {
                    if (docSnap.exists()) {
                        hasSessionExisted = true;
                    } else if (hasSessionExisted && !docSnap.exists()) {
                        console.warn("Session disconnected remotely. Logout triggered.");
                        if (window.desktopHeartbeatInterval) clearInterval(window.desktopHeartbeatInterval);
                        if (typeof firebase !== 'undefined' && firebase.auth()) {
                            firebase.auth().signOut().then(() => window.location.reload());
                        } else {
                            window.location.reload();
                        }
                    }
                });

            } catch (e) { console.error("Session listener error:", e); }

            // --- USER DATA LISTENER ---
            if (unsubscribeUserDoc) unsubscribeUserDoc();

            unsubscribeUserDoc = onSnapshot(doc(db, "users", username), (docSnap) => {
                if (!docSnap.exists() && isLoggedIn && currentUser === username) {
                    appendOutput("Sua conta de usuÃ¡rio foi removida. Desconectando automaticamente...", "error");
                    setTimeout(() => logoutUser(), 3000);
                } else if (docSnap.exists()) {
                    const userData = docSnap.data();
                    // Update Global State
                    if (typeof isUserBlocked !== 'undefined' && userData.isBlocked !== isUserBlocked) {
                        isUserBlocked = userData.isBlocked || false;
                        if (typeof updateBlockedUI === 'function') updateBlockedUI();
                    }
                    if (typeof isCloudDisabled !== 'undefined' && userData.isCloudDisabled !== isCloudDisabled) {
                        isCloudDisabled = userData.isCloudDisabled || false;
                        const btnCloud = document.getElementById('btn-cloud'); // Ensure element ref
                        if (btnCloud) {
                            if (isCloudDisabled) btnCloud.classList.add('blocked-ui');
                            else btnCloud.classList.remove('blocked-ui');
                        }
                    }

                    // REAL-TIME EXPIRATION CHECK
                    const subStatus = checkSubscriptionStatus(userData);
                    if (subStatus.expired && !userData.isAdmin) {
                        console.warn("Assinatura expirou em tempo real. Desconectando...");
                        if (expiryCheckInterval) clearInterval(expiryCheckInterval);
                        logoutUser();
                        document.getElementById('subscription-expired-modal').style.display = 'flex';
                    }
                }
            }, (error) => {
                console.error("Listener error for user document:", error);
            });

            // Initialize other listeners found in old function
            if (typeof setupFirebaseListener === 'function') setupFirebaseListener(username);
            if (typeof setupTransferListener === 'function') setupTransferListener(username);
            if (window.axonPluginManager && typeof window.axonPluginManager.startPluginListener === 'function') window.axonPluginManager.startPluginListener();
            if (typeof setupGlobalSettingsListener === 'function') setupGlobalSettingsListener();

            // Toggle view as it was there
            if (typeof toggleMonitorView === 'function') toggleMonitorView('anamnesis');
            if (window.loadFreeModeData) window.loadFreeModeData();
        };

        const searchPatients = (searchTerm) => {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const patientItems = patientList.querySelectorAll('.patient-item');
            let visibleCount = 0;

            patientItems.forEach(item => {
                const patientName = item.querySelector('strong')?.textContent.toLowerCase();
                if (patientName && patientName.includes(lowerCaseSearchTerm)) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            const noResultsMessage = patientList.querySelector('.info');
            if (noResultsMessage) {
                noResultsMessage.remove();
            }

            if (visibleCount === 0 && patientItems.length > 0) {
                const noResults = document.createElement('div');
                noResults.className = 'info';
                noResults.textContent = 'Nenhum paciente encontrado.';
                patientList.appendChild(noResults);
            }
        };

        const openAdminAuth = () => {
            adminAuthPass.value = '';
            adminAuthFeedback.textContent = '';
            adminAuthModal.style.display = 'flex';
            adminAuthPass.focus();
        };

        const checkAdminAuth = async () => {
            if (await verifyAdminPassword(adminAuthPass.value)) {
                adminAuthModal.style.display = 'none';
                adminPanelModal.style.display = 'flex';
                activateAdminTab('users');
            } else {
                adminAuthFeedback.textContent = 'Senha incorreta.';
            }
        };

        const disconnectAllUsers = async () => {
            showConfirmModal(
                "Tem certeza de que deseja desconectar TODOS os usuÃ¡rios de suas sessÃµes de desktop ativas? Isso forÃ§arÃ¡ um novo login para todos.",
                async () => {
                    const feedbackEl = document.getElementById('admin-create-user-feedback') || { textContent: '', style: {} };
                    feedbackEl.textContent = 'Desconectando todos os usuÃ¡rios...';
                    feedbackEl.style.color = 'var(--prompt-color)';

                    try {
                        const sessionsRef = collection(db, "sessions");
                        const sessionsSnap = await getDocs(sessionsRef);

                        if (sessionsSnap.empty) {
                            feedbackEl.textContent = 'Nenhuma sessÃ£o ativa para desconectar.';
                            feedbackEl.style.color = 'var(--info-color)';
                            return;
                        }

                        const batch = writeBatch(db);
                        sessionsSnap.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();

                        feedbackEl.textContent = `Sucesso! ${sessionsSnap.size} sessÃ£o(Ãµes) encerrada(s).`;
                        feedbackEl.style.color = 'var(--success-color)';

                    } catch (e) {
                        feedbackEl.textContent = `Erro: ${e.message}`;
                        feedbackEl.style.color = 'var(--error-color)';
                        console.error("Erro ao desconectar todos os usuÃ¡rios:", e);
                    }
                }
            );
        };





        const renderAdminSettingsUI = () => {
            const isManual = globalSettings.mode === 'manual';
            const isGoogle = globalSettings.apiProvider === 'gemini';
            const isOpenRouter = globalSettings.apiProvider === 'openrouter';
            const isGroq = globalSettings.apiProvider === 'groq';
            const isCustom = globalSettings.apiProvider === 'custom';

            const textModelsOptions = globalSettings.apiModels.map(m =>
                `<option value="${m.name}" ${globalSettings.manualTextModel === m.name ? 'selected' : ''}>${m.name}</option>`
            ).join('');

            const visionModelsOptions = globalSettings.apiModels.filter(m => m.vision).map(m =>
                `<option value="${m.name}" ${globalSettings.manualVisionModel === m.name ? 'selected' : ''}>${m.name}</option>`
            ).join('');

            const apiKeysOptions = globalSettings.apiKeys.map(key =>
                `<option value="${key}" ${globalSettings.manualApiKey === key ? 'selected' : ''}>${key}</option>`
            ).join('');

            const openRouterModelsOptions = openRouterModels.map(m =>
                `<option value="${m.name}" ${globalSettings.openRouterModel === m.name ? 'selected' : ''}>${m.name} ${m.vision ? '(+VisÃ£o)' : ''}</option>`
            ).join('');

            const groqList = globalSettings.groqAvailableModels || groqModels;

            const groqTextModelsOptions = groqList.map(m =>
                `<option value="${m.name}" ${globalSettings.groqTextModel === m.name ? 'selected' : ''}>${m.name}</option>`
            ).join('');

            const groqVisionModelsOptions = groqList.map(m =>
                `<option value="${m.name}" ${globalSettings.groqVisionModel === m.name ? 'selected' : ''}>${m.name}</option>`
            ).join('');

            let html = `
                <div class="admin-section">
                    <div class="admin-section-title">Provedor da API</div>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="apiProvider" value="gemini" ${isGoogle ? 'checked' : ''} onchange="window.updateProvider('gemini')"> Google Gemini (Direto)
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="apiProvider" value="openrouter" ${isOpenRouter ? 'checked' : ''} onchange="window.updateProvider('openrouter')"> OpenRouter (Universal)
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="apiProvider" value="groq" ${isGroq ? 'checked' : ''} onchange="window.updateProvider('groq')"> Groq (Ultra RÃ¡pido)
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="apiProvider" value="custom" ${isCustom ? 'checked' : ''} onchange="window.updateProvider('custom')"> Customizado (Misto)
                        </label>
                    </div>
                </div>
            `;

            if (isCustom) {
                html += `
                <div class="admin-section">
                    <div class="admin-section-title">ConfiguraÃ§Ã£o Customizada</div>
                    
                    <label>Provedor para Tarefas de Texto:</label>
                    <select id="custom-text-provider" class="admin-input" style="width:100%; margin-bottom:10px;" onchange="window.saveManualSelection()">
                        <option value="gemini" ${globalSettings.customTextProvider === 'gemini' ? 'selected' : ''}>Google Gemini</option>
                        <option value="openrouter" ${globalSettings.customTextProvider === 'openrouter' ? 'selected' : ''}>OpenRouter</option>
                        <option value="groq" ${globalSettings.customTextProvider === 'groq' ? 'selected' : ''}>Groq</option>
                    </select>

                    <label>Provedor para Tarefas de VisÃ£o (Imagens):</label>
                    <select id="custom-vision-provider" class="admin-input" style="width:100%; margin-bottom:10px;" onchange="window.saveManualSelection()">
                        <option value="gemini" ${globalSettings.customVisionProvider === 'gemini' ? 'selected' : ''}>Google Gemini</option>
                        <option value="openrouter" ${globalSettings.customVisionProvider === 'openrouter' ? 'selected' : ''}>OpenRouter</option>
                        <option value="groq" ${globalSettings.customVisionProvider === 'groq' ? 'selected' : ''}>Groq</option>
                    </select>
                    
                    <div class="info" style="font-size: 12px; margin-top: 10px;">
                        Nota: As configuraÃ§Ãµes para cada provedor (chaves, modelos) devem ser ajustadas em suas respectivas abas. A seleÃ§Ã£o customizada apenas direciona as chamadas.
                    </div>
                </div>
                `;
            } else if (isGoogle) {
                html += `
                <div class="admin-section">
                    <div class="admin-section-title">Modo Google (Direto)</div>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="apiMode" value="automatic" ${!isManual ? 'checked' : ''} onchange="window.updateMode('automatic')"> AutomÃ¡tico (RotaÃ§Ã£o)
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="apiMode" value="manual" ${isManual ? 'checked' : ''} onchange="window.updateMode('manual')"> Manual (Fixo)
                        </label>
                    </div>

                    <div id="manual-settings" style="display: ${isManual ? 'block' : 'none'}; margin-top: 15px;">
                        <div class="admin-section-title">SeleÃ§Ã£o Manual</div>
                        <label>Motor de Texto:</label>
                        <select id="manual-text-select" class="admin-input" style="width:100%; margin-bottom:10px;" onchange="window.saveManualSelection()">
                            <option value="">Selecione...</option>
                            ${textModelsOptions}
                        </select>
                        
                        <label>Motor de VisÃ£o:</label>
                        <select id="manual-vision-select" class="admin-input" style="width:100%; margin-bottom:10px;" onchange="window.saveManualSelection()">
                            <option value="">Selecione...</option>
                            ${visionModelsOptions}
                        </select>
                        
                        <label>Chave API:</label>
                        <select id="manual-key-select" class="admin-input" style="width:100%;" onchange="window.saveManualSelection()">
                            <option value="">Selecione...</option>
                            ${apiKeysOptions}
                        </select>
                    </div>
                </div>

                <div class="admin-section">
                    <div class="admin-section-title">Chaves de API (Google)</div>
                    <div class="admin-list" id="api-keys-list">
                        ${globalSettings.apiKeys.map((key, index) => `
                            <div class="admin-list-item">
                                <input type="text" class="admin-input" value="${key}" readonly>
                                <button class="patient-action-button delete" style="flex:0;" onclick="window.removeApiKey(${index})"><i class="fas fa-trash"></i></button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="admin-list-item" style="margin-top: 10px;">
                         <input type="text" id="new-api-key" class="admin-input" placeholder="Nova chave API...">
                         <button class="patient-action-button pdf" style="flex:0;" onclick="window.addApiKey()">Adicionar</button>
                    </div>
                </div>
                `;
            } else if (isOpenRouter) {
                html += `
                <div class="admin-section">
                    <div class="admin-section-title">ConfiguraÃ§Ã£o OpenRouter</div>
                    <label>Chave de API OpenRouter:</label>
                    <input type="text" id="openrouter-key-input" class="admin-input" style="width: 100%; margin-bottom: 10px;" value="${globalSettings.openRouterKey}" onchange="window.saveManualSelection()">
                    
                    <label>Modelo (Texto e VisÃ£o):</label>
                    <select id="openrouter-model-select" class="admin-input" style="width:100%;" onchange="window.saveManualSelection()">
                        ${openRouterModelsOptions}
                    </select>
                </div>
                `;
            } else if (isGroq) {
                html += `
                <div class="admin-section">
                    <div class="admin-section-title">ConfiguraÃ§Ã£o Groq</div>
                    <label>Chave de API Groq:</label>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="text" id="groq-key-input" class="admin-input" style="flex:1;" value="${globalSettings.groqKey}" onchange="window.saveManualSelection()">
                        <button class="patient-action-button" id="btn-refresh-groq" style="flex:0; white-space:nowrap;" onclick="window.refreshGroqModels()">
                            <i class="fas fa-sync-alt"></i> Atualizar Modelos
                        </button>
                    </div>
                    
                    <label>Modelo de Texto:</label>
                    <select id="groq-text-model-select" class="admin-input" style="width:100%; margin-bottom:10px;" onchange="window.saveManualSelection()">
                        <option value="">Selecione...</option>
                        ${groqTextModelsOptions}
                    </select>

                    <label>Modelo de VisÃ£o:</label>
                    <select id="groq-vision-model-select" class="admin-input" style="width:100%;" onchange="window.saveManualSelection()">
                        <option value="">Selecione...</option>
                        ${groqVisionModelsOptions}
                    </select>
                </div>
                `;
            }

            if (isGoogle) {
                html += `
                <div class="admin-section">
                    <div class="admin-section-title">Motores de IA (Google)</div>
                    <div class="admin-list" id="api-models-list">
                         ${globalSettings.apiModels.map((model, index) => `
                            <div class="admin-list-item">
                                <div style="flex: 1;">
                                    <div style="font-size: 12px; font-weight: bold;">${model.name}</div>
                                    <div style="font-size: 10px; color: #888;">${model.vision ? 'VisÃ£o' : 'Texto'}</div>
                                </div>
                                <button class="patient-action-button delete" style="flex:0;" onclick="window.removeApiModel(${index})"><i class="fas fa-trash"></i></button>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px;">
                        <input type="text" id="new-model-name" class="admin-input" placeholder="Nome do modelo (ex: gemini-1.5-pro)" style="width: 100%; margin-bottom: 5px;">
                        <label class="radio-label" style="font-size: 12px; margin-bottom: 10px;">
                            <input type="checkbox" id="new-model-vision"> Suporta VisÃ£o?
                        </label>
                        <button class="app-modal-button" onclick="window.addApiModel()">Adicionar Modelo</button>
                    </div>
                </div>
                `;
            }

            adminSettingsBody.innerHTML = html;
        };

        const renderAdminDebugUI = () => {
            adminDebugBody.innerHTML = `
                <div class="admin-section">
                    <div class="admin-section-title">Layout</div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span>Modo Mobile 2.0 (Interface simplificada)</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="mobile-2-0-toggle" ${globalSettings.mobile2_0_enabled ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="admin-section" style="margin-top: 15px;">
                    <div class="admin-section-title">Assistente de PrescriÃ§Ã£o</div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <span>Mostrar BotÃ£o Assistente</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-assist-btn-visibility">
                            <span class="slider"></span>
                        </label>
                    </div>
                     <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span>Mostrar BotÃ£o Ferramentas (Plugins)</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-tools-btn-visibility">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px;">
                        <span style="font-size: 14px; font-weight: bold; display: block; margin-bottom: 5px;">Armazenamento Axon Eye</span>
                         <div class="radio-group" style="display: flex; flex-direction: column; gap: 5px;">
                            <label class="radio-label">
                                <input type="radio" name="axonEyeStorage" value="imgur" ${globalSettings.axonEyeStorageProvider !== 'axon_storage' ? 'checked' : ''}>
                                Imgur (PadrÃ£o - TemporÃ¡rio)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="axonEyeStorage" value="axon_storage" ${globalSettings.axonEyeStorageProvider === 'axon_storage' ? 'checked' : ''}>
                                Axon Storage (Supabase/Pinata - Permanente)
                            </label>
                        </div>
                    </div>

                </div>
                <div class="admin-section" style="margin-top: 15px;">
                    <div class="admin-section-title">Feedback e Logs</div>
                     <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span>Gerenciar Logs do Terminal</span>
                        <button class="app-modal-button" onclick="window.openLogSettings()" style="width: auto; padding: 5px 15px;">Configurar</button>
                    </div>
                </div>
                <div class="admin-section" style="margin-top: 15px;">
                    <div class="admin-section-title">Backup & Restore (Firestore)</div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="app-modal-button" onclick="window.backupFirestore()">Baixar Backup (JSON)</button>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="file" id="restore-file-input" accept=".json" style="display: none;" onchange="window.restoreFirestore(this)">
                            <button class="app-modal-button" style="background-color: var(--highlight-color);" onclick="document.getElementById('restore-file-input').click()">Restaurar Backup (JSON)</button>
                        </div>
                        <div id="backup-restore-feedback" class="app-modal-feedback" style="text-align: left; font-size: 12px;"></div>
                    </div>
                </div>
            `;
            document.getElementById('mobile-2-0-toggle').addEventListener('change', async (e) => {
                try {
                    await setDoc(doc(db, "settings", "global"), { mobile2_0_enabled: e.target.checked }, { merge: true });
                } catch (err) {
                    console.error("Erro ao salvar modo Mobile 2.0:", err);
                }
            });

            // Prescription Assistant Toggles
            // Prescription Assistant Toggles
            const toggleAssistBtn = document.getElementById('toggle-assist-btn-visibility');
            if (toggleAssistBtn) {
                // Load saved state from Global Settings
                const shouldShow = globalSettings.showPrescriptionAssistant !== false;
                toggleAssistBtn.checked = shouldShow;

                toggleAssistBtn.addEventListener('change', async (e) => {
                    try {
                        await setDoc(doc(db, "settings", "global"), { showPrescriptionAssistant: e.target.checked }, { merge: true });
                        // Local update for immediate feedback (though listener will confirm)
                        const btn = document.getElementById('btn-prescription-assist');
                        // We rely on the global listener, but immediate feedback is nice if online.
                        // But to be consistent with "Real-time", let's wait for listener or do optimistic UI?
                        // Optimistic is better for toggle responsiveness.
                        if (btn) btn.style.display = e.target.checked ? 'flex' : 'none';
                    } catch (err) {
                        console.error("Erro ao salvar visibilidade do assistente:", err);
                        // Revert toggle if failed?
                        e.target.checked = !e.target.checked;
                    }
                });
            }

            // Tools Button Toggle
            const toggleToolsBtn = document.getElementById('toggle-tools-btn-visibility');
            if (toggleToolsBtn) {
                // Set initial state without triggering listener
                toggleToolsBtn.checked = globalSettings.showToolsButton !== false;

                toggleToolsBtn.addEventListener('change', async (e) => {
                    const newState = e.target.checked;
                    try {
                        // Optimistic update of globalSettings in memory to prevent revert on re-render if it happens fast
                        globalSettings.showToolsButton = newState;

                        // Update UI immediately
                        const btn = document.getElementById('btn-tools');
                        if (btn) btn.style.display = newState ? 'flex' : 'none';

                        await setDoc(doc(db, "settings", "global"), { showToolsButton: newState }, { merge: true });
                    } catch (err) {
                        console.error("Erro ao salvar visibilidade ferramentas:", err);
                        // Revert UI
                        e.target.checked = !newState;
                        globalSettings.showToolsButton = !newState;
                        const btn = document.getElementById('btn-tools');
                        if (btn) btn.style.display = !newState ? 'flex' : 'none';
                    }
                });
            }

            // Axon Eye Storage Toggle
            const axonEyeRadios = document.getElementsByName('axonEyeStorage');
            axonEyeRadios.forEach(radio => {
                radio.addEventListener('change', async (e) => {
                    if (e.target.checked) {
                        try {
                            await setDoc(doc(db, "settings", "global"), { axonEyeStorageProvider: e.target.value }, { merge: true });
                            globalSettings.axonEyeStorageProvider = e.target.value; // Optimistic update
                        } catch (err) {
                            console.error("Erro ao salvar provider Axon Eye:", err);
                        }
                    }
                });
            });



        };

        window.backupFirestore = async () => {
            const feedback = document.getElementById('backup-restore-feedback');
            if (feedback) feedback.textContent = "Gerando backup...";
            try {
                const settingsDoc = await getDoc(doc(db, "settings", "global"));
                const settingsData = settingsDoc.exists() ? settingsDoc.data() : {};

                const usersSnap = await getDocs(collection(db, "users"));
                const usersData = [];
                usersSnap.forEach(doc => {
                    usersData.push({ id: doc.id, data: doc.data() });
                });

                const backupData = {
                    settings: settingsData,
                    users: usersData,
                    timestamp: new Date().toISOString(),
                    version: "1.6"
                };

                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "axon_backup_" + new Date().toISOString().slice(0, 10) + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                if (feedback) {
                    feedback.textContent = "Backup baixado com sucesso!";
                    feedback.style.color = "var(--success-color)";
                }
            } catch (e) {
                console.error("Erro no backup:", e);
                if (feedback) {
                    feedback.textContent = "Erro ao gerar backup: " + e.message;
                    feedback.style.color = "var(--error-color)";
                }
            }
        };

        window.restoreFirestore = async (input) => {
            const feedback = document.getElementById('backup-restore-feedback');
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                if (feedback) feedback.textContent = "Lendo arquivo...";

                reader.onload = async function (e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        if (feedback) feedback.textContent = "Restaurando dados...";

                        if (backupData.settings) {
                            await setDoc(doc(db, "settings", "global"), backupData.settings, { merge: true });
                        }

                        if (backupData.users && Array.isArray(backupData.users)) {
                            for (const user of backupData.users) {
                                if (user.id && user.data) {
                                    await setDoc(doc(db, "users", user.id), user.data, { merge: true });
                                }
                            }
                        }

                        if (feedback) {
                            feedback.textContent = "RestauraÃ§Ã£o concluÃ­da com sucesso! Recarregando...";
                            feedback.style.color = "var(--success-color)";
                        }
                        setTimeout(() => window.location.reload(), 2000);

                    } catch (err) {
                        console.error("Erro na restauraÃ§Ã£o:", err);
                        if (feedback) {
                            feedback.textContent = "Erro ao restaurar: " + err.message;
                            feedback.style.color = "var(--error-color)";
                        }
                    }
                };
                reader.readAsText(file);
            }
        };

        window.updateProvider = async (provider) => {
            try {
                await setDoc(doc(db, "settings", "global"), { ...globalSettings, apiProvider: provider }, { merge: true });
            } catch (e) { console.error("Erro ao atualizar provedor:", e); }
        };

        window.updateMode = async (mode) => {
            try {
                await setDoc(doc(db, "settings", "global"), { ...globalSettings, mode }, { merge: true });
            } catch (e) { console.error("Erro ao atualizar modo:", e); }
        };

        window.saveManualSelection = async () => {
            let updates = {};

            if (globalSettings.apiProvider === 'gemini') {
                const textModel = document.getElementById('manual-text-select')?.value;
                const visionModel = document.getElementById('manual-vision-select')?.value;
                const apiKey = document.getElementById('manual-key-select')?.value;
                updates = {
                    manualTextModel: textModel,
                    manualVisionModel: visionModel,
                    manualApiKey: apiKey
                };
            } else if (globalSettings.apiProvider === 'openrouter') {
                const orKey = document.getElementById('openrouter-key-input')?.value;
                const orModel = document.getElementById('openrouter-model-select')?.value;
                updates = {
                    openRouterKey: orKey,
                    openRouterModel: orModel
                };
            } else if (globalSettings.apiProvider === 'groq') {
                const groqKey = document.getElementById('groq-key-input')?.value;
                const groqTextModel = document.getElementById('groq-text-model-select')?.value;
                const groqVisionModel = document.getElementById('groq-vision-model-select')?.value;
                updates = {
                    groqKey: groqKey,
                    groqTextModel: groqTextModel,
                    groqVisionModel: groqVisionModel
                };
            } else if (globalSettings.apiProvider === 'custom') {
                const textProvider = document.getElementById('custom-text-provider')?.value;
                const visionProvider = document.getElementById('custom-vision-provider')?.value;
                updates = {
                    customTextProvider: textProvider,
                    customVisionProvider: visionProvider
                };
            }

            try {
                await setDoc(doc(db, "settings", "global"), {
                    ...globalSettings,
                    ...updates
                }, { merge: true });
            } catch (e) { console.error("Erro ao salvar seleÃ§Ã£o manual:", e); }
        };

        window.openLogSettings = () => {
            const modal = document.getElementById('log-settings-modal');
            const toggle = document.getElementById('modal-hide-status-toggle');
            if (modal && toggle) {
                toggle.checked = globalSettings.hideStatusMessages || false;
                modal.style.display = 'flex';
            }
        };

        window.toggleLogSuppression = async (isChecked) => {
            try {
                // Optimistic UI update
                globalSettings.hideStatusMessages = isChecked;
                applySettings(); // Immediately applies CSS class

                await setDoc(doc(db, "settings", "global"), {
                    hideStatusMessages: isChecked
                }, { merge: true });
            } catch (e) {
                console.error("Erro ao salvar configuraÃ§Ã£o de log:", e);
                // Revert if error
                globalSettings.hideStatusMessages = !isChecked;
                applySettings();
            }
        };

        window.refreshGroqModels = async () => {
            const apiKey = document.getElementById('groq-key-input').value;
            if (!apiKey) { alert("Insira a chave API do Groq primeiro."); return; }

            const btn = document.getElementById('btn-refresh-groq');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
            btn.disabled = true;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/models", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    }
                });

                if (!response.ok) throw new Error(`Erro: ${response.status} ${response.statusText}`);

                const data = await response.json();

                // Process models
                const models = data.data.map(m => ({
                    name: m.id,
                    vision: m.id.includes('vision') || m.id.includes('llama-3.2') // Simple heuristic
                })).sort((a, b) => a.name.localeCompare(b.name));

                await setDoc(doc(db, "settings", "global"), {
                    ...globalSettings,
                    groqAvailableModels: models
                }, { merge: true });

                alert("Modelos atualizados com sucesso!");
                // The onSnapshot will trigger re-render

            } catch (e) {
                console.error(e);
                alert("Erro ao buscar modelos: " + e.message);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        };

        window.addApiKey = async () => {
            const input = document.getElementById('new-api-key');
            const newKey = input.value.trim();
            if (newKey) {
                const newKeys = [...globalSettings.apiKeys, newKey];
                try {
                    await setDoc(doc(db, "settings", "global"), { ...globalSettings, apiKeys: newKeys }, { merge: true });
                    input.value = '';
                } catch (e) { console.error("Erro ao adicionar chave:", e); }
            }
        };

        window.removeApiKey = async (index) => {
            if (globalSettings.apiKeys.length <= 1) {
                alert("Ã‰ necessÃ¡rio ter pelo menos uma chave de API.");
                return;
            }
            const newKeys = globalSettings.apiKeys.filter((_, i) => i !== index);
            try {
                await setDoc(doc(db, "settings", "global"), { ...globalSettings, apiKeys: newKeys }, { merge: true });
            } catch (e) { console.error("Erro ao remover chave:", e); }
        };

        window.addApiModel = async () => {
            const nameInput = document.getElementById('new-model-name');
            const visionInput = document.getElementById('new-model-vision');
            const name = nameInput.value.trim();
            if (name) {
                const newModel = { id: Date.now(), name, vision: visionInput.checked };
                const newModels = [...globalSettings.apiModels, newModel];
                try {
                    await setDoc(doc(db, "settings", "global"), { ...globalSettings, apiModels: newModels }, { merge: true });
                    nameInput.value = '';
                    visionInput.checked = false;
                } catch (e) { console.error("Erro ao adicionar modelo:", e); }
            }
        };

        window.removeApiModel = async (index) => {
            if (globalSettings.apiModels.length <= 1) {
                alert("Ã‰ necessÃ¡rio ter pelo menos um modelo.");
                return;
            }
            const newModels = globalSettings.apiModels.filter((_, i) => i !== index);
            try {
                await setDoc(doc(db, "settings", "global"), { ...globalSettings, apiModels: newModels }, { merge: true });
            } catch (e) { console.error("Erro ao remover modelo:", e); }
        };

        const loadAdminUsersData = async () => {
            try {
                const usersSnap = await getDocs(collection(db, "users"));
                const users = [];

                const patientsSnap = await getDocs(collection(db, "patients"));
                const savedCounts = {};
                patientsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.savedBy) {
                        savedCounts[data.savedBy] = (savedCounts[data.savedBy] || 0) + 1;
                    }
                });

                usersSnap.forEach(doc => {
                    const userData = doc.data();
                    users.push({
                        username: doc.id,
                        ...userData,
                        savedCount: savedCounts[doc.id] || 0
                    });
                });

                users.sort((a, b) => b.savedCount - a.savedCount);
                adminUsersData = users;
                renderAdminUsersList(users);

            } catch (e) {
                console.error("Erro ao carregar usuÃ¡rios:", e);
                adminUsersList.innerHTML = `<div class="error">Erro ao carregar dados: ${e.message}</div>`;
            }
        };

        const renderAdminUsersList = (users) => {
            if (users.length === 0) {
                adminUsersList.innerHTML = '<div class="info">Nenhum usuÃ¡rio encontrado.</div>';
                return;
            }

            adminUsersList.innerHTML = users.map(user => `
                <div class="user-list-item" onclick="window.selectAdminUser('${user.username}')" id="user-item-${user.username}">
                    <div>
                        <span class="user-name" style="${user.isBlocked ? 'text-decoration: line-through; color: #666;' : ''}">${user.username}</span>
                        <div style="font-size: 10px; color: #666;">Registrado em: ${user.createdAt ? user.createdAt.toDate().toLocaleDateString() : 'N/A'}</div>
                    </div>
                    <div style="display: flex; gap: 5px; align-items:center;">
                        ${user.isBlocked ? '<span class="analytics-badge" style="color: #ffcc00; border: 1px solid #ffcc00; padding:2px 5px; border-radius:10px;">Bloqueado</span>' : ''}
                        <span class="analytics-badge ${user.savedCount > 0 ? 'analytics-high' : ''}" style="border: 1px solid; padding:2px 5px; border-radius:10px;">${user.savedCount} Pacientes</span>
                    </div>
                </div>
            `).join('');
        };

        window.selectAdminUser = async (username) => {
            document.querySelectorAll('.user-list-item').forEach(el => el.classList.remove('selected'));
            const selectedEl = document.getElementById(`user-item-${username}`);
            if (selectedEl) selectedEl.classList.add('selected');

            const user = adminUsersData.find(u => u.username === username);
            if (!user) return;

            adminUserDetails.innerHTML = '<div class="info">Carregando detalhes e imagens...</div>';

            try {
                const patientsQuery = query(collection(db, "patients"), where("savedBy", "==", username));
                const patientsSnap = await getDocs(patientsQuery);

                let images = [];
                let consultationsLast7Days = 0;
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                patientsSnap.forEach(doc => {
                    const pData = doc.data();
                    if (pData.consultations) {
                        pData.consultations.forEach(c => {
                            if (c.date && c.date.toDate() > oneWeekAgo) consultationsLast7Days++;
                            if (c.axonEyeImages && c.axonEyeImages.length > 0) {
                                c.axonEyeImages.forEach(img => images.push(img.link));
                            }
                        });
                    }
                });

                const dailyAvg = (consultationsLast7Days / 7).toFixed(1);

                let imagesHtml = '';
                if (images.length > 0) {
                    imagesHtml = `
                        <div class="user-detail-header" style="margin-top: 20px;">
                            <div class="user-detail-label">IMAGENS ENVIADAS Ã€ IA (HistÃ³rico)</div>
                        </div>
                        <div class="admin-user-images">
                            ${images.map(src => `<img src="${src}" class="admin-user-img" onclick="window.openFullscreenModal('${src}')">`).join('')}
                        </div>
                    `;
                } else {
                    imagesHtml = '<div class="info" style="margin-top: 15px;">Nenhuma imagem salva encontrada.</div>';
                }

                renderUserDetails(user, imagesHtml);

                if (unsubscribeUserDoc) unsubscribeUserDoc();
                unsubscribeUserDoc = onSnapshot(doc(db, "users", username), (doc) => {
                    if (doc.exists()) {
                        const updatedUser = { username: doc.id, ...doc.data() };
                        const idx = adminUsersData.findIndex(u => u.username === username);
                        if (idx !== -1) adminUsersData[idx] = updatedUser;
                        renderUserDetails(updatedUser, imagesHtml);
                    }
                });

            } catch (e) {
                console.error("Erro ao carregar detalhes do usuÃ¡rio:", e);
                adminUserDetails.innerHTML = `<div class="error">Erro ao carregar detalhes: ${e.message}</div>`;
            }
        };

        window.createUserFromPanel = async () => {
            const usernameInput = document.getElementById('admin-new-user');
            const passwordInput = document.getElementById('admin-new-pass');
            const emailInput = document.getElementById('admin-new-email');
            const levelInput = document.getElementById('admin-new-level');
            const daysInput = document.getElementById('admin-new-days');
            const hoursInput = document.getElementById('admin-new-hours');
            const minutesInput = document.getElementById('admin-new-minutes');
            const isAdminInput = document.getElementById('admin-new-isadmin');
            const feedback = document.getElementById('admin-create-user-feedback');

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            const email = emailInput ? emailInput.value.trim() : '';
            const accountLevel = levelInput ? levelInput.value : 'personal';
            const days = daysInput ? parseInt(daysInput.value) || 0 : 30;
            const hours = hoursInput ? parseInt(hoursInput.value) || 0 : 0;
            const minutes = minutesInput ? parseInt(minutesInput.value) || 0 : 0;
            const isAdmin = isAdminInput ? isAdminInput.checked : false;

            if (!username || !password) {
                feedback.textContent = "Nome e senha sÃ£o obrigatÃ³rios.";
                feedback.style.color = "var(--error-color)";
                return;
            }

            feedback.textContent = "Criando...";
            feedback.style.color = "var(--text-color)";

            try {
                const userRef = doc(db, "users", username);
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    feedback.textContent = `UsuÃ¡rio '${username}' jÃ¡ existe.`;
                    feedback.style.color = "var(--error-color)";
                } else {
                    await setDoc(userRef, {
                        password,
                        email,
                        accountLevel,
                        subscriptionDays: isAdmin ? 0 : days,
                        subscriptionHours: isAdmin ? 0 : hours,
                        subscriptionMinutes: isAdmin ? 0 : minutes,
                        subscriptionStartDate: null, // Will start on first login
                        isAdmin,
                        createdAt: new Date(),
                        textRequests: 0,
                        visionRequests: 0,
                        isBlocked: false,
                        isCloudDisabled: false
                    });

                    feedback.textContent = `UsuÃ¡rio '${username}' criado!`;
                    feedback.style.color = "var(--success-color)";

                    // Clear inputs
                    usernameInput.value = '';
                    passwordInput.value = '';
                    if (emailInput) emailInput.value = '';
                    if (daysInput) daysInput.value = '30';
                    if (hoursInput) hoursInput.value = '0';
                    if (minutesInput) minutesInput.value = '0';
                    if (isAdminInput) isAdminInput.checked = false;

                    loadAdminUsersData();
                }
            } catch (e) {
                feedback.textContent = "Erro: " + e.message;
                feedback.style.color = "var(--error-color)";
            }
        };



        const renderUserDetails = (user) => {
            const adminUserDetails = document.getElementById('admin-user-details');
            const consultationsLast7Days = 0; // Placeholder
            const dailyAvg = 0; // Placeholder
            const images = user.axonEyeImages || []; // Or fetch from sessions

            try {
                let imagesHtml = '';
                // ... (Images logic unchanged) ... 
                if (images.length > 0) {
                    imagesHtml = `
                        <div class="user-detail-header" style="margin-top: 20px;">
                            <div class="user-detail-label">IMAGENS ENVIADAS Ã€ IA (HistÃ³rico)</div>
                        </div>
                        <div class="admin-user-images">
                            ${images.map(src => `<img src="${src}" class="admin-user-img" onclick="window.openFullscreenModal('${src}')">`).join('')}
                        </div>
                    `;
                } else {
                    imagesHtml = '<div class="info" style="margin-top: 15px;">Nenhuma imagem salva encontrada.</div>';
                }

                const subStatus = checkSubscriptionStatus(user);
                const badgeColor = user.isAdmin ? 'var(--accent-color)' : (user.accountLevel === 'enterprise' ? '#805ad5' : (user.accountLevel === 'student' ? '#f59e0b' : '#3182ce'));
                const badgeText = user.isAdmin ? 'Administrador' : (user.accountLevel === 'enterprise' ? 'Enterprise' : (user.accountLevel === 'student' ? 'Student' : 'Personal'));

                adminUserDetails.innerHTML = `
                    <div class="user-detail-header">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; width:100%;">
                            <div>
                                <h3 style="color: var(--prompt-color); margin-bottom: 5px;">${user.username} ${user.isBlocked ? '(BLOQUEADO)' : ''}</h3>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <span style="font-size: 12px; color: #888;">ID: ${user.username}</span>
                                    <span style="font-size: 10px; background: ${badgeColor}; color: white; padding: 2px 6px; border-radius: 4px;">${badgeText}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        <div class="user-detail-row">
                            <span class="user-detail-label">SENHA</span>
                            <span class="user-detail-value" style="font-family: monospace;">${user.password || '****'}</span>
                        </div>
                        <div class="user-detail-row">
                            <span class="user-detail-label">EMAIL</span>
                            <span class="user-detail-value">${user.email || '-'}</span>
                        </div>
                        <div class="user-detail-row">
                            <span class="user-detail-label">DATA REGISTRO</span>
                            <span class="user-detail-value">${user.createdAt ? (user.createdAt.toDate ? user.createdAt.toDate().toLocaleDateString() : new Date(user.createdAt).toLocaleDateString()) : 'Desconhecida'}</span>
                        </div>
                         <div class="user-detail-row">
                            <span class="user-detail-label">ASSINATURA</span>
                            <span class="user-detail-value" style="color: ${subStatus.expired && !user.isAdmin ? 'var(--error-color)' : 'var(--success-color)'}; font-weight:bold;">
                                ${subStatus.formattedRemaining}
                            </span>
                        </div>
                    </div>

                     <div class="user-detail-row" style="margin-top: 15px;">
                         <span class="user-detail-label">AÃ‡Ã•ES DA CONTA</span>
                         <div style="display: flex; margin-top: 5px; gap: 10px; flex-wrap: wrap;">
                             <button class="patient-action-button" style="flex: 1;" onclick="window.toggleBlockUser('${user.username}', ${!user.isBlocked})">
                                ${user.isBlocked ? '<i class="fas fa-unlock"></i> Desbloquear' : '<i class="fas fa-ban"></i> Bloquear'}
                             </button>
                             <button class="patient-action-button" style="flex: 1;" onclick="window.toggleUserCloudAccess('${user.username}', ${!user.isCloudDisabled})">
                                ${user.isCloudDisabled ? '<i class="fas fa-cloud"></i> Ativar Cloud' : '<i class="fas fa-cloud-slash"></i> Desativar Cloud'}
                             </button>
                             <button class="patient-action-button delete" style="flex: 1;" onclick="window.deleteUserFromPanel('${user.username}')">
                                <i class="fas fa-trash"></i> Excluir UsuÃ¡rio
                             </button>
                         </div>
                         <div style="display: flex; margin-top: 10px; gap: 10px;">
                             <button class="patient-action-button" style="flex: 1; background: #2d3748; color: white;" onclick="window.openAddTimeModal('${user.username}')">
                                <i class="fas fa-clock"></i> Adicionar Tempo
                             </button>
                             <button class="patient-action-button" style="flex: 1; background: #2d3748; color: white;" onclick="window.toggleAdminStatus('${user.username}', ${!user.isAdmin})">
                                ${user.isAdmin ? '<i class="fas fa-user-slash"></i> Remover Admin' : '<i class="fas fa-user-shield"></i> Tornar Admin'}
                             </button>
                         </div>
                    </div>

                    <div class="usage-stats-box">
                        <div class="user-detail-label" style="color: var(--highlight-color);">ESTATÃSTICAS DE USO (API)</div>
                        <div style="display: flex; gap: 20px; margin-top: 5px; flex-wrap: wrap;">
                            <div>
                                <div style="font-size: 20px; font-weight: bold;">${user.textRequests || 0}</div>
                                <div style="font-size: 10px;">req Texto</div>
                            </div>
                             <div>
                                <div style="font-size: 20px; font-weight: bold;">${user.visionRequests || 0}</div>
                                <div style="font-size: 10px;">req VisÃ£o</div>
                            </div>
                             <div>
                                <div style="font-size: 20px; font-weight: bold;">${user.savedCount || 0}</div>
                                <div style="font-size: 10px;">Pacientes</div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error("Erro ao carregar detalhes do usuÃ¡rio:", e);
                adminUserDetails.innerHTML = `<div class="error">Erro ao carregar detalhes: ${e.message}</div>`;
            }
        };

        window.toggleBlockUser = async (username, shouldBlock) => {
            try {
                const userRef = doc(db, "users", username);
                await updateDoc(userRef, { isBlocked: shouldBlock });
            } catch (e) {
                alert(`Erro ao alterar status de bloqueio: ${e.message}`);
            }
        };

        window.toggleUserCloudAccess = async (username, shouldDisable) => {
            try {
                const userRef = doc(db, "users", username);
                await updateDoc(userRef, { isCloudDisabled: shouldDisable });
            } catch (e) {
                alert(`Erro ao alterar acesso cloud: ${e.message}`);
            }
        };

        window.openAddTimeModal = (username) => {
            const modal = document.getElementById('add-time-modal');
            const target = document.getElementById('add-time-target-user');
            if (modal && target) {
                target.textContent = `UsuÃ¡rio: ${username}`;
                target.dataset.username = username;
                document.getElementById('add-time-days').value = 0;
                document.getElementById('add-time-hours').value = 0;
                document.getElementById('add-time-minutes').value = 0;
                modal.style.display = 'flex';
            }
        };

        const submitAddTime = async () => {
            const username = document.getElementById('add-time-target-user').dataset.username;
            const daysInput = parseInt(document.getElementById('add-time-days').value) || 0;
            const hoursInput = parseInt(document.getElementById('add-time-hours').value) || 0;
            const minutesInput = parseInt(document.getElementById('add-time-minutes').value) || 0;

            if (!username) return;

            const btn = document.getElementById('submit-add-time-btn');
            const originalText = btn.textContent;
            btn.textContent = "Processando...";
            btn.disabled = true;

            try {
                const userRef = doc(db, "users", username);
                const userDoc = await getDoc(userRef);
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    const status = checkSubscriptionStatus(data);

                    let updateData = {};

                    if (status.expired) {
                        // Reset start date to NOW and strictly set duration
                        updateData = {
                            subscriptionStartDate: new Date(),
                            subscriptionDays: daysInput,
                            subscriptionHours: hoursInput,
                            subscriptionMinutes: minutesInput,
                            isBlocked: false
                        };
                    } else {
                        // Extend logic
                        updateData = {
                            subscriptionDays: (data.subscriptionDays || 0) + daysInput,
                            subscriptionHours: (data.subscriptionHours || 0) + hoursInput,
                            subscriptionMinutes: (data.subscriptionMinutes || 0) + minutesInput
                        };
                    }

                    await updateDoc(userRef, updateData);
                    document.getElementById('add-time-modal').style.display = 'none';
                    // The onSnapshot listener in selectAdminUser will handle the UI update
                }
            } catch (e) {
                alert("Erro: " + e.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        };

        const _subTimeBtn = document.getElementById('submit-add-time-btn');
        if (_subTimeBtn) _subTimeBtn.onclick = submitAddTime;

        window.toggleAdminStatus = async (username, isAdmin) => {
            if (username === currentUser && !isAdmin) {
                if (!confirm("VocÃª estÃ¡ removendo seu prÃ³prio acesso de administrador. Tem certeza?")) return;
            }
            try {
                const userRef = doc(db, "users", username);
                await updateDoc(userRef, { isAdmin: isAdmin });
            } catch (e) {
                alert(`Erro ao alterar status de admin: ${e.message}`);
            }
        };

        window.deleteUserFromPanel = async (username) => {
            showConfirmModal(`Tem certeza que deseja excluir o usuÃ¡rio '${username}' permanentemente?`, async () => {
                try {
                    const userRef = doc(db, "users", username);
                    await deleteDoc(userRef);
                    // No need to manually update list, listener or refresh will handle?
                    // But we don't have a listener on the LIST entire collection usually, just manual load.
                    adminUsersData = adminUsersData.filter(u => u.username !== username);
                    renderAdminUsersList(adminUsersData);
                    document.getElementById('admin-user-details').innerHTML = '<div class="info" style="margin-top: 20px;">UsuÃ¡rio excluÃ­do. Selecione outro.</div>';
                } catch (e) {
                    alert(`Erro ao excluir usuÃ¡rio: ${e.message}`);
                }
            });
        };

        const openPrescriptionHelper = async (category) => {
            prescriptionHelperTitle.textContent = `Assistente de PrescriÃ§Ã£o: ${category}`;
            prescriptionHelperBody.innerHTML = `<div class="info">Gerando sugestÃµes personalizadas para o paciente...</div>`;
            prescriptionHelperModal.style.display = 'flex';

            try {
                const templates = await generateContextualTemplates(category);

                let contentHTML = '';
                if (templates && templates.length > 0) {
                    templates.forEach((template, index) => {
                        const templateId = `template-${category.replace(/\s/g, '-')}-${index}`;
                        contentHTML += `
                            <div class="prescription-template-item">
                                <div class="prescription-template-header">
                                    <div class="prescription-template-title">${template.title}</div>
                                    <button class="prescription-template-copy-btn" data-template-id="${templateId}">
                                        <i class="fas fa-copy"></i> Copiar
                                    </button>
                                </div>
                                <div class="prescription-template-text" id="${templateId}">${template.text}</div>
                            </div>
                        `;
                    });
                } else {
                    contentHTML = `<div class="info">Nenhuma sugestÃ£o relevante encontrada para o quadro clÃ­nico atual.</div>`;
                }

                prescriptionHelperBody.innerHTML = contentHTML;

            } catch (error) {
                console.error(`Error generating contextual templates for ${category}:`, error);
                prescriptionHelperBody.innerHTML = `<div class="error">Erro ao gerar sugestÃµes: ${error.message}</div>`;
            }
        };

        const generateContextualTemplates = async (category) => {
            let instruction = '';
            let format_example = '';
            switch (category) {
                case 'CONDUTA FARMACOLÃ“GICA (SUS)':
                    instruction = "Gere atÃ© 3 prescriÃ§Ãµes de medicamentos (padrÃ£o SUS) pertinentes ao quadro clÃ­nico.";
                    format_example = `O texto ('text') de cada prescriÃ§Ã£o deve seguir EXATAMENTE este formato multi-linha:
USO ORAL:
[NOME DO MEDICAMENTO] [DOSAGEM] ---------------- [QUANTIDADE/DURAÃ‡ÃƒO]
[INSTRUÃ‡Ã•ES DE USO (ex: TOMAR 01 COMPRIMIDO AO DIA)]`;
                    break;
                case 'EXAMES COMPLEMENTARES (SUS)':
                    instruction = "Gere atÃ© 3 solicitaÃ§Ãµes de exames (padrÃ£o SUS) pertinentes, com justificativa clÃ­nica.";
                    format_example = `O texto ('text') de cada solicitaÃ§Ã£o deve seguir EXATAMENTE este formato multi-linha:
SOLICITO:
- [NOME DO EXAME 1]
- [NOME DO EXAME 2]
JUSTIFICATIVA: [Justificativa clÃ­nica concisa]`;
                    break;
                case 'CONDUTAS NÃƒO FARMACOLÃ“GICAS (SUS)':
                    instruction = "Gere atÃ© 3 condutas nÃ£o farmacolÃ³gicas pertinentes, focando em encaminhamentos para especialistas.";
                    format_example = `O texto ('text') de cada encaminhamento deve seguir EXATAMENTE este formato multi-linha:
Ã€ [ESPECIALIDADE]:
ENCAMINHO O PACIENTE [NOME DO PACIENTE AQUI], COM [DIAGNÃ“STICO/SINTOMAS PRINCIPAIS].
GRATO.`;
                    break;
                case 'RECOMENDAÃ‡Ã•ES':
                    instruction = "Gere atÃ© 3 recomendaÃ§Ãµes ou atestados pertinentes para a situaÃ§Ã£o do paciente.";
                    format_example = `O texto ('text') deve ser claro, objetivo e pronto para uso, como um atestado ou uma recomendaÃ§Ã£o formal.`;
                    break;
                default:
                    return [];
            }

            const prompt = `VocÃª Ã© um assistente mÃ©dico especialista em gerar documentos clÃ­nicos. Com base no quadro clÃ­nico do paciente, siga a instruÃ§Ã£o fornecida.

**Quadro ClÃ­nico do Paciente:**
- Anamnese: ${JSON.stringify(anamnesis)}
- Resultados de Exames PrÃ©vios: ${examsResults || "Nenhum"}
- AnÃ¡lise Visual (Axon Eye): ${axonEyeResults || "Nenhum"}

**InstruÃ§Ã£o EspecÃ­fica:**
${instruction}

**Regras de FormataÃ§Ã£o (ObrigatÃ³rio):**
1. Crie solicitaÃ§Ãµes que faÃ§am sentido clÃ­nico com o quadro apresentado.
2. Formate a resposta como um array JSON de objetos. Cada objeto deve ter as chaves 'title' e 'text'.
3. O 'title' deve ser um resumo curto da sugestÃ£o (ex: "Metformina para DM2", "Encaminhamento Ã  Cardiologia").
4. ${format_example}
5. Se nenhuma sugestÃ£o for clinicamente justificÃ¡vel, retorne um array JSON vazio: [].

**Retorne APENAS o array JSON, sem nenhum texto ou formataÃ§Ã£o adicional.**`;

            try {
                const response = await callGeminiAPI(prompt);
                const jsonStart = response.indexOf('[');
                const jsonEnd = response.lastIndexOf(']') + 1;
                if (jsonStart === -1 || jsonEnd === 0) {
                    console.error("No JSON array found in response:", response);
                    return [];
                }
                const jsonString = response.substring(jsonStart, jsonEnd);
                return JSON.parse(jsonString);
            } catch (error) {
                console.error("Failed to parse AI response for templates:", error);
                throw new Error("A IA retornou uma resposta em formato invÃ¡lido.");
            }
        };

        const closePrescriptionHelper = () => {
            prescriptionHelperModal.style.display = 'none';
        };

        const openChatbox = () => {
            chatboxMessages.innerHTML = '';
            // Populate with existing history
            conversationHistory.forEach(msg => {
                const textPart = msg.parts.find(p => p.text);
                const imageParts = msg.parts.filter(p => p.inlineData);
                appendChatMessage(textPart.text, msg.role, false, imageParts.map(p => `data:${p.inlineData.mimeType};base64,${p.inlineData.data}`));
            });

            if (conversationHistory.length === 0) {
                appendChatMessage(`OlÃ¡ Dr(a). ${currentUser}! Como posso te ajudar hoje?`, 'model');
            }

            chatboxModal.style.display = 'flex';
            chatboxInput.focus();
        };

        const closeChatbox = () => {
            chatboxModal.style.display = 'none';
        };

        const showConfirmModal = (message, onConfirm, isAlert = false) => {
            const modal = document.getElementById('custom-confirm-modal');
            const text = document.getElementById('confirm-modal-text');
            const btnYes = document.getElementById('confirm-btn-yes');
            const btnNo = document.getElementById('confirm-btn-no');

            text.textContent = message;

            if (isAlert) {
                btnYes.style.display = 'none';
                btnNo.textContent = 'OK';
            } else {
                btnYes.style.display = 'inline-block';
                btnNo.textContent = 'Cancelar';
            }

            modal.style.display = 'flex';

            return new Promise((resolve) => {
                const handleYes = () => {
                    modal.style.display = 'none';
                    if (onConfirm) onConfirm();
                    resolve(true);
                    cleanup();
                };
                const handleNo = () => {
                    modal.style.display = 'none';
                    resolve(false);
                    cleanup();
                };

                const cleanup = () => {
                    btnYes.onclick = null;
                    btnNo.onclick = null;
                }

                btnYes.onclick = handleYes;
                btnNo.onclick = handleNo;
            });
        };
        window.showConfirmModal = showConfirmModal;

        const appendChatMessage = (message, sender, isTyping = false, images = []) => {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `chat-message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'chat-avatar';
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user-circle"></i>' : '<i class="fas fa-robot"></i>';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            if (isTyping) {
                bubble.classList.add('typing');
                bubble.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
            } else {
                let contentHTML = message.replace(/\*(.*?)\*/g, '<b>$1</b>');
                if (images.length > 0) {
                    images.forEach(imgSrc => {
                        contentHTML += `<img src="${imgSrc}" class="chat-image-attachment" onclick="window.openFullscreenModal('${imgSrc}')">`;
                    });
                }
                bubble.innerHTML = contentHTML;
            }

            messageWrapper.appendChild(avatar);
            messageWrapper.appendChild(bubble);
            chatboxMessages.appendChild(messageWrapper);
            chatboxMessages.scrollTop = chatboxMessages.scrollHeight;

            return bubble;
        };

        const handleChatImageUpload = (event) => {
            chatImagePreviews.innerHTML = '';
            chatImagesToSend = [];
            const files = Array.from(event.target.files);

            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageDataURL = e.target.result;
                        chatImagesToSend.push(imageDataURL);

                        const previewItem = document.createElement('div');
                        previewItem.className = 'chat-preview-item';
                        previewItem.innerHTML = `
                            <img src="${imageDataURL}" alt="Preview">
                            <button class="chat-preview-delete" onclick="window.removeChatPreviewImage(${index})">&times;</button>
                        `;
                        chatImagePreviews.appendChild(previewItem);
                    };
                    reader.readAsDataURL(file);
                }
            });
            event.target.value = ''; // Reset input
        };

        window.removeChatPreviewImage = (indexToRemove) => {
            chatImagesToSend.splice(indexToRemove, 1);
            chatImagePreviews.innerHTML = ''; // Re-render
            chatImagesToSend.forEach((imageDataURL, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'chat-preview-item';
                previewItem.innerHTML = `
                    <img src="${imageDataURL}" alt="Preview">
                    <button class="chat-preview-delete" onclick="window.removeChatPreviewImage(${index})">&times;</button>
                `;
                chatImagePreviews.appendChild(previewItem);
            });
        };

        const sendChatMessage = async () => {
            const question = chatboxInput.value.trim();
            if (!question && chatImagesToSend.length === 0) return;

            appendChatMessage(question, 'user', false, chatImagesToSend);
            chatboxInput.value = '';
            chatboxInput.disabled = true;
            chatboxSendBtn.disabled = true;
            chatboxUploadBtn.disabled = true;
            chatImagePreviews.innerHTML = '';

            const images = [...chatImagesToSend];
            chatImagesToSend = [];

            const typingBubble = appendChatMessage('', 'model', true);

            try {
                let response;
                if (images.length > 0) {
                    response = await askVisionQuestionBasedOnContext(question || "Analise esta(s) imagem(ns).", images);
                } else {
                    response = await askQuestionBasedOnContext(question);
                }

                const formattedResponse = response.replace(/\*(.*?)\*/g, '<b>$1</b>');

                typingBubble.innerHTML = formattedResponse;
                typingBubble.classList.remove('typing');

            } catch (error) {
                typingBubble.innerHTML = `Desculpe, ocorreu um erro: ${error.message}`;
                typingBubble.style.color = 'var(--error-color)';
                typingBubble.classList.remove('typing');
            } finally {
                chatboxInput.disabled = false;
                chatboxSendBtn.disabled = false;
                chatboxUploadBtn.disabled = false;
                chatboxInput.focus();
            }
        };

        adminUserSearch.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = adminUsersData.filter(u => u.username.toLowerCase().includes(term));
            renderAdminUsersList(filtered);
        });

        adminPanelClose.addEventListener('click', () => adminPanelModal.style.display = 'none');

        adminTabButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tabName = e.currentTarget.dataset.tab;
                activateAdminTab(tabName);
            });
        });

        const activateAdminTab = (tabName) => {
            document.querySelectorAll('.admin-tab-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).style.display = 'block';
            document.querySelector(`.admin-tab-btn[data-tab="${tabName}"]`).classList.add('active');

            if (tabName === 'users') loadAdminUsersData();
            if (tabName === 'api') renderAdminSettingsUI();
            if (tabName === 'debug') renderAdminDebugUI();
            if (tabName === 'axon-drive') renderAdminAxonDrive();
            if (tabName === 'bridge') renderAdminBridgeUI();
        };

        const validatePinataKey = async (apiKey, apiSecret) => {
            try {
                const response = await fetch('https://api.pinata.cloud/data/testAuthentication', {
                    method: 'GET',
                    headers: {
                        'pinata_api_key': apiKey,
                        'pinata_secret_api_key': apiSecret
                    }
                });
                return response.ok;
            } catch (e) {
                console.error("Erro na validaÃ§Ã£o da chave Pinata:", e);
                return false;
            }
        };

        window.addPinataKey = async () => {
            const keyInput = document.getElementById('new-pinata-key');
            const secretInput = document.getElementById('new-pinata-secret');
            const jwtInput = document.getElementById('new-pinata-jwt');

            const key = keyInput.value.trim();
            const secret = secretInput.value.trim();
            const jwt = jwtInput.value.trim();

            if (!key || !secret) {
                showConfirmModal("Por favor, insira a API Key e a Secret Key.", null, true);
                return;
            }

            const btn = document.getElementById('btn-add-pinata-key');
            const originalText = btn.innerHTML;
            btn.textContent = "Validando...";
            btn.disabled = true;

            const isValid = await validatePinataKey(key, secret);

            if (isValid) {
                const newKeyObj = { key, secret, jwt, addedAt: new Date().toISOString() };
                const currentKeys = globalSettings.pinataKeys || [];
                const updatedKeys = [...currentKeys, newKeyObj];

                try {
                    await setDoc(doc(db, "settings", "global"), { pinataKeys: updatedKeys }, { merge: true });
                    keyInput.value = '';
                    secretInput.value = '';
                    jwtInput.value = '';
                    showConfirmModal("Chave adicionada com sucesso! (+1GB)", null, true);
                    renderAdminAxonDrive();
                } catch (e) {
                    showConfirmModal("Erro ao salvar chave: " + e.message, null, true);
                }
            } else {
                showConfirmModal("Chave invÃ¡lida! Verifique suas credenciais no Pinata.", null, true);
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        };

        window.adminRenameFile = async (id, pathRef, currentName) => {
            const modal = document.getElementById('custom-input-modal');
            const titleEl = document.getElementById('custom-input-title');
            const inputEl = document.getElementById('custom-input-field');
            const confirmBtn = document.getElementById('custom-input-confirm');
            const cancelBtn = document.getElementById('custom-input-cancel');

            titleEl.textContent = "Renomear Arquivo";
            inputEl.value = currentName;
            modal.style.display = 'flex';
            inputEl.focus();

            confirmBtn.onclick = async () => {
                const newName = inputEl.value.trim();
                if (newName && newName !== currentName) {
                    try {
                        const parts = pathRef.split('/');
                        // Ensure minimal path length (collection/doc)
                        if (parts.length >= 2) {
                            const docRef = doc(db, ...parts);
                            await updateDoc(docRef, { name: newName });
                            renderAdminAxonDrive();
                        }
                        modal.style.display = 'none';
                    } catch (e) {
                        alert("Erro ao renomear: " + e.message);
                    }
                } else {
                    modal.style.display = 'none';
                }
            };

            cancelBtn.onclick = () => modal.style.display = 'none';
        }

        window.adminOpenFile = async (name, mimeType, ipfsHash, pathRef) => {
            const previewModal = document.getElementById('file-preview-modal');
            const previewContent = document.getElementById('preview-content');
            const previewTitle = document.getElementById('preview-title');
            const downloadBtn = document.getElementById('preview-download-btn');

            previewContent.innerHTML = '';
            previewTitle.textContent = name;
            const fileUrl = `https://gateway.pinata.cloud/ipfs/${ipfsHash}`;

            // Fix: Override default link behavior to force download via blob
            downloadBtn.onclick = async (e) => {
                e.preventDefault();
                downloadBtn.innerHTML = "Baixando...";
                try {
                    const response = await fetch(fileUrl);
                    if (!response.ok) throw new Error("Erro na rede");
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = name;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(downloadUrl);
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i> Baixar';
                } catch (err) {
                    alert("Erro no download: " + err.message);
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i> Baixar';
                }
            };
            // Keep href for right-click 'Save As' fallback
            downloadBtn.href = fileUrl;
            downloadBtn.download = name;

            if (mimeType && mimeType.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = fileUrl;
                previewContent.appendChild(img);
                previewModal.style.display = 'flex';
            } else if (mimeType && mimeType.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = fileUrl;
                video.controls = true;
                previewContent.appendChild(video);
                previewModal.style.display = 'flex';
            } else if (mimeType && mimeType.includes('pdf')) {
                const iframe = document.createElement('iframe');
                iframe.src = fileUrl;
                previewContent.appendChild(iframe);
                previewModal.style.display = 'flex';
            } else if (name.endsWith('.txt') || (mimeType && mimeType.includes('text'))) {
                const modal = document.getElementById('text-editor-modal');
                const textarea = document.getElementById('text-editor-textarea');
                const title = document.getElementById('text-editor-title');
                const saveBtn = document.getElementById('text-editor-save');
                const closeBtn = document.getElementById('text-editor-close');
                const status = document.getElementById('text-editor-status');

                title.textContent = `Editando (Admin): ${name}`;
                textarea.value = "Carregando...";
                status.textContent = "";

                modal.style.display = 'flex';

                try {
                    const response = await fetch(fileUrl);
                    if (!response.ok) throw new Error("Falha ao carregar arquivo.");
                    const text = await response.text();
                    textarea.value = text;
                } catch (e) {
                    textarea.value = "";
                    status.textContent = "Erro: " + e.message;
                }

                saveBtn.onclick = async () => {
                    const newContent = textarea.value;
                    status.textContent = "Salvando...";
                    try {
                        const blob = new Blob([newContent], { type: 'text/plain' });
                        const file = new File([blob], name, { type: 'text/plain' });
                        const uploadResult = await uploadToPinata(file);

                        const parts = pathRef.split('/');
                        if (parts.length >= 2) {
                            const docRef = doc(db, ...parts);
                            await updateDoc(docRef, {
                                ipfsHash: uploadResult.ipfsHash,
                                pinataKey: uploadResult.pinataKey,
                                size: file.size,
                                lastModified: new Date()
                            });

                            status.textContent = "Salvo com sucesso!";
                            status.style.color = "var(--success-color)";
                            setTimeout(() => {
                                status.textContent = "";
                                renderAdminAxonDrive();
                            }, 2000);
                        }
                    } catch (e) {
                        status.textContent = "Erro ao salvar: " + e.message;
                        status.style.color = "var(--error-color)";
                    }
                };
                closeBtn.onclick = () => modal.style.display = 'none';

            } else {
                window.open(fileUrl, '_blank');
            }
        };

        window.renderAdminBridgeUI = () => {
            const bridgeBody = document.getElementById('admin-bridge-body');
            if (!bridgeBody) return;

            const permissions = [
                { key: 'sendToChat', label: 'Enviar para Chat (/ask)' },
                { key: 'callAI', label: 'Solicitar AnÃ¡lise de IA (Texto/VisÃ£o)' },
                { key: 'getAnamnesis', label: 'Ler Anamnese e Exames' },
                { key: 'storage', label: 'Armazenamento (Pinata/IPFS)' }
            ];

            if (!globalSettings.bridgePermissions) {
                globalSettings.bridgePermissions = {
                    sendToChat: true,
                    callAI: true,
                    getAnamnesis: true,
                    storage: true
                };
            }

            let html = '';
            permissions.forEach(p => {
                const isEnabled = globalSettings.bridgePermissions[p.key] !== false; // Default true
                html += `
                    <div style="display:flex; justify-content:space-between; align-items:center; background:var(--input-bg); padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid var(--border-color);">
                        <span class="admin-bridge-label" style="font-weight:500;">${p.label} <code style="font-size:10px; opacity:0.6; margin-left:5px">${p.key}</code></span>
                        <label class="toggle-switch">
                            <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="window.toggleBridgePermission('${p.key}', this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                `;
            });

            bridgeBody.innerHTML = html;
        };

        window.toggleBridgePermission = async (key, value) => {
            if (!globalSettings.bridgePermissions) globalSettings.bridgePermissions = {};
            globalSettings.bridgePermissions[key] = value;

            try {
                await setDoc(doc(db, "settings", "global"), { bridgePermissions: globalSettings.bridgePermissions }, { merge: true });
                appendOutput(`PermissÃ£o Bridge '${key}' alterada para ${value}`, "info");
            } catch (e) {
                console.error("Erro ao salvar permissÃ£o Bridge:", e);
                appendOutput("Erro ao salvar permissÃ£o.", "error");
            }
        };

        // Admin Axon Drive State
        let adminDriveCurrentView = 'users'; // 'users' or 'files'
        let adminDriveSelectedUser = null;
        let adminDriveAllFiles = []; // Cache for current render

        window.renderAdminAxonDrive = async () => {
            try {
                const settingsSnap = await getDoc(doc(db, "settings", "global"));
                if (settingsSnap.exists()) globalSettings = { ...globalSettings, ...settingsSnap.data() };
            } catch (e) { console.error("Error fetching settings:", e); }

            let totalUsed = 0;
            let totalFilesCount = 0;
            let keyCount = (globalSettings.pinataKeys && globalSettings.pinataKeys.length > 0) ? globalSettings.pinataKeys.length : 1;
            let totalLimit = keyCount * 1024 * 1024 * 1024;

            const usageText = document.getElementById('admin-pinata-usage-text');
            const usagePercent = document.getElementById('admin-pinata-usage-percent');
            const usageBar = document.getElementById('admin-pinata-usage-bar');
            const fileList = document.getElementById('admin-pinata-file-list');
            const keyList = document.getElementById('admin-pinata-key-list');

            // Add Styles for clickable folders if not present
            if (!document.getElementById('admin-drive-styles')) {
                const style = document.createElement('style');
                style.id = 'admin-drive-styles';
                style.innerHTML = `
                    .admin-drive-folder {
                        display: flex;
                        align-items: center;
                        padding: 10px;
                        border-bottom: 1px solid var(--border-color);
                        cursor: pointer;
                        transition: background-color 0.2s;
                    }
                    .admin-drive-folder:hover {
                        background-color: var(--button-hover-bg);
                    }
                    .admin-drive-file {
                        display: flex;
                        align-items: center;
                        padding: 8px;
                        border-bottom: 1px solid var(--border-color);
                        gap: 10px;
                    }
                `;
                document.head.appendChild(style);
            }

            const btnAddKey = document.getElementById('btn-add-pinata-key');
            if (btnAddKey) {
                const newBtn = btnAddKey.cloneNode(true);
                btnAddKey.parentNode.replaceChild(newBtn, btnAddKey);
                newBtn.addEventListener('click', window.addPinataKey);
                newBtn.className = "patient-action-button details";
                newBtn.style.width = "auto";
                newBtn.style.padding = "6px 12px";
                newBtn.style.color = "white"; // Force white color
                newBtn.innerHTML = '<i class="fas fa-plus"></i> Adicionar (+1GB)';
            }

            // **Global File Manager Logic**
            const allFiles = [];

            // Default keys check
            const defaultKeys = [{
                key: "",
                secret: "",
                jwt: "afbed7932f0ebf5c50d88d04378359164aca3ae63a72e2628375dc02e4fcfb05",
                addedAt: new Date().toISOString()
            }];

            if ((!globalSettings.pinataKeys || globalSettings.pinataKeys.length === 0)) {
                globalSettings.pinataKeys = defaultKeys;
                setDoc(doc(db, "settings", "global"), { pinataKeys: defaultKeys }, { merge: true }).catch(console.error);
            }

            keyCount = globalSettings.pinataKeys ? globalSettings.pinataKeys.length : 1;
            totalLimit = keyCount * 1024 * 1024 * 1024;

            try {
                const filesSnapshot = await getDocs(query(collectionGroup(db, 'files')));
                filesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const userId = doc.ref.parent.parent ? doc.ref.parent.parent.id : 'Desconhecido';
                    if (data.size && data.provider !== 'supabase') totalUsed += data.size;
                    allFiles.push({ ...data, id: doc.id, path: doc.ref.path, origin: 'Cloud', user: userId });
                });
                totalFilesCount = allFiles.length; // Count files

                // Fetch transfers if needed
                const transfersSnapshot = await getDocs(query(collectionGroup(db, 'transfers')));
                transfersSnapshot.forEach(doc => {
                    const data = doc.data();
                    // Just count pinata files here to avoid double counting if logic changes, but assuming transfers are separate
                    const userId = doc.ref.parent.parent ? doc.ref.parent.parent.id : 'Desconhecido';
                    if (data.size && (data.type === 'file' || data.type === 'pinata')) {
                        totalUsed += data.size;
                        totalFilesCount++;
                        allFiles.push({ ...data, id: doc.id, path: doc.ref.path, origin: 'Share', user: userId });
                    }
                });

            } catch (e) {
                fileList.innerHTML = `<div class="error">Erro ao carregar arquivos globais: ${e.message}</div>`;
                return;
            }

            adminDriveAllFiles = allFiles; // Cache

            // Re-render Progress
            const percent = totalLimit > 0 ? Math.min((totalUsed / totalLimit) * 100, 100).toFixed(1) : 0;
            const gbUsed = (totalUsed / (1024 * 1024 * 1024)).toFixed(2);
            const gbTotal = (totalLimit / (1024 * 1024 * 1024)).toFixed(0);

            // Update Status Text with File Count
            if (usageText) usageText.innerHTML = `${gbUsed} GB / ${gbTotal} GB <span style="font-size:12px; margin-left:10px; opacity:0.8;">(${totalFilesCount} arquivos)</span>`;
            if (usagePercent) usagePercent.textContent = `${percent}%`;
            if (usageBar) usageBar.style.width = `${percent}%`;


            // Render Logic depending on View
            fileList.innerHTML = '';

            if (adminDriveCurrentView === 'users') {
                // Group by User
                const userMap = {};
                allFiles.forEach(f => {
                    if (!userMap[f.user]) userMap[f.user] = { count: 0, size: 0, user: f.user };
                    userMap[f.user].count++;
                    userMap[f.user].size += (f.size || 0);
                });

                const users = Object.values(userMap).sort((a, b) => b.size - a.size);

                if (users.length === 0) {
                    fileList.innerHTML = '<div style="padding:10px;text-align:center;opacity:0.5;">Nenhum usuÃ¡rio com arquivos.</div>';
                } else {
                    users.forEach(u => {
                        const div = document.createElement('div');
                        div.className = 'admin-drive-folder';
                        div.innerHTML = `
                            <div style="width:30px; text-align:center;"><i class="fas fa-folder" style="color:#ecc94b; font-size:18px;"></i></div>
                            <div style="flex:1;">
                                <div style="font-weight:bold;">${u.user}</div>
                                <div style="font-size:11px; opacity:0.7;">${u.count} arquivos</div>
                            </div>
                            <div style="font-size:12px;">${(u.size / 1024 / 1024).toFixed(2)} MB</div>
                            <div style="margin-left:10px; opacity:0.5;"><i class="fas fa-chevron-right"></i></div>
                        `;
                        div.addEventListener('click', () => {
                            adminDriveSelectedUser = u.user;
                            adminDriveCurrentView = 'files';
                            renderAdminAxonDrive(); // Re-render
                        });
                        fileList.appendChild(div);
                    });
                }

            } else if (adminDriveCurrentView === 'files') {
                // Header with Back Button
                const header = document.createElement('div');
                header.style.cssText = "display:flex; align-items:center; padding:10px; border-bottom:1px solid var(--border-color); background:rgba(0,0,0,0.1); margin-bottom:10px;";
                header.innerHTML = `
                    <button class="patient-action-button" style="width:auto; padding:5px 10px; margin-right:10px;" id="admin-drive-back">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div style="font-weight:bold;">Arquivos de: ${adminDriveSelectedUser}</div>
                `;
                fileList.appendChild(header);
                // Bind click after append
                fileList.querySelector('#admin-drive-back').onclick = () => {
                    adminDriveCurrentView = 'users';
                    adminDriveSelectedUser = null;
                    renderAdminAxonDrive();
                };

                const userFiles = allFiles.filter(f => f.user === adminDriveSelectedUser).sort((a, b) => b.size - a.size);

                if (userFiles.length === 0) {
                    const empty = document.createElement('div');
                    empty.innerHTML = '<div style="padding:20px; text-align:center;">Nenhum arquivo encontrado.</div>';
                    fileList.appendChild(empty);
                } else {
                    userFiles.forEach(file => {
                        const div = document.createElement('div');
                        div.className = 'admin-drive-file'; // Use new class

                        const icon = file.type === 'folder' ? '<i class="fas fa-folder" style="color:#ecc94b"></i>' : '<i class="fas fa-file" style="color:var(--text-color)"></i>';

                        div.innerHTML = `
                            <div style="width:30px; text-align:center;">${icon}</div>
                            <div style="flex:1; overflow:hidden;">
                                <div style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${file.name}</div>
                                <div style="font-size:10px; opacity:0.7;">${file.origin}</div>
                            </div>
                            <div style="font-size:12px; white-space:nowrap;">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                            <div style="display:flex; gap:5px;">
                                ${file.link || file.ipfsHash ? `<button class="patient-action-button" onclick="window.adminOpenFile('${file.name}', '${file.mimeType}', '${file.ipfsHash}', '${file.path}')" title="Abrir"><i class="fas fa-eye"></i></button>` : ''}
                                <button class="patient-action-button" onclick="window.adminRenameFile('${file.id}', '${file.path}', '${file.name}')" title="Renomear"><i class="fas fa-edit"></i></button>
                                 ${file.link || file.ipfsHash ? `<button class="patient-action-button" onclick="window.adminDownloadFile('${file.name}', '${file.ipfsHash}')" title="Download"><i class="fas fa-download"></i></button>` : ''}
                                <button class="patient-action-button delete" onclick="window.adminDeleteFile('${file.id}', '${file.path}', '${file.ipfsHash}')" title="Excluir"><i class="fas fa-trash"></i></button>
                            </div>
                         `;
                        fileList.appendChild(div);
                    });
                }
            }


            if (keyList) {
                keyList.innerHTML = '';
                const keysToDisplay = globalSettings.pinataKeys || [];
                if (keysToDisplay.length === 0) {
                    keyList.innerHTML = '<div style="padding:10px;opacity:0.5;">Nenhuma chave registrada.</div>';
                } else {
                    keysToDisplay.forEach((k, index) => {
                        const kDiv = document.createElement('div');
                        kDiv.className = 'key-item';
                        kDiv.style.display = 'flex';
                        kDiv.style.alignItems = 'center';
                        kDiv.style.background = 'rgba(0,0,0,0.1)';
                        kDiv.style.padding = '10px';
                        kDiv.style.marginBottom = '5px';
                        kDiv.style.borderRadius = '8px';

                        kDiv.innerHTML = `
                            <div style="flex:1;">
                                <div style="font-weight:bold;">Chave ${index + 1}</div>
                                <div style="font-family:monospace; opacity:0.7; font-size:12px;">${k.key.substring(0, 8)}...${k.key.substring(k.key.length - 4)}</div>
                            </div>
                            <button class="patient-action-button delete" onclick="window.removePinataKey(${index})">Remover</button>
                         `;
                        keyList.appendChild(kDiv);
                    });
                }
            }
            // Supabase Logic
            const sbToggle = document.getElementById('admin-supabase-toggle');
            const sbUrl = document.getElementById('admin-supabase-url');
            const sbKey = document.getElementById('admin-supabase-key');
            const sbBucket = document.getElementById('admin-supabase-bucket');
            const sbFileList = document.getElementById('admin-supabase-file-list');
            const sbUsageText = document.getElementById('admin-supabase-usage-text');
            const sbUsageBar = document.getElementById('admin-supabase-usage-bar');
            const sbUsagePercent = document.getElementById('admin-supabase-usage-percent');

            if (sbToggle) sbToggle.checked = globalSettings.supabaseEnabled || false;
            if (sbUrl) sbUrl.value = globalSettings.supabaseUrl || '';
            if (sbKey) sbKey.value = globalSettings.supabaseKey || '';
            if (sbBucket) sbBucket.value = globalSettings.supabaseBucket || 'axon-drive';

            // Supabase Files
            const sbFiles = allFiles.filter(f => f.provider === 'supabase');
            const sbTotalSize = sbFiles.reduce((acc, f) => acc + (f.size || 0), 0);

            // Mock limit or just show usage
            const sbLimit = 500 * 1024 * 1024; // 500MB Free Tier Estimate
            const sbPercent = sbLimit > 0 ? Math.min((sbTotalSize / sbLimit) * 100, 100).toFixed(1) : 0;

            if (sbUsageText) sbUsageText.innerHTML = `${(sbTotalSize / 1024 / 1024).toFixed(2)} MB / 500 MB <span style="font-size:10px; opacity:0.6;">(Est. Free Tier)</span>`;
            if (sbUsagePercent) sbUsagePercent.textContent = `${sbPercent}%`;
            if (sbUsageBar) sbUsageBar.style.width = `${sbPercent}%`;

            if (sbFileList) {
                sbFileList.innerHTML = '';
                if (sbFiles.length === 0) {
                    sbFileList.innerHTML = '<div style="padding:10px;text-align:center;opacity:0.5;">Nenhum arquivo no Supabase.</div>';
                } else {
                    // Group by User
                    const sbUserMap = {};
                    sbFiles.forEach(f => {
                        if (!sbUserMap[f.user]) sbUserMap[f.user] = [];
                        sbUserMap[f.user].push(f);
                    });

                    Object.keys(sbUserMap).sort().forEach(user => {
                        const uDiv = document.createElement('div');
                        uDiv.style.cssText = "background:rgba(255,255,255,0.05); padding:8px 10px; margin-top:10px; border-radius:4px; font-weight:bold; font-size:12px; color:#3ecf8e; display:flex; align-items:center; gap:5px;";
                        uDiv.innerHTML = `<i class="fas fa-user-circle"></i> ${user}`;
                        sbFileList.appendChild(uDiv);

                        sbUserMap[user].forEach(file => {
                            const div = document.createElement('div');
                            div.className = 'admin-drive-file';
                            div.style.marginLeft = '10px';
                            div.style.borderLeft = '2px solid rgba(62, 207, 142, 0.3)';
                            div.innerHTML = `
                                 <div style="width:30px; text-align:center;"><i class="fas fa-file" style="color:var(--text-color)"></i></div>
                                 <div style="flex:1; overflow:hidden;">
                                     <div style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${file.name}</div>
                                     <div style="font-size:10px; opacity:0.7;">${new Date(file.createdAt.seconds * 1000).toLocaleDateString()}</div>
                                 </div>
                                 <div style="font-size:12px; margin-right:10px;">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                                 <div style="display:flex; gap:5px;">
                                     <button class="patient-action-button" onclick="window.open('${file.url}', '_blank')" title="Abrir"><i class="fas fa-eye"></i></button>
                                      <button class="patient-action-button delete" onclick="window.adminDeleteFile('${file.id}', '${file.path}', null, '${file.provider}', '${file.supabasePath}')" title="Excluir"><i class="fas fa-trash"></i></button>
                                 </div>
                            `;
                            sbFileList.appendChild(div);
                        });
                    });
                }
            }
        };

        window.toggleSupabase = async (value) => {
            globalSettings.supabaseEnabled = value;
            try {
                await setDoc(doc(db, "settings", "global"), { supabaseEnabled: value }, { merge: true });
                appendOutput(`IntegraÃ§Ã£o Supabase ${value ? 'ativada' : 'desativada'}.`, "success");
            } catch (e) {
                appendOutput("Erro ao salvar configuraÃ§Ã£o.", "error");
            }
        };

        window.saveSupabaseConfig = async () => {
            const url = document.getElementById('admin-supabase-url').value;
            const key = document.getElementById('admin-supabase-key').value;
            const bucket = document.getElementById('admin-supabase-bucket').value || 'axon-drive';

            if (!url || !key) {
                alert("Por favor, preencha URL e Chave.");
                return;
            }

            // Validate
            appendOutput("Validando credenciais do Supabase...", "info");
            try {
                // Try listing buckets to validate Key
                const testUrl = `${url}/storage/v1/bucket`;
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${key}`, 'apikey': key }
                });

                if (!response.ok) {
                    const err = await response.text();
                    alert(`Credenciais InvÃ¡lidas! Erro: ${response.status} - ${response.statusText}`);
                    appendOutput(`Erro de validaÃ§Ã£o Supabase: ${err}`, "error");
                    return;
                }

                // Success
                globalSettings.supabaseUrl = url;
                globalSettings.supabaseKey = key;
                globalSettings.supabaseBucket = bucket;

                await setDoc(doc(db, "settings", "global"), {
                    supabaseUrl: url,
                    supabaseKey: key,
                    supabaseBucket: bucket
                }, { merge: true });
                appendOutput("Credenciais Supabase validadas e salvas com sucesso!", "success");
                alert("Sucesso! Credenciais do Supabase validadas e salvas.");
                renderAdminAxonDrive();
            } catch (e) {
                appendOutput(`Erro ao validar/salvar: ${e.message}`, "error");
                alert("Erro ao conectar com Supabase. Verifique a URL.");
            }
        };

        window.adminDownloadFile = async (name, ipfsHash) => {
            try {
                const url = `https://gateway.pinata.cloud/ipfs/${ipfsHash}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("Erro na rede ao tentar baixar.");
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(downloadUrl);
            } catch (e) {
                alert("Erro ao iniciar download: " + e.message);
            }
        };

        window.adminDeleteFile = async (id, pathRef, ipfsHash, provider, supabasePath) => {
            showConfirmModal("Apagar arquivo permanentemente?", async () => {
                try {
                    // Update specific list based on provider or just re-render
                    // Ideally check tab? But re-render handles it.

                    if (provider === 'supabase' && supabasePath) {
                        await deleteFromSupabase(supabasePath);
                    } else if (ipfsHash) {
                        await unpinFromPinata(ipfsHash);
                    }

                    const parts = pathRef.split('/');
                    if (parts.length >= 2) {
                        const docRef = doc(db, ...parts);
                        await deleteDoc(docRef);
                    }

                    renderAdminAxonDrive();
                } catch (e) {
                    alert("Erro ao deletar: " + e.message);
                    renderAdminAxonDrive();
                }
            });
        };


        window.removePinataKey = async (index) => {
            showConfirmModal("Remover esta chave API? O armazenamento total serÃ¡ reduzido.", async () => {
                const keys = [...(globalSettings.pinataKeys || [])];
                keys.splice(index, 1);
                await setDoc(doc(db, "settings", "global"), { pinataKeys: keys }, { merge: true });
                renderAdminAxonDrive();
            });
        };

        // Fix Terminal Input
        const fixTerminalInput = () => {
            const input = document.getElementById('command-input');
            if (input) {
                input.disabled = false;
                input.focus();
                // Ensure z-index is correct if it was hidden
                input.style.zIndex = '10';
                input.style.position = 'relative';
            }
        };
        // Call it occasionally or on click
        document.addEventListener('click', (e) => {
            if (e.target.closest('.terminal')) fixTerminalInput();
        });
        // Also call on init
        setTimeout(fixTerminalInput, 1000);

        const processCommand = async (command) => {
            if (isUserBlocked) {
                appendOutput("Sua conta foi bloqueada! Funcionalidade indisponÃ­vel.", "highlight");
                commandInput.value = '';
                return;
            }

            const parts = command.trim().split(' ');
            const mainCmd = parts[0].toLowerCase();
            const isCommand = mainCmd.startsWith('/');

            if (!isLoggedIn) {
                appendOutput("Por favor, faÃ§a o login para continuar.", "error");
                commandInput.value = '';
                return;
            }

            if (!isCommand) {
                await processAnamnesisInfo(command);
                commandInput.value = '';
                return;
            }

            if (!validCommands.some(vc => mainCmd === vc.split(' ')[0])) {
                appendOutput(`Comando '${mainCmd}' nÃ£o existe. Digite /help para ver os comandos disponÃ­veis.`, "error");
                commandInput.value = '';
                return;
            }

            switch (mainCmd) {
                case '/exit': logoutUser(); break;
                case '/clear':
                    await performSessionClear();

                    break;
                case '/hear':
                    if (parts[1] === 'on') toggleListening();
                    else if (parts[1] === 'off') stopListening();
                    else appendOutput("Uso: /hear on|off", "error");
                    break;
                case '/hd':
                    appendOutput("Gerando hipÃ³teses diagnÃ³sticas...", "info");
                    await generateDiagnosticHypotheses();
                    break;
                case '/cd':
                    appendOutput("Gerando conduta mÃ©dica...", "info");
                    await generateMedicalConduct();
                    break;
                case '/copy': copyMonitorContent(); break;
                case '/ia':
                    const questionIA = command.substring(3).trim();
                    if (!questionIA) { appendOutput("Uso: /ia [pergunta]", "error"); break; }
                    appendOutput("Processando sua pergunta...", "info");
                    try {
                        const response = await callGeminiAPI(`Responda de forma objetiva Ã  pergunta mÃ©dica: "${questionIA}"`);
                        appendOutput(response.replace(/\*(.*?)\*/g, '<b>$1</b>'), "output");
                    } catch (error) { appendOutput(`Erro ao consultar a IA: ${error.message}`, "error"); }
                    break;
                case '/ask':
                    const questionAsk = command.substring(4).trim();
                    if (!questionAsk) { appendOutput("Uso: /ask [pergunta contextual]", "error"); break; }
                    appendOutput("Processando pergunta contextual...", "info");
                    try {
                        const response = await askQuestionBasedOnContext(questionAsk);
                        const formattedResponse = response.replace(/\*(.*?)\*/g, '<b>$1</b>');
                        appendOutput(`Pergunta: ${questionAsk}<br>Resposta: ${formattedResponse}`, "output");
                    } catch (error) {
                        appendOutput(`Erro ao processar pergunta: ${error.message}`, "error");
                    }
                    break;
                case '/api-set': openAdminAuth(); break;
                case '/api':
                    const currentText = globalSettings.mode === 'manual' ? (globalSettings.manualTextModel || 'NÃ£o definido') : currentAIModel;
                    const currentVision = globalSettings.mode === 'manual' ? (globalSettings.manualVisionModel || 'NÃ£o definido') : currentVisionAIModel;
                    const modeLabel = globalSettings.mode === 'manual' ? 'Manual (Fixo)' : 'AutomÃ¡tico (RotaÃ§Ã£o)';
                    appendOutput(`Status da API: ${apiConnectionStatus}\nModo: ${modeLabel}\nMotor de Texto Atual: ${currentText}\nMotor de VisÃ£o Atual: ${currentVision}`, "info");
                    break;
                case '/register':
                    const [, adminPassReg, newUser, newPass] = parts;
                    await registerUser(adminPassReg, newUser, newPass);
                    break;
                case '/delete':
                    const [, adminPassDel, userToDel] = parts;
                    await deleteUser(adminPassDel, userToDel);
                    break;
                case '/users':
                    if (await verifyAdminPassword(parts[1])) {
                        adminPanelModal.style.display = 'flex';
                        activateAdminTab('users');
                    } else { appendOutput("Senha de administrador incorreta.", "error"); }
                    break;
                case '/help': appendOutput(`Comandos: ${validCommands.join(', ')}`, "info"); break;
                case '/exames': await startCamera('exams'); break;
                case '/see': await startCamera('axon-eye'); break;
                case '/load': await loadPatientList(); break;
                case '/pdf':
                    const patientName = command.substring(4).trim();
                    generatePDFFromCurrentSession(patientName);
                    break;
                default: appendOutput(`Comando '${mainCmd}' nÃ£o reconhecido.`, "error");
            }
            commandInput.value = '';
        };

        window.toggleTheme = toggleTheme;
        window.logoutUser = logoutUser;

        commandInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') processCommand(commandInput.value); });
        monitorCopyBtn.addEventListener('click', copyMonitorContent);
        logoutButton.addEventListener('click', logoutUser);
        settingsButton.addEventListener('click', openAdminAuth);
        themeToggleButton.addEventListener('click', toggleTheme);
        disconnectAllUsersBtn.addEventListener('click', disconnectAllUsers);

        captureButton.addEventListener('click', capturePhoto);
        uploadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);
        sendExamsButton.addEventListener('click', analyzeExams);
        sendAxonEyeButton.addEventListener('click', analyzeAxonEye);
        cancelCameraButton.addEventListener('click', cancelCamera);
        cameraSwitchButton.addEventListener('click', switchCamera);
        flashlightButton.addEventListener('click', toggleFlashlight);
        cameraCloseBtn.addEventListener('click', cancelCamera);
        toggleAnamnesisButton.addEventListener('click', () => toggleMonitorView('anamnesis'));
        toggleExamsButton.addEventListener('click', () => toggleMonitorView('exams'));
        toggleAxonEyeButton.addEventListener('click', () => toggleMonitorView('axon-eye'));
        albumButton.addEventListener('click', openAlbumModal);
        albumModalClose.addEventListener('click', closeAlbumModal);
        albumModal.addEventListener('click', (e) => { if (e.target === albumModal) closeAlbumModal(); });

        const checkBlockedAndExecute = (callback) => {
            if (isUserBlocked) {
                if (isMobile && globalSettings.mobile2_0_enabled) {
                    showConfirmModal("Sua conta do usuÃ¡rio foi bloqueada.", () => { }, true);
                } else {
                    appendOutput("Sua conta foi bloqueada! Funcionalidade indisponÃ­vel.", "highlight");
                }
            } else {
                callback();
            }
        }

        btnExames.addEventListener('click', () => checkBlockedAndExecute(() => processCommand('/exames')));
        btnSee.addEventListener('click', () => checkBlockedAndExecute(() => processCommand('/see')));
        btnHd.addEventListener('click', () => checkBlockedAndExecute(() => processCommand('/hd')));
        btnCd.addEventListener('click', () => checkBlockedAndExecute(() => processCommand('/cd')));

        // Prescription Assistant Logic
        const btnPrescAssist = document.getElementById('btn-prescription-assist');
        const prescModal = document.getElementById('prescription-modal');
        const btnGeneratePresc = document.getElementById('btn-generate-prescription');
        // btn-show-med-info removed
        const medInfoModal = document.getElementById('med-info-modal');

        if (btnPrescAssist && prescModal) {
            btnPrescAssist.addEventListener('click', (e) => {
                e.stopPropagation();
                prescModal.style.display = 'flex';
            });
        }

        if (btnGeneratePresc) {
            btnGeneratePresc.addEventListener('click', async () => {
                const query = document.getElementById('presc-input').value;
                const age = document.getElementById('presc-age').value;
                const weight = document.getElementById('presc-weight').value;
                const source = document.querySelector('input[name="presc-source"]:checked').value;

                if (!query) {
                    alert("Por favor, digite a doenÃ§a ou medicaÃ§Ã£o.");
                    return;
                }

                const resultArea = document.getElementById('presc-result-area');
                const output = document.getElementById('presc-text-output'); // Not used directly now, we render list

                resultArea.style.display = 'block';
                // Clear previous
                const resultContainer = document.getElementById('presc-list-container');
                resultContainer.innerHTML = '<div style="text-align:center; padding: 20px;">Gerando prescriÃ§Ãµes... <i class="fas fa-spinner fa-spin"></i></div>';

                // Construct Prompt
                const prompt = `Atue como um Assistente de PrescriÃ§Ã£o MÃ©dica SÃªnior.
                O mÃ©dico solicitou assistÃªncia para: "${query}".
                
                Dados do Paciente:
                - Idade: ${age || 'NÃ£o informado'}
                - Peso: ${weight || 'NÃ£o informado'}
                
                PreferÃªncia: ${source === 'sus' ? 'Priorizar SUS' : 'Todas as opÃ§Ãµes'}.
                
                TAREFA CRÃTICA:
                   1. Gere 2 ou 3 opÃ§Ãµes de receita mÃ©dica para este caso.
                2. O texto da receita DEVE ser TOTALMENTE EM CAIXA ALTA (UPPERCASE).
                3. TODA RECEITA DEVE INICIAR ESTRITAMENTE COM A VIA DE ADMINISTRAÃ‡ÃƒO (EX: "USO ORAL:", "USO TÃ“PICO:", "USO OFTÃLMICO:", ETC).
                4. O formato de cada receita deve ser:
                   VIA DE ADMINISTRAÃ‡ÃƒO
                   NOME MEDICAMENTO + CONCENTRAÃ‡ÃƒO + APRESENTAÃ‡ÃƒO ---------------- USO (CONTÃNUO OU QUANTIDADE TOTAL)
                   POSOLOGIA (COMO TOMAR).

                   IMPORTANTE: SE O USO FOR TEMPORÃRIO, SUBSTITUA "USO TEMPORÃRIO" PELA QUANTIDADE TOTAL (EX: "01 FRASCO", "30 COMPRIMIDOS", "01 CAIXA"). SE FOR CONTÃNUO, MANTENHA "USO CONTÃNUO".
                   
                   Exemplo 1 (ContÃ­nuo):
                   USO ORAL:
                   LOSARTANA 50 MG COMPRIMIDO ---------------------------- USO CONTÃNUO
                   TOMAR 01 COMPRIMIDO PELA MANHÃƒ.

                   Exemplo 2 (TemporÃ¡rio):
                   USO ORAL:
                   AMOXICILINA 500 MG CÃPSULA ---------------------------- 21 CÃPSULAS
                   TOMAR 01 CÃPSULA DE 8 EM 8 HORAS POR 7 DIAS.
                   
                5. ForneÃ§a alertas separados.

                FORMATO DE RESPOSTA JSON RETORNE APENAS O JSON:
                {
                    "prescriptions": [
                        "TEXTO DA RECEITA 1...",
                        "TEXTO DA RECEITA 2..."
                    ],
                    "info": "<h1>InformaÃ§Ãµes</h1>..."
                }
                `;

                try {
                    let responseText = "";
                    if (typeof callGeminiAPI === 'function') {
                        responseText = await callGeminiAPI(prompt, null, true);
                    } else {
                        responseText = await callGeminiAPI(prompt + "\n\nResponda estritamente em JSON.");
                    }

                    // Parse JSON
                    let data = { prescriptions: [], info: "Sem info." };
                    try {
                        const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            data = JSON.parse(jsonMatch[0]);
                        } else {
                            // Fallback if structured failed
                            data = { prescriptions: [responseText], info: "Verifique o texto." };
                        }
                    } catch (e) {
                        data = { prescriptions: ["Erro na geraÃ§Ã£o."], info: "Falha no parse." };
                    }

                    // Render List
                    resultContainer.innerHTML = '';

                    if (data.prescriptions && Array.isArray(data.prescriptions)) {
                        data.prescriptions.forEach((text, idx) => {
                            const card = document.createElement('div');
                            card.className = 'prescription-suggestion-card';
                            card.innerHTML = `
                                <button class="suggestion-copy-btn" onclick="window.copyToClipboard(this)">Copiar</button>
                                <div class="prescription-suggestion-text">${text}</div>
                            `;
                            resultContainer.appendChild(card);
                        });
                    } else if (data.prescription) { // Legacy single
                        const card = document.createElement('div');
                        card.className = 'prescription-suggestion-card';
                        card.innerHTML = `
                                <button class="suggestion-copy-btn" onclick="window.copyToClipboard(this)">Copiar</button>
                                <div class="prescription-suggestion-text">${data.prescription}</div>
                            `;
                        resultContainer.appendChild(card);
                    }

                    // Setup info button
                    window.currentMedInfo = data.info;

                } catch (e) {
                    resultContainer.innerHTML = `<div style="color:red">Erro: ${e.message}</div>`;
                }
            });
        }

        window.copyToClipboard = (btn) => {
            const text = btn.nextElementSibling.innerText;
            navigator.clipboard.writeText(text).then(() => {
                const original = btn.textContent;
                btn.textContent = "Copiado!";
                setTimeout(() => btn.textContent = original, 2000);
            });
        }

        btnRecords.addEventListener('click', () => checkBlockedAndExecute(() => processCommand('/load')));
        btnClear.addEventListener('click', () => checkBlockedAndExecute(() => {
            if (isFreeMode) {
                if (textareaFreeMode) {
                    textareaFreeMode.value = '';
                    if (typeof saveFreeModeText === 'function') saveFreeModeText('');
                    // Optional: Visual feedback for textarea clear
                }
            } else {
                resetSession();
                if (typeof updateFreeModeUI === 'function') updateFreeModeUI(false); // Fix Free Mode Mix Bug
            }
        }));
        btnMic.addEventListener('click', () => checkBlockedAndExecute(() => processCommand(isListening ? '/hear off' : '/hear on')));
        btnSaveFromList.addEventListener('click', () => {
            if (isUserBlocked) {
                appendOutput("Sua conta foi bloqueada! Funcionalidade indisponÃ­vel.", "highlight");
                patientListModal.style.display = 'none';
                return;
            }
            patientListModal.style.display = 'none';
            openSaveModal();
        });

        // Transfer Logic
        const CHUNK_SIZE = 900 * 1024; // 900KB safe limit for Firestore

        const uploadFileP2P = async (file) => {
            if (!isLoggedIn) {
                transferStatus.textContent = "Erro: UsuÃ¡rio nÃ£o logado.";
                transferStatus.style.color = "var(--error-color)";
                return;
            }

            // Reset UI
            transferStatus.style.color = "var(--text-color)";
            transferProgressBar.style.display = 'block';
            transferProgressFill.style.width = '0%';
            transferProgressFill.classList.remove('pro-mode');

            // 10MB Limit for Pinata
            const isLargeFile = file.size > 10 * 1024 * 1024;

            if (isLargeFile) {
                transferStatus.textContent = "Modo Axon Share Pro ativado (Pinata)...";
                transferProgressFill.classList.add('pro-mode');

                // Show pro mode text below bar
                const proText = document.createElement('div');
                proText.id = 'pro-mode-text';
                proText.innerText = "Modo de compartilhamento Axon Share Pro ativado.";
                proText.style.fontSize = "10px";
                proText.style.color = "#4299e1";
                proText.style.marginTop = "5px";
                proText.style.textAlign = "center";

                if (!document.getElementById('pro-mode-text')) {
                    transferProgressBar.parentNode.appendChild(proText);
                }

                try {
                    const uploadResult = await uploadToPinata(file, (progress) => {
                        transferProgressFill.style.width = `${progress}%`;
                    });
                    const ipfsHash = uploadResult.ipfsHash;

                    // Create record in Firestore to signal receiver
                    await addDoc(collection(db, "sessions", currentUser, "transfers"), {
                        filename: file.name,
                        fileSize: file.size,
                        senderId: deviceId,
                        status: "complete", // Ready for download
                        type: 'pinata',
                        ipfsHash: ipfsHash,
                        pinataKey: uploadResult.pinataKey, // Save key metadata
                        timestamp: new Date()
                    });

                    transferStatus.textContent = "Arquivo enviado com sucesso!";
                    transferStatus.style.color = "var(--success-color)";

                } catch (err) {
                    console.error("Pinata Upload Error:", err);
                    transferStatus.textContent = "Erro Axon Share Pro: " + err.message;
                    transferStatus.style.color = "var(--error-color)";
                }

            } else {
                // Legacy / Small File Logic
                const proText = document.getElementById('pro-mode-text');
                if (proText) proText.remove();

                transferStatus.textContent = "Lendo arquivo...";
                transferProgressFill.style.width = '10%';

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Data = e.target.result;
                    const totalSize = base64Data.length;

                    transferStatus.textContent = "Enviando...";
                    transferProgressFill.style.width = '30%';

                    try {
                        if (totalSize < CHUNK_SIZE) {
                            await addDoc(collection(db, "sessions", currentUser, "transfers"), {
                                filename: file.name,
                                fileSize: file.size,
                                senderId: deviceId,
                                status: "complete",
                                chunkCount: 0,
                                data: base64Data,
                                timestamp: new Date()
                            });
                        } else {
                            const transferRef = await addDoc(collection(db, "sessions", currentUser, "transfers"), {
                                filename: file.name,
                                fileSize: file.size,
                                senderId: deviceId,
                                status: "uploading",
                                chunkCount: Math.ceil(totalSize / CHUNK_SIZE),
                                timestamp: new Date()
                            });

                            const chunksCollectionRef = collection(db, "sessions", currentUser, "transfers", transferRef.id, "chunks");
                            const batch = writeBatch(db);
                            let chunkIndex = 0;

                            for (let start = 0; start < totalSize; start += CHUNK_SIZE) {
                                const end = Math.min(start + CHUNK_SIZE, totalSize);
                                const chunkData = base64Data.slice(start, end);
                                const chunkDocRef = doc(chunksCollectionRef, chunkIndex.toString());
                                batch.set(chunkDocRef, { data: chunkData });
                                chunkIndex++;
                            }
                            await batch.commit();
                            await updateDoc(transferRef, { status: "complete" });
                        }

                        transferProgressFill.style.width = '100%';
                        transferStatus.textContent = "Arquivo enviado com sucesso!";
                        transferStatus.style.color = "var(--success-color)";
                    } catch (err) {
                        console.error("Upload error:", err);
                        transferStatus.textContent = "Erro no envio: " + err.message;
                        transferStatus.style.color = "var(--error-color)";
                    }
                };
                reader.readAsDataURL(file);
            }

            // Cleanup UI after delay
            setTimeout(() => {
                if (transferStatus.textContent.includes("sucesso")) {
                    transferModal.style.display = 'none';
                    transferProgressBar.style.display = 'none';
                    transferProgressFill.style.width = '0%';
                    transferStatus.textContent = '';
                    const proText = document.getElementById('pro-mode-text');
                    if (proText) proText.remove();
                }
            }, 3000);
        };

        const handleTransferFileSelect = async (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    await uploadFileP2P(files[i]);
                    // Add small delay between uploads to avoid race conditions or UI flickering
                    if (i < files.length - 1) await new Promise(r => setTimeout(r, 1000));
                }
            }
        };

        const handleTransferDrop = async (e) => {
            e.preventDefault();
            transferDropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                for (let i = 0; i < e.dataTransfer.files.length; i++) {
                    await uploadFileP2P(e.dataTransfer.files[i]);
                    if (i < e.dataTransfer.files.length - 1) await new Promise(r => setTimeout(r, 1000));
                }
            }
        };

        btnTransferFile.addEventListener('click', () => {
            checkBlockedAndExecute(() => {
                transferModal.style.display = 'flex';
            });
        });

        btnCloud.addEventListener('click', () => {
            checkBlockedAndExecute(() => {
                // Mobile 2.0 Check for visibility (redundant if hidden by CSS/hide logic)
                if (isMobile && globalSettings.mobile2_0_enabled) return;

                if (isCloudDisabled) {
                    showConfirmModal("Ops! vocÃª nÃ£o tem acesso aos recusos de armazenamento em nuvem da Axon.", () => { }, true); // True to hide cancel button (make it an alert)
                    return;
                }

                if (axonCloud) {
                    document.getElementById('axon-cloud-modal').style.display = 'flex';
                    axonCloud.render();
                } else {
                    appendOutput("Erro: MÃ³dulo de Nuvem nÃ£o inicializado.", "error");
                }
            });
        });

        // Hide Cloud Button on Mobile 2.0 Init
        const updateMobileVisibility = () => {
            const btnTools = document.getElementById('btn-tools');
            if (isMobile && globalSettings.mobile2_0_enabled) {
                if (btnCloud) btnCloud.style.display = 'none';
                if (btnTools) btnTools.style.display = 'none';
            } else {
                if (btnCloud) btnCloud.style.display = 'flex';
                if (btnTools) btnTools.style.display = 'flex';
            }
        };
        // Call it initially and potentially on listeners if settings change (not implemented here but good to have)

        transferModalClose.addEventListener('click', () => transferModal.style.display = 'none');
        transferDropZone.addEventListener('click', () => transferFileInput.click());
        transferFileInput.addEventListener('change', handleTransferFileSelect);

        transferDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            transferDropZone.classList.add('dragover');
        });
        transferDropZone.addEventListener('dragleave', () => transferDropZone.classList.remove('dragover'));
        transferDropZone.addEventListener('drop', handleTransferDrop);


        // Mobile 2.0 Button Listeners
        mobileBtnExames.addEventListener('click', () => checkBlockedAndExecute(() => startCamera('exams')));
        mobileBtnSee.addEventListener('click', () => checkBlockedAndExecute(() => startCamera('axon-eye')));

        mobileBtnChat.addEventListener('click', () => checkBlockedAndExecute(openChatbox));
        chatboxCloseBtn.addEventListener('click', closeChatbox);
        chatboxSendBtn.addEventListener('click', sendChatMessage);
        chatboxInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendChatMessage(); });
        chatboxUploadBtn.addEventListener('click', () => chatFileInput.click());
        chatFileInput.addEventListener('change', handleChatImageUpload);
        chatboxNewChatBtn.addEventListener('click', () => {
            showConfirmModal("Deseja iniciar uma nova conversa? O histÃ³rico atual serÃ¡ perdido.", () => {
                conversationHistory = [];
                chatboxMessages.innerHTML = '';
                openChatbox();
            });
        });

        adminAuthClose.addEventListener('click', () => adminAuthModal.style.display = 'none');
        adminAuthButton.addEventListener('click', checkAdminAuth);
        adminAuthPass.addEventListener('keydown', (e) => { if (e.key === 'Enter') checkAdminAuth(); });

        patientListModal.addEventListener('click', (e) => {
            const target = e.target;
            const deleteButton = target.closest('.delete');
            const pdfButton = target.closest('.pdf');
            const detailsButton = target.closest('.details');

            if (deleteButton) {
                checkBlockedAndExecute(() => deletePatient(deleteButton.dataset.id));
            } else if (pdfButton && !pdfButton.classList.contains('disabled')) {
                checkBlockedAndExecute(() => generatePatientPDF(pdfButton.dataset.id));
            } else if (detailsButton && !detailsButton.classList.contains('disabled')) {
                const patientId = detailsButton.dataset.id;
                const patientData = allPatients.find(p => p.id === patientId);
                if (patientData) showPatientDetails(patientData);
            }
        });

        patientDetailsModal.addEventListener('click', (e) => {
            const header = e.target.closest('.consultation-header');
            if (header) {
                const body = header.nextElementSibling;
                const icon = header.querySelector('i');
                const isVisible = body.style.display === 'block';
                body.style.display = isVisible ? 'none' : 'block';
                icon.classList.toggle('fa-chevron-down', !isVisible);
                icon.classList.toggle('fa-chevron-right', isVisible);
            }
        });

        patientListClose.addEventListener('click', () => patientListModal.style.display = 'none');
        patientDetailsClose.addEventListener('click', () => patientDetailsModal.style.display = 'none');
        patientSearchInput.addEventListener('input', (e) => searchPatients(e.target.value));

        loginModalButton.addEventListener('click', async () => {
            const username = loginModalUser.value.trim(), password = loginModalPass.value.trim();
            if (!username || !password) return loginModalFeedback.textContent = "Preencha todos os campos.";
            loginModalFeedback.textContent = "Verificando..."; loginModalButton.disabled = true;

            const authResult = await authenticateUser(username, password);

            if (authResult.success) {
                if (authResult.isBlocked) {
                    loginModalFeedback.style.color = '#ffcc00';
                    loginModalFeedback.textContent = "Sua conta foi bloqueada!";
                    loginModalButton.disabled = false;
                } else {
                    loginModalFeedback.style.color = 'var(--success-color)'; loginModalFeedback.textContent = "Sucesso!";
                    setTimeout(() => handleSuccessfulLogin(username, false), 500);
                }
            } else {
                loginModalFeedback.style.color = 'var(--error-color)'; loginModalFeedback.textContent = "UsuÃ¡rio ou senha incorretos.";
                loginModalButton.disabled = false;
            }
        });

        const handleSuccessfulLogin = async (username, isAutoLogin) => {
            currentUser = username;
            isLoggedIn = true;

            // Persist login state for Mobile 2.0
            localStorage.setItem('axon_logged_in_user', username);

            appendOutput(`UsuÃ¡rio ${username} conectado.`, "success");

            // Fetch full user data to check subscription start date
            try {
                const userRef = doc(db, "users", username);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    currentUserData = userSnap.data();

                    // Initialize subscription start date if missing (first login)
                    if (!currentUserData.subscriptionStartDate && !currentUserData.isAdmin) {
                        const now = new Date();
                        await updateDoc(userRef, { subscriptionStartDate: now });
                        currentUserData.subscriptionStartDate = now;
                    }

                    // Check subscription status
                    // Check subscription status
                    const subStatus = checkSubscriptionStatus(currentUserData);
                    if (subStatus.expired && !currentUserData.isAdmin) {
                        // If expired, ensure blocked (if not already) and SHOW MODAL
                        if (!currentUserData.isBlocked) {
                            await updateDoc(userRef, { isBlocked: true });
                        }

                        // Close Login Modal and Reset State
                        loginModal.style.display = 'none';
                        isLoggedIn = false;
                        currentUser = null;

                        // Show Expiration Modal
                        const expiredModal = document.getElementById('subscription-expired-modal');
                        if (expiredModal) {
                            expiredModal.style.display = 'flex';
                            expiredModal.style.zIndex = '999999'; // Ensure it's on top
                        }

                        // Do not proceed with login init
                        return;
                    }
                    // Force unblock if valid? No, handled by admin.
                }
            } catch (e) {
                console.error("Error fetching user data on login:", e);
            }

            loginModal.style.display = 'none';
            loginModalFeedback.textContent = '';
            loginModalUser.value = '';
            loginModalPass.value = '';
            loginModalButton.disabled = false;

            // Configure Header Buttons based on Role
            // CLONE BUTTONS TO STRIP LISTENERS and Fix Overlap
            let settingsBtn = document.getElementById('settings-button');
            if (settingsBtn) {
                const newBtn = settingsBtn.cloneNode(true);
                settingsBtn.parentNode.replaceChild(newBtn, settingsBtn);
                settingsBtn = newBtn;
            }

            let mobileSettingsBtn = document.getElementById('mobile-settings-btn');
            if (mobileSettingsBtn) {
                const newMobileBtn = mobileSettingsBtn.cloneNode(true);
                mobileSettingsBtn.parentNode.replaceChild(newMobileBtn, mobileSettingsBtn);
                mobileSettingsBtn = newMobileBtn;
            }

            if (currentUserData && currentUserData.isAdmin) {
                // Admin: Show Settings Cog -> Admin Auth
                if (settingsBtn) {
                    settingsBtn.innerHTML = '<i class="fas fa-sliders-h"></i>';
                    settingsBtn.onclick = openAdminAuth;
                    settingsBtn.setAttribute('data-label', 'ConfiguraÃ§Ãµes');
                }
                if (mobileSettingsBtn) {
                    mobileSettingsBtn.innerHTML = '<i class="fas fa-sliders-h"></i>';
                    mobileSettingsBtn.onclick = openAdminAuth;
                }
            } else {
                // User: Show User Icon -> Profile Modal
                if (settingsBtn) {
                    settingsBtn.innerHTML = '<i class="fas fa-user"></i>';
                    settingsBtn.onclick = openUserInfoModal;
                    settingsBtn.setAttribute('data-label', 'Meu Perfil');
                }
                if (mobileSettingsBtn) {
                    mobileSettingsBtn.innerHTML = '<i class="fas fa-user"></i>';
                    mobileSettingsBtn.onclick = openUserInfoModal;
                }
            }

            // Cloud Access Check
            if (currentUserData) {
                isCloudDisabled = currentUserData.isCloudDisabled || false;
            }

            // Sync with Desktop if Mobile
            if (isMobile && globalSettings.mobile2_0_enabled) {
                // ... (existing mobile sync code if any, logic handled in heartbeat)
            }

            applySettings();
            initSpeechRecognition();

            // Initialize Cloud
            if (!isCloudDisabled) {
                axonCloud = new AxonCloud(username);
            }

            // Start Heartbeats
            startDesktopHeartbeat(username);
            setupFirestoreListeners(username);

            // Periodic Subscription Check (every 30 seconds)
            if (expiryCheckInterval) clearInterval(expiryCheckInterval);
            expiryCheckInterval = setInterval(() => {
                if (isLoggedIn && currentUserData && !currentUserData.isAdmin) {
                    const status = checkSubscriptionStatus(currentUserData);
                    if (status.expired) {
                        console.warn("Assinatura expirou (Timer). Desconectando...");
                        clearInterval(expiryCheckInterval);
                        logoutUser();
                        document.getElementById('subscription-expired-modal').style.display = 'flex';
                    }
                }
            }, 30000);

            // Log Login
            logInteractionToFirebase(username, "Login efetuado", "system", "login");
        };

        let userInfoRefreshInterval = null;

        const updateUserInfoDisplay = () => {
            if (!currentUserData) return;

            const subEl = document.getElementById('user-info-subscription');
            const expiredWarning = document.getElementById('user-info-expired-warning');

            const subStatus = checkSubscriptionStatus(currentUserData);
            subEl.textContent = subStatus.formattedRemaining;

            if (subStatus.expired && !currentUserData.isAdmin) {
                subEl.classList.remove('subscription-active');
                subEl.classList.add('subscription-expired');
                expiredWarning.style.display = 'flex';
            } else {
                subEl.classList.add('subscription-active');
                subEl.classList.remove('subscription-expired');
                expiredWarning.style.display = 'none';
            }
        };

        const openUserInfoModal = () => {
            if (!currentUserData) return;

            const modal = document.getElementById('user-info-modal');
            const usernameEl = document.getElementById('user-info-username');
            const badgeEl = document.getElementById('user-info-badge');
            const emailEl = document.getElementById('user-info-email');
            const createdEl = document.getElementById('user-info-created');
            const avatarEl = document.getElementById('user-info-avatar');
            const studentWarning = document.getElementById('user-info-student-warning');

            usernameEl.textContent = currentUserData.username || currentUser; // Fallback

            // Badge
            if (currentUserData.isAdmin) {
                badgeEl.textContent = 'Administrador';
                badgeEl.style.backgroundColor = 'var(--accent-color)';
                badgeEl.style.color = '#fff';
            } else if (currentUserData.accountLevel === 'enterprise') {
                badgeEl.textContent = 'Axon Enterprise';
                badgeEl.style.backgroundColor = '#805ad5'; // Purple
                badgeEl.style.color = '#fff';
            } else if (currentUserData.accountLevel === 'student') {
                badgeEl.textContent = 'AXON STUDENT';
                badgeEl.style.backgroundColor = '#f59e0b'; // Yellow
                badgeEl.style.color = '#fff';
                // Custom Icon
                if (avatarEl) {
                    avatarEl.innerHTML = '<img src="https://cdn-icons-png.flaticon.com/512/16803/16803995.png" style="width:80%; height:80%; border-radius:50%; object-fit:cover; display:block; margin:auto;">';
                }
            } else {
                badgeEl.textContent = 'Axon Personal';
                badgeEl.style.backgroundColor = '#3182ce'; // Blue
                badgeEl.style.color = '#fff';
            }

            // Student Warning
            if (studentWarning) {
                studentWarning.style.display = (currentUserData.accountLevel === 'student') ? 'block' : 'none';
            }

            // Reset Avatar for non-students (if needed, or just keep as is if not student)
            if (currentUserData.accountLevel !== 'student' && avatarEl && avatarEl.querySelector('img')) {
                avatarEl.innerHTML = '<i class="fas fa-user-shield"></i>';
            }

            emailEl.textContent = currentUserData.email || 'NÃ£o informado';

            const createdDate = currentUserData.createdAt?.toDate?.() || currentUserData.createdAt;
            createdEl.textContent = createdDate ? new Date(createdDate).toLocaleDateString() : '-';

            // Initial subscription status update
            updateUserInfoDisplay();

            modal.style.display = 'flex';

            // Start real-time refresh interval (every 5 seconds)
            if (userInfoRefreshInterval) clearInterval(userInfoRefreshInterval);
            userInfoRefreshInterval = setInterval(() => {
                if (modal.style.display === 'flex') {
                    updateUserInfoDisplay();
                } else {
                    clearInterval(userInfoRefreshInterval);
                    userInfoRefreshInterval = null;
                }
            }, 5000);

            // Close logic
            const closeModal = () => {
                modal.style.display = 'none';
                if (userInfoRefreshInterval) {
                    clearInterval(userInfoRefreshInterval);
                    userInfoRefreshInterval = null;
                }
            };

            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            modal.querySelector('.app-modal-close').onclick = closeModal;
        };
        loginModalPass.addEventListener('keydown', (e) => { if (e.key === 'Enter') loginModalButton.click(); });

        savePatientModalClose.addEventListener('click', closeSaveModal);
        savePatientButton.addEventListener('click', () => {
            const name = savePatientNameInput.value.trim();
            const dob = savePatientDobInput.value.trim();
            if (!name || !dob) return savePatientFeedback.textContent = 'Preencha todos os campos.';
            savePatient(name, dob);
        });
        savePatientDobInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '').slice(0, 8);
            if (value.length > 4) value = `${value.slice(0, 2)}/${value.slice(2, 4)}/${value.slice(4)}`;
            else if (value.length > 2) value = `${value.slice(0, 2)}/${value.slice(2)}`;
            e.target.value = value;
        });
        savePatientDobInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') savePatientButton.click(); });

        prescriptionHelperClose.addEventListener('click', closePrescriptionHelper);
        prescriptionHelperModal.addEventListener('click', (e) => {
            if (e.target === prescriptionHelperModal) {
                closePrescriptionHelper();
            }
        });

        prescriptionHelperBody.addEventListener('click', (e) => {
            const copyBtn = e.target.closest('.prescription-template-copy-btn');
            if (copyBtn) {
                const templateId = copyBtn.dataset.templateId;
                const templateTextElement = document.getElementById(templateId);
                if (templateTextElement) {
                    const templateText = templateTextElement.textContent;
                    navigator.clipboard.writeText(templateText).then(() => {
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                        copyBtn.style.backgroundColor = 'var(--success-color)';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                            copyBtn.style.backgroundColor = '';
                        }, 2000);
                    });
                }
            }
        });

        interactiveOutput.addEventListener('click', (e) => {
            const conductTitle = e.target.closest('.conduct-title');
            if (conductTitle && conductTitle.dataset.category) {
                openPrescriptionHelper(conductTitle.dataset.category);
            }
        });

        const uploadToSupabase = async (file) => {
            if (!globalSettings.supabaseUrl || !globalSettings.supabaseKey) {
                throw new Error("Credenciais do Supabase nÃ£o configuradas.");
            }

            const cleanName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
            const path = `${currentUser}/${Date.now()}_${cleanName}`;
            const bucket = globalSettings.supabaseBucket || 'axon-drive'; // Default to axon-drive
            const url = `${globalSettings.supabaseUrl}/storage/v1/object/${bucket}/${path}`;

            const headers = {
                'Authorization': `Bearer ${globalSettings.supabaseKey}`,
                'apikey': globalSettings.supabaseKey
            };
            // Try to guess content type or default to octet-stream
            // Supabase sometimes requires strict types or just detects it.
            // if (file.type) headers['Content-Type'] = file.type; 

            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: file
            });

            if (!response.ok) {
                let errDetail = '';
                try {
                    const errJson = await response.json();
                    errDetail = JSON.stringify(errJson);
                    if (errJson.error === 'Bucket not found') {
                        errDetail += " (Verifique se o Bucket existe no Supabase)";
                    }
                } catch (e) {
                    errDetail = await response.text();
                }

                throw new Error(`Erro Supabase: ${response.status} - ${errDetail}`);
            }

            const data = await response.json();

            return {
                path: path,
                fullPath: data.Key,
                url: `${globalSettings.supabaseUrl}/storage/v1/object/public/${bucket}/${path}`,
                provider: 'supabase'
            };
        };

        const deleteFromSupabase = async (pathRef) => {
            if (!globalSettings.supabaseUrl || !globalSettings.supabaseKey) return;
            const bucket = globalSettings.supabaseBucket || 'axon-drive';
            const url = `${globalSettings.supabaseUrl}/storage/v1/object/${bucket}/${pathRef}`;

            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${globalSettings.supabaseKey}`,
                        'apikey': globalSettings.supabaseKey
                    }
                });

                if (!response.ok) {
                    console.error("Supabase Delete Error:", await response.text());
                } else {
                    console.log("Supabase File Deleted:", pathRef);
                }
            } catch (e) {
                console.error("Supabase Delete Exception:", e);
            }
        };

        const renameInSupabase = async (oldPath, newPath) => {
            if (!globalSettings.supabaseUrl || !globalSettings.supabaseKey) return;
            const bucket = globalSettings.supabaseBucket || 'axon-drive';
            const url = `${globalSettings.supabaseUrl}/storage/v1/object/move`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${globalSettings.supabaseKey}`,
                        'apikey': globalSettings.supabaseKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bucketId: bucket,
                        sourceKey: oldPath,
                        destinationKey: newPath
                    })
                });
                if (!response.ok) console.error("Supabase Move Error:", await response.text());
                else console.log("Supabase File Renamed");
            } catch (e) {
                console.error("Supabase Move Exception:", e);
            }
        };

        const updateSupabaseFile = async (item, content) => {
            if (!globalSettings.supabaseUrl || !globalSettings.supabaseKey) throw new Error("Credenciais ausentes");
            const bucket = globalSettings.supabaseBucket || 'axon-drive';
            const path = item.supabasePath;
            const url = `${globalSettings.supabaseUrl}/storage/v1/object/${bucket}/${path}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${globalSettings.supabaseKey}`,
                    'apikey': globalSettings.supabaseKey,
                    'x-upsert': 'true',
                    'Content-Type': 'text/plain;charset=UTF-8'
                },
                body: content
            });

            if (!response.ok) {
                const err = await response.text();
                console.error("Supabase Save Error:", err);
                throw new Error(err);
            }
        };

        class AxonCloud {
            constructor(username) {
                this.username = username;
                this.currentPath = [];
                this.files = [];
                this.filteredFiles = [];
                this.storageUsed = 0;
                this.filterType = 'all';
                this.unsubscribe = null;
                this.clipboard = null;
                this.handleKeyDown = this.handleKeyDown.bind(this);
                this.init();
            }


            async init() {
                const filesRef = collection(db, "users", this.username, "files");
                this.unsubscribe = onSnapshot(filesRef, (snapshot) => {
                    this.files = [];
                    this.storageUsed = 0;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        this.files.push({ id: doc.id, ...data });
                        if (data.size) this.storageUsed += data.size;
                    });
                    this.updateStorageUI();
                    this.render();
                });

                this.setupUI();
            }

            setupUI() {
                this.grid = document.getElementById('cloud-grid');
                this.breadcrumb = document.getElementById('cloud-breadcrumb');
                this.sidebarItems = document.querySelectorAll('.cloud-sidebar-item');
                this.uploadBtn = document.getElementById('cloud-btn-upload');
                this.newFolderBtn = document.getElementById('cloud-btn-new-folder');
                this.refreshBtn = document.getElementById('cloud-btn-refresh');
                this.dropZone = document.getElementById('cloud-drop-zone');
                this.searchInput = document.getElementById('cloud-search');
                this.contextMenu = document.getElementById('cloud-context-menu');
                this.bgContextMenu = document.getElementById('cloud-bg-context-menu');

                document.removeEventListener('keydown', this.handleKeyDown);
                document.addEventListener('keydown', this.handleKeyDown);

                // Sidebar
                this.sidebarItems.forEach(item => {
                    item.addEventListener('click', () => {
                        this.sidebarItems.forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        this.filterType = item.dataset.target;
                        this.render();
                    });
                });

                // Buttons
                if (this.uploadBtn) {
                    let cloudInput = document.getElementById('cloud-file-input');
                    if (!cloudInput) {
                        cloudInput = document.createElement('input');
                        cloudInput.type = 'file';
                        cloudInput.id = 'cloud-file-input';
                        cloudInput.style.display = 'none';
                        cloudInput.multiple = true;
                        document.body.appendChild(cloudInput);
                        cloudInput.addEventListener('change', (e) => this.handleUpload(e.target.files));
                    }
                    this.uploadBtn.onclick = () => cloudInput.click();
                }
                if (this.newFolderBtn) this.newFolderBtn.onclick = () => this.createNewFolder();
                if (this.refreshBtn) this.refreshBtn.onclick = () => this.render();

                if (this.searchInput) {
                    this.searchInput.addEventListener('input', (e) => this.render(e.target.value));
                }

                // Drag & Drop on Zone
                if (this.dropZone) {
                    this.dropZone.ondragover = (e) => {
                        e.preventDefault();
                        this.dropZone.style.borderColor = 'var(--highlight-color)';
                        this.dropZone.style.background = 'rgba(66, 153, 225, 0.1)';
                    };
                    this.dropZone.ondragleave = (e) => {
                        this.dropZone.style.borderColor = '';
                        this.dropZone.style.background = '';
                    };
                    this.dropZone.ondrop = (e) => {
                        e.preventDefault();
                        this.dropZone.style.borderColor = '';
                        this.dropZone.style.background = '';
                        if (e.dataTransfer.files.length > 0) this.handleUpload(e.dataTransfer.files);
                    };
                }

                // Global Click to close Context Menus
                document.addEventListener('click', () => {
                    if (this.contextMenu) this.contextMenu.style.display = 'none';
                    if (this.bgContextMenu) this.bgContextMenu.style.display = 'none';
                });

                // Grid Right Click (Background)
                this.grid.oncontextmenu = (e) => {
                    if (e.target === this.grid) {
                        e.preventDefault();
                        if (this.bgContextMenu) {
                            this.bgContextMenu.style.display = 'block';
                            this.bgContextMenu.style.left = `${e.pageX}px`;
                            this.bgContextMenu.style.top = `${e.pageY}px`;
                        }
                    }
                };

                // Bind Context Menu Actions
                document.getElementById('ctx-open').onclick = () => this.handleContextAction('open');
                document.getElementById('ctx-download').onclick = () => this.handleContextAction('download');
                document.getElementById('ctx-copy').onclick = () => this.handleContextAction('copy');
                document.getElementById('ctx-rename').onclick = () => this.handleContextAction('rename');
                document.getElementById('ctx-move').onclick = () => this.handleContextAction('move');
                document.getElementById('ctx-delete').onclick = () => this.handleContextAction('delete');

                document.getElementById('ctx-bg-new-folder').onclick = () => this.createNewFolder();
                document.getElementById('ctx-bg-new-text').onclick = () => this.createNewTextFile();
                document.getElementById('ctx-bg-paste').onclick = () => this.handleContextAction('paste');
                document.getElementById('ctx-bg-upload').onclick = () => document.getElementById('cloud-file-input').click();

                // Locking Context Menu
                const ctxLock = document.getElementById('ctx-lock');
                if (ctxLock) ctxLock.onclick = () => this.handleContextAction('lock');
                else {
                    // Inject if not exists (fallback) - Direct append to container as div
                    const ctxMenu = document.getElementById('cloud-context-menu');
                    if (ctxMenu) {
                        const div = document.createElement('div');
                        div.id = 'ctx-lock';
                        div.className = 'context-menu-item';
                        div.innerHTML = '<i class="fas fa-lock"></i> Trancar/Destrancar';
                        div.onclick = () => this.handleContextAction('lock');
                        ctxMenu.appendChild(div);
                    }
                }
            }

            updateStorageUI() {
                let totalLimit = globalSettings.pinataKeys ? globalSettings.pinataKeys.length * 1024 * 1024 * 1024 : 1024 * 1024 * 1024;
                const percent = Math.min((this.storageUsed / totalLimit) * 100, 100);
                const bar = document.getElementById('cloud-storage-bar');
                const text = document.getElementById('cloud-storage-text');
                if (bar) bar.style.width = `${percent}%`;
                if (text) text.textContent = `${this.formatBytes(this.storageUsed)} / ${this.formatBytes(totalLimit)}`;
            }

            isFolderLocked(folderId) {
                if (!folderId || folderId === 'root') return false;
                const folder = this.files.find(f => f.id === folderId);
                if (!folder) return false;
                if (folder.isLocked) return true;
                return this.isFolderLocked(folder.parent);
            }

            render(searchTerm = "") {
                if (!this.grid) return;
                this.grid.innerHTML = '';
                this.updateBreadcrumb();

                const currentParentId = this.currentPath.length > 0 ? this.currentPath[this.currentPath.length - 1].id : 'root';

                // Base items for 'all' view (current folder only)
                let items = this.files.filter(f => f.parent === currentParentId);

                // For type filters, we search globally but MUST respect locked folders logic
                if (this.filterType !== 'all') {
                    // Filter helper
                    const isVisible = (f) => !this.isFolderLocked(f.parent);

                    if (this.filterType === 'images') {
                        items = this.files.filter(f => f.mimeType && f.mimeType.startsWith('image/') && isVisible(f));
                    } else if (this.filterType === 'videos') {
                        items = this.files.filter(f => f.mimeType && f.mimeType.startsWith('video/') && isVisible(f));
                    } else if (this.filterType === 'docs') {
                        items = this.files.filter(f => f.mimeType && (f.mimeType.includes('pdf') || f.mimeType.includes('text')) && isVisible(f));
                    }
                }

                if (searchTerm) {
                    items = this.files.filter(f => f.name.toLowerCase().includes(searchTerm.toLowerCase()));
                }

                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'cloud-item';
                    el.draggable = true;
                    el.dataset.id = item.id; // Added ID for lookups
                    el.dataset.type = item.type;

                    let icon = 'fa-file';
                    if (item.type === 'folder') icon = 'fa-folder';
                    else if (item.mimeType?.startsWith('image')) icon = 'fa-file-image';
                    else if (item.mimeType?.startsWith('video')) icon = 'fa-file-video';
                    else if (item.mimeType?.includes('pdf')) icon = 'fa-file-pdf';

                    // Lock Icon
                    let lockIcon = '';
                    if (item.isLocked) {
                        lockIcon = '<i class="fas fa-lock" style="color:var(--error-color); font-size: 10px; margin-left: 5px;" title="Protegido por senha"></i>';
                    }

                    el.innerHTML = `
                        <div class="cloud-item-icon"><i class="fas ${icon}"></i></div>
                        <div class="cloud-item-name">${item.name} ${lockIcon}</div>
                    `;

                    // Drag Events for Move
                    el.ondragstart = (e) => {
                        e.dataTransfer.setData('text/plain', JSON.stringify({ id: item.id, type: item.type }));
                        el.style.opacity = '0.5';
                    };
                    el.ondragend = () => el.style.opacity = '1';

                    if (item.type === 'folder') {
                        el.ondragover = (e) => { e.preventDefault(); el.style.background = 'var(--highlight-color)'; };
                        el.ondragleave = () => { el.style.background = ''; };
                        el.ondrop = (e) => {
                            e.preventDefault();
                            el.style.background = '';
                            const data = e.dataTransfer.getData('text/plain');
                            if (data) {
                                const draggedItem = JSON.parse(data);
                                if (draggedItem.id !== item.id) {
                                    this.moveItem(draggedItem.id, item.id);
                                }
                            }
                        };
                    }

                    el.onclick = () => {
                        document.querySelectorAll('.cloud-item').forEach(i => i.classList.remove('selected'));
                        el.classList.add('selected');
                        el.classList.add('selected');
                        this.selectedItem = item;
                    };

                    // For keyboard nav to work, we need to update selectedItem when selection changes via keyboard.
                    // But keyboard handler relies on DOM.
                    // So I need to reverse lookup item from DOM ID. 
                    // I will do that in handleKeyDown using dataset.id


                    el.ondblclick = () => {
                        if (item.type === 'folder') {
                            this.verifyLockedFolderAccess(item, () => {
                                this.currentPath.push({ id: item.id, name: item.name });
                                this.render();
                            });
                        } else {
                            this.openPreview(item);
                        }
                    };

                    el.oncontextmenu = (e) => {
                        e.preventDefault();
                        document.querySelectorAll('.cloud-item').forEach(i => i.classList.remove('selected'));
                        el.classList.add('selected');
                        this.selectedItem = item;


                        // Update Lock Context label dynamically
                        const ctxLockItem = document.getElementById('ctx-lock');
                        if (ctxLockItem) {
                            if (item.isLocked) ctxLockItem.innerHTML = '<i class="fas fa-lock-open"></i> Destrancar';
                            else ctxLockItem.innerHTML = '<i class="fas fa-lock"></i> Trancar';
                        }

                        if (this.contextMenu) {
                            this.contextMenu.style.display = 'block';
                            this.contextMenu.style.left = `${e.pageX}px`;
                            this.contextMenu.style.top = `${e.pageY}px`;
                        }
                    };

                    this.grid.appendChild(el);
                });
            }

            updateBreadcrumb() {
                if (!this.breadcrumb) return;
                this.breadcrumb.innerHTML = '';

                const home = document.createElement('div');
                home.className = 'cloud-breadcrumb-item';
                home.innerHTML = '<i class="fas fa-home"></i> InÃ­cio';
                home.onclick = () => {
                    this.currentPath = [];
                    this.render();
                };
                this.breadcrumb.appendChild(home);

                this.currentPath.forEach((step, index) => {
                    const divider = document.createElement('span');
                    divider.innerHTML = '<i class="fas fa-chevron-right" style="font-size: 10px; opacity: 0.5; margin: 0 5px;"></i>';
                    this.breadcrumb.appendChild(divider);

                    const item = document.createElement('div');
                    item.className = 'cloud-breadcrumb-item';
                    item.textContent = step.name;
                    item.onclick = () => {
                        this.currentPath = this.currentPath.slice(0, index + 1);
                        this.render();
                    };
                    this.breadcrumb.appendChild(item);
                });
            }

            async createNewFolder() {
                this.showCustomInput("Nova Pasta", (name) => {
                    const currentParentId = this.currentPath.length > 0 ? this.currentPath[this.currentPath.length - 1].id : 'root';
                    addDoc(collection(db, "users", this.username, "files"), {
                        name: name,
                        type: 'folder',
                        parent: currentParentId,
                        createdAt: new Date(),
                        size: 0
                    }).catch(e => appendOutput("Erro ao criar pasta: " + e.message, "error"));
                });
            }

            async createNewTextFile() {
                this.showCustomInput("Nome do Arquivo (sem .txt)", (name) => {
                    const fileName = name.endsWith('.txt') ? name : `${name}.txt`;
                    // Open a simple editor? For now just empty file or prompt content.
                    // User asked for "Notepad-like". 
                    // Let's ask for content in a standard prompt for simplicity or create empty and open it.
                    // Creating empty is better.
                    const currentParentId = this.currentPath.length > 0 ? this.currentPath[this.currentPath.length - 1].id : 'root';

                    // Helper to upload text as file
                    const blob = new Blob([""], { type: 'text/plain' });
                    const file = new File([blob], fileName, { type: 'text/plain' });

                    this.handleUpload([file]);
                });
            }


            async handleUpload(fileList) {
                const currentParentId = this.currentPath.length > 0 ? this.currentPath[this.currentPath.length - 1].id : 'root';

                // Show notification with animation
                const notification = document.createElement('div');
                notification.className = 'notification-popup';
                notification.innerHTML = `
                    <div style="font-weight:bold; color:var(--highlight-color); display:flex; align-items:center; gap:5px;"><i class="fas fa-cloud-upload-alt"></i> Upload Iniciado</div>
                    <div style="font-size:12px;">Enviando ${fileList.length} arquivo(s)...</div>
                `;
                document.body.appendChild(notification);
                notification.style.display = 'flex';
                if (window.innerWidth <= 768) notification.classList.add('mobile-center');

                // Sequential upload better for status/errors
                for (const file of Array.from(fileList)) {
                    try {
                        let uploadResult = null;
                        let provider = 'pinata';
                        const LIMIT_50MB = 50 * 1024 * 1024;

                        // Check Supabase Preference
                        // Ensure loose type check matches boolean or string 'true'
                        const isSupabaseEnabled = (globalSettings.supabaseEnabled === true || globalSettings.supabaseEnabled === 'true');

                        if (isSupabaseEnabled && file.size < LIMIT_50MB && globalSettings.supabaseUrl && globalSettings.supabaseKey) {
                            try {
                                uploadResult = await uploadToSupabase(file);
                                provider = 'supabase';
                            } catch (sbErr) {
                                console.warn("Supabase upload failed, falling back to Pinata:", sbErr);
                                appendOutput(`Aviso: Upload p/ Supabase falhou (${sbErr.message}). Usando Pinata.`, "info");
                                // Fallback
                                uploadResult = await uploadToPinata(file);
                                provider = 'pinata';
                            }
                        } else {
                            if (isSupabaseEnabled && file.size < LIMIT_50MB) {
                                console.warn("Supabase enabled but missing credentials.");
                            }
                            uploadResult = await uploadToPinata(file);
                            provider = 'pinata';
                        }

                        // Prepare Metadata
                        const fileData = {
                            name: file.name,
                            type: 'file',
                            parent: currentParentId,
                            createdAt: new Date(),
                            size: file.size,
                            mimeType: file.type,
                            provider: provider
                        };

                        if (provider === 'supabase') {
                            fileData.supabasePath = uploadResult.path;
                            fileData.supabaseFullPath = uploadResult.fullPath;
                            fileData.url = uploadResult.url;
                        } else {
                            fileData.ipfsHash = uploadResult.ipfsHash;
                            fileData.pinataKey = uploadResult.pinataKey;
                        }

                        await addDoc(collection(db, "users", this.username, "files"), fileData);

                    } catch (e) {
                        appendOutput(`Erro no upload de ${file.name}: ${e.message}`, "error");
                    }
                }

                setTimeout(() => {
                    notification.innerHTML = `<div style="font-weight:bold; color:var(--success-color);"><i class="fas fa-check"></i> Upload ConcluÃ­do</div>`;
                    setTimeout(() => notification.remove(), 2000);
                }, 2000); // Fake delay for UX if quick, real reporting above
            }

            async moveItem(itemId, targetFolderId) {
                try {
                    await updateDoc(doc(db, "users", this.username, "files", itemId), { parent: targetFolderId });
                    // No need to re-render, onSnapshot will trigger
                } catch (e) { console.error("Move error", e); }
            }

            showErrorModal(message) {
                // Reuse showConfirmModal logic but simplified, or create a specific one.
                // Using alert for simplicity if custom modal overhead is high, but user asked for pop-up.
                // Let's use showConfirmModal with a single callback that does nothing, effectively an OK button loop or just hide cancel button?
                // Actually, let's implement a quick custom "Alert" modal using the existing structure or inject one.
                // Reusing showConfirmModal is easiest if we can tweak it.
                // Or just showCustomConfirm with no cancel action? 

                // Let's try to inject a simple alert modal structure similar to notification but persistent until clicked.
                const overlay = document.createElement('div');
                overlay.className = 'custom-modal';
                overlay.style.display = 'flex';
                overlay.style.zIndex = '9999';

                const content = document.createElement('div');
                content.className = 'custom-modal-content';
                content.style.border = '1px solid var(--error-color)';

                content.innerHTML = `
                    <div class="custom-modal-title" style="color:var(--error-color)"><i class="fas fa-exclamation-triangle"></i> Erro</div>
                    <div style="color:var(--text-color); margin-bottom:10px;">${message}</div>
                    <div class="custom-modal-actions">
                        <button class="app-modal-button" id="btn-err-ok">OK</button>
                    </div>
                `;

                overlay.appendChild(content);
                document.body.appendChild(overlay);

                document.getElementById('btn-err-ok').onclick = () => overlay.remove();
            }

            verifyLockedFolderAccess(item, callback) {
                if (!item) return;
                // If it's a file, check parent? For now, requirement implies locking folders prevents access/action on folder itself.
                // But does it prevent deleting a file inside a locked folder? 
                // The current structure tracks "isLocked" on the folder item. 
                // If the item itself is the folder being acted upon (rename, delete, move), we check it.

                if (item.type === 'folder' && item.isLocked) {
                    this.showCustomInput("Esta pasta estÃ¡ trancada. Digite a senha:", (password) => {
                        if (password === item.lockPassword) {
                            callback();
                        } else {
                            this.showErrorModal("Senha incorreta! Acesso negado.");
                        }
                    });
                } else {
                    callback();
                }
            }

            async handleContextAction(action) {
                if (!this.selectedItem && action !== 'paste') return;
                const item = this.selectedItem;

                if (action === 'open') {
                    if (item.type === 'folder') {
                        this.verifyLockedFolderAccess(item, () => {
                            this.currentPath.push({ id: item.id, name: item.name });
                            this.render();
                        });
                    } else {
                        this.openPreview(item);
                    }
                } else if (action === 'move') {
                    this.verifyLockedFolderAccess(item, () => {
                        this.showFolderSelection((targetFolderId) => {
                            if (targetFolderId && targetFolderId !== item.id) {
                                this.moveItem(item.id, targetFolderId);
                            }
                        });
                    });
                } else if (action === 'download') {
                    if (item.type === 'folder') {
                        this.verifyLockedFolderAccess(item, async () => {
                            if (typeof JSZip === 'undefined') {
                                appendOutput("Erro: Biblioteca JSZip nÃ£o carregada.", "error");
                                return;
                            }

                            appendOutput(`Preparando download da pasta "${item.name}"...`, "info");
                            const zip = new JSZip();
                            let fileCount = 0;

                            // Recursive function to add files/folders
                            const processFolder = async (folderId, zipFolder) => {
                                // Find children
                                const children = this.files.filter(f => f.parent === folderId);

                                for (const child of children) {
                                    if (child.type === 'folder') {
                                        const newZipFolder = zipFolder.folder(child.name);
                                        await processFolder(child.id, newZipFolder);
                                        // Move Supabase items from temp to permanent
                                        for (let i = 0; i < temporaryImgurUploads.length; i++) {
                                            const img = temporaryImgurUploads[i];
                                            console.log("DEBUG: Processing image for save:", img);
                                            if (img.provider === 'supabase' && img.isTemp) {
                                                try {
                                                    const oldPath = img.deleteHash; // stored as path
                                                    const filename = oldPath.split('/').pop();
                                                    const newPath = `${currentUser}/${filename}`;

                                                    await moveInSupabase(oldPath, newPath);

                                                    // Reconstruct the full public URL explicitly to allow viewing
                                                    const bucket = globalSettings.supabaseBucket || 'axon-drive';
                                                    img.link = `${globalSettings.supabaseUrl}/storage/v1/object/public/${bucket}/${newPath}`;
                                                    img.deleteHash = newPath;
                                                    img.isTemp = false;
                                                    img.saved = true; // Mark as saved
                                                } catch (e) {
                                                    console.error("Failed to move Supabase image:", e);
                                                }
                                            } else {
                                                img.saved = true; // Mark other providers as saved too
                                            }
                                        }
                                    } else {
                                        // FIX: Support Mixed Storage (Supabase & IPFS)
                                        let fileUrl = child.url || child.link;
                                        if (!fileUrl && child.ipfsHash) {
                                            fileUrl = `https://gateway.pinata.cloud/ipfs/${child.ipfsHash}`;
                                        }

                                        if (fileUrl) {
                                            try {
                                                const response = await fetch(fileUrl);
                                                if (response.ok) {
                                                    const blob = await response.blob();
                                                    zipFolder.file(child.name, blob);
                                                    fileCount++;
                                                }
                                            } catch (e) {
                                                console.warn(`Skipped ${child.name}:`, e);
                                            }
                                        }
                                    }
                                }
                            };

                            try {
                                const rootZip = zip.folder(item.name);
                                await processFolder(item.id, rootZip);

                                if (fileCount === 0) {
                                    appendOutput("A pasta estÃ¡ vazia ou os arquivos nÃ£o puderam ser baixados.", "error");
                                    return;
                                }

                                appendOutput("Gerando arquivo ZIP...", "info");
                                const content = await zip.generateAsync({ type: "blob" });
                                const downloadUrl = window.URL.createObjectURL(content);
                                const link = document.createElement('a');
                                link.href = downloadUrl;
                                link.download = `${item.name}.zip`;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                window.URL.revokeObjectURL(downloadUrl);
                                appendOutput("Download da pasta concluÃ­do!", "success");

                            } catch (e) {
                                appendOutput(`Erro ao criar ZIP: ${e.message}`, "error");
                            }
                        });
                        return;
                    }

                    // FIX: Support Supabase/Direct URLs
                    let url = item.url || item.link;
                    if (!url && item.ipfsHash) {
                        url = `https://gateway.pinata.cloud/ipfs/${item.ipfsHash}`;
                    }

                    if (!url) {
                        appendOutput("Erro: URL de download nÃ£o encontrada (Hash IPFS ou Link ausente).", "error");
                        return;
                    }

                    // const url = ... (Removed old const declaration)
                    appendOutput(`Iniciando download de ${item.name}...`, "info");

                    try {
                        // Attempt Fetch first to preserve filename
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`Status ${response.status}`);
                        const blob = await response.blob();
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = item.name;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(downloadUrl);
                        appendOutput("Download concluÃ­do.", "success");
                    } catch (e) {
                        console.warn("Fetch download failed, trying fallback:", e);
                        // Fallback: Direct link (works even if CORS blocks fetch)
                        try {
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = item.name;
                            link.target = "_blank"; // Force new tab if download attribute ignored
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            appendOutput("Download iniciado (Link Direto).", "success");
                        } catch (errFallback) {
                            appendOutput(`Erro ao baixar arquivo: ${errFallback.message}`, "error");
                        }
                    }
                } else if (action === 'delete') {
                    this.verifyLockedFolderAccess(item, () => {
                        this.showCustomConfirm(`Excluir ${item.name}?`, async () => {
                            if (item.provider === 'supabase' && item.supabasePath) {
                                await deleteFromSupabase(item.supabasePath);
                            } else if (item.type === 'file' && item.ipfsHash) {
                                await unpinFromPinata(item.ipfsHash);
                            }
                            await deleteDoc(doc(db, "users", this.username, "files", item.id));
                        });
                    });
                } else if (action === 'rename') {
                    this.verifyLockedFolderAccess(item, () => {
                        this.showCustomInput("Renomear", async (newName) => {
                            if (newName && newName !== item.name) {
                                let updates = { name: newName };
                                // Supabase Rename
                                if (item.provider === 'supabase' && item.supabasePath) {
                                    // Construct new path: keep folder structure, replace filename in path?
                                    // Usually supabasePath = user/timestamp_filename
                                    // We can just replace the filename part, but timestamp ensures uniqueness.
                                    // Simpler: Just rename in metadata OR try to rename file in bucket.
                                    // User wants bucket change.
                                    // Let's keep timestamp but change name suffix.
                                    const parts = item.supabasePath.split('_');
                                    // Reconstruct prefix
                                    const prefix = parts[0]; // "user/timestamp" (wait, timestamp is likely part 1 if format is "user/timestamp_name")
                                    // Actually path construction was: `${currentUser}/${Date.now()}_${cleanName}`
                                    // So it splits by _. 
                                    // If name has underscores, split might be complex.
                                    // Safer: Replace last part or just use a new clean name with SAME timestamp prefix if possible, or just NEW path.

                                    // Let's use the folder path (parent directory) + new name?
                                    // But supabasePath is just a key.
                                    // Let's just create a new key: `currentUser/Date.now()_newName` (new timestamp to be safe)
                                    // But Move requires known source.
                                    // Destination can be anything.
                                    // Let's make destination: `currentUser/${Date.now()}_${newName.replace(/[^a-zA-Z0-9.-]/g, '_')}`

                                    const cleanName = newName.replace(/[^a-zA-Z0-9.-]/g, '_');
                                    const newPath = `${this.username}/${Date.now()}_${cleanName}`;

                                    await renameInSupabase(item.supabasePath, newPath);

                                    updates.supabasePath = newPath;
                                    updates.supabaseFullPath = `${globalSettings.supabaseBucket || 'axon-drive'}/${newPath}`;
                                    // Update URL too? 
                                    // Yes, URL changes.
                                    updates.url = `${globalSettings.supabaseUrl}/storage/v1/object/public/${globalSettings.supabaseBucket || 'axon-drive'}/${newPath}`;
                                }

                                await updateDoc(doc(db, "users", this.username, "files", item.id), updates);
                            }
                        }, item.name);
                    });
                } else if (action === 'copy') {
                    // Copying a locked folder? Maybe check access before copying?
                    this.verifyLockedFolderAccess(item, () => {
                        this.clipboard = { action: 'copy', item: item };
                        this.contextMenu.style.display = 'none';
                    });
                } else if (action === 'paste') {
                    if (this.clipboard) {
                        const currentParentId = this.currentPath.length > 0 ? this.currentPath[this.currentPath.length - 1].id : 'root';
                        const { item } = this.clipboard;

                        if (this.clipboard.action === 'copy') {
                            const newItem = { ...item };
                            delete newItem.id;

                            await addDoc(collection(db, "users", this.username, "files"), {
                                ...newItem,
                                name: `CÃ³pia de ${item.name}`,
                                parent: currentParentId,
                                createdAt: new Date()
                            });
                        }
                    }
                } else if (action === 'lock') {
                    if (!this.selectedItem) return;
                    if (this.selectedItem.type !== 'folder') {
                        return this.showErrorModal("Apenas pastas podem ser trancadas.");
                    }

                    if (this.selectedItem.isLocked) {
                        // UNLOCK FLOW
                        this.showCustomInput("Digite a senha para destrancar:", async (password) => {
                            if (password === this.selectedItem.lockPassword) {
                                await updateDoc(doc(db, "users", this.username, "files", this.selectedItem.id), {
                                    isLocked: false,
                                    lockPassword: null
                                });
                                appendOutput("Pasta destrancada.", "success");
                            } else {
                                this.showErrorModal("Senha incorreta.");
                            }
                        });
                    } else {
                        // LOCK FLOW
                        this.showCustomInput("Crie uma senha para esta pasta:", async (password) => {
                            if (!password) return;
                            await updateDoc(doc(db, "users", this.username, "files", this.selectedItem.id), {
                                isLocked: true,
                                lockPassword: password
                            });
                            appendOutput("Pasta trancada com sucesso.", "success");
                        });
                    }
                }

                if (this.contextMenu) this.contextMenu.style.display = 'none';
                if (this.bgContextMenu) this.bgContextMenu.style.display = 'none';
            }

            handleKeyDown(e) {
                const modal = document.getElementById('axon-cloud-modal');
                if (!modal || modal.style.display === 'none') return;

                // Ignore if creating/renaming (input focused in custom modal)
                if (document.getElementById('custom-input-modal').style.display === 'flex') return;
                // Ignore if text editor is open
                if (document.getElementById('text-editor-modal').style.display === 'flex') return;

                if (e.key === 'Escape') {
                    modal.style.display = 'none';
                    return;
                }

                // Ignore if user is typing in an input (e.g. search bar, free mode, terminal)
                if (['INPUT', 'TEXTAREA'].includes(e.target.tagName) || e.target.isContentEditable) return;

                if (e.ctrlKey && (e.key === 'c' || e.key === 'C')) {
                    if (this.selectedItem) {
                        this.handleContextAction('copy');
                        // Visual feedback?
                    }
                    return;
                }

                if (e.ctrlKey && (e.key === 'v' || e.key === 'V')) {
                    this.handleContextAction('paste');
                    return;
                }

                if (e.key === 'Delete') {
                    if (this.selectedItem) this.handleContextAction('delete');
                    return;
                }

                if (e.key === 'Enter') {
                    if (this.selectedItem) {
                        if (this.selectedItem.type === 'folder') {
                            if (this.selectedItem.isLocked) {
                                this.showCustomInput("Esta pasta estÃ¡ trancada. Digite a senha:", (password) => {
                                    if (password === this.selectedItem.lockPassword) {
                                        this.currentPath.push({ id: this.selectedItem.id, name: this.selectedItem.name });
                                        this.render();
                                    } else {
                                        appendOutput("Senha incorreta! Acesso negado.", "error");
                                    }
                                });
                                return;
                            }
                            this.currentPath.push({ id: this.selectedItem.id, name: this.selectedItem.name });
                            this.render();
                        } else {
                            this.openPreview(this.selectedItem);
                        }
                    }
                    return;
                }

                const items = Array.from(document.querySelectorAll('.cloud-item'));
                if (items.length === 0) return;

                let selectedIndex = items.findIndex(el => el.classList.contains('selected'));

                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                    if (selectedIndex === -1) {
                        selectedIndex = 0;
                    } else {
                        const gridStyle = window.getComputedStyle(this.grid);
                        const gridCols = gridStyle.getPropertyValue('grid-template-columns').split(' ').length || 1;
                        // Note: split(' ').length might not work if it returns "repeat(...)" or auto-fill. 
                        // Better to estimate based on item width and container width.
                        const itemWidth = items[0].offsetWidth + 20; // + gap approx
                        const containerWidth = this.grid.clientWidth;
                        const cols = Math.floor(containerWidth / itemWidth) || 1;

                        if (e.key === 'ArrowRight') selectedIndex = Math.min(items.length - 1, selectedIndex + 1);
                        else if (e.key === 'ArrowLeft') selectedIndex = Math.max(0, selectedIndex - 1);
                        else if (e.key === 'ArrowDown') selectedIndex = Math.min(items.length - 1, selectedIndex + cols);
                        else if (e.key === 'ArrowUp') selectedIndex = Math.max(0, selectedIndex - cols);
                    }

                    // Update selection
                    items.forEach(i => i.classList.remove('selected'));
                    items[selectedIndex].classList.add('selected');
                    items[selectedIndex].scrollIntoView({ block: 'nearest' });

                    // Update selectedItem from DOM
                    const newSelectedEl = items[selectedIndex];
                    const newId = newSelectedEl.dataset.id;
                    this.selectedItem = this.files.find(f => f.id === newId);
                }
            }

            showCustomInput(title, callback, defaultValue = "") {
                const modal = document.getElementById('custom-input-modal');
                const titleEl = document.getElementById('custom-input-title');
                const inputEl = document.getElementById('custom-input-field');
                const confirmBtn = document.getElementById('custom-input-confirm');
                const cancelBtn = document.getElementById('custom-input-cancel');

                titleEl.textContent = title;
                inputEl.value = defaultValue;
                modal.style.display = 'flex';
                inputEl.focus();

                confirmBtn.onclick = () => {
                    if (inputEl.value.trim()) {
                        callback(inputEl.value.trim());
                        modal.style.display = 'none';
                    }
                };
                cancelBtn.onclick = () => modal.style.display = 'none';
            }

            showCustomConfirm(text, onYes) {
                // Use the modal I just added in HTML
                // But wait, I added 'custom-confirm-modal' (existing) OR 'custom-confirm-modal-axon' ??? 
                // The existing code has 'custom-confirm-modal'.
                // My new HTML has 'custom-confirm-modal-axon' ?? NO, I used 'custom-confirm-modal' in existing HTML?
                // Let's use the existing 'showConfirmModal' function if possible, or adapt.
                // The existing 'showConfirmModal' returns a Promise.

                // Reuse existing global function
                showConfirmModal(text, onYes);
            }

            async showFolderSelection(callback) {
                const modal = document.getElementById('select-folder-modal');
                const listContainer = document.getElementById('folder-list-container');
                const cancelBtn = document.getElementById('select-folder-cancel');

                // Get all folders
                const folders = this.files.filter(f => f.type === 'folder');

                listContainer.innerHTML = '';

                // Add Root option
                const rootEl = document.createElement('div');
                rootEl.style.padding = '10px';
                rootEl.style.cursor = 'pointer';
                rootEl.style.borderBottom = '1px solid var(--border-color)';
                rootEl.innerHTML = '<i class="fas fa-home"></i> Raiz (InÃ­cio)';
                rootEl.onmouseover = () => rootEl.style.background = 'var(--button-hover-bg)';
                rootEl.onmouseout = () => rootEl.style.background = '';
                rootEl.onclick = () => {
                    callback('root');
                    modal.style.display = 'none';
                };
                listContainer.appendChild(rootEl);

                folders.forEach(folder => {
                    const el = document.createElement('div');
                    el.style.padding = '10px';
                    el.style.cursor = 'pointer';
                    el.style.borderBottom = '1px solid var(--border-color)';
                    el.innerHTML = `<i class="fas fa-folder"></i> ${folder.name}`;
                    el.onmouseover = () => el.style.background = 'var(--button-hover-bg)';
                    el.onmouseout = () => el.style.background = '';
                    el.onclick = () => {
                        callback(folder.id);
                        modal.style.display = 'none';
                    };
                    listContainer.appendChild(el);
                });

                modal.style.display = 'flex';
                cancelBtn.onclick = () => modal.style.display = 'none';
            }

            formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            async openPreview(item) {
                const previewModal = document.getElementById('file-preview-modal');
                const previewContent = document.getElementById('preview-content');
                const previewTitle = document.getElementById('preview-title');
                const downloadBtn = document.getElementById('preview-download-btn');

                // Reset content
                previewContent.innerHTML = '';
                previewTitle.textContent = item.name;

                let fileUrl = '';
                if (item.provider === 'supabase' && item.url) {
                    fileUrl = item.url;
                } else if (item.ipfsHash) {
                    fileUrl = `https://gateway.pinata.cloud/ipfs/${item.ipfsHash}`;
                } else {
                    appendOutput("Erro: URL do arquivo nÃ£o encontrada.", "error");
                    return;
                }

                // Direct Download Handlers for Preview
                downloadBtn.onclick = async (e) => {
                    e.preventDefault();
                    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    try {
                        const response = await fetch(fileUrl);
                        if (!response.ok) throw new Error("Falha ao baixar.");
                        const blob = await response.blob();
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = item.name;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(downloadUrl);
                        downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
                    } catch (err) {
                        alert("Erro no download: " + err.message);
                        downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
                    }
                };
                downloadBtn.href = "#"; // Disable default link

                if (item.mimeType && item.mimeType.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = fileUrl;
                    previewContent.appendChild(img);
                    previewModal.style.display = 'flex';
                } else if (item.mimeType && item.mimeType.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = fileUrl;
                    video.controls = true;
                    previewContent.appendChild(video);
                    previewModal.style.display = 'flex';
                } else if (item.mimeType && item.mimeType.includes('pdf')) {
                    const iframe = document.createElement('iframe');
                    iframe.src = fileUrl; // Pinata Gateway can render PDFs usually
                    // Alternatively use pdf.js if needed, but iframe is a good start
                    previewContent.appendChild(iframe);
                    previewModal.style.display = 'flex';
                } else if (item.name.endsWith('.txt') || (item.mimeType && item.mimeType.includes('text'))) {
                    this.openTextEditor(item);
                } else {
                    // Fallback for others
                    appendOutput(`NÃ£o Ã© possÃ­vel visualizar este arquivo. Iniciando download...`, "info");
                    downloadBtn.click();
                }
            }

            async openTextEditor(item) {
                const modal = document.getElementById('text-editor-modal');
                const textarea = document.getElementById('text-editor-textarea');
                const title = document.getElementById('text-editor-title');
                const saveBtn = document.getElementById('text-editor-save');
                const closeBtn = document.getElementById('text-editor-close');
                const status = document.getElementById('text-editor-status');

                title.textContent = `Editando: ${item.name}`;
                textarea.value = "Carregando...";
                status.textContent = "";

                modal.style.display = 'flex';

                let fileUrl = '';
                if (item.provider === 'supabase' && item.url) {
                    fileUrl = item.url;
                } else if (item.ipfsHash) {
                    fileUrl = `https://gateway.pinata.cloud/ipfs/${item.ipfsHash}`;
                }

                if (item.provider === 'supabase') {
                    fileUrl += (fileUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
                }

                try {
                    const response = await fetch(fileUrl);
                    if (!response.ok) throw new Error("Falha ao carregar arquivo de texto.");
                    const text = await response.text();
                    textarea.value = text;
                } catch (e) {
                    textarea.value = "";
                    status.textContent = "Erro ao carregar conteÃºdo.";
                    console.error(e);
                }

                saveBtn.onclick = async () => {
                    const newContent = textarea.value;
                    status.textContent = "Salvando...";
                    try {
                        await this.saveTextFile(item, newContent);
                        status.textContent = "Salvo com sucesso!";
                        status.style.color = "var(--success-color)";
                        setTimeout(() => status.textContent = "", 3000);
                    } catch (e) {
                        status.textContent = "Erro ao salvar: " + e.message;
                        status.style.color = "var(--error-color)";
                    }
                };

                closeBtn.onclick = () => {
                    modal.style.display = 'none';
                };
            }

            async saveTextFile(item, content) {
                // 1. Create Blob/File
                const blob = new Blob([content], { type: 'text/plain' });
                const file = new File([blob], item.name, { type: 'text/plain' });

                if (item.provider === 'supabase') {
                    await updateSupabaseFile(item, content);
                    await updateDoc(doc(db, "users", this.username, "files", item.id), {
                        size: new Blob([content]).size,
                        lastModified: new Date()
                    });
                    return;
                }

                // 2. Upload to Pinata
                const uploadResult = await uploadToPinata(file);

                // 3. Update Firestore
                await updateDoc(doc(db, "users", this.username, "files", item.id), {
                    ipfsHash: uploadResult.ipfsHash,
                    pinataKey: uploadResult.pinataKey,
                    size: file.size,
                    lastModified: new Date()
                });

                // 4. Clean up old file (optional, depends on policy, here we just orphan it safely)
                // We could call unpinFromPinata(item.ipfsHash) if we want to save space and have the keys.
                // NOTE: We do not have the old pinataKey stored in the item doc explicitly in previous versions? 
                // Wait, we DO store pinataKey in the doc now (see line 7555).
                if (item.pinataKey && item.ipfsHash) {
                    // Try to unpin old
                    // However, we need to pass the specific key used for that file.
                    // The uploadToPinata function uses a random key.
                    // If we stored the key object or just the keys... 
                    // The doc stores `pinataKey` object: { key: '...', secret: '...' }
                    // So we can unpin.

                    // But wait, unpinFromPinata iterates ALL global keys. 
                    // Let's just use unpinFromPinata(item.ipfsHash). It tries all keys.
                    // Or improves unpinFromPinata to take a specific key if known?
                    // For now, let's just trigger unpinFromPinata(item.ipfsHash).
                    unpinFromPinata(item.ipfsHash);
                }
            }
        }

        const initApp = async () => {
            // Initialize settings FIRST to ensure listeners and preferences (like log suppression) are active
            await setupGlobalSettingsListener();

            const savedTheme = localStorage.getItem('theme');
            const systemPrefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
            if (savedTheme) {
                setTheme(savedTheme);
            } else {
                setTheme(systemPrefersLight ? 'light' : 'dark');
            }

            adminPanelModal.addEventListener('click', (e) => {
                const formContainer = document.getElementById('create-user-form-container');
                if (!formContainer) return;

                if (e.target.closest('#toggle-create-user-form')) {
                    formContainer.style.display = 'block';
                }
                if (e.target.closest('#close-create-user-form')) {
                    formContainer.style.display = 'none';
                }
            });

            const cloudCloseBtn = document.querySelector('.axon-cloud-close');
            if (cloudCloseBtn) {
                cloudCloseBtn.addEventListener('click', () => {
                    document.getElementById('axon-cloud-modal').style.display = 'none';
                });
            }


            const mobileStatusEl = document.querySelector('.mobile-connection-status');
            if (mobileStatusEl) {
                mobileStatusEl.addEventListener('click', () => {
                    showConfirmModal(
                        "Deseja encerrar todas as sessÃµes em desktops? Qualquer dispositivo conectado serÃ¡ desconectado e precisarÃ¡ de um novo login.",
                        async () => {
                            if (currentUser) {
                                try {
                                    await deleteDoc(doc(db, "sessions", currentUser));
                                } catch (e) {
                                    console.error("Erro ao encerrar sessÃ£o remota:", e);
                                }
                            }
                        }
                    );
                });
            }

            window.addEventListener('beforeunload', () => {
                if (isLoggedIn && currentUser && !isMobile) {
                    // This is a 'fire and forget' call. It's a best-effort attempt to clean up 
                    // the session document when the desktop user closes the tab or navigates away.
                    deleteDoc(doc(db, "sessions", currentUser));
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (chatboxModal.style.display === 'flex') {
                        closeChatbox();
                    } else if (fullscreenModal.style.display === 'block') {
                        fullscreenModal.style.display = 'none';
                    } else if (albumModal.style.display === 'flex') {
                        closeAlbumModal();
                    } else if (patientListModal.style.display === 'flex') {
                        patientListModal.style.display = 'none';
                    } else if (patientDetailsModal.style.display === 'flex') {
                        patientDetailsModal.style.display = 'none';
                    } else if (savePatientModal.style.display === 'flex') {
                        closeSaveModal();
                    } else if (adminAuthModal.style.display === 'flex') {
                        adminAuthModal.style.display = 'none';
                    } else if (adminPanelModal.style.display === 'flex') {
                        adminPanelModal.style.display = 'none';
                    } else if (prescriptionHelperModal.style.display === 'flex') {
                        closePrescriptionHelper();
                    } else if (cameraModal.style.display === 'flex') {
                        cancelCamera();
                    } else if (transferModal.style.display === 'flex') {
                        transferModal.style.display = 'none';
                    }
                }
            });

            if (isSpeechRecognitionSupported()) initSpeechRecognition();

            const savedUser = localStorage.getItem('axon_logged_in_user');
            if (savedUser) {
                appendOutput(`Verificando sessÃ£o para ${savedUser}...`, "info", false);
                const userIsValid = await isUserValid(savedUser);
                if (userIsValid) {
                    const sessionRef = doc(db, "sessions", savedUser);
                    const sessionSnap = await getDoc(sessionRef);

                    if (!isMobile && sessionSnap.exists()) {
                        handleSuccessfulLogin(savedUser, true);
                        updateMobileVisibility();
                    } else {
                        if (isMobile) { // Mobile can always "restore" to connect to a desktop session
                            handleSuccessfulLogin(savedUser, true);
                            updateMobileVisibility();
                        } else {
                            appendOutput("SessÃ£o anterior foi encerrada. Por favor, faÃ§a login novamente.", "info", false);
                            localStorage.removeItem('axon_logged_in_user');
                            loginModal.style.display = 'flex';
                            loginModalUser.focus();
                        }
                    }
                } else {
                    appendOutput(`UsuÃ¡rio '${savedUser}' nÃ£o existe mais. Por favor, faÃ§a login novamente.`, "error", false);
                    localStorage.removeItem('axon_logged_in_user');
                    loginModal.style.display = 'flex';
                    loginModalUser.focus();
                }
            } else {
                loginModal.style.display = 'flex';
                loginModalUser.focus();
            }
            if (isMobile) {
                if (statusTextApi) statusTextApi.textContent = "";
                if (statusTextMic) statusTextMic.textContent = "";
                if (statusTextCam) statusTextCam.textContent = "";
            }
        };

        // Prescription Assistant Interactions & Admin Logic
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const prescModal = document.getElementById('prescription-modal');
                if (prescModal && prescModal.style.display === 'flex') {
                    prescModal.style.display = 'none';
                }
            }
        });

        ['presc-input', 'presc-age', 'presc-weight'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('btn-generate-prescription').click();
                    }
                });
            }
        });

        // Prescription Assistant Interactions
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const prescModal = document.getElementById('prescription-modal');
                if (prescModal && prescModal.style.display === 'flex') {
                    prescModal.style.display = 'none';
                }
            }
        });

        ['presc-input', 'presc-age', 'presc-weight'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('btn-generate-prescription').click();
                    }
                });
            }
        });



        // --- AXON PLUGIN SYSTEM ---
        class AxonPluginManager {
            constructor() {
                this.plugins = [];
                this.activeWindows = [];
                this.storePlugins = []; // Will load from mock or file
                this.unsubscribePlugins = null;
            }

            init() {
                this.injectButton();
                this.loadStoreData();
                this.startPluginListener(); // Real-time Firestore sync
                // Ensure tabs are correct on init
                this.switchTab('installed');
            }

            // Listen for user's plugins from Firestore
            startPluginListener() {
                if (!currentUser) return;
                const q = query(collection(db, "users", currentUser, "files"), where("type", "==", "axon_plugin"));

                this.unsubscribePlugins = onSnapshot(q, (snapshot) => {
                    this.plugins = [];
                    snapshot.forEach(doc => {
                        this.plugins.push({ dbId: doc.id, ...doc.data() });
                    });
                    this.renderInstalled();
                });
            }

            async loadStoreData() {
                // Base plugins (Local backup or core)
                const localPlugins = [
                    {
                        id: 'quick-notes-pro',
                        name: 'Notas RÃ¡pidas Pro',
                        author: 'Community',
                        description: 'Bloco de notas persistente. Salva suas anotaÃ§Ãµes automaticamente.',
                        icon: 'https://cdn-icons-png.flaticon.com/512/3209/3209265.png',
                        version: '2.0',
                        html: `
                            <style>body{margin:0;display:flex;flex-direction:column;height:100vh; font-family: sans-serif;} textarea{flex:1;border:none;padding:15px;font-size: 14px; resize:none;outline:none;background:#fffaf0; line-height: 1.5; color: #444;} ::placeholder { color: #aaa; }</style>
                            <textarea id="note" placeholder="Digite suas notas aqui..."></textarea>
                            <script>
                                const area = document.getElementById('note');
                                area.value = localStorage.getItem('axon_quick_note') || '';
                                area.addEventListener('input', () => localStorage.setItem('axon_quick_note', area.value));
                            <\/script>
                        `
                    }
                ];

                this.storePlugins = [...localPlugins];

                // Show Loading Animation
                const storeList = document.getElementById('store-plugins-list');
                if (storeList) {
                    storeList.innerHTML = `
                        <div style="grid-column: 1 / -1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding: 50px; color: var(--text-color); opacity: 0.8;">
                            <div class="ai-processing-animation" style="transform:scale(0.8); margin-bottom:15px;">
                                <div class="scanner-animation">
                                    <div class="brain-icon"><i class="fas fa-cubes"></i></div>
                                    <div class="scanner-line"></div>
                                </div>
                            </div>
                            <div style="font-size:14px; font-weight:500;">Conectando Ã  Axon Store...</div>
                            <div style="font-size:11px; opacity:0.6; margin-top:5px;">Buscando plugins via satÃ©lite Pinata...</div>
                        </div>
                     `;
                }

                if (this.unsubscribeStore) this.unsubscribeStore();

                // Real-time listener to Global Store
                this.unsubscribeStore = onSnapshot(collection(db, "axon_store_plugins"), (snapshot) => {
                    // Update list
                    this.storePlugins = [...localPlugins];

                    snapshot.forEach(doc => {
                        this.storePlugins.push(doc.data());
                    });

                    this.storeStatusMessage = "";
                    this.renderStore();
                }, (error) => {
                    console.error("Store Error", error);
                    this.storeStatusMessage = "Erro de conexÃ£o com a loja. Verifique sua internet.";
                    this.renderStore();
                });
            }

            injectButton() {
                // Target: Header 'Enviar' button (btn-transfer-file)
                const refBtn = document.getElementById('btn-transfer-file');

                if (refBtn && refBtn.parentNode) {
                    // Check if already exists
                    if (document.getElementById('btn-tools')) return;

                    // Global Setting Check
                    if (globalSettings.showToolsButton === false) return; // Don't create if disabled globally

                    const btn = document.createElement('div');
                    btn.id = 'btn-tools';
                    btn.className = 'status-bar';
                    btn.style.cssText = 'cursor:pointer;margin-right:10px;background:var(--highlight-color);color:#fff;border-color:transparent';
                    btn.innerHTML = '<div class="status-item"><i class="fas fa-cubes"></i><span>Ferramentas</span></div>';
                    btn.onclick = () => this.openManager();

                    // Insert after btn-transfer-file
                    if (refBtn.nextSibling) {
                        refBtn.parentNode.insertBefore(btn, refBtn.nextSibling);
                    } else {
                        refBtn.parentNode.appendChild(btn);
                    }

                    // Apply mobile visibility rules immediately
                    if (typeof updateMobileVisibility === 'function') updateMobileVisibility();
                } else {
                    // Fallback to footer logic removed or simplied if needed, but Header is preferred.
                }
            }

            openManager() {
                document.getElementById('plugin-manager-modal').style.display = 'flex';
                this.renderInstalled();
                // Trigger load again when opening, to catch new file changes if possible (though browser caches)
                this.loadStoreData().then(() => this.renderStore());
            }

            switchTab(tab) {
                const installedView = document.getElementById('view-installed-plugins');
                const storeView = document.getElementById('view-axon-store');
                const tabInstalled = document.getElementById('tab-installed-plugins');
                const tabStore = document.getElementById('tab-axon-store');

                if (installedView) installedView.style.display = tab === 'installed' ? 'block' : 'none';
                if (storeView) storeView.style.display = tab === 'store' ? 'block' : 'none';
                if (tabInstalled) tabInstalled.classList.toggle('active', tab === 'installed');
                if (tabStore) tabStore.classList.toggle('active', tab === 'store');

                if (tab === 'store') this.renderStore();
            }

            renderInstalled() {
                const container = document.getElementById('installed-plugins-list');
                const emptyMsg = document.getElementById('no-plugins-msg');
                if (!container) return;

                container.innerHTML = '';

                // Add Import Button at the top/start of the list as a special card or header action
                // User asked for "Import button layout... similar to other buttons... in Installed tab"
                // Let's create a header area for the installed tab
                // Wait, the HTML structure for 'view-installed-plugins' is just the grid. 
                // I'll prepend a toolbar div.
                const toolbar = document.createElement('div');
                toolbar.style.cssText = 'width: 100%; padding: 10px 15px; display: flex; justify-content: flex-end; align-items: center; border-bottom: 1px solid var(--border-color); margin-bottom: 10px;';
                toolbar.innerHTML = `
                    <button class="patient-action-button" onclick="window.axonPluginManager.importFromFile()">
                        <i class="fas fa-file-import"></i> Importar Plugin
                    </button>
                `;
                // If I append to container, it messes up grid. 
                // Grid is 'plugin-grid'. 
                // I should clear container and insert toolbar BEFORE the logic of items? 
                // No, grid should only contain cards. Toolbar should be outside.
                // But the HTML for tab body is hardcoded. 
                // I will inject the toolbar into the parent of container if not exists?
                // Or just clear container AND add toolbar? But toolbar shouldn't be a grid item.
                // Let's modify the modal HTML dynamically properly or just assume grid handles full width items? No.
                // I will manipulate the DOM of 'view-installed-plugins' to ensure toolbar exists.

                const installedView = document.getElementById('view-installed-plugins');
                let existingToolbar = installedView.querySelector('.installed-toolbar');
                if (!existingToolbar) {
                    existingToolbar = toolbar;
                    existingToolbar.className = 'installed-toolbar';
                    installedView.insertBefore(existingToolbar, container);
                }

                if (this.plugins.length === 0) {
                    if (emptyMsg) emptyMsg.style.display = 'block';
                    return;
                }
                if (emptyMsg) emptyMsg.style.display = 'none';

                this.plugins.forEach(p => {
                    const card = this.createCard(p, true);
                    container.appendChild(card);
                });
            }

            renderStore() {
                const container = document.getElementById('store-plugins-list');
                const searchEl = document.getElementById('store-search');
                if (!container) return;

                const search = searchEl ? searchEl.value.toLowerCase() : "";
                container.innerHTML = '';

                // Show Status/Error Message if exists
                if (this.storeStatusMessage) {
                    const msgDiv = document.createElement('div');
                    msgDiv.style.cssText = 'grid-column: 1 / -1; padding: 15px; margin-bottom: 20px; background: rgba(50,50,50,0.05); border-left: 4px solid var(--highlight-color); border-radius: 4px; color: var(--text-color); font-size: 14px;';
                    // Use error color if it contains "Erro"
                    if (this.storeStatusMessage.toLowerCase().includes('erro') || this.storeStatusMessage.toLowerCase().includes('aviso')) {
                        msgDiv.style.borderLeftColor = 'var(--error-color)';
                        msgDiv.style.background = 'rgba(255,0,0,0.05)';
                    }
                    msgDiv.innerHTML = `<strong>Status:</strong> ${this.storeStatusMessage}`;
                    container.appendChild(msgDiv);
                }

                // Styling explicitly for Store to look like an App Store
                container.style.display = 'grid';
                container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))';
                container.style.gap = '20px';

                this.storePlugins
                    .filter(p => p.name.toLowerCase().includes(search) || p.description.toLowerCase().includes(search))
                    .forEach(p => {
                        const card = this.createStoreCard(p);
                        container.appendChild(card);
                    });
            }

            createCard(plugin, isInstalled) {
                const div = document.createElement('div');
                div.className = 'plugin-card';
                // Use a database ID or fallback to id field
                const pId = plugin.dbId || plugin.id;

                // UPDATE CHECK LOGIC
                // Find matching plugin in store by originalId or name
                const storeMatch = this.storePlugins.find(sp => (plugin.originalId && sp.id === plugin.originalId) || sp.name === plugin.name);
                let updateAvailable = false;
                if (storeMatch) {
                    const installedUpdate = plugin.updatedAt ? (plugin.updatedAt.toDate ? plugin.updatedAt.toDate() : new Date(plugin.updatedAt)) : null;
                    const storeUpdate = storeMatch.updatedAt ? (storeMatch.updatedAt.toDate ? storeMatch.updatedAt.toDate() : new Date(storeMatch.updatedAt)) : null;

                    // Logic:
                    // 1. If Store Date > Installed Date -> Update available (Admin pushed new build, even if version is same or lower/rollback)
                    // 2. OR If Store Version > Installed Version (Fallback if timestamps missing/unreliable)

                    if (storeUpdate && installedUpdate && storeUpdate.getTime() > installedUpdate.getTime()) {
                        updateAvailable = true;
                    } else if (storeMatch.version > plugin.version) {
                        updateAvailable = true;
                    }
                }

                div.innerHTML = `
                    <div class="plugin-icon-area" style="position:relative;">
                        <img src="${plugin.icon || 'default_icon.png'}" class="plugin-icon-img" onerror="this.src='https://via.placeholder.com/50'">
                        <div class="plugin-info">
                            <div class="plugin-name">${plugin.name}</div>
                            <div class="plugin-author" style="display:flex; align-items:center; gap:4px;">
                                v${plugin.version} â€¢ ${plugin.author}
                                ${plugin.author === 'Axon Dev' && plugin.source === 'store' ? '<i class="fas fa-check-circle" style="color:var(--highlight-color); font-size:10px;" title="Verificado"></i>' : ''}
                            </div>
                        </div>
                        ${updateAvailable ? `
                        <div class="update-badge" 
                             title="Existe uma nova versÃ£o desse plugin disponÃ­vel na Axon Store! Clique aqui para atualizar."
                             onclick="window.axonPluginManager.updatePlugin('${pId}', '${storeMatch.id}')">
                             <img src="https://cdn-icons-png.flaticon.com/512/3247/3247396.png" style="width:20px;height:20px;">
                             <span>AtualizaÃ§Ã£o disponÃ­vel</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="plugin-desc">${plugin.description || 'Sem descriÃ§Ã£o.'}</div>
                    <div class="plugin-actions">
                        <button class="plugin-btn btn-open-plugin" onclick="window.axonPluginManager.openPlugin('${pId}')"><i class="fas fa-play"></i> Abrir</button>
                        <button class="plugin-btn btn-uninstall" onclick="window.axonPluginManager.uninstallPlugin('${pId}')" title="Desinstalar"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                return div;
            }

            createStoreCard(plugin) {
                const div = document.createElement('div');
                div.className = 'plugin-store-card';
                div.style.cssText = `
                    background: var(--glass-bg);
                    border: 1px solid var(--border-color);
                    border-radius: 12px;
                    padding: 20px;
                    display: flex;
                    flex-direction: column;
                    transition: transform 0.2s;
                `;
                div.onmouseover = () => div.style.transform = 'translateY(-2px)';
                div.onmouseout = () => div.style.transform = 'translateY(0)';

                const isAlreadyInstalled = this.plugins.some(p => p.id === plugin.id); // Simple check by internal ID

                div.innerHTML = `
                    <div style="display:flex; gap: 15px; margin-bottom: 15px;">
                        <img src="${plugin.icon}" style="width: 60px; height: 60px; border-radius: 12px; object-fit: cover; background: #fff;">
                        <div>
                            <div style="font-weight: bold; font-size: 16px; color: var(--text-color);">${plugin.name}</div>
                            <div style="font-size: 12px; opacity: 0.7; margin-top: 4px; display:flex; align-items:center; gap:5px;">
                                ${plugin.author}
                                ${plugin.author === 'Axon Dev' ? '<i class="fas fa-check-circle" style="color:var(--highlight-color);" title="Verificado"></i>' : ''}
                            </div>
                        </div>
                    </div>
                    <div style="font-size: 13px; color: var(--text-color); opacity: 0.8; margin-bottom: 20px; flex: 1; line-height: 1.4;">
                        ${plugin.description}
                    </div>
                    <button class="app-modal-button" 
                        onclick="window.axonPluginManager.installPlugin('${plugin.id}')"
                        style="width: 100%; ${isAlreadyInstalled ? 'background: var(--success-color); cursor: default;' : ''}"
                        ${isAlreadyInstalled ? 'disabled' : ''}>
                        ${isAlreadyInstalled ? '<i class="fas fa-check"></i> Instalado' : '<i class="fas fa-download"></i> Obter'}
                    </button>
                `;
                return div;
            }

            async installPlugin(storePluginId) {
                const plugin = this.storePlugins.find(p => p.id === storePluginId);
                if (!plugin) return;

                // Check for duplicates
                const isDupe = this.plugins.find(p => p.originalId === storePluginId || p.name === plugin.name);
                if (isDupe) {
                    showConfirmModal(
                        `O plugin "${plugin.name}" jÃ¡ estÃ¡ instalado. Deseja reinstalar? (Sua versÃ£o atual serÃ¡ substituÃ­da)`,
                        async () => {
                            // Reinstall Logic
                            appendOutput(`Reinstalando ${plugin.name}...`, "info");
                            // 1. Remove old
                            try {
                                await deleteDoc(doc(db, "users", currentUser, "files", isDupe.dbId));
                                this.plugins = this.plugins.filter(p => p.dbId !== isDupe.dbId);
                            } catch (err) {
                                console.warn("Erro ao limpar versÃ£o antiga:", err);
                            }
                            // 2. Proceed to install (call internal helper or just continue logic? Recursive call might hit this check again if state not updated? 
                            // Optimized: Just continue execution below? No, "return" blocks it.
                            // I'll extract install logic or allow flow to continue.
                            // Safest: Recursively call installPlugin but with a force flag? Or clearer:
                            // Let's manually trigger the install steps here.
                            this._performInstall(plugin);
                        },
                        true // isConfirm
                    );
                    return;
                }

                await this._performInstall(plugin);
            }

            async updatePlugin(installedDbId, storePluginId) {
                const plugin = this.storePlugins.find(p => p.id === storePluginId);
                if (!plugin) return;

                // Show Confirmation/Animation Popup
                // Create a temporary modal for the update process
                const popupId = 'update-popup-' + Date.now();
                const popup = document.createElement('div');
                popup.id = popupId;
                popup.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;
                    backdrop-filter: blur(5px);
                `;
                popup.innerHTML = `
                    <div style="background: var(--glass-bg); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: var(--text-color);">
                        <i class="fas fa-sync fa-spin" style="font-size: 40px; color: var(--highlight-color); margin-bottom: 20px;"></i>
                        <h3 style="margin-bottom: 10px; color: var(--text-color);">Atualizando...</h3>
                        <p style="color: var(--text-color); opacity: 0.8; margin-bottom: 0;">Substituindo a versÃ£o antiga pela nova versÃ£o (${plugin.version}) da Axon Store.</p>
                    </div>
                `;
                document.body.appendChild(popup);

                // Simulate delay/process
                await new Promise(r => setTimeout(r, 1500));

                try {
                    // 1. Delete Old
                    await deleteDoc(doc(db, "users", currentUser, "files", installedDbId));

                    // 2. Install New
                    // Using _performInstall logic but adapted to ensure smooth transition
                    // We can just call _performInstall
                    await this._performInstall(plugin);

                    // Success feedback
                    popup.innerHTML = `
                        <div style="background: var(--glass-bg); padding: 30px; border-radius: 12px; border: 1px solid var(--success-color); text-align: center; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: var(--text-color);">
                            <i class="fas fa-check-circle" style="font-size: 40px; color: var(--success-color); margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 10px; color: var(--text-color);">Atualizado!</h3>
                            <p style="color: var(--text-color); opacity: 0.8; margin-bottom: 0;">O plugin foi atualizado com sucesso.</p>
                        </div>
                     `;

                    setTimeout(() => {
                        popup.classList.add('fade-out'); // assuming CSS or just remove
                        popup.style.opacity = '0';
                        popup.style.transition = 'opacity 0.5s';
                        setTimeout(() => popup.remove(), 500);
                    }, 1500);

                } catch (err) {
                    console.error("Update failed:", err);
                    popup.remove();
                    appendOutput("Erro ao atualizar plugin: " + err.message, "error");
                }
            }

            async _performInstall(plugin) {
                // Optimization: Link to original file instead of re-uploading
                const storeIpfsHash = plugin.ipfsHash;
                let finalIpfsHash = storeIpfsHash;
                let finalPinataKey = plugin.pinataKey || 'shared';

                if (!finalIpfsHash) {
                    appendOutput(`Instalando ${plugin.name} na nuvem (Upload)...`, "info");
                    const jsonContent = JSON.stringify(plugin);
                    const blob = new Blob([jsonContent], { type: 'application/json' });
                    const file = new File([blob], plugin.name + ".json", { type: "application/json" });
                    try {
                        const res = await uploadToPinata(file);
                        finalIpfsHash = res.ipfsHash;
                        finalPinataKey = res.pinataKey;
                    } catch (e) {
                        appendOutput("Erro no upload: " + e.message, "error");
                        return;
                    }
                } else {
                    appendOutput(`Instalando ${plugin.name}...`, "info");
                }


                try {
                    // 3. Save reference to Firestore (Persist user registry)
                    // We use type 'axon_plugin' to distinguish from regular files
                    await addDoc(collection(db, "users", currentUser, "files"), {
                        name: plugin.name,
                        type: 'axon_plugin',
                        source: 'store', // Flag as store-installed
                        originalId: plugin.id,
                        icon: plugin.icon,
                        description: plugin.description,
                        author: plugin.author,
                        version: plugin.version,
                        createdAt: new Date(),
                        updatedAt: plugin.updatedAt || new Date(), // Copy store's updatedAt for update detection
                        size: plugin.size || 0,
                        ipfsHash: finalIpfsHash,
                        pinataKey: finalPinataKey,
                        content: plugin.html
                    });

                    // Optimistic Update
                    const newPlugin = { ...plugin, dbId: 'temp_' + Date.now() };
                    if (!this.plugins.some(p => p.originalId === plugin.id)) {
                        this.plugins.push(newPlugin);
                    }
                    this.renderInstalled();

                    appendOutput("Plugin instalado e salvo com sucesso!", "success");
                    this.switchTab('installed');
                } catch (e) {
                    console.error(e);
                    appendOutput("Erro ao instalar plugin: " + e.message, "error");
                }
            }

            async uninstallPlugin(dbId) {
                showConfirmModal("Tem certeza que deseja remover este plugin?", async () => {
                    try {
                        await deleteDoc(doc(db, "users", currentUser, "files", dbId));
                        // Optimistic
                        this.plugins = this.plugins.filter(p => p.dbId !== dbId);
                        this.renderInstalled();
                        appendOutput("Plugin removido.", "success");
                    } catch (e) {
                        appendOutput("Erro ao remover: " + e.message, "error");
                    }
                });
            }

            async importFromFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;

                    showConfirmModal(
                        `ATENÃ‡ÃƒO: VocÃª estÃ¡ importando um plugin externo ("${file.name}").\n\nPlugins externos podem executar cÃ³digo desconhecido e acessar seus dados.\n\nCertifique-se de que confia na fonte deste arquivo. Deseja continuar?`,
                        () => { this.processImport(file); }
                    );
                };
                input.click();
            }

            processImport(file) {
                const reader = new FileReader();
                reader.onload = async event => {
                    try {
                        const plugin = JSON.parse(event.target.result);
                        if (plugin.name && plugin.html) {
                            // Check for duplicates
                            const existing = this.plugins.find(p => p.name === plugin.name);
                            if (existing) {
                                appendOutput(`O plugin '${plugin.name}' jÃ¡ estÃ¡ instalado!`, "error");
                                return;
                            }

                            // Install it properly via Pinata
                            const blob = new Blob([JSON.stringify(plugin)], { type: 'application/json' });
                            const uploadFile = new File([blob], plugin.name + ".json", { type: "application/json" });

                            appendOutput("Importando e salvando plugin...", "info");
                            const uploadResult = await uploadToPinata(uploadFile);

                            const docData = {
                                name: plugin.name,
                                type: 'axon_plugin',
                                source: 'import', // Flag as imported
                                originalId: plugin.id || 'custom-' + Date.now(),
                                icon: plugin.icon || 'https://via.placeholder.com/50',
                                description: plugin.description || 'Plugin importado',
                                author: plugin.author || 'User',
                                version: plugin.version || '1.0',
                                createdAt: new Date(),
                                size: uploadFile.size,
                                ipfsHash: uploadResult.ipfsHash,
                                pinataKey: uploadResult.pinataKey,
                                content: plugin.html
                            };

                            await addDoc(collection(db, "users", currentUser, "files"), docData);

                            // Optimistic Update removed to prevent duplication (Firestore listener handles it)
                            // this.plugins.push({ ...docData, dbId: 'temp_imp_' + Date.now() });
                            this.renderInstalled();

                            this.switchTab('installed');
                            appendOutput("Plugin importado com sucesso.", "success");
                        } else {
                            throw new Error("Formato invÃ¡lido (requer name e html).");
                        }
                    } catch (err) {
                        appendOutput("Erro ao importar: " + err.message, "error");
                    }
                };
                reader.readAsText(file);
            }

            openPlugin(dbIdOrId) {
                // Find in loaded plugins
                // plugins array now has firestore data
                let plugin = this.plugins.find(p => p.dbId === dbIdOrId);

                // If not found (maybe manual ID passed?), try to find by original ID?
                if (!plugin) plugin = this.plugins.find(p => p.originalId === dbIdOrId);

                if (!plugin) return;

                document.getElementById('plugin-manager-modal').style.display = 'none';
                this.createFloatingWindow(plugin);
            }

            createFloatingWindow(plugin) {
                const id = 'win_' + Date.now();
                const win = document.createElement('div');
                win.className = 'floating-plugin-window';
                win.id = id;
                win.style.top = (100 + this.activeWindows.length * 20) + 'px';
                win.style.left = (100 + this.activeWindows.length * 20) + 'px';

                // Loading Screen Overlay
                const loadingId = 'loading_' + id;

                win.innerHTML = `
                    <div class="floating-header" id="${id}_header">
                        <div class="floating-title">
                            <img src="${plugin.icon}" style="width:16px;height:16px;"> ${plugin.name}
                        </div>
                        <div class="floating-controls">
                            <div class="float-btn minimize-btn" onclick="window.axonPluginManager.minimizeWindow('${id}')"></div>
                            <div class="float-btn close-btn" onclick="document.getElementById('${id}').remove()"></div>
                        </div>
                    </div>
                    <div class="floating-content" style="position:relative;">
                        <iframe class="floating-iframe" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
                        <div id="${loadingId}" style="position:absolute;top:0;left:0;width:100%;height:100%;background:var(--bg-color);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;">
                            <i class="fas fa-spinner fa-spin" style="font-size:24px;color:var(--highlight-color);margin-bottom:10px;"></i>
                            <span style="font-size:12px;opacity:0.8;">Carregando Plugin...</span>
                        </div>
                    </div>
                `;

                document.body.appendChild(win);
                this.makeDraggable(win);

                const iframe = win.querySelector('iframe');
                const loadingOverlay = document.getElementById(loadingId);

                // Hide loading when iframe loads
                iframe.onload = () => {
                    setTimeout(() => {
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => loadingOverlay.style.display = 'none', 300);
                    }, 500); // Small delay for smooth effect
                };

                // Use the cached content if available, otherwise fetch from IPFS (not implemented in this snippet for simplicity, assuming content is cached)
                let htmlContent = plugin.content;
                // Inject the bridge script
                // We use postMessage, so we need to inject a helper script into the iframe to make it easier for developers?
                /*
                   We inject a script that defines window.AxonPluginBridge for backward compatibility 
                   or simply a helper that proxies to postMessage
                */
                const bridgeScript = `
                    <script>
                        window.AxonPluginBridge = {
                            sendToChat: (text) => window.parent.postMessage({ type: 'AXON_PLUGIN_MESSAGE', action: 'sendToChat', payload: text }, '*'),
                            getAnamnesis: () => { window.parent.postMessage({ type: 'AXON_PLUGIN_MESSAGE', action: 'getAnamnesis', reqId: Date.now() }, '*'); },
                            callAI: (prompt) => { window.parent.postMessage({ type: 'AXON_PLUGIN_MESSAGE', action: 'callAI', payload: prompt, reqId: Date.now() }, '*'); },
                            getAxonEyeResults: () => { window.parent.postMessage({ type: 'AXON_PLUGIN_MESSAGE', action: 'getAxonEyeResults', reqId: Date.now() }, '*'); },
                            getExamsResults: () => { window.parent.postMessage({ type: 'AXON_PLUGIN_MESSAGE', action: 'getExamsResults', reqId: Date.now() }, '*'); }
                        };
                    <\/script>
                `;

                // Fix: Properly inject the bridge script into the content
                htmlContent = bridgeScript + htmlContent;

                const blob = new Blob([htmlContent], { type: 'text/html' });
                iframe.src = URL.createObjectURL(blob);

                this.activeWindows.push(win);
            }

            makeDraggable(elmnt) {
                var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                const header = elmnt.querySelector('.floating-header');
                if (header) {
                    header.onmousedown = dragMouseDown;
                }

                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;

                    // Simple Z-index mgmt
                    elmnt.style.zIndex = 1500;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                }

                function closeDragElement() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }


            minimizeWindow(id) {
                const win = document.getElementById(id);
                if (!win) return;

                // Store original dimensions before hiding? 
                // Actually display:none might reset iframe state in some browsers, but usually just hides.
                // The "half screen" bug might be due to re-render issues.
                // Let's ensure we save the size? CSS handles it? 
                // If the bug is "half screen content" inside iframe, it's a resize event issue.
                // If it's "half window visible", it's a position issue.
                // Assuming content issue: force redraw on restore.

                win.style.display = 'none';

                // Add to HEADER (header-right) taskbar
                let taskbar = document.getElementById('plugin-taskbar-header');
                if (!taskbar) {
                    // Create it if not exists, look for header-right (div wrapping the right buttons)
                    // The user said "axon-glass-header", but the right buttons are in a div at line 4466.
                    // Let's target that div specifically. It doesn't have a class name other than inline style.
                    // We will search for the .header-right equivalent.
                    // Looking at HTML around 4466: <div style="display: flex; gap: 10px; padding-right: 15px;">
                    // We can insert before that, or inside it.
                    // Let's add an ID to that container via script if needed, or just find it.
                    const header = document.querySelector('.axon-glass-header');
                    const rightContainer = header ? header.querySelector('div[style*="display: flex; gap: 10px"]') : null;

                    if (rightContainer) {
                        taskbar = document.createElement('div');
                        taskbar.id = 'plugin-taskbar-header';
                        taskbar.style.cssText = 'display: flex; gap: 8px; margin-right: 15px; align-items: center;';
                        // Insert at the beginning of the right container
                        rightContainer.insertBefore(taskbar, rightContainer.firstChild);
                    } else {
                        // Fallback
                        console.warn("Right container not found for taskbar");
                        return;
                    }
                }

                // Get icon from header
                const img = win.querySelector('.floating-header img');
                const iconSrc = img ? img.src : 'https://via.placeholder.com/20';
                const titleEl = win.querySelector('.floating-title');
                const title = titleEl ? titleEl.textContent.trim() : 'Plugin';

                const tab = document.createElement('div');
                tab.id = 'tab_' + id;
                // ROUNDED STYLE as requested
                tab.style.cssText = `
                    cursor: pointer; 
                    background: rgba(255, 255, 255, 0.1); 
                    padding: 5px 12px; 
                    border-radius: 20px; 
                    border: 1px solid rgba(255,255,255,0.2); 
                    display: flex; 
                    align-items: center; 
                    gap: 6px;
                    transition: all 0.2s;
                    backdrop-filter: blur(5px);
                `;
                tab.onmouseover = () => tab.style.background = 'rgba(255, 255, 255, 0.2)';
                tab.onmouseout = () => tab.style.background = 'rgba(255, 255, 255, 0.1)';

                tab.innerHTML = `<img src="${iconSrc}" style="width:16px;height:16px;border-radius:50%;"> <span style="font-size: 11px; color: var(--text-color);">${title}</span>`;
                tab.title = "Restaurar " + title;
                tab.onclick = () => this.restoreWindow(id);

                taskbar.appendChild(tab);
            }

            restoreWindow(id) {
                const win = document.getElementById(id);
                if (win) {
                    win.style.display = 'flex'; // Was 'block', flex matches css usually
                    // Force Layout Recalculation to fix text/half-screen glitches
                    // Trigger a resize event on the window to help iframe content adjust
                    window.dispatchEvent(new Event('resize'));

                    // Simple fix for "half screen" if it means the iframe didn't fill:
                    const container = win.querySelector('.floating-content');
                    if (container) {
                        container.style.display = 'none';
                        container.offsetHeight; // force reflow
                        container.style.display = 'flex'; // or block
                    }

                    // Bring to front
                    this.activeWindows.forEach(w => w.style.zIndex = 1000);
                    win.style.zIndex = 1500;
                }
                const tab = document.getElementById('tab_' + id);
                if (tab) tab.remove();
            }

            restoreWindow(id) {
                const win = document.getElementById(id);
                if (win) {
                    win.style.display = 'flex'; // Was 'block', flex matches css usually
                    // Force Layout Recalculation to fix text/half-screen glitches
                    // Trigger a resize event on the window to help iframe content adjust
                    window.dispatchEvent(new Event('resize'));

                    // Simple fix for "half screen" if it means the iframe didn't fill:
                    const container = win.querySelector('.floating-content');
                    if (container) {
                        container.style.display = 'none';
                        container.offsetHeight; // force reflow
                        container.style.display = 'flex'; // or block
                    }

                    // Bring to front
                    this.activeWindows.forEach(w => w.style.zIndex = 1000);
                    win.style.zIndex = 1500;
                }
                const tab = document.getElementById('tab_' + id);
                if (tab) tab.remove();
            }
        }

        // --- MESSAGE HANDLER FOR PLUGINS ---
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'AXON_PLUGIN_MESSAGE') {
                const { action, payload, reqId } = event.data;

                // PERMISSION CHECK
                if (globalSettings.bridgePermissions && globalSettings.bridgePermissions[action] === false) {
                    if (reqId) {
                        event.source.postMessage({
                            type: 'AXON_PLUGIN_RESPONSE',
                            reqId: reqId,
                            error: `PermissÃ£o negada para '${action}'. Admin desativou.`
                        }, '*');
                    }
                    appendOutput(`Plugin tentou usar '${action}' mas foi bloqueado.`, 'error');
                    return;
                }

                if (action === 'sendToChat') {
                    const input = document.getElementById('command-input');
                    const cmdInput = document.getElementById('command-input');
                    if (cmdInput) {
                        cmdInput.value = payload;
                        cmdInput.focus();
                        // Auto-submit via Enter key event
                        const enterEvent = new KeyboardEvent('keydown', {
                            bubbles: true, cancelable: true, keyCode: 13, key: 'Enter', code: 'Enter'
                        });
                        cmdInput.dispatchEvent(enterEvent);
                    }
                }

                // Add more handlers here (getAnamnesis, etc) if we implement two-way sync
                if (action === 'getAnamnesis') {
                    // Send back
                    if (event.source) {
                        event.source.postMessage({
                            type: 'AXON_PLUGIN_RESPONSE',
                            reqId: reqId,
                            data: typeof anamnesis !== 'undefined' ? anamnesis : {}
                        }, '*');
                    }
                }

                if (action === 'getAxonEyeResults') {
                    if (event.source) {
                        event.source.postMessage({
                            type: 'AXON_PLUGIN_RESPONSE',
                            reqId: reqId,
                            data: typeof axonEyeResults !== 'undefined' ? axonEyeResults : []
                        }, '*');
                    }
                }

                if (action === 'getExamsResults') {
                    if (event.source) {
                        // Assuming 'examsResults' or 'patientExams' is the global
                        // Using 'examsResults' as per plan, but falling back to empty
                        event.source.postMessage({
                            type: 'AXON_PLUGIN_RESPONSE',
                            reqId: reqId,
                            data: typeof examsResults !== 'undefined' ? examsResults : []
                        }, '*');
                    }
                }

                if (action === 'callAI') {
                    // Call Gemini API (or current provider)
                    if (event.source && payload) {
                        // Async operation, but we don't want to block the listener
                        callGeminiAPI(payload).then(response => {
                            event.source.postMessage({
                                type: 'AXON_PLUGIN_RESPONSE',
                                reqId: reqId,
                                data: response
                            }, '*');
                        }).catch(err => {
                            event.source.postMessage({
                                type: 'AXON_PLUGIN_RESPONSE',
                                reqId: reqId,
                                error: err.message,
                                data: "Erro ao consultar IA: " + err.message
                            }, '*');
                        });

                    }
                }

                if (action === 'storage') {
                    // payload: { content: string/blob, filename: string }
                    if (event.source && payload && payload.content && payload.filename) {
                        const blob = new Blob([payload.content]);
                        const file = new File([blob], payload.filename);

                        uploadToPinata(file).then(res => {
                            event.source.postMessage({
                                type: 'AXON_PLUGIN_RESPONSE',
                                reqId: reqId,
                                data: {
                                    success: true,
                                    ipfsHash: res.ipfsHash,
                                    gatewayUrl: `https://gateway.pinata.cloud/ipfs/${res.ipfsHash}`
                                }
                            }, '*');
                        }).catch(err => {
                            event.source.postMessage({
                                type: 'AXON_PLUGIN_RESPONSE',
                                reqId: reqId,
                                error: "Falha no upload: " + err.message
                            }, '*');
                        });
                    }
                }

                if (action === 'storageList') {
                    // List files from Firestore for current user
                    try {
                        const q = query(collection(db, "users", currentUser, "files"), orderBy("lastModified", "desc"));
                        getDocs(q).then(snapshot => {
                            const files = [];
                            snapshot.forEach(doc => {
                                files.push({ id: doc.id, ...doc.data() });
                            });
                            event.source.postMessage({
                                type: 'AXON_PLUGIN_RESPONSE',
                                reqId: reqId,
                                data: { success: true, files: files }
                            }, '*');
                        }).catch(e => {
                            event.source.postMessage({ type: 'AXON_PLUGIN_RESPONSE', reqId: reqId, error: e.message }, '*');
                        });
                    } catch (e) {
                        event.source.postMessage({ type: 'AXON_PLUGIN_RESPONSE', reqId: reqId, error: e.message }, '*');
                    }
                }

                if (action === 'storageRegister') {
                    // Register a file in Firestore (metadata only)
                    // payload: { name, ipfsHash, size, mimeType }
                    if (payload && payload.name && payload.ipfsHash) {
                        try {
                            const fileData = {
                                name: payload.name,
                                ipfsHash: payload.ipfsHash,
                                size: payload.size || 0,
                                type: payload.mimeType || 'application/octet-stream',
                                pinataKey: 'shared', // or specific if available
                                lastModified: new Date()
                            };
                            addDoc(collection(db, "users", currentUser, "files"), fileData).then(docRef => {
                                event.source.postMessage({
                                    type: 'AXON_PLUGIN_RESPONSE',
                                    reqId: reqId,
                                    data: { success: true, id: docRef.id }
                                }, '*');
                            }).catch(e => {
                                event.source.postMessage({ type: 'AXON_PLUGIN_RESPONSE', reqId: reqId, error: e.message }, '*');
                            });
                        } catch (e) {
                            event.source.postMessage({ type: 'AXON_PLUGIN_RESPONSE', reqId: reqId, error: e.message }, '*');
                        }
                    } else {
                        event.source.postMessage({ type: 'AXON_PLUGIN_RESPONSE', reqId: reqId, error: "Dados incompletos (name, ipfsHash obrigatÃ³rios)" }, '*');
                    }
                }
            }
        });

        window.axonPluginManager = new AxonPluginManager();

        // --- GLOBAL SETTINGS LISTENER (Real-time Sync) ---
        try {
            onSnapshot(doc(db, "settings", "global"), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();

                    // Sync globalSettings object
                    if (typeof globalSettings !== 'undefined') {
                        globalSettings.showToolsButton = data.showToolsButton;
                        globalSettings.mobile2_0_enabled = data.mobile2_0_enabled;
                        globalSettings.showPrescriptionAssistant = data.showPrescriptionAssistant;
                    }

                    // Mobile 2.0 Logic: Hide Dock Buttons (Axon Eye, Exames)
                    const btnSee = document.getElementById('btn-see');
                    const btnExames = document.getElementById('btn-exames');
                    if (globalSettings.mobile2_0_enabled) {
                        if (btnSee) btnSee.style.display = 'none';
                        if (btnExames) btnExames.style.display = 'none';
                    } else {
                        if (btnSee) btnSee.style.display = 'flex';
                        if (btnExames) btnExames.style.display = 'flex';
                    }

                    // Update Tools Button UI
                    const btnTools = document.getElementById('btn-tools');
                    if (btnTools) {
                        const show = data.showToolsButton !== false; // Default true
                        btnTools.style.display = show ? 'flex' : 'none';
                    }

                    // Update Admin Toggle UI if present (Real-time sync for other admins)
                    const toggleTools = document.getElementById('toggle-tools-btn-visibility');
                    if (toggleTools) {
                        toggleTools.checked = data.showToolsButton !== false;
                    }

                    // Update Prescription Assistant UI if present
                    const btnAssist = document.getElementById('btn-prescription-assist');
                    if (btnAssist && typeof data.showPrescriptionAssistant !== 'undefined') {
                        btnAssist.style.display = data.showPrescriptionAssistant ? 'flex' : 'none';
                    }
                }
            }, (error) => {
                console.warn("Error listening to global settings:", error);
            });
        } catch (e) {
            console.warn("Failed to setup global settings listener:", e);
        }

        // --- ADMIN PLUGIN MANAGEMENT ---
        window.adminUploadPlugin = async (input) => {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const decoder = new TextDecoder("utf-8");
                    const text = decoder.decode(e.target.result);
                    const pluginData = JSON.parse(text);

                    if (!pluginData.name || !pluginData.id || !pluginData.version) {
                        alert("JSON invÃ¡lido. Requer name, id e version.");
                        return;
                    }

                    appendOutput(`Verificando se o plugin ${pluginData.name} jÃ¡ existe...`, "info");

                    // CHECK FOR EXISTING PLUGIN BY ID
                    const existingQuery = query(collection(db, "axon_store_plugins"), where("id", "==", pluginData.id));
                    const existingSnap = await getDocs(existingQuery);

                    let existingDocId = null;
                    let oldIpfsHash = null;
                    if (!existingSnap.empty) {
                        // Plugin already exists - get its doc ID for replacement
                        existingDocId = existingSnap.docs[0].id;
                        oldIpfsHash = existingSnap.docs[0].data().ipfsHash;
                        appendOutput(`Plugin existente encontrado (ID: ${pluginData.id}). Substituindo...`, "info");
                    }

                    appendOutput(`Enviando plugin ${pluginData.name} para Pinata...`, "info");

                    const uploadResult = await uploadToPinata(file);

                    const docData = {
                        id: pluginData.id,
                        name: pluginData.name,
                        description: pluginData.description || "",
                        version: pluginData.version,
                        author: pluginData.author || "Admin",
                        icon: pluginData.icon || "https://via.placeholder.com/150",
                        ipfsHash: uploadResult.ipfsHash,
                        pinataKey: uploadResult.pinataKey,
                        size: file.size,
                        createdAt: existingDocId ? existingSnap.docs[0].data().createdAt : new Date(),
                        updatedAt: new Date(), // Always update this timestamp
                        html: pluginData.html || ""
                    };

                    if (existingDocId) {
                        // REPLACE existing document
                        await updateDoc(doc(db, "axon_store_plugins", existingDocId), docData);
                        // Optionally unpin old IPFS hash
                        if (oldIpfsHash && oldIpfsHash !== uploadResult.ipfsHash) {
                            try {
                                await unpinFromPinata(oldIpfsHash);
                            } catch (unpinErr) {
                                console.warn("Failed to unpin old hash:", unpinErr);
                            }
                        }
                        appendOutput(`Plugin ${pluginData.name} atualizado na Store!`, "success");
                        alert("Plugin atualizado com sucesso!");
                    } else {
                        // ADD new document
                        await addDoc(collection(db, "axon_store_plugins"), docData);
                        appendOutput(`Plugin ${pluginData.name} publicado na Store!`, "success");
                        alert("Plugin publicado com sucesso!");
                    }

                    input.value = ''; // Reset input
                } catch (err) {
                    console.error(err);
                    alert("Erro ao processar plugin: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        };

        window.deleteStorePlugin = async (docId) => {
            if (!confirm("Tem certeza que deseja apagar este plugin da Loja?")) return;
            try {
                await deleteDoc(doc(db, "axon_store_plugins", docId));
                alert("Plugin removido.");
            } catch (e) {
                alert("Erro: " + e.message);
            }
        };

        let unsubscribeAdminPlugins = null;
        window.downloadStorePlugin = async (ipfsHash, name) => {
            if (!ipfsHash) { alert("Hash IPFS nÃ£o encontrado."); return; }
            try {
                const url = `https://gateway.pinata.cloud/ipfs/${ipfsHash}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error("Falha no download");
                const blob = await res.blob();
                const dUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = dUrl;
                a.download = (name || 'plugin') + ".json";
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(dUrl);
            } catch (e) {
                alert("Erro ao baixar: " + e.message);
            }
        };

        const initAdminPluginsListener = () => {
            if (unsubscribeAdminPlugins) return; // Already listening
            const listContainer = document.getElementById('admin-plugins-list');
            if (!listContainer) return;

            unsubscribeAdminPlugins = onSnapshot(collection(db, "axon_store_plugins"), (snapshot) => {
                if (snapshot.empty) {
                    listContainer.innerHTML = '<div style="padding:10px;text-align:center;opacity:0.5;">Nenhum plugin na loja.</div>';
                    return;
                }

                listContainer.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const p = docSnap.data();
                    const el = document.createElement('div'); // Using default div, style with css class
                    el.className = 'pinata-file-row';
                    el.innerHTML = `
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${p.icon}" style="width:24px;height:24px;border-radius:4px;object-fit:cover;">
                            <div>
                                <div style="font-weight:bold;font-size:13px;">${p.name} <span style="font-weight:normal;opacity:0.7;font-size:11px;">v${p.version}</span></div>
                                <div style="font-size:10px;opacity:0.6;">ID: ${p.id}</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:5px;">
                             <button class="patient-action-button" style="padding:4px 8px; width:auto; background: var(--button-bg);" onclick="window.downloadStorePlugin('${p.ipfsHash}', '${p.name}')" title="Baixar JSON">
                                <i class="fas fa-download"></i>
                             </button>
                             <button class="patient-action-button delete" style="padding:4px 8px; width:auto;" onclick="window.deleteStorePlugin('${docSnap.id}')" title="Remover da Loja">
                                <i class="fas fa-trash"></i>
                             </button>
                        </div>
                    `;
                    listContainer.appendChild(el);
                });
            });
        };

        // Hook into Admin Tab Switching
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('admin-tab-btn')) {
                const tab = e.target.dataset.tab;
                if (tab === 'bridge') {
                    setTimeout(initAdminPluginsListener, 100);
                } else {
                    if (unsubscribeAdminPlugins) {
                        unsubscribeAdminPlugins();
                        unsubscribeAdminPlugins = null;
                    }
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof initApp === 'function') {
                // Wait a bit for auth
                setTimeout(() => window.axonPluginManager.init(), 2000);
            }
        });


        // --- Free Mode (Board) Implementation ---
        const btnFreeMode = document.getElementById('btn-free-mode');
        const freeModeBoard = document.getElementById('free-mode-board');


        const textareaFreeMode = document.getElementById('free-mode-textarea');
        const btnProcessFreeMode = document.getElementById('btn-process-free-mode');
        const inputLine = document.querySelector('.input-line');
        let isFreeMode = false;

        if (btnFreeMode && freeModeBoard && interactiveOutput && textareaFreeMode) {
            const updateFreeModeUI = (active) => {
                isFreeMode = active;
                if (isFreeMode) {
                    interactiveOutput.style.display = 'none';
                    if (inputLine) inputLine.style.display = 'none';

                    freeModeBoard.style.display = 'flex';
                    freeModeBoard.style.flex = '1';
                    // Ensure proper cleanup of previous styles if any
                    interactiveOutput.style.visibility = '';
                    interactiveOutput.style.position = '';

                    textareaFreeMode.focus();
                    btnFreeMode.style.color = 'var(--highlight-color)';
                    btnFreeMode.innerHTML = '<i class="fas fa-terminal"></i>';
                    btnFreeMode.title = "Voltar ao Terminal";
                } else {
                    interactiveOutput.style.display = 'block';
                    if (inputLine) inputLine.style.display = 'flex';

                    freeModeBoard.style.display = 'none';

                    btnFreeMode.style.color = '';
                    btnFreeMode.innerHTML = '<i class="fas fa-edit"></i>';
                    btnFreeMode.title = "Modo Livre";
                }
            };

            btnFreeMode.addEventListener('click', () => updateFreeModeUI(!isFreeMode));

            // Auto-close listeners
            ['btn-hd', 'btn-cd', 'btn-mic'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.addEventListener('click', () => {
                    if (isFreeMode) updateFreeModeUI(false);
                });
            });

            // Persistence
            let saveTimeout;
            const saveFreeModeText = (text) => {
                localStorage.setItem('axon_free_mode_text', text);
                if (saveTimeout) clearTimeout(saveTimeout);
                saveTimeout = setTimeout(async () => {
                    if (currentUser && typeof setDoc !== 'undefined' && typeof doc !== 'undefined' && typeof db !== 'undefined') {
                        try {
                            await setDoc(doc(db, "users", currentUser.uid), {
                                freeModeText: text,
                                lastUpdate: new Date().toISOString()
                            }, { merge: true });
                        } catch (e) {
                            console.error("Erro saving Free Mode:", e);
                        }
                    }
                }, 2000); // 2s Debounce
            };

            textareaFreeMode.addEventListener('input', (e) => {
                saveFreeModeText(e.target.value);
            });

            // AI Processing
            btnProcessFreeMode.addEventListener('click', async () => {
                const text = textareaFreeMode.value.trim();
                if (!text) {
                    // Visual shake or feedback needed? alert is annoying.
                    const originalText = btnProcessFreeMode.innerHTML;
                    btnProcessFreeMode.innerHTML = '<i class="fas fa-exclamation-circle"></i> Vazio!';
                    setTimeout(() => btnProcessFreeMode.innerHTML = originalText, 1500);
                    return;
                }

                // Visual feedback
                const originalText = btnProcessFreeMode.innerHTML;
                const originalBg = btnProcessFreeMode.style.background;
                btnProcessFreeMode.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
                btnProcessFreeMode.disabled = true;
                btnProcessFreeMode.style.cursor = 'wait';

                try {
                    // Call existing AI function
                    await processAnamnesisInfo(`
                    [MODO LIVRE - INPUT DO MÃ‰DICO]
                    O mÃ©dico digitou as seguintes informaÃ§Ãµes livremente no quadro:
                    "${text}"
                    
                    Por favor, extraia e atualize a anamnese.
                    `);

                    // Success Feedback
                    btnProcessFreeMode.innerHTML = '<i class="fas fa-check"></i> Enviado!';
                    btnProcessFreeMode.style.background = 'var(--success-color)';
                    setTimeout(() => {
                        btnProcessFreeMode.innerHTML = originalText;
                        btnProcessFreeMode.disabled = false;
                        btnProcessFreeMode.style.background = originalBg;
                        btnProcessFreeMode.style.cursor = 'pointer';
                    }, 2000);

                } catch (e) {
                    // Error Feedback
                    btnProcessFreeMode.innerHTML = '<i class="fas fa-times"></i> Erro';
                    btnProcessFreeMode.style.background = 'var(--error-color)';
                    console.error(e);
                    setTimeout(() => {
                        btnProcessFreeMode.innerHTML = originalText;
                        btnProcessFreeMode.disabled = false;
                        btnProcessFreeMode.style.background = originalBg;
                        btnProcessFreeMode.style.cursor = 'pointer';
                    }, 2000);
                }
            });

            // Load Data
            window.loadFreeModeData = async () => {
                const local = localStorage.getItem('axon_free_mode_text');
                if (local) textareaFreeMode.value = local;

                if (currentUser && typeof getDoc !== 'undefined' && typeof doc !== 'undefined' && typeof db !== 'undefined') {
                    try {
                        const snap = await getDoc(doc(db, "users", currentUser.uid));
                        if (snap.exists()) {
                            const data = snap.data();
                            // Load if server has data. Assuming server sync is key.
                            // If local is empty, use server.
                            // If both, prioritizing server for cross-device persistence as requested.
                            if (data.freeModeText) {
                                textareaFreeMode.value = data.freeModeText;
                                localStorage.setItem('axon_free_mode_text', data.freeModeText);
                            }
                        }
                    } catch (e) { console.error(e); }
                }
            };

            // Clear Data
            window.clearFreeModeData = async () => {
                textareaFreeMode.value = '';
                localStorage.removeItem('axon_free_mode_text');
                if (currentUser && typeof updateDoc !== 'undefined' && typeof deleteField !== 'undefined' && typeof doc !== 'undefined' && typeof db !== 'undefined') {
                    try {
                        await updateDoc(doc(db, "users", currentUser.uid), { freeModeText: deleteField() });
                    } catch (e) { console.error(e); }
                }
            };
        }

        document.addEventListener('DOMContentLoaded', initApp);</script>
    <!-- PRESCRIPTION ASSISTANT MODAL -->
    <div id="prescription-modal" class="app-modal">
        <div class="app-modal-content" style="max-width: 800px; width: 90%;">
            <span class="app-modal-close"
                onclick="document.getElementById('prescription-modal').style.display='none'">&times;</span>
            <div class="app-modal-header">
                <h2 class="app-modal-title"><i class="fas fa-file-prescription"></i> Assistente de PrescriÃ§Ã£o <span
                        class="badge-beta"
                        style="font-size: 10px; background: var(--highlight-color); color: #fff; font-weight: 800; padding: 2px 5px; border-radius: 4px; vertical-align: middle; margin-left: 5px;">BETA</span>
                </h2>
            </div>
            <div class="app-modal-body">
                <div class="prescription-row">
                    <div style="flex: 2.5;">
                        <div class="prescription-form-group">
                            <label>DoenÃ§a ou MedicaÃ§Ã£o</label>
                            <input type="text" id="presc-input" class="app-modal-input compact-input"
                                placeholder="Ex: Cefaleia">
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <div class="prescription-form-group">
                            <label>Idade</label>
                            <input type="text" id="presc-age" class="app-modal-input compact-input" placeholder="Anos">
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <div class="prescription-form-group">
                            <label>Peso</label>
                            <input type="text" id="presc-weight" class="app-modal-input compact-input" placeholder="Kg">
                        </div>
                    </div>
                </div>

                <div class="prescription-options"
                    style="padding: 5px; margin-bottom: 10px; display: flex; gap: 15px; align-items: center;">
                    <label class="radio-label" style="font-size: 13px;">
                        <input type="radio" name="presc-source" value="sus" checked> Apenas SUS
                    </label>
                    <label class="radio-label" style="font-size: 13px;">
                        <input type="radio" name="presc-source" value="all"> Todas (GenÃ©ricos/Ref)
                    </label>
                </div>

                <button id="btn-generate-prescription" class="app-modal-button"
                    style="width: 100%; margin-bottom: 10px; padding: 10px;">
                    <i class="fas fa-magic"></i> Gerar PrescriÃ§Ã£o
                </button>

                <div id="presc-result-area" style="display: none;">
                    <div class="prescription-form-group">
                        <label>SugestÃµes de Receita</label>
                        <div id="presc-list-container" class="prescription-result-container">
                            <!-- List will be injected here -->
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- INFO MODAL -->
    <div id="med-info-modal" class="app-modal" style="z-index: 9500;">
        <div class="app-modal-content" style="max-width: 600px;">
            <span class="app-modal-close"
                onclick="document.getElementById('med-info-modal').style.display='none'">&times;</span>
            <div class="app-modal-header">
                <h2 class="app-modal-title">Detalhes e Alertas</h2>
            </div>
            <div class="app-modal-body" id="med-info-body" style="text-align: left; line-height: 1.6;"></div>
        </div>
    </div>

    <!-- AXON PLUGIN MANAGER MODAL -->
    <div id="plugin-manager-modal" class="app-modal" style="z-index: 9999;">
        <div class="app-modal-content"
            style="max-width: 900px; width: 95%; height: 80vh; display: flex; flex-direction: column; padding: 0;">
            <div
                style="padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--glass-bg);">
                <div
                    style="font-size: 18px; font-weight: bold; color: var(--header-text-color); display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-cubes"></i> Gerenciador de Plugins Axon
                </div>
                <span class="app-modal-close" style="position: static;"
                    onclick="document.getElementById('plugin-manager-modal').style.display='none'">&times;</span>
            </div>

            <div style="display: flex; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.02);">
                <div id="tab-installed-plugins" class="plugin-tab active"
                    onclick="window.axonPluginManager.switchTab('installed')"
                    style="padding: 12px 20px; cursor: pointer; font-weight: 600; border-bottom: 2px solid transparent; transition: all 0.2s;">
                    <i class="fas fa-check-circle"></i> Instalados
                </div>
                <div id="tab-axon-store" class="plugin-tab" onclick="window.axonPluginManager.switchTab('store')"
                    style="padding: 12px 20px; cursor: pointer; font-weight: 600; border-bottom: 2px solid transparent; transition: all 0.2s;">
                    <i class="fas fa-shopping-bag"></i> Axon Store
                </div>
            </div>

            <div style="flex: 1; overflow-y: auto; padding: 20px; position: relative;">

                <!-- view: Installed -->
                <div id="view-installed-plugins">
                    <div id="installed-plugins-toolbar" class="installed-toolbar"
                        style="margin-bottom:15px; display:flex; justify-content:flex-end;">
                        <!-- Injected via JS or static -->
                    </div>
                    <div id="installed-plugins-list" class="plugin-grid"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                        <!-- Cards go here -->
                    </div>
                    <div id="no-plugins-msg"
                        style="display:none; text-align:center; padding: 40px; color: var(--text-color); opacity: 0.6;">
                        <i class="fas fa-box-open" style="font-size: 40px; margin-bottom: 10px;"></i><br>
                        Nenhum plugin instalado.
                    </div>
                </div>

                <!-- view: Store -->
                <div id="view-axon-store" style="display: none;">
                    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                        <div style="flex: 1; position: relative;">
                            <i class="fas fa-search"
                                style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-color); opacity: 0.5;"></i>
                            <input type="text" id="store-search" placeholder="Buscar plugins..."
                                style="width: 100%; padding: 10px 10px 10px 35px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color);"
                                onkeyup="window.axonPluginManager.renderStore()">
                        </div>
                    </div>
                    <div id="store-plugins-list">
                        <!-- Store Cards go here -->
                    </div>
                </div>

            </div>
        </div>
    </div>
    <script>
        // Real-time listener for Global Settings (Tools Button Visibility)
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure db is initialized (it is in main script, but this runs after)
            // We need to wait for Firebase/DB to be ready if it's async? 
            // Usually it's synchronous ref creation.
            // We'll wrap in a check or timeout, or just run it since this is at the end of body.

            if (typeof onSnapshot !== 'undefined' && typeof doc !== 'undefined' && typeof db !== 'undefined') {
                onSnapshot(doc(db, "settings", "global"), (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();

                        // Sync globalSettings object
                        // Sync globalSettings object
                        if (typeof globalSettings === 'undefined') {
                            window.globalSettings = {};
                        }

                        const settingsTarget = typeof globalSettings !== 'undefined' ? globalSettings : window.globalSettings;

                        if (settingsTarget) {
                            settingsTarget.showToolsButton = data.showToolsButton;
                            settingsTarget.mobile2_0_enabled = data.mobile2_0_enabled;
                            settingsTarget.showPrescriptionAssistant = data.showPrescriptionAssistant;

                            // Sync Axon Eye Storage & Supabase Settings
                            if (data.axonEyeStorageProvider) settingsTarget.axonEyeStorageProvider = data.axonEyeStorageProvider;
                            if (data.supabaseEnabled !== undefined) settingsTarget.supabaseEnabled = data.supabaseEnabled;
                            if (data.supabaseUrl) settingsTarget.supabaseUrl = data.supabaseUrl;
                            if (data.supabaseKey) settingsTarget.supabaseKey = data.supabaseKey;
                            if (data.supabaseBucket) settingsTarget.supabaseBucket = data.supabaseBucket;

                            // FORCE MOBILE UPDATE NOW THAT WE HAVE DATA
                            if (window.updateMobile2Layout) {
                                window.updateMobile2Layout();
                            }
                        }

                        // Update Tools Button UI
                        const btnTools = document.getElementById('btn-tools');
                        if (btnTools) {
                            const show = data.showToolsButton !== false; // Default true
                            btnTools.style.display = show ? 'flex' : 'none';
                        }

                        // Update Admin Toggle UI if present (Real-time sync for other admins)
                        const toggleTools = document.getElementById('toggle-tools-btn-visibility');
                        if (toggleTools) {
                            toggleTools.checked = data.showToolsButton !== false;
                        }
                    }
                }, (error) => {
                    console.warn("Error listening to global settings:", error);
                });
            }
        });

        // Logout Cleanup Logic (Injected Fix)
        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.getElementById('logout-button');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    // Clear login fields logic
                    const userField = document.getElementById('login-modal-user');
                    const passField = document.getElementById('login-modal-pass');

                    if (userField) userField.value = '';
                    if (passField) passField.value = '';
                });
            }
        });
    </script>
    <script>
        // Gallium Ripple Effect
        document.addEventListener('click', function (e) {
            // Check if clicking on interactive elements like buttons
            const target = e.target;
            // Apply to buttons or elements with .gallium-btn class
            const button = target.closest('button') || target.closest('.gallium-btn');

            if (button) {
                // Ensure the element can contain the absolute ripple
                const style = window.getComputedStyle(button);
                if (style.position === 'static') {
                    button.style.position = 'relative';
                }
                if (style.overflow !== 'hidden') {
                    button.style.overflow = 'hidden';
                }

                const rect = button.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const ripple = document.createElement('div');
                ripple.classList.add('ripple');
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';

                button.appendChild(ripple);

                setTimeout(() => {
                    ripple.remove();
                }, 600);
            }
        });

        // Gallium Mouse Tracking
        document.addEventListener('mousemove', function (e) {
            const canvas = document.querySelectorAll('.gallium-canvas');
            canvas.forEach(c => {
                const moveX = (e.clientX - window.innerWidth / 2) * 0.05;
                const moveY = (e.clientY - window.innerHeight / 2) * 0.05;
                c.style.transform = `translate(${moveX}px, ${moveY}px)`;
            });
        });
        // --- AXON LAYOUT: MONITOR TABS LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const tabs = [
                { btn: 'toggle-anamnesis', view: 'anamnesis-preview' },
                { btn: 'toggle-exams', view: 'exams-results-preview' },
                { btn: 'toggle-axon-eye', view: 'axon-eye-results-preview' }
            ];

            tabs.forEach(t => {
                const btnEl = document.getElementById(t.btn);
                if (btnEl) {
                    btnEl.addEventListener('click', () => {
                        // 1. Deactivate all tabs
                        tabs.forEach(x => {
                            const b = document.getElementById(x.btn);
                            const v = document.getElementById(x.view);
                            if (b) b.classList.remove('active');
                            if (v) v.style.display = 'none';
                        });

                        // 2. Activate clicked
                        const viewEl = document.getElementById(t.view); // Define viewEl properly
                        if (btnEl) btnEl.classList.add('active');
                        if (viewEl) viewEl.style.display = 'block';
                    });
                }
            });
        });



        // --- GLOBAL FIXES & REFINEMENTS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure Settings Listener is Active
            if (typeof setupGlobalSettingsListener === 'function') setupGlobalSettingsListener();
            else if (window.setupGlobalSettingsListener) window.setupGlobalSettingsListener();

            // 1. Tools / Plugin Manager Fix
            const btnTools = document.getElementById('btn-tools');
            const toolsModal = document.getElementById('plugin-manager-modal');
            if (btnTools && toolsModal) {
                btnTools.addEventListener('click', () => {
                    toolsModal.style.display = 'flex';
                    // Initialize or refresh if needed
                    if (window.axonPluginManager && window.axonPluginManager.renderInstalled) {
                        window.axonPluginManager.renderInstalled();
                    }
                });
            }

            // 2. Global Modal Close Functionality
            document.body.addEventListener('click', (e) => {
                if (e.target.matches('.app-modal-close') || e.target.closest('.app-modal-close')) {
                    const closeBtn = e.target.matches('.app-modal-close') ? e.target : e.target.closest('.app-modal-close');
                    const modal = closeBtn.closest('.app-modal') || closeBtn.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }
            });

            // 3. Free Mode Textarea Input Fix
            const fmText = document.getElementById('free-mode-textarea');
            if (fmText) {
                // Ensure events don't bubble up to global listeners that might block input
                fmText.addEventListener('keydown', (e) => e.stopPropagation());
                fmText.addEventListener('keypress', (e) => e.stopPropagation());
                // Force focusability
                fmText.removeAttribute('readonly');
            }
        });
        // --- ADMIN ALERT SYSTEM (Modular SDK) ---

        window.updateAlertPreview = function () {
            const title = document.getElementById('alert-title').value || "TÃ­tulo do Alerta";
            const content = document.getElementById('alert-content').value || "O conteÃºdo da mensagem aparecerÃ¡ aqui...";
            const mediaType = document.getElementById('alert-media-type').value;
            const mediaUrl = document.getElementById('alert-media-url').value;

            document.getElementById('preview-title').textContent = title;
            document.getElementById('preview-message').innerText = content;

            const mediaContainer = document.getElementById('preview-media');
            mediaContainer.innerHTML = '';
            mediaContainer.style.display = 'none';

            if (mediaType !== 'none' && mediaUrl) {
                mediaContainer.style.display = 'flex';
                if (mediaType === 'image') {
                    mediaContainer.innerHTML = `<img src="${mediaUrl}" alt="Preview">`;
                } else if (mediaType === 'video') {
                    mediaContainer.innerHTML = `<video src="${mediaUrl}" controls autoplay loop muted></video>`;
                } else if (mediaType === 'iframe') {
                    mediaContainer.innerHTML = `<iframe src="${mediaUrl}"></iframe>`;
                }
            }
        };

        window.toggleMediaType = function () {
            const type = document.getElementById('alert-media-type').value;
            const container = document.getElementById('media-input-container');
            const urlInput = document.getElementById('alert-media-url');
            const htmlInput = document.getElementById('alert-html-content');

            if (type === 'none') {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
                if (type === 'iframe') {
                    urlInput.style.display = 'none';
                    htmlInput.style.display = 'block';
                } else {
                    urlInput.style.display = 'block';
                    htmlInput.style.display = 'none';
                }
            }
            window.updateAlertPreview();
        };

        window.updateAlertPreview = function () {
            const title = document.getElementById('alert-title').value || "TÃ­tulo do Alerta";
            const content = document.getElementById('alert-content').value || "O conteÃºdo da mensagem aparecerÃ¡ aqui...";
            const mediaType = document.getElementById('alert-media-type').value;
            const mediaUrl = document.getElementById('alert-media-url').value;
            const mediaHtml = document.getElementById('alert-html-content').value;

            // Dimensions
            const width = document.getElementById('alert-width').value;
            const height = document.getElementById('alert-height').value;

            const previewStage = document.querySelector('.alert-preview-stage');
            if (previewStage) {
                if (width) {
                    previewStage.style.width = width + 'px';
                    previewStage.style.maxWidth = width + 'px';
                } else {
                    previewStage.style.width = '100%';
                    previewStage.style.maxWidth = '100%';
                }
                previewStage.style.height = height ? height + 'px' : 'auto';
            }

            document.getElementById('preview-title').textContent = title;
            document.getElementById('preview-message').innerText = content;

            const mediaContainer = document.getElementById('preview-media');
            mediaContainer.innerHTML = '';
            mediaContainer.style.display = 'none';

            if (mediaType !== 'none') {
                if (mediaType === 'iframe' && mediaHtml) {
                    mediaContainer.style.display = 'flex';
                    // Fix: Use iframe for isolation
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.border = 'none';
                    iframe.style.background = 'white';
                    iframe.srcdoc = mediaHtml;
                    mediaContainer.appendChild(iframe);
                } else if (mediaUrl) {
                    mediaContainer.style.display = 'flex';
                    if (mediaType === 'image') {
                        mediaContainer.innerHTML = `<img src="${mediaUrl}" alt="Preview">`;
                    } else if (mediaType === 'video') {
                        mediaContainer.innerHTML = `<video src="${mediaUrl}" controls autoplay loop muted></video>`;
                    }
                }
            }
        };

        window.currentEditingAlertId = null;

        window.publishAlert = async function () {
            const title = document.getElementById('alert-title').value;
            const content = document.getElementById('alert-content').value;

            if (!title || !content) {
                alert("Preencha TÃ­tulo e ConteÃºdo.");
                return;
            }

            const alertData = {
                title,
                content,
                mediaType: document.getElementById('alert-media-type').value,
                mediaUrl: document.getElementById('alert-media-url').value,
                mediaHtml: document.getElementById('alert-html-content').value,
                audience: document.getElementById('alert-audience').value,
                frequency: document.getElementById('alert-frequency').value,
                lockTime: parseInt(document.getElementById('alert-lock-time').value) || 0,
                width: parseInt(document.getElementById('alert-width').value) || 0,
                height: parseInt(document.getElementById('alert-height').value) || 0,
                closeBtnSize: parseInt(document.getElementById('alert-close-size').value) || 0,
                closeBtnColor: document.getElementById('alert-close-color').value || '',
                mediaHeight: parseInt(document.getElementById('alert-media-height').value) || 0,
                // Do not overwrite createdAt on edit
                active: true,
                createdBy: typeof currentUser !== 'undefined' ? currentUser : "unknown"
            };

            // If Creating New
            if (!window.currentEditingAlertId) {
                alertData.createdAt = new Date();
                alertData.priority = Date.now(); // Lower = higher priority. New alerts get lowest priority.
            }

            try {
                if (window.currentEditingAlertId) {
                    await updateDoc(doc(db, 'alerts', window.currentEditingAlertId), alertData);
                    alert("Alerta atualizado!");
                } else {
                    await addDoc(collection(db, 'alerts'), alertData);
                    alert("Alerta publicado!");
                }
                window.clearAlertForm();
            } catch (e) {
                console.error("Publish Error:", e);
                alert("Erro ao salvar: " + e.message);
            }
        };

        window.editAlert = async function (id) {
            try {
                const docSnap = await getDoc(doc(db, 'alerts', id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.currentEditingAlertId = id;

                    document.getElementById('alert-title').value = data.title || '';
                    document.getElementById('alert-content').value = data.content || '';
                    document.getElementById('alert-media-type').value = data.mediaType || 'none';
                    document.getElementById('alert-media-url').value = data.mediaUrl || '';
                    document.getElementById('alert-html-content').value = data.mediaHtml || '';
                    document.getElementById('alert-audience').value = data.audience || 'all';
                    document.getElementById('alert-frequency').value = data.frequency || 'once';
                    document.getElementById('alert-lock-time').value = data.lockTime || 0;
                    document.getElementById('alert-width').value = data.width || '';
                    document.getElementById('alert-height').value = data.height || '';
                    document.getElementById('alert-close-size').value = data.closeBtnSize || '24';
                    document.getElementById('alert-close-color').value = data.closeBtnColor || '#000000';
                    document.getElementById('alert-media-height').value = data.mediaHeight || '';

                    window.toggleMediaType();
                    window.updateAlertPreview();

                    // Update Button Text
                    const btn = document.getElementById('btn-publish-alert');
                    if (btn) btn.innerHTML = '<i class="fas fa-save"></i> Salvar AlteraÃ§Ãµes';

                    // Scroll to top
                    document.querySelector('.admin-panel-content')?.scrollTo(0, 0); // Attempt to scroll modal
                }
            } catch (e) {
                console.error("Edit Error", e);
            }
        };

        window.previewPausedAlert = async function (id) {
            try {
                const docSnap = await getDoc(doc(db, 'alerts', id));
                if (docSnap.exists()) {
                    showAlert(id, docSnap.data(), 'test_preview_mode');
                }
            } catch (e) { console.error(e); }
        };

        window.clearAlertForm = function () {
            window.currentEditingAlertId = null;
            document.getElementById('alert-title').value = '';
            document.getElementById('alert-content').value = '';
            document.getElementById('alert-media-type').value = 'none';
            document.getElementById('alert-media-url').value = '';
            document.getElementById('alert-html-content').value = '';
            document.getElementById('alert-lock-time').value = '0';
            document.getElementById('alert-width').value = '';
            document.getElementById('alert-height').value = '';

            const btn = document.getElementById('btn-publish-alert');
            if (btn) btn.innerHTML = '<i class="fas fa-paper-plane"></i> Publicar Alerta';

            window.toggleMediaType();
            window.updateAlertPreview();
        };

        // Drag-and-Drop for Alert Priority Reordering
        let draggedAlertItem = null;

        function initAlertDragAndDrop(container) {
            if (!container) return;

            const items = container.querySelectorAll('.alert-list-item[draggable="true"]');
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedAlertItem = item;
                    item.style.opacity = '0.5';
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.style.opacity = '1';
                    draggedAlertItem = null;
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                item.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    if (!draggedAlertItem || draggedAlertItem === item) return;

                    // Reorder in DOM
                    const allItems = [...container.querySelectorAll('.alert-list-item[draggable="true"]')];
                    const draggedIndex = allItems.indexOf(draggedAlertItem);
                    const targetIndex = allItems.indexOf(item);

                    if (draggedIndex < targetIndex) {
                        item.parentNode.insertBefore(draggedAlertItem, item.nextSibling);
                    } else {
                        item.parentNode.insertBefore(draggedAlertItem, item);
                    }

                    // Update priorities in Firebase based on new DOM order
                    const reorderedItems = [...container.querySelectorAll('.alert-list-item[draggable="true"]')];
                    const updates = reorderedItems.map((el, index) => {
                        const alertId = el.dataset.id;
                        return updateDoc(doc(db, 'alerts', alertId), { priority: index });
                    });

                    try {
                        await Promise.all(updates);
                        console.log('[AlertSystem] Priority order updated.');
                    } catch (err) {
                        console.error('[AlertSystem] Failed to update priority:', err);
                    }
                });
            });
        }

        window.deleteAlert = async function (id) {
            if (confirm("Excluir alerta?")) {
                await deleteDoc(doc(db, 'alerts', id));
            }
        };

        window.toggleAlertStatus = async function (id, currentStatus) {
            await updateDoc(doc(db, 'alerts', id), { active: !currentStatus });
        };

        let activeAlertListenerUnsub = null;
        function initAlertSystem() {
            if (activeAlertListenerUnsub) return;
            const q = query(collection(db, 'alerts'), orderBy('priority', 'asc'));

            activeAlertListenerUnsub = onSnapshot(q, (snapshot) => {
                const adminList = document.getElementById('active-alerts-list');
                const pausedList = document.getElementById('paused-alerts-list');

                if (adminList && pausedList) {
                    adminList.innerHTML = '';
                    pausedList.innerHTML = '';

                    if (snapshot.empty) {
                        adminList.innerHTML = '<div style="padding:15px;opacity:0.5;">Nenhum alerta.</div>';
                    } else {
                        snapshot.forEach(d => {
                            const a = d.data();
                            const itemHtml = `
                                <div class="alert-list-item" draggable="${a.active ? 'true' : 'false'}" data-id="${d.id}" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; ${a.active ? 'cursor:grab;' : ''}">
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        ${a.active ? '<i class="fas fa-grip-vertical" style="opacity:0.4; cursor:grab;"></i>' : ''}
                                        <div>
                                            <div style="font-weight:bold;font-size:13px;">${a.title}</div>
                                            <div style="font-size:11px;opacity:0.6;">${a.audience} â€¢ ${a.frequency}</div>
                                        </div>
                                    </div>
                                    <div style="display:flex; gap:10px;">
                                        ${!a.active ? `<button onclick="window.previewPausedAlert('${d.id}')" style="cursor:pointer;border:none;background:none;color:var(--text-color); opacity:0.8;" title="Ver"><i class="fas fa-eye"></i></button>` : ''}
                                        ${!a.active ? `<button onclick="window.editAlert('${d.id}')" style="cursor:pointer;border:none;background:none;color:var(--text-color); opacity:0.8;" title="Editar"><i class="fas fa-pen"></i></button>` : ''}
                                        
                                        <button onclick="window.toggleAlertStatus('${d.id}', ${a.active})" style="cursor:pointer;border:none;background:none;color:var(--text-color); opacity:0.8;" title="${a.active ? 'Pausar' : 'Retomar'}">
                                            <i class="fas fa-${a.active ? 'pause' : 'play'}"></i>
                                        </button>
                                        <button onclick="window.deleteAlert('${d.id}')" style="cursor:pointer;border:none;background:none;color:var(--error-color);" title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>`;

                            if (a.active) adminList.innerHTML += itemHtml;
                            else pausedList.innerHTML += itemHtml;
                        });
                    }

                    if (adminList.innerHTML === '') adminList.innerHTML = '<div style="padding:15px;opacity:0.5;text-align:center">Nenhum alerta ativo.</div>';
                    if (pausedList.innerHTML === '') pausedList.innerHTML = '<div style="padding:15px;opacity:0.5;text-align:center">Nenhum alerta pausado.</div>';

                    // Initialize Drag-and-Drop for Active Alerts
                    initAlertDragAndDrop(adminList);
                }

                snapshot.forEach(d => {
                    const data = d.data();
                    if (data.active) processAlertForUser(d.id, data);
                });

                // After processing all alerts, sort and show first
                setTimeout(() => {
                    window.alertQueue.sort((a, b) => (a.data.priority || Infinity) - (b.data.priority || Infinity));
                    console.log('[AlertSystem] Queue ready:', window.alertQueue.map(a => a.data.title));
                    window.alertQueueReady = true;
                    window.showNextAlert();
                }, 500); // Small delay to allow all async processAlertForUser calls to complete
            });
        }

        // In-memory Set to track alerts shown in this page load (prevents 'always' re-triggers on snapshot updates)
        const shownAlertsThisPageLoad = new Set();
        let cachedUserAlertData = null;

        // Alert Queue System
        window.alertQueue = [];
        window.alertQueueReady = false;

        async function processAlertForUser(id, alertData) {
            console.log('[AlertSystem] Processing alert:', id, alertData.title, 'Audience:', alertData.audience);

            // --- LOGIN GATE (DOM-based) ---
            if (!isUserLoggedIn()) {
                console.log('[AlertSystem] Blocked: User not logged in');
                return;
            }

            // --- FETCH USER DATA ---
            let userLevel = 'personal';
            let userIsAdmin = false;

            try {
                const storedUser = localStorage.getItem('axon_logged_in_user');
                if (storedUser) {
                    if (cachedUserAlertData && cachedUserAlertData.username === storedUser) {
                        userLevel = cachedUserAlertData.accountLevel;
                        userIsAdmin = cachedUserAlertData.isAdmin;
                    } else {
                        // Fetch fresh data
                        // Ensure doc/getDoc availability or use global shim if needed, but assuming global availability based on file structure
                        const userDocRef = doc(db, "users", storedUser);
                        const userSnap = await getDoc(userDocRef);
                        if (userSnap.exists()) {
                            const uData = userSnap.data();
                            userLevel = uData.accountLevel || 'personal';
                            userIsAdmin = uData.isAdmin || false;

                            cachedUserAlertData = {
                                username: storedUser,
                                accountLevel: userLevel,
                                isAdmin: userIsAdmin
                            };
                        }
                    }
                } else {
                    console.log('[AlertSystem] Warning: No user in localStorage, default to personal');
                }
            } catch (err) {
                console.warn('[AlertSystem] Error fetching user data, using defaults:', err);
            }

            console.log('[AlertSystem] User context (Resolved):', { userLevel, userIsAdmin });

            // Apply audience filter (skip for 'all' audience)
            if (alertData.audience === 'enterprise' && userLevel !== 'enterprise') {
                console.log('[AlertSystem] Blocked: Enterprise only');
                return;
            }
            if (alertData.audience === 'personal' && userLevel !== 'personal') {
                console.log('[AlertSystem] Blocked: Personal only');
                return;
            }
            if (alertData.audience === 'all_except_admin' && userIsAdmin) {
                console.log('[AlertSystem] Blocked: Not for admins');
                return;
            }
            if (alertData.audience === 'student' && userLevel !== 'student') {
                console.log('[AlertSystem] Blocked: Student only');
                return;
            }
            // NOTE: 'all' audience passes through without any check

            // --- FREQUENCY CHECK ---
            const storedUser = localStorage.getItem('axon_logged_in_user') || 'anonymous';
            const storageKey = `axon_alert_${storedUser}_${id}_seen`;

            // For 'once': Check LocalStorage
            if (alertData.frequency === 'once' && localStorage.getItem(storageKey)) {
                console.log('[AlertSystem] Blocked: Already seen (once)');
                return;
            }

            // For 'always': Check in-memory Set (prevents re-showing on snapshot update, but allows on page reload)
            if (alertData.frequency === 'always' && shownAlertsThisPageLoad.has(id)) {
                console.log('[AlertSystem] Blocked: Already shown this page load (always)');
                return;
            }

            // --- PREVENT DUPLICATE IN QUEUE ---
            if (window.alertQueue.some(item => item.id === id)) {
                console.log('[AlertSystem] Blocked: Already in queue');
                return;
            }

            console.log('[AlertSystem] Adding to queue:', id);
            window.alertQueue.push({ id, data: alertData, storageKey });
        }

        function showAlert(id, data, storageKey) {
            const overlay = document.getElementById('axon-alert-overlay');
            if (!overlay) return;

            // Apply Custom Dimensions
            const viewStage = overlay.querySelector('.alert-view-stage');
            if (viewStage) {
                if (data.width) {
                    viewStage.style.width = data.width + 'px';
                    viewStage.style.maxWidth = data.width + 'px';
                } else {
                    viewStage.style.width = '90%';
                    viewStage.style.maxWidth = '550px';
                }
                viewStage.style.height = data.height ? data.height + 'px' : 'auto';
            }

            document.getElementById('user-alert-title').textContent = data.title;
            document.getElementById('user-alert-message').innerText = data.content;

            const media = document.getElementById('user-alert-media');
            const closeBtn = document.getElementById('user-alert-close-btn');

            // Apply Visual Styles
            if (data.closeBtnSize) closeBtn.style.fontSize = data.closeBtnSize + 'px';
            if (data.closeBtnColor && data.closeBtnColor !== '#000000') closeBtn.style.backgroundColor = data.closeBtnColor;
            if (data.mediaHeight) media.style.height = data.mediaHeight + 'px';
            else media.style.height = ''; // Auto

            media.innerHTML = '';
            media.style.display = 'none';

            if (data.mediaType !== 'none') {
                media.style.display = 'flex';
                if (data.mediaType === 'iframe' && data.mediaHtml) {
                    // Fix: Use iframe for isolation
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.border = 'none';
                    iframe.style.background = 'white';
                    iframe.srcdoc = data.mediaHtml;
                    media.appendChild(iframe);
                } else if (data.mediaUrl) {
                    if (data.mediaType === 'image') media.innerHTML = `<img src="${data.mediaUrl}" alt="Media">`;
                    else if (data.mediaType === 'video') media.innerHTML = `<video src="${data.mediaUrl}" controls autoplay></video>`;
                    else if (data.mediaType === 'iframe') media.innerHTML = `<iframe src="${data.mediaUrl}"></iframe>`;
                }
            }

            if (data.lockTime > 0) {
                closeBtn.disabled = true;
                closeBtn.style.opacity = '0.5';
                closeBtn.style.cursor = 'not-allowed';
                let timeLeft = data.lockTime;
                closeBtn.textContent = `Aguarde (${timeLeft}s)`;
                const timer = setInterval(() => {
                    timeLeft--;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        closeBtn.disabled = false;
                        closeBtn.style.opacity = '1';
                        closeBtn.style.cursor = 'pointer';
                        closeBtn.textContent = 'Entendido';
                    } else {
                        closeBtn.textContent = `Aguarde (${timeLeft}s)`;
                    }
                }, 1000);
            } else {
                closeBtn.disabled = false;
                closeBtn.style.opacity = '1';
                closeBtn.style.cursor = 'pointer';
                closeBtn.textContent = 'Entendido';
            }

            overlay.style.display = 'flex';
            if (data.frequency === 'once') {
                localStorage.setItem(storageKey, Date.now());
            }
            sessionStorage.setItem(storageKey, true);
        }

        window.closeAxonAlert = function () {
            document.getElementById('axon-alert-overlay').style.display = 'none';
            document.getElementById('user-alert-media').innerHTML = '';
            // Show next alert in queue
            if (typeof window.showNextAlert === 'function') {
                window.showNextAlert();
            }
        };

        window.showNextAlert = function () {
            if (!window.alertQueueReady || window.alertQueue.length === 0) {
                console.log('[AlertSystem] Queue empty or not ready.');
                return;
            }

            const overlay = document.getElementById('axon-alert-overlay');
            if (overlay && overlay.style.display === 'flex') {
                console.log('[AlertSystem] showNextAlert: Overlay still visible, skipping.');
                return;
            }

            const next = window.alertQueue.shift();
            if (!next) return;

            console.log('[AlertSystem] Showing next alert:', next.data.title);

            // Mark as shown for 'always' frequency
            if (next.data.frequency === 'always') {
                shownAlertsThisPageLoad.add(next.id);
            }

            showAlert(next.id, next.data, next.storageKey);
        };

        // Init Alert System - Wait for login (DOM-based detection)
        function isUserLoggedIn() {
            const loginModal = document.getElementById('login-modal');
            // User is logged in if login modal exists and is hidden
            return loginModal && (loginModal.style.display === 'none' || loginModal.classList.contains('hidden'));
        }

        function tryInitAlertSystem() {
            if (typeof db !== 'undefined' && isUserLoggedIn()) {
                console.log('[AlertSystem] User logged in (login modal hidden), initializing...');
                initAlertSystem();
            } else {
                console.log('[AlertSystem] Waiting for login... loginModal visible:', document.getElementById('login-modal')?.style.display);
                setTimeout(tryInitAlertSystem, 2000);
            }
        }
        /* --- VISUAL ALERT EDITOR LOGIC --- */
        window.openVisualEditor = function () {
            const modal = document.getElementById('visual-editor-modal');
            if (!modal) return;
            modal.style.display = 'flex';

            // Sync Main -> Editor
            const w = document.getElementById('alert-width').value;
            const h = document.getElementById('alert-height').value;

            document.getElementById('ve-width').value = w || '550'; // Default width if auto
            document.getElementById('ve-height').value = h || '';
            document.getElementById('ve-close-size').value = document.getElementById('alert-close-size').value || '24';
            document.getElementById('ve-close-color').value = document.getElementById('alert-close-color').value || '#000000';
            document.getElementById('ve-media-height').value = document.getElementById('alert-media-height').value || '';
            document.getElementById('ve-close-size-val').textContent = document.getElementById('ve-close-size').value;

            window.renderVisualAlert();
        };

        window.renderVisualAlert = function () {
            const stage = document.getElementById('ve-alert-stage');
            if (!stage) return;

            // Gather Data
            const title = document.getElementById('alert-title').value || "TÃ­tulo Exemplo";
            const content = document.getElementById('alert-content').value || "ConteÃºdo para visualizaÃ§Ã£o.";
            const mediaType = document.getElementById('alert-media-type').value;
            const mediaUrl = document.getElementById('alert-media-url').value;
            const mediaHtml = document.getElementById('alert-html-content').value;

            // Dimensions
            const w = document.getElementById('ve-width').value || '550';
            const h = document.getElementById('ve-height').value;
            const closeSize = document.getElementById('ve-close-size').value;
            const closeColor = document.getElementById('ve-close-color').value;
            const mediaHeight = document.getElementById('ve-media-height').value;

            // Apply to Stage Container
            stage.style.width = w + 'px';
            stage.style.height = h ? h + 'px' : 'auto';
            stage.style.background = 'rgba(255, 255, 255, 0.85)';
            stage.style.backdropFilter = 'blur(32px) saturate(180%)';
            stage.style.webkitBackdropFilter = 'blur(32px) saturate(180%)';
            stage.style.borderRadius = '24px';
            stage.style.padding = '0 30px 20px'; // Matched padding logic (header has padding, content has padding)
            // Wait, real alert splits padding. Header is separate. 
            // Real Alert: .alert-view-stage { padding: 0 (overflow hidden) } .alert-content { padding: 0 30px 20px }
            // For Editor, we used simple padding causing content shift?
            // Let's use simple padding for now but closer to source.
            stage.style.padding = '0'; // Reset styling to match real container
            stage.style.display = 'flex';
            stage.style.flexDirection = 'column';
            stage.style.position = 'relative';
            stage.style.color = '#1a1a1a';
            stage.style.boxShadow = '0 20px 60px rgba(0,0,0,0.2)';
            stage.style.fontFamily = "'Plus Jakarta Sans', sans-serif";
            stage.style.overflow = 'hidden';

            // Build Inner HTML (Simulating Alert Structure)
            let mediaBlock = '';
            if (mediaType !== 'none') {
                let innerMedia = '';
                if (mediaType === 'iframe' && mediaHtml) {
                    innerMedia = `<div style="width:100%; height:100%; background: #eee; display:flex; align-items:center; justify-content:center; border:1px dashed #ccc; padding:10px; color:#666; font-size:12px;">iFrame / HTML Preview<br>(Simplified for Editor)</div>`;
                } else if (mediaUrl) {
                    if (mediaType === 'image') innerMedia = `<img src="${mediaUrl}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
                    else innerMedia = `<div style="width:100%; height:100%; background:#eee; display:flex; align-items:center; justify-content:center; color:#666;">Video Preview</div>`;
                }

                const mhStyle = mediaHeight ? `height:${mediaHeight}px` : 'min-height:200px';
                mediaBlock = `<div style="margin-top:15px; width:100%; ${mhStyle}; display:flex; align-items:center; justify-content:center; background:#f9f9f9; overflow:hidden; border-radius:8px;">${innerMedia}</div>`;
            }

            stage.innerHTML = `
            <div style="position: absolute; top: 10px; right: 10px; z-index: 10;">
                <button style="background: none; border: none; font-size: ${closeSize}px; color: ${closeColor}; cursor: pointer; line-height: 1; padding:0; opacity:0.7;">&times;</button>
            </div>
            <h2 style="margin: 0 0 10px 0; font-size: 20px; color: #333; padding-right: 30px; font-weight:700;">${title}</h2>
            <div style="font-size: 14px; color: #555; line-height: 1.5;">${content}</div>
            ${mediaBlock}
            
            <!-- Close Button Simulation at bottom (as in real alert) -->
            <div style="margin-top:auto; padding-top:20px; text-align:right;">
                 <button style="padding:8px 20px; background:#007bff; color:white; border:none; border-radius:6px; font-size:14px; opacity:0.5; pointer-events:none;">Entendido</button>
            </div>

            <!-- Resize Handle -->
            <div id="ve-resize-handle" style="width: 25px; height: 25px; position: absolute; bottom: 0; right: 0; cursor: se-resize; background: linear-gradient(135deg, transparent 50%, var(--highlight-color, #007bff) 50%); border-radius: 0 0 8px 0; pointer-events:all;"></div>
        `;

            // Re-attach drag events
            const handle = document.getElementById('ve-resize-handle');
            if (handle) {
                handle.addEventListener('mousedown', initResizeDrag);
            }
        };

        window.updateVisualEditorFromInputs = function () {
            document.getElementById('ve-close-size-val').textContent = document.getElementById('ve-close-size').value;
            window.renderVisualAlert();
        };

        window.applyVisualEditor = function () {
            document.getElementById('alert-width').value = document.getElementById('ve-width').value;
            document.getElementById('alert-height').value = document.getElementById('ve-height').value;
            document.getElementById('alert-close-size').value = document.getElementById('ve-close-size').value;
            document.getElementById('alert-close-color').value = document.getElementById('ve-close-color').value;
            document.getElementById('alert-media-height').value = document.getElementById('ve-media-height').value;

            document.getElementById('visual-editor-modal').style.display = 'none';
            window.updateAlertPreview();
        };

        function initResizeDrag(e) {
            e.preventDefault();
            e.stopPropagation(); // Stop bubbling
            const stage = document.getElementById('ve-alert-stage');
            const startX = e.clientX;
            const startY = e.clientY;
            const startW = stage.offsetWidth;
            const startH = stage.offsetHeight;

            function doDrag(e) {
                const newW = Math.max(300, startW + e.clientX - startX);
                const newH = Math.max(200, startH + e.clientY - startY);
                stage.style.width = newW + 'px';
                stage.style.height = newH + 'px';

                // Update Inputs
                document.getElementById('ve-width').value = newW;
                document.getElementById('ve-height').value = newH;
            }

            function stopDrag() {
                window.removeEventListener('mousemove', doDrag);
                window.removeEventListener('mouseup', stopDrag);
            }

            window.addEventListener('mousemove', doDrag);
            window.addEventListener('mouseup', stopDrag);
        }

        window.previewCurrentAlert = function () {
            const data = {
                title: document.getElementById('alert-title').value,
                content: document.getElementById('alert-content').value,
                mediaType: document.getElementById('alert-media-type').value,
                mediaUrl: document.getElementById('alert-media-url').value,
                mediaHtml: document.getElementById('alert-html-content').value,
                width: parseInt(document.getElementById('alert-width').value) || 0,
                height: parseInt(document.getElementById('alert-height').value) || 0,
                lockTime: parseInt(document.getElementById('alert-lock-time').value) || 0,
                closeBtnSize: parseInt(document.getElementById('alert-close-size').value) || 24,
                closeBtnColor: document.getElementById('alert-close-color').value || '#000000',
                mediaHeight: parseInt(document.getElementById('alert-media-height').value) || 0,
                frequency: 'once',
                createdAt: { seconds: Date.now() / 1000 } // Dummy timestamp
            };

            console.log("PREVIEWING:", data);
            showAlert('PREVIEW_TEST_' + Date.now(), data, 'test_mode');
        };

        setTimeout(tryInitAlertSystem, 3000);

    </script>
    <!-- VISUAL ALERT EDITOR MODAL -->
    <div id="visual-editor-modal" class="custom-modal"
        style="display:none; z-index: 10000; align-items: center; justify-content: center;">
        <div class="custom-modal-content"
            style="width: 95vw; height: 90vh; max-width: none; display: flex; flex-direction: column; padding: 0; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden;">
            <!-- Header -->
            <div
                style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary);">
                <div style="display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-edit" style="color:var(--highlight-color)"></i>
                    <h3 style="margin:0; font-size: 16px;">Editor Visual de Alertas</h3>
                </div>
                <button onclick="document.getElementById('visual-editor-modal').style.display='none'"
                    style="background:none; border:none; cursor:pointer; color:var(--text-color); font-size:16px;"><i
                        class="fas fa-times"></i></button>
            </div>
            <!-- Body -->
            <div style="flex:1; display:flex; overflow: hidden;">
                <!-- Canvas -->
                <div id="visual-editor-canvas"
                    style="flex:1; background: #121212; position: relative; overflow: auto; display: flex; justify-content: center; align-items: center; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;">
                    <!-- Alert Element will be injected here via JS -->
                    <div id="ve-alert-stage" style="position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5);"></div>
                </div>
                <!-- Controls -->
                <div
                    style="width: 320px; background: var(--bg-secondary); border-left: 1px solid var(--border-color); padding: 20px; overflow-y: auto; display:flex; flex-direction:column;">
                    <h4
                        style="font-size: 13px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">
                        Propriedades</h4>

                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 11px; opacity: 0.7; display:block; margin-bottom:5px;">DimensÃµes
                            (Arraste para redimensionar)</label>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex:1">
                                <span style="font-size:10px; opacity:0.5">W</span>
                                <input type="number" id="ve-width" class="admin-input"
                                    oninput="window.updateVisualEditorFromInputs()">
                            </div>
                            <div style="flex:1">
                                <span style="font-size:10px; opacity:0.5">H</span>
                                <input type="number" id="ve-height" class="admin-input"
                                    oninput="window.updateVisualEditorFromInputs()">
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 11px; opacity: 0.7; display:block; margin-bottom:5px;">BotÃ£o
                            Fechar</label>
                        <div style="margin-bottom: 10px;">
                            <span style="font-size: 10px;">Tamanho (<span id="ve-close-size-val">24</span>px)</span>
                            <input type="range" id="ve-close-size" min="16" max="48" value="24" style="width:100%"
                                oninput="window.updateVisualEditorFromInputs()">
                        </div>
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <span style="font-size: 10px;">Cor do Ãcone</span>
                            <input type="color" id="ve-close-color" value="#000000"
                                style="width: 30px; height: 30px; border:none; cursor:pointer;"
                                oninput="window.updateVisualEditorFromInputs()">
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 11px; opacity: 0.7; display:block; margin-bottom:5px;">MÃ­dia /
                            iFrame</label>
                        <span style="font-size: 10px;">Altura Fixa (px) - Opcional</span>
                        <input type="number" id="ve-media-height" placeholder="Auto" class="admin-input"
                            oninput="window.updateVisualEditorFromInputs()">
                    </div>

                    <div style="margin-top: auto;">
                        <button onclick="window.applyVisualEditor()"
                            style="width: 100%; padding: 12px; background: var(--success-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:8px;">
                            <i class="fas fa-check"></i> Aplicar AlteraÃ§Ãµes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MOBILE 2.0 INTEGRATION -->
    <style>
        /* Plugin Update Badge */
        .update-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #38bdf8, #0ea5e9);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(56, 189, 248, 0.5);
            transition: all 0.3s ease;
            z-index: 5;
            animation: pulse-badge 2s infinite;
        }

        .update-badge:hover {
            transform: scale(1.1);
            width: auto;
            border-radius: 12px;
            padding: 4px 10px;
        }

        .update-badge img {
            width: 12px;
            height: 12px;
            filter: brightness(0) invert(1);
        }

        .update-badge span {
            display: none;
            white-space: nowrap;
            margin-left: 4px;
        }

        .update-badge:hover span {
            display: inline;
        }

        @keyframes pulse-badge {
            0% {
                box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(56, 189, 248, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(56, 189, 248, 0);
            }
        }

        /* Mobile 2.0 Variables - Always Available */
        :root {
            /* Mobile 2.0 - Light Theme (Default) */
            --m2-bg-blur: rgba(226, 232, 240, 0.5);
            --m2-gallium-base: #cfd8e3;
            --m2-gallium-reflect: #f1f5f9;
            --m2-gallium-shadow: rgba(148, 163, 184, 0.25);
            --m2-text-primary: #334155;
            --m2-text-mono: #64748b;
            --m2-accent-glow: rgba(37, 99, 235, 0.2);
            --m2-status-off: #94a3b8;
            --m2-status-on: #10b981;
            --m2-btn-bg: rgba(255, 255, 255, 0.5);
            --m2-surface-edge: rgba(255, 255, 255, 0.6);
            --m2-transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            --m2-card-radius: 28px;
        }

        /* Mobile 2.0 - Dark Theme Override */


        body:not(.light-mode) {
            /* Dark theme for Mobile 2.0 */
            --m2-bg-blur: rgba(15, 23, 42, 0.7);
            --m2-gallium-base: #0f172a;
            --m2-gallium-reflect: #1e293b;
            --m2-gallium-shadow: rgba(0, 0, 0, 0.4);
            --m2-text-primary: #f1f5f9;
            --m2-text-mono: #94a3b8;
            --m2-accent-glow: rgba(96, 165, 250, 0.25);
            --m2-status-off: #334155;
            --m2-status-on: #34d399;
            --m2-btn-bg: rgba(30, 41, 59, 0.6);
            --m2-surface-edge: rgba(255, 255, 255, 0.05);
        }

        .mobile-2-0-wrapper {
            display: none;
            /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--m2-gallium-base, #0f172a);
            z-index: 999999 !important;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: background 0.8s ease;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Outfit', sans-serif;
        }

        /* Hide specific main app elements when active */
        body.mobile-2-0-active {
            overflow: hidden !important;
        }

        /* Aggressive Hide for Desktop Elements */
        body.mobile-2-0-active>*:not(.mobile-2-0-wrapper):not(#mobile-debug-hud):not(script):not(style):not(#custom-confirm-modal):not(#login-modal):not(#custom-mobile-confirm-modal):not(#confirm-modal-content):not(.modal):not(.album-modal):not(#camera-container):not(.patient-list-modal):not(.patient-details-modal):not(.app-modal):not(.fullscreen-modal):not(#fullscreen-modal):not(#mobile-analysis-loader):not(.mobile-analysis-loader) {
            display: none !important;
        }

        /* Force high z-index for modals in mobile mode */
        body.mobile-2-0-active .album-modal,
        body.mobile-2-0-active .patient-list-modal,
        body.mobile-2-0-active .patient-details-modal,
        body.mobile-2-0-active .app-modal,
        body.mobile-2-0-active #camera-container {
            z-index: 9999999 !important;
        }

        /* Fullscreen modal must be above album-modal */
        body.mobile-2-0-active .fullscreen-modal,
        body.mobile-2-0-active #fullscreen-modal {
            z-index: 99999999 !important;
        }

        /* Mobile analysis loader must be above camera-container */
        body.mobile-2-0-active #mobile-analysis-loader,
        body.mobile-2-0-active .mobile-analysis-loader {
            z-index: 99999999 !important;
        }

        @media screen and (orientation: landscape) {
            body.mobile-2-0-active .mobile-2-0-wrapper {
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
            }

            body.mobile-2-0-active .mobile-2-0-container {
                display: flex !important;
            }

            body.mobile-2-0-active .container {
                display: none !important;
            }

            body.mobile-2-0-active .main-stage {
                display: none !important;
            }
        }

        @media screen and (orientation: portrait) {
            body.mobile-2-0-active .mobile-2-0-wrapper {
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
            }

            body.mobile-2-0-active .mobile-2-0-container {
                display: flex !important;
            }

            body.mobile-2-0-active .container {
                display: none !important;
            }

            body.mobile-2-0-active .main-stage {
                display: none !important;
            }
        }

        /* MOBILE 2.0 CSS FROM mobile2.0.html */
        .mobile-2-0-container {
            width: 98%;
            max-width: 98%;
            background: var(--m2-bg-blur);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid var(--m2-surface-edge);
            border-radius: 40px;
            padding: 30px 24px;
            box-shadow: 0 40px 100px -20px var(--m2-gallium-shadow),
                inset 0 2px 5px var(--m2-surface-edge);
            position: relative;
            animation: containerReveal 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            color: var(--m2-text-primary);
            margin: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @keyframes containerReveal {
            0% {
                opacity: 0.7;
                transform: translateY(20px) scale(0.98);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .mobile-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .mobile-header h2 {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1.5px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--m2-text-primary) 30%, var(--m2-text-mono));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .mobile-header p {
            font-size: 14px;
            color: var(--m2-text-mono);
            font-weight: 400;
        }

        .info-banner {
            background: var(--m2-btn-bg);
            border: 1px solid var(--m2-surface-edge);
            border-radius: 24px;
            padding: 16px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .chat-bubble-info {
            display: flex;
            gap: 12px;
            font-size: 13px;
            line-height: 1.5;
            color: var(--m2-text-primary);
            position: relative;
            z-index: 1;
        }

        .chat-bubble-info i {
            color: #3b82f6;
            font-size: 16px;
            margin-top: 2px;
        }

        .highlight-link {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 600;
            margin-left: 4px;
            border-bottom: 1px solid transparent;
            transition: var(--m2-transition);
        }

        .highlight-link:hover {
            border-color: #3b82f6;
            opacity: 0.8;
        }

        .mobile-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
            width: 100%;
        }

        .mobile-btn {
            background: var(--m2-btn-bg);
            border: 1px solid var(--m2-surface-edge);
            border-radius: 24px;
            padding: 20px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--m2-transition);
            box-shadow: 0 4px 15px var(--m2-gallium-shadow);
            position: relative;
            overflow: hidden;
            color: var(--m2-text-primary);
            width: 100%;
            min-height: 110px;
        }

        .mobile-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            pointer-events: none;
        }

        .mobile-btn i {
            font-size: 28px;
            color: var(--m2-text-primary);
            transition: var(--m2-transition);
        }

        .mobile-btn span {
            font-size: 13px;
            font-weight: 600;
            color: var(--m2-text-primary);
            text-align: center;
        }

        .mobile-btn:hover {
            transform: translateY(-5px) scale(1.02);
            background: var(--m2-gallium-reflect);
            box-shadow: 0 15px 30px var(--m2-gallium-shadow);
            border-color: #3b82f644;
        }

        .mobile-btn:hover i {
            transform: scale(1.1);
            color: #3b82f6;
        }

        .mobile-connection-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid var(--m2-surface-edge);
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--m2-btn-bg);
            border-radius: 20px;
            border: 1px solid var(--m2-surface-edge);
            font-size: 12px;
            font-weight: 500;
            color: var(--m2-text-primary);
        }

        .status-dot-m2-real {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--m2-status-off);
            box-shadow: 0 0 0 4px rgba(148, 163, 184, 0.1);
            position: relative;
        }

        .status-dot-m2-real.active {
            background: var(--m2-status-on);
            box-shadow: 0 0 12px var(--m2-status-on);
            animation: pulse 2s infinite;
        }

        /* Status dot classes matching axonantigo.html style */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--m2-status-off);
            box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.15);
            flex-shrink: 0;
        }

        .status-dot.status-on {
            background: var(--m2-status-on);
            box-shadow: 0 0 10px var(--m2-status-on), 0 0 0 3px rgba(16, 185, 129, 0.2);
            animation: pulse-status 2s infinite;
        }

        @keyframes pulse-status {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .axon-usb-badge {
            color: #68d391;
            border: 1px solid #68d391;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: bold;
            background: rgba(104, 211, 145, 0.1);
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .logout-hint {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--m2-text-mono);
            text-align: center;
            max-width: 240px;
            line-height: 1.4;
            cursor: pointer;
            transition: var(--m2-transition);
        }

        .logout-hint:hover {
            color: #ef4444;
        }

        .theme-switcher {
            position: absolute;
            top: 25px;
            right: 25px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--m2-btn-bg);
            border: 1px solid var(--m2-surface-edge);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--m2-text-primary);
            transition: var(--m2-transition);
            z-index: 10;
        }

        .theme-switcher:hover {
            background: var(--m2-gallium-reflect);
            transform: rotate(15deg) scale(1.1);
        }

        .theme-switcher-m2 {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--m2-btn-bg);
            border: 1px solid var(--m2-surface-edge);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--m2-text-primary);
            transition: var(--m2-transition);
            z-index: 10;
        }

        .theme-switcher-m2:hover {
            background: var(--m2-gallium-reflect);
            transform: rotate(15deg) scale(1.1);
        }

        .axon-dot {
            position: absolute;
            top: 25px;
            left: 25px;
            font-weight: 800;
            font-size: 18px;
            letter-spacing: -1px;
            color: var(--m2-text-primary);
        }

        .axon-dot::after {
            content: '';
            display: inline-block;
            width: 5px;
            height: 5px;
            background: var(--m2-status-on);
            border-radius: 50%;
            margin-left: 2px;
        }

        .status-dot-m2 {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--m2-status-off);
            box-shadow: 0 0 0 4px rgba(148, 163, 184, 0.1);
        }

        .status-dot-m2.active {
            background: var(--m2-status-on);
            box-shadow: 0 0 12px var(--m2-status-on);
            animation: pulse-m2 2s infinite;
        }

        @keyframes pulse-m2 {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .theme-switcher-m2 {
            position: absolute;
            top: 25px;
            right: 25px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--m2-btn-bg);
            border: 1px solid var(--m2-surface-edge);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--m2-text-primary);
            z-index: 10;
        }

        .axon-dot-m2 {
            position: absolute;
            top: 25px;
            left: 25px;
            font-weight: 800;
            font-size: 18px;
            letter-spacing: -1px;
            color: var(--m2-text-primary);
        }

        .axon-dot-m2::after {
            content: '';
            display: inline-block;
            width: 5px;
            height: 5px;
            background: var(--m2-status-on);
            border-radius: 50%;
            margin-left: 2px;
        }
    </style>

    <!-- MOBILE 2.0 CONTAINER -->
    <div id="mobile-2-0-container" class="mobile-2-0-wrapper"
        style="display:none; align-items:center; justify-content:center;">
        <div class="mobile-2-0-container" style="position:relative;">

            <!-- Header Controls -->
            <div style="position: absolute; top: 25px; left: 25px; z-index: 10;">
                <div id="mobile-settings-btn" class="theme-switcher-m2" style="position: relative; top: 0; left: 0;">
                    <i class="fas fa-cog"></i>
                </div>
            </div>

            <div style="position: absolute; top: 25px; right: 25px; z-index: 10; display: flex; gap: 10px;">
                <div id="mobile-logout-button" class="theme-switcher-m2" title="Sair"
                    style="position: relative; top: 0; right: 0;">
                    <i class="fas fa-power-off"></i>
                </div>
                <div id="mobile-theme-toggle" class="theme-switcher-m2" style="position: relative; top: 0; right: 0;">
                    <i class="fas fa-moon"></i>
                </div>
            </div>

            <div class="mobile-header" style="margin-top: 60px;">
                <h2 id="mobile-welcome-title">Bem-vindo!</h2>
                <p>Selecione uma opÃ§Ã£o para comeÃ§ar.</p>
            </div>

            <div class="info-banner">
                <div class="chat-bubble-info">
                    <i class="fas fa-info-circle"></i>
                    <span id="info-banner-content">
                        Para acesso completo acesse em seu navegador: <a href="https://funortehub.github.io/axon"
                            target="_blank" class="highlight-link">funortehub.github.io/axon</a> ou conecte um
                        dispositivo AXON USB.
                    </span>
                </div>
            </div>

            <div class="mobile-grid">
                <button id="mobile-btn-exames" class="mobile-btn">
                    <i class="fas fa-notes-medical"></i>
                    <span>Analisar Exames</span>
                </button>

                <button id="mobile-btn-see" class="mobile-btn">
                    <i class="fas fa-eye"></i>
                    <span>AnÃ¡lise Axon Eye</span>
                </button>



                <button id="mobile-btn-chat" class="mobile-btn">
                    <i class="fas fa-comment-medical"></i>
                    <span>Axon AI Chat</span>
                </button>

                <button id="mobile-btn-transfer" class="mobile-btn">
                    <i class="fas fa-file-import"></i>
                    <span>Enviar</span>
                </button>
            </div>

            <div class="mobile-connection-status">
                <div id="mobile-connection-status-inner" class="status-pill"
                    style="display:flex;align-items:center;justify-content:center;gap:8px">
                    <div id="mobile-status-dot" class="status-dot"></div>
                    <span id="mobile-status-text">Verificando conexÃ£o...</span>
                </div>
                <small id="mobile-disconnect-btn" class="logout-hint"
                    style="margin-top: 8px; color: var(--danger); font-weight:bold;">
                    <i class="fas fa-power-off"></i> Desconectar Remotamente
                </small>
            </div>
        </div>
    </div>

    <script>
        // --- MOBILE 2.0 LOGIC REFORMULATED ---
        // MOBILE 2.0 UNIFIED LOGIC - FIX v6 (Auth, List, Status, Global Flag)
        (function () {
            // --- STATE ---
            let isMobileModeActive = false;
            let mobileListenersAttached = false;
            let desktopListenerUnsubscribe = null;

            // --- ELEMENTS ---
            const container = document.querySelector('.mobile-2-0-wrapper'); // The wrapper
            const statusText = document.getElementById('mobile-status-text');
            const statusDot = document.getElementById('mobile-status-dot');
            const disconnectBtn = document.getElementById('mobile-disconnect-btn');

            // --- CORE FUNCTIONS ---

            // 1. Safe Modal Opener (Reparenting Fix + Styling)
            const safeOpen = (modalId, displayType = 'flex') => {
                const modal = document.getElementById(modalId);
                if (!modal) return console.error(`[MobileFX] Modal ${modalId} not found`);

                // Reparent to body if not already (Critical for z-index)
                if (modal.parentNode !== document.body) {
                    document.body.appendChild(modal);
                }

                // Force visibility
                modal.style.setProperty('display', displayType, 'important');
                modal.style.setProperty('z-index', '9999999', 'important');
                modal.style.setProperty('visibility', 'visible', 'important');
                modal.style.setProperty('position', 'fixed', 'important');
                modal.style.setProperty('top', '0', 'important');
                modal.style.setProperty('left', '0', 'important');
                modal.style.setProperty('width', '100%', 'important');
                modal.style.setProperty('height', '100%', 'important');
            };

            // 2. Desktop Info Detection (from axonantigo.html)
            const getDesktopInfo = () => {
                const ua = navigator.userAgent;
                let os = 'OS Desconhecido';
                let browser = 'Navegador Desconhecido';

                // OS Detection
                if (navigator.appVersion.indexOf("Win") != -1) os = "Windows";
                if (navigator.appVersion.indexOf("Mac") != -1) os = "macOS";
                if (navigator.appVersion.indexOf("X11") != -1) os = "UNIX";
                if (navigator.appVersion.indexOf("Linux") != -1) os = "Linux";

                // Browser Detection
                if (ua.toLowerCase().indexOf("axon") !== -1) {
                    browser = `Axon USB App`;
                } else if (ua.indexOf("Edg/") !== -1) {
                    browser = `Edge ${ua.split('Edg/')[1].split(' ')[0]}`;
                } else if (ua.indexOf("Firefox/") !== -1) {
                    browser = `Firefox ${ua.split('Firefox/')[1].split(' ')[0]}`;
                } else if (ua.indexOf("Chrome/") !== -1 && ua.indexOf("Safari/") !== -1 && ua.indexOf("OPR/") === -1) {
                    browser = `Chrome ${ua.split('Chrome/')[1].split(' ')[0]}`;
                } else if (ua.indexOf("Safari/") !== -1 && ua.indexOf("Chrome/") === -1) {
                    browser = `Safari ${ua.split('Version/')[1]?.split(' ')[0] || ''}`;
                }

                return { os, browser, userAgent: ua };
            };

            // Make getDesktopInfo globally available for desktop session updates
            window.getDesktopInfo = getDesktopInfo;

            // 3. Status Updater (matching axonantigo.html style)
            const updateConnectionStatus = (desktopData) => {
                if (!statusDot || !statusText) return;

                const isConnected = desktopData && desktopData.timestamp && (new Date() - desktopData.timestamp.toDate() < 30000);

                // Update status dot classes
                statusDot.classList.remove('status-dot-m2', 'active', 'status-on');
                statusDot.classList.add('status-dot');
                if (isConnected) {
                    statusDot.classList.add('status-on');
                }

                if (isConnected) {
                    // Check for Axon USB connection
                    const isAxon = (desktopData.userAgent && desktopData.userAgent.toLowerCase().includes('axon')) ||
                        (desktopData.browser && desktopData.browser.toLowerCase().includes('axon'));

                    if (isAxon) {
                        statusText.innerHTML = `<span class="axon-usb-badge">CONECTADO VIA UNIDADE AXON USB</span>`;
                    } else {
                        // Show detailed device info like axonantigo.html
                        const osInfo = desktopData.os || 'Desktop';
                        const browserInfo = desktopData.browser || 'Navegador';
                        statusText.textContent = `Conectado em desktop: ${osInfo} - ${browserInfo}`;
                    }
                } else {
                    statusText.textContent = 'Nenhum desktop conectado';
                }
            };

            // 3. Activation Logic
            window.activateMobileMode = () => {
                if (isMobileModeActive) return;
                isMobileModeActive = true;
                window.isMobile = true; // Global Flag for other scripts

                document.body.classList.add('mobile-2-0-active');
                if (container) container.style.display = 'flex';

                // Hide Desktop Main Stage
                const mainStage = document.querySelector('.main-stage');
                if (mainStage) mainStage.style.setProperty('display', 'none', 'important');

                // Header & Footer
                const header = document.querySelector('.header-wrap');
                const footer = document.querySelector('.footer');
                if (header) header.style.display = 'none';
                if (footer) footer.style.display = 'none';

                console.log("[MobileFX] Activated");
            };

            window.deactivateMobileMode = () => {
                isMobileModeActive = false;
                window.isMobile = false;

                document.body.classList.remove('mobile-2-0-active');
                if (container) container.style.display = 'none';

                const mainStage = document.querySelector('.main-stage');
                if (mainStage) mainStage.style.removeProperty('display');

                const header = document.querySelector('.header-wrap');
                const footer = document.querySelector('.footer');
                if (header) header.style.display = '';
                if (footer) footer.style.display = '';

                if (desktopListenerUnsubscribe) {
                    desktopListenerUnsubscribe();
                    desktopListenerUnsubscribe = null;
                }
            };

            // 4. Update Layout & Listeners
            window.updateMobile2Layout = () => {
                // Wait for Settings
                if (typeof globalSettings === 'undefined' || !globalSettings) return;

                // Feature Flag Check
                if (globalSettings.mobile2_0_enabled === false) {
                    if (isMobileModeActive) deactivateMobileMode();
                    return;
                }

                // Device Check - TRUST USER AGENT
                const isMobileUA = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                // Only consider width if NOT a mobile UA (e.g. small browser window on desktop)
                const isMobileWidth = window.innerWidth <= 1024;
                const isMobileLocal = isMobileUA || isMobileWidth;

                if (!isMobileLocal) {
                    if (isMobileModeActive) deactivateMobileMode();
                    return;
                }

                // Strictly Enforce Mobile Mode if isMobileUA is true (Prevents Rotation to Desktop)
                // If it is a mobile device, we NEVER show desktop view.

                // Auth Check
                if (typeof firebase !== 'undefined' && firebase.auth()) {
                    const user = firebase.auth().currentUser;
                    if (user) {
                        activateMobileMode();

                        // Setup Status Listener (Robust Local Implementation)
                        if (!desktopListenerUnsubscribe && typeof onSnapshot !== 'undefined' && typeof doc !== 'undefined' && typeof db !== 'undefined') {
                            try {
                                const userEmail = user.email || (typeof currentUser !== 'undefined' ? currentUser : null);
                                if (userEmail) {
                                    desktopListenerUnsubscribe = onSnapshot(doc(db, "sessions", userEmail), (docSnap) => {
                                        if (docSnap.exists()) {
                                            const data = docSnap.data();
                                            if (data && data.desktopConnection) {
                                                updateConnectionStatus(data.desktopConnection);
                                            }
                                        }
                                    });
                                }
                            } catch (e) { console.error("[MobileFX] Status listener setup error:", e); }
                        }

                    } else {
                        // User NOT Logged In logic

                        // Check for persistence flag effectively "Loading" state
                        if (localStorage.getItem('axon_logged_in_user')) {
                            // Do nothing, let the auth state resolve or timeout
                            // If it takes too long without auth change, firebase listener will eventually fire "null" user if truly logged out?
                            // Actually, firebase.auth().onAuthStateChanged handles the truth. 
                            // But we need to avoid the flicker of "Mobile Mode Active" (Desktop Hidden) vs "Mobile Login Pushed".
                            // If we have local storage, we assume we ARE logged in until proven otherwise.
                            activateMobileMode();
                            return;
                        }

                        if (isMobileUA) {
                            // On Mobile Device:
                            // 1. Activate "Mobile Mode" CSS to HIDE Desktop elements (via body class)
                            document.body.classList.add('mobile-2-0-active');
                            window.isMobile = true;

                            // 2. Hide Mobile Container (Wrapper) because user wants ONLY Login Modal
                            if (container) container.style.display = 'none';

                            // 3. Ensure Login Modal is visible (handled by CSS exclusion and Main Logic)
                            // Note: deactivateMobileMode would show desktop, which we DON'T want.

                            // Hide Main Stage explicitly if needed (redundant with body class but safe)
                            const mainStage = document.querySelector('.main-stage');
                            if (mainStage) mainStage.style.setProperty('display', 'none', 'important');

                        } else {
                            // On Desktop (small window): Just show standard view (Deactivate Logic)
                            deactivateMobileMode();
                        }
                    }
                } else {
                    // No Firebase Auth instance yet?
                    if (isMobileUA) {
                        document.body.classList.add('mobile-2-0-active');
                        if (container) container.style.display = 'none';
                        const mainStage = document.querySelector('.main-stage');
                        if (mainStage) mainStage.style.setProperty('display', 'none', 'important');
                    } else {
                        deactivateMobileMode();
                    }
                }
            };

            // 5. Init Event Listeners
            const initListeners = () => {
                if (mobileListenersAttached) return;

                // Buttons
                const btnExames = document.getElementById('mobile-btn-exames');
                const btnSee = document.getElementById('mobile-btn-see');
                const btnRecords = document.getElementById('mobile-btn-records');
                const btnSettings = document.getElementById('mobile-settings-btn');
                const btnChat = document.getElementById('mobile-btn-chat');
                const btnTransfer = document.getElementById('mobile-btn-transfer');

                if (btnExames) btnExames.onclick = () => safeOpen('camera-modal', 'flex');
                if (btnSee) btnSee.onclick = () => safeOpen('camera-modal', 'flex');

                // Patient List - Prevent Propagation Fix
                if (btnRecords) {
                    btnRecords.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        safeOpen('patient-list-modal', 'flex');
                    });
                }

                // Admin Auth - Intercept & Custom Handling
                if (btnSettings) {
                    btnSettings.addEventListener('click', (e) => {
                        // Open Auth Modal
                        e.preventDefault();
                        e.stopPropagation();
                        safeOpen('admin-auth-modal', 'flex');

                        // Focus Input
                        const passInput = document.getElementById('admin-auth-pass');
                        if (passInput) setTimeout(() => passInput.focus(), 100);
                    });
                }

                // Admin Auth Submit Interceptor
                const adminSubmitBtn = document.getElementById('admin-auth-button');
                if (adminSubmitBtn) {
                    // Use capture to ensure we handle it before any broken listeners
                    adminSubmitBtn.addEventListener('click', async (e) => {
                        if (document.body.classList.contains('mobile-2-0-active')) {
                            e.preventDefault();
                            e.stopPropagation();

                            const passInput = document.getElementById('admin-auth-pass');
                            const feedback = document.getElementById('admin-auth-feedback');

                            if (passInput && await verifyAdminPassword(passInput.value)) {
                                // Close Auth
                                const authModal = document.getElementById('admin-auth-modal');
                                if (authModal) authModal.style.display = 'none';

                                // Open Panel
                                safeOpen('admin-panel-modal', 'flex');

                                // Initialize Users Tab
                                const usersTab = document.querySelector('.admin-tab-btn[data-tab="users"]');
                                if (usersTab) usersTab.click();
                                else if (typeof activateAdminTab !== 'undefined') activateAdminTab('users');

                            } else {
                                if (feedback) feedback.textContent = 'Senha incorreta.';
                            }
                        }
                    });
                }

                // Disconnect Button Listener
                if (disconnectBtn) {
                    disconnectBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        // Using the requested Confirmation Modal
                        if (typeof showConfirmModal === 'function') {
                            showConfirmModal(
                                "Deseja encerrar todas as sessÃµes em desktops? Qualquer dispositivo conectado serÃ¡ desconectado e precisarÃ¡ de um novo login.",
                                async () => {
                                    const user = (typeof currentUser !== 'undefined' && currentUser)
                                        ? currentUser
                                        : (typeof firebase !== 'undefined' && firebase.auth().currentUser ? firebase.auth().currentUser.email : null);

                                    if (user) {
                                        try {
                                            await deleteDoc(doc(db, "sessions", user));
                                            if (statusText) statusText.textContent = "SessÃ£o encerrada.";
                                        } catch (e) {
                                            console.error("Erro ao encerrar sessÃ£o remota:", e);
                                            alert("Erro ao desconectar: " + e.message);
                                        }
                                    }
                                }
                            );
                        } else {
                            // Fallback if modal not found
                            if (confirm("Deseja encerrar todas as sessÃµes em desktops?")) {
                                const user = (typeof currentUser !== 'undefined' && currentUser)
                                    ? currentUser
                                    : (typeof firebase !== 'undefined' && firebase.auth().currentUser ? firebase.auth().currentUser.email : null);

                                if (user) deleteDoc(doc(db, "sessions", user));
                            }
                        }
                    });
                }

                if (btnChat) btnChat.onclick = () => safeOpen('chatbox-modal', 'flex');
                if (btnTransfer) btnTransfer.onclick = () => safeOpen('transfer-modal', 'flex');



                // Logout Header
                // Logout Header
                const mobileLogoutBtn = document.getElementById('mobile-logout-button');
                if (mobileLogoutBtn) {
                    mobileLogoutBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        const performLogout = () => {
                            // 1. Force UI Transition Immediately
                            const loginModal = document.getElementById('login-modal');
                            const mobContainer = document.getElementById('mobile-2-0-container');

                            if (mobContainer) mobContainer.style.display = 'none';

                            // Show Login Modal FORCEFULLY
                            if (loginModal) {
                                loginModal.style.setProperty('display', 'flex', 'important');
                                loginModal.style.setProperty('z-index', '999999999', 'important');
                                loginModal.style.setProperty('visibility', 'visible', 'important');
                                loginModal.style.opacity = '1';
                            }

                            // Keep Desktop Hidden
                            document.body.classList.add('mobile-2-0-active');

                            // 2. Clear Persistence
                            localStorage.removeItem('axon_logged_in_user');

                            // 3. Sign Out (async but UI is already updated)
                            if (typeof firebase !== 'undefined' && firebase.auth()) {
                                firebase.auth().signOut().then(() => {
                                    if (window.updateMobile2Layout) window.updateMobile2Layout();
                                }).catch(err => {
                                    console.error(err);
                                    window.location.reload();
                                });
                            } else {
                                window.location.reload();
                            }
                        };

                        // Use Existing Modal Architecture (custom-modal class)
                        let modal = document.getElementById('custom-mobile-confirm-modal');
                        if (!modal) {
                            modal = document.createElement('div');
                            modal.id = 'custom-mobile-confirm-modal';
                            // Reuse existing classes but force z-index for mobile
                            modal.className = 'custom-modal';
                            modal.style.cssText = 'display:none; z-index:99999999 !important;';

                            modal.innerHTML = `
                                <div class="custom-modal-content">
                                    <h3 class="custom-modal-title">Sair?</h3>
                                    <p style="color:var(--text-color); opacity:0.8;">Deseja realmente sair e encerrar a sessÃ£o?</p>
                                    <div class="custom-modal-actions">
                                        <button id="mob-conf-cancel" style="padding:8px 16px; background:var(--button-bg); color:var(--text-color); border-radius:6px; border:1px solid var(--border-color); cursor:pointer;">Cancelar</button>
                                        <button id="mob-conf-ok" style="padding:8px 16px; background:var(--error-color, #ef4444); color:white; border-radius:6px; border:none; cursor:pointer;">Sair</button>
                                    </div>
                                </div>
                            `;
                            document.body.appendChild(modal);
                            document.getElementById('mob-conf-cancel').onclick = () => modal.style.display = 'none';
                        }

                        // Re-bind OK button to current closure
                        const okBtn = document.getElementById('mob-conf-ok');
                        if (okBtn) okBtn.onclick = () => {
                            document.getElementById('custom-mobile-confirm-modal').style.display = 'none';
                            performLogout();
                        };

                        document.getElementById('custom-mobile-confirm-modal').style.display = 'flex';
                    };
                }



                // Theme
                const mobileThemeToggle = document.querySelector('.theme-switcher-m2');
                const mobileThemeToggleId = document.getElementById('mobile-theme-toggle');

                const toggleHandler = () => {
                    if (window.toggleTheme) window.toggleTheme();
                    // Update icon logic if needed (usually handled by main theme function)
                };

                if (mobileThemeToggleId) mobileThemeToggleId.onclick = toggleHandler;
                else if (mobileThemeToggle) mobileThemeToggle.onclick = toggleHandler;

                mobileListenersAttached = true;
                console.log("[MobileFX] Listeners Attached");
            };

            // 6. Init Triggers
            // Try to lock screen orientation to portrait on mobile devices
            const tryLockOrientation = () => {
                const isMobileUA = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobileUA && screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('portrait').catch(e => {
                        console.log('[MobileFX] Orientation lock not supported:', e.message);
                    });
                }
            };
            tryLockOrientation();

            // Resize listener - SKIP recalculation on mobile devices to prevent rotation issues
            window.addEventListener('resize', () => {
                const isMobileUA = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobileUA && isMobileModeActive) {
                    // On mobile device + already in mobile mode: DO NOT recalculate layout
                    // This prevents rotation from hiding the mobile container
                    console.log('[MobileFX] Resize ignored on mobile device');
                    return;
                }
                window.updateMobile2Layout();
            });

            // Poll for Firebase Readiness
            const initInterval = setInterval(() => {
                if (typeof firebase !== 'undefined' && firebase.auth()) {
                    clearInterval(initInterval);

                    // Attach listeners
                    initListeners();

                    // Initial Layout Update
                    window.updateMobile2Layout();

                    // Auth Listener
                    firebase.auth().onAuthStateChanged((user) => {
                        window.updateMobile2Layout();
                    });
                }
            }, 200);

            // Fallback Init (in case firebase is slow or not used)
            setTimeout(() => {
                if (!mobileListenersAttached) initListeners();
                window.updateMobile2Layout();
            }, 1000);

        })();
    </script>
    <!-- USER ALERT MODAL (Overlay) -->
    <div id="axon-alert-overlay"
        style="display: none; position: fixed; inset: 0; z-index: 999999999; justify-content: center; align-items: center; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px);">
        <!-- Re-using styles from Admin but scoped or inline for safety -->
        <div class="alert-view-stage" style="
            position: relative;
            width: 90%;
            max-width: 550px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(32px) saturate(180%);
            -webkit-backdrop-filter: blur(32px) saturate(180%);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #1a1a1a;
            animation: alertPopup 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        ">
            <style>
                @keyframes alertPopup {
                    0% {
                        opacity: 0;
                        transform: scale(0.9) translateY(20px);
                    }

                    100% {
                        opacity: 1;
                        transform: scale(1) translateY(0);
                    }
                }
            </style>

            <div class="alert-header">
                <div class="alert-badge">MENSAGEM DO SISTEMA</div>
                <div style="font-family: monospace; font-size: 10px; opacity: 0.5;">AGORA</div>
            </div>

            <div class="alert-content" style="padding: 0 30px 20px;">
                <h1 id="user-alert-title" class="alert-title" style="font-size: 24px; margin-bottom: 12px;"></h1>
                <p id="user-alert-message" class="alert-message" style="font-size: 15px; margin-bottom: 20px;"></p>

                <div id="user-alert-media" class="alert-media-container" style="display:none; max-height: 300px;">
                    <!-- Media injected here -->
                </div>
            </div>

            <div class="alert-footer"
                style="padding: 20px 30px; background: rgba(0,0,0,0.02); border-top: 1px solid rgba(0,0,0,0.05);">
                <button id="user-alert-close-btn" class="alert-btn alert-btn-primary" onclick="closeAxonAlert()">
                    Entendido
                </button>
            </div>
        </div>
    </div>


</body>

</html>
